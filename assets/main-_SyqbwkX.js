const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./EffectComposer-DiPw_UWQ.js","./three-D29c9MRG.js","./CopyShader-B0dke3by.js","./ShaderPass-B1yiaKM_.js","./Pass-DIKeR8G_.js","./RenderPass-izMPNzSc.js","./UnrealBloomPass-Bq7yDCkQ.js","./SSAOPass-D3mFbYdI.js","./FXAAShader-WBPB6ysx.js","./OutlinePass-BgQqcNOP.js"])))=>i.map(i=>d[i]);
import{V as g,e as W,g as N,G as _,h as O,i as be,j as we,k as G,D as Ne,C as U,a as Ie,l as re,M as ve,Q as Ct,m as St,N as Mt,b as ke,n as Ft,P as Ee,I as Ot,o as Ce,p as lt,q as Nt,r as zt,s as Pt,t as Rt,u as _t,v as Lt,w as Dt,x as Bt,y as kt,z as $t,W as Gt,A as Re,L as qe,F as Ke,H as Ut,J as Ht,K as jt,O as Vt,B as Te,R as Wt,T as Zt,U as Yt,X as Je,Y as Qe,Z as Xt,_ as qt}from"./three-D29c9MRG.js";import{A as Kt}from"./controls-CG9ErnIQ.js";import{r as Jt}from"./crypto-YkV0U4e7.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function V(a){return a*Math.PI/180}function te(a){return(a*180/Math.PI+360)%360}function ze(a){const e=new Float32Array(a.length);let t=0;for(let s=0;s<a.length/9;s++){const n=new g().fromArray(a,s*9),r=new g().fromArray(a,s*9+3),o=new g().fromArray(a,s*9+6),i=new g().subVectors(n,r),c=new g().subVectors(n,o),l=new g().crossVectors(i,c);l.normalize();for(let u=0;u<3;u++)e[t++]=l.x,e[t++]=l.y,e[t++]=l.z}return e}function Qt(a,e){const t=window.URL.createObjectURL(a),s=document.createElement("a");s.style.display="none",s.href=t,s.setAttribute("download",e),typeof s.download>"u"&&s.setAttribute("target","_blank"),document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>{window.URL.revokeObjectURL(t)},100)}function ut(a,e){const t=new W,s=[];for(const o of e)if(o.length===3)for(const i of o)s.push(a[i*3],a[i*3+1],a[i*3+2]);else if(o.length===4){const[i,c,l,u]=o;s.push(a[i*3],a[i*3+1],a[i*3+2],a[c*3],a[c*3+1],a[c*3+2],a[l*3],a[l*3+1],a[l*3+2]),s.push(a[l*3],a[l*3+1],a[l*3+2],a[u*3],a[u*3+1],a[u*3+2],a[i*3],a[i*3+1],a[i*3+2])}const n=new Float32Array(s);t.setAttribute("position",new N(n,3));const r=ze(n);return t.setAttribute("normal",new N(r,3)),t}var es=Object.defineProperty,ts=(a,e,t)=>e in a?es(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,C=(a,e,t)=>ts(a,typeof e!="symbol"?e+"":e,t);const je=class $e{constructor(e,t,s){C(this,"id"),C(this,"name"),C(this,"transform"),C(this,"visible"),C(this,"locked"),C(this,"parentId"),C(this,"userData"),C(this,"_threeObject"),C(this,"_isSelected",!1),C(this,"_selectionOutline"),this.id=e,this.name=t,this.transform=s||M.createDefaultTransform(),this.visible=!0,this.locked=!1}getThreeObject(){return this._threeObject}updateTransform(){this._threeObject&&(this._threeObject.position.copy(this.transform.position),this._threeObject.rotation.setFromVector3(this.transform.rotation),this._threeObject.scale.copy(this.transform.scale))}setVisible(e){this.visible=e,this._threeObject&&(this._threeObject.visible=e)}select(){this._isSelected||(this._isSelected=!0,this.createSelectionOutline(),$e.onSelectionChange?.(this))}deselect(){this._isSelected&&(this._isSelected=!1,this.removeSelectionOutline())}isSelected(){return this._isSelected}delete(){this.deselect(),this.dispose(),$e.onDelete?.(this)}createSelectionOutline(){if(!(!this._threeObject||this._selectionOutline)&&(this._selectionOutline=new _,this._threeObject instanceof O)){const e=new be({color:65280,side:we,transparent:!0,opacity:.8}),t=new O(this._threeObject.geometry,e);t.renderOrder=-1,this._selectionOutline.add(t),this._selectionOutline.position.copy(this._threeObject.position),this._selectionOutline.rotation.copy(this._threeObject.rotation),this._selectionOutline.scale.copy(this._threeObject.scale),this._selectionOutline.scale.multiplyScalar(1.02),this._threeObject.parent?.add(this._selectionOutline)}}removeSelectionOutline(){this._selectionOutline&&(this._selectionOutline.parent?.remove(this._selectionOutline),this._selectionOutline.traverse(e=>{e instanceof O&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()))}),this._selectionOutline=void 0)}applyTransform(e){e.position.copy(this.transform.position),e.rotation.setFromVector3(this.transform.rotation),e.scale.copy(this.transform.scale)}createThreeMaterial(e){return new G({color:e.color,opacity:e.opacity,transparent:e.transparent||e.opacity<1,side:Ne,flatShading:!1,toneMapped:!0})}};C(je,"onSelectionChange");C(je,"onDelete");let Se=je;class q extends Se{constructor(e,t,s,n,r){super(e,t,r),C(this,"type"),C(this,"surfaceType"),C(this,"material"),this.type=s,this.surfaceType="structure",this.material=n}render(){if(!this._threeObject){const e=this.createGeometry(),t=this.createThreeMaterial(this.material);this._threeObject=new O(e,t),this._threeObject.name=this.name,this._threeObject.userData.cifObject=this,this._threeObject.userData.cifId=this.id,this._threeObject.userData.cifType=this.type,this._threeObject.userData.surfaceType=this.surfaceType,this._threeObject.visible=this.visible,this.applyTransform(this._threeObject)}return this._threeObject}dispose(){this.removeSelectionOutline(),this._threeObject instanceof O&&(this._threeObject.geometry&&this._threeObject.geometry.dispose(),this._threeObject.material&&(Array.isArray(this._threeObject.material)?this._threeObject.material.forEach(e=>e.dispose()):this._threeObject.material.dispose())),this._threeObject=void 0}}class de extends q{constructor(e,t,s,n,r){super(e,t,"triangle",n,r),C(this,"vertices"),C(this,"normals"),C(this,"uvs"),this.vertices=s}createGeometry(){const e=new W,t=new Float32Array(9);for(let s=0;s<3;s++){const n=this.vertices[s];t[s*3]=n.x,t[s*3+1]=n.y,t[s*3+2]=n.z}if(e.setAttribute("position",new N(t,3)),this.normals){const s=new Float32Array(9);for(let n=0;n<3;n++){const r=this.normals[n];s[n*3]=r.x,s[n*3+1]=r.y,s[n*3+2]=r.z}e.setAttribute("normal",new N(s,3))}else{const s=ze(t);e.setAttribute("normal",new N(s,3))}if(this.uvs){const s=new Float32Array(6);for(let n=0;n<3;n++){const r=this.uvs[n];s[n*2]=r.x,s[n*2+1]=r.y}e.setAttribute("uv",new N(s,2))}return e}clone(){return new de(M.generateId(),this.name+" (Copy)",[this.vertices[0].clone(),this.vertices[1].clone(),this.vertices[2].clone()],{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class he extends q{constructor(e,t,s,n,r){super(e,t,"quad",n,r),C(this,"vertices"),C(this,"normals"),C(this,"uvs"),this.vertices=s}createGeometry(){const e=new W,t=[0,1,2,2,3,0],s=new Float32Array(12);for(let r=0;r<4;r++){const o=this.vertices[r];s[r*3]=o.x,s[r*3+1]=o.y,s[r*3+2]=o.z}const n=new Float32Array(18);for(let r=0;r<6;r++){const o=t[r];n[r*3]=s[o*3],n[r*3+1]=s[o*3+1],n[r*3+2]=s[o*3+2]}if(e.setAttribute("position",new N(n,3)),this.normals){const r=new Float32Array(18);for(let o=0;o<6;o++){const i=t[o],c=this.normals[i];r[o*3]=c.x,r[o*3+1]=c.y,r[o*3+2]=c.z}e.setAttribute("normal",new N(r,3))}else{const r=ze(n);e.setAttribute("normal",new N(r,3))}if(this.uvs){const r=new Float32Array(12);for(let o=0;o<6;o++){const i=t[o],c=this.uvs[i];r[o*2]=c.x,r[o*2+1]=c.y}e.setAttribute("uv",new N(r,2))}return e}clone(){return new he(M.generateId(),this.name+" (Copy)",[this.vertices[0].clone(),this.vertices[1].clone(),this.vertices[2].clone(),this.vertices[3].clone()],{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Ve extends q{constructor(e,t,s,n,r){super(e,t,"cube",n,r),C(this,"vertices"),this.vertices=s}createGeometry(){const e=new W,t=[[0,1,2],[2,3,0],[4,7,6],[6,5,4],[0,4,5],[5,1,0],[2,6,7],[7,3,2],[0,3,7],[7,4,0],[1,5,6],[6,2,1]],s=[];for(const o of t)for(const i of o){const c=this.vertices[i];s.push(c.x,c.y,c.z)}const n=new Float32Array(s);e.setAttribute("position",new N(n,3));const r=ze(n);return e.setAttribute("normal",new N(r,3)),e}clone(){return new Ve(M.generateId(),this.name+" (Copy)",this.vertices.map(e=>e.clone()),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class We extends q{constructor(e,t,s,n,r){super(e,t,"revolution",n,r),C(this,"profile"),C(this,"axis"),C(this,"startAngle"),C(this,"endAngle"),C(this,"segments"),C(this,"closed"),this.profile=s,this.axis=new g(0,0,1),this.startAngle=0,this.endAngle=Math.PI*2,this.segments=32,this.closed=!0}createGeometry(){if(this.profile.length<2)return console.warn("Revolution profile must have at least 2 points"),new W;const e=this.endAngle-this.startAngle,t=[],s=[];for(let r=0;r<=this.segments;r++){const o=this.startAngle+e*r/this.segments,i=Math.cos(o),c=Math.sin(o);for(const l of this.profile){const u=l.x*i-l.y*c,d=l.x*c+l.y*i,p=l.z;t.push(u,d,p)}}const n=this.profile.length;for(let r=0;r<this.segments;r++)for(let o=0;o<n-1;o++){const i=r*n+o,c=r*n+o+1,l=(r+1)*n+o+1,u=(r+1)*n+o;s.push([i,c,l]),s.push([l,u,i])}return ut(t,s)}clone(){const e=new We(M.generateId(),this.name+" (Copy)",this.profile.map(t=>t.clone()),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()});return e.axis=this.axis.clone(),e.startAngle=this.startAngle,e.endAngle=this.endAngle,e.segments=this.segments,e.closed=this.closed,e}}class pe extends q{constructor(e,t,s,n,r,o){super(e,t,"mesh",r,o),C(this,"vertices"),C(this,"faces"),C(this,"normals"),C(this,"uvs"),this.vertices=s,this.faces=n}createGeometry(){const e=[];for(const t of this.vertices)e.push(t.x,t.y,t.z);return ut(e,this.faces)}clone(){return new pe(M.generateId(),this.name+" (Copy)",this.vertices.map(e=>e.clone()),this.faces.map(e=>[...e]),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class k extends Se{constructor(e,t,s){super(e,t,s),C(this,"children"),this.children=[]}addChild(e){if(e.parentId=this.id,this.children.push(e),this._threeObject&&this._threeObject instanceof _){const t=e.render();this._threeObject.add(t)}}removeChild(e){const t=this.children.indexOf(e);if(t!==-1&&(this.children.splice(t,1),e.parentId=void 0,this._threeObject)){const s=e.render();s&&this._threeObject.remove(s)}}render(){if(!this._threeObject){this._threeObject=new _,this._threeObject.name=this.name,this._threeObject.userData.cifObject=this,this._threeObject.userData.cifId=this.id,this._threeObject.userData.cifType="group",this._threeObject.visible=this.visible,this.applyTransform(this._threeObject);for(const e of this.children){const t=e.render();this._threeObject.add(t)}}return this._threeObject}clone(){const e=new k(M.generateId(),this.name+" (Copy)",{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()});for(const t of this.children)e.addChild(t.clone());return e}dispose(){this.removeSelectionOutline();for(const e of this.children)e.dispose();this._threeObject=void 0}traverse(e){e(this);for(const t of this.children)t instanceof k?t.traverse(e):e(t)}findById(e){if(this.id===e)return this;for(const t of this.children){if(t.id===e)return t;if(t instanceof k){const s=t.findById(e);if(s)return s}}return null}}class ss{constructor(e){C(this,"metadata"),C(this,"root"),C(this,"materials"),C(this,"units"),C(this,"coordinateSystem"),C(this,"upAxis"),this.metadata={created:new Date,version:"2.0",...e},this.root=new k(M.generateId(),"Root"),this.materials=new Map,this.units="meters",this.coordinateSystem="right-handed",this.upAxis="z"}render(){return this.root.render()}findById(e){return this.root.findById(e)}addToRoot(e){this.root.addChild(e)}dispose(){this.root.dispose(),this.materials.clear()}}class M{static createDefaultTransform(){return{position:new g(0,0,0),rotation:new g(0,0,0),scale:new g(1,1,1)}}static createDefaultMaterial(e="default",t=13421772){return{name:e,color:new U(t),opacity:1,transparent:!1}}static generateId(){return"cif_"+Math.random().toString(36).substr(2,9)+"_"+Date.now().toString(36)}static createScene(e){return new ss(e)}static findObjectById(e,t){return e.findById(t)}static getAllOfType(e,t){const s=[];return e.traverse(n=>{n instanceof t&&s.push(n)}),s}static addToGroup(e,t){e.addChild(t)}static validateScene(e){const t=[];return e.root||t.push("Scene must have a root group"),e.materials.size===0&&console.warn("Scene has no materials defined"),e.root.traverse(s=>{s.id||t.push(`Object ${s.name||"unnamed"} has no ID`),s.name||t.push(`Object ${s.id} has no name`),s instanceof q&&(s.material||t.push(`Primitive ${s.name} has no material`))}),{valid:t.length===0,errors:t}}}var ns=Object.defineProperty,rs=(a,e,t)=>e in a?ns(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,et=(a,e,t)=>rs(a,typeof e!="symbol"?e+"":e,t);class oe{constructor(e){et(this,"scene"),et(this,"currentGroup"),this.scene=M.createScene(e),this.currentGroup=this.scene.root}setUnits(e){return this.scene.units=e,this}setCoordinateSystem(e){return this.scene.coordinateSystem=e,this}setUpAxis(e){return this.scene.upAxis=e,this}addMaterial(e,t){const s={...M.createDefaultMaterial(),...t};return this.scene.materials.set(e,s),this}getMaterial(e){return this.scene.materials.get(e)}beginGroup(e){const t=new k(M.generateId(),e,M.createDefaultTransform());return t.parentId=this.currentGroup.id,M.addToGroup(this.currentGroup,t),this.currentGroup=t,this}endGroup(){if(this.currentGroup.parentId){const e=M.findObjectById(this.scene.root,this.currentGroup.parentId);e&&"children"in e&&(this.currentGroup=e)}return this}setTransform(e){return Object.assign(this.currentGroup.transform,e),this}translate(e,t,s){return this.currentGroup.transform.position.set(e,t,s),this}rotate(e,t,s){return this.currentGroup.transform.rotation.set(e,t,s),this}scale(e,t,s){return this.currentGroup.transform.scale.set(e,t,s),this}addTriangle(e,t,s,n={}){[e,t,s].forEach((i,c)=>{if(!i||isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||!isFinite(i.x)||!isFinite(i.y)||!isFinite(i.z))throw new Error(`Invalid vertex at index ${c}: ${i?`(${i.x}, ${i.y}, ${i.z})`:"null/undefined"}`)});const r=this.resolveMaterial(n.materialId,n.material),o=new de(M.generateId(),n.name||"Triangle",[e.clone(),t.clone(),s.clone()],r,{...M.createDefaultTransform(),...n.transform});return o.surfaceType=n.surfaceType||"structure",o.parentId=this.currentGroup.id,n.normals&&(o.normals=[n.normals[0].clone(),n.normals[1].clone(),n.normals[2].clone()]),n.uvs&&(o.uvs=[...n.uvs]),M.addToGroup(this.currentGroup,o),this}addQuad(e,t,s,n,r={}){[e,t,s,n].forEach((c,l)=>{if(!c||isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||!isFinite(c.x)||!isFinite(c.y)||!isFinite(c.z))throw new Error(`Invalid vertex at index ${l}: ${c?`(${c.x}, ${c.y}, ${c.z})`:"null/undefined"}`)});const o=this.resolveMaterial(r.materialId,r.material),i=new he(M.generateId(),r.name||"Quad",[e.clone(),t.clone(),s.clone(),n.clone()],o,{...M.createDefaultTransform(),...r.transform});return i.surfaceType=r.surfaceType||"structure",i.parentId=this.currentGroup.id,r.normals&&(i.normals=[r.normals[0].clone(),r.normals[1].clone(),r.normals[2].clone(),r.normals[3].clone()]),r.uvs&&(i.uvs=[...r.uvs]),M.addToGroup(this.currentGroup,i),this}addCube(e,t={}){const s=this.resolveMaterial(t.materialId,t.material),n=new Ve(M.generateId(),t.name||"Cube",e.map(r=>r.clone()),s,{...M.createDefaultTransform(),...t.transform});return n.surfaceType=t.surfaceType||"structure",n.parentId=this.currentGroup.id,M.addToGroup(this.currentGroup,n),this}addRevolution(e,t={}){const s=this.resolveMaterial(t.materialId,t.material),n=new We(M.generateId(),t.name||"Revolution",e.map(r=>r.clone()),s,{...M.createDefaultTransform(),...t.transform});return n.surfaceType=t.surfaceType||"structure",n.axis=t.axis?.clone()||new g(0,0,1),n.startAngle=t.startAngle||0,n.endAngle=t.endAngle||Math.PI*2,n.segments=t.segments||32,n.closed=t.closed!==!1,n.parentId=this.currentGroup.id,M.addToGroup(this.currentGroup,n),this}addMesh(e,t,s={}){const n=e.filter((i,c)=>{const l=!i||isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||!isFinite(i.x)||!isFinite(i.y)||!isFinite(i.z);return l&&console.error(`Invalid vertex at index ${c}: ${i?`(${i.x}, ${i.y}, ${i.z})`:"null/undefined"}`),l});if(n.length>0&&n.length>0)throw new Error(`Found ${n.length} invalid vertices out of ${e.length}`);t.forEach((i,c)=>{i.forEach((l,u)=>{if(l<0||l>=e.length)throw new Error(`Invalid vertex index ${l} at position ${u} in face ${c}. Valid range is 0-${e.length-1}`)})});const r=this.resolveMaterial(s.materialId,s.material),o=new pe(M.generateId(),s.name||"Mesh",e.map(i=>i.clone()),t.map(i=>[...i]),r,{...M.createDefaultTransform(),...s.transform});return o.surfaceType=s.surfaceType||"structure",o.parentId=this.currentGroup.id,s.normals&&(o.normals=s.normals.map(i=>i.clone())),s.uvs&&(o.uvs=[...s.uvs]),M.addToGroup(this.currentGroup,o),this}addRectangle(e,t,s={}){const n=s.center||new g(0,0,0),r=e/2,o=t/2;return this.addQuad(new g(n.x-r,n.y-o,n.z),new g(n.x+r,n.y-o,n.z),new g(n.x+r,n.y+o,n.z),new g(n.x-r,n.y+o,n.z),{name:s.name||"Rectangle",materialId:s.materialId,material:s.material,transform:s.transform,surfaceType:s.surfaceType})}addCircle(e,t=32,s={}){const n=[new g(e,0,0),new g(0,0,0)];return this.addRevolution(n,{name:s.name||"Circle",materialId:s.materialId,material:s.material,transform:s.transform,segments:t,axis:new g(0,0,1),surfaceType:s.surfaceType})}addArc(e,t,s,n,r={}){const o=[new g(t,0,0),new g(e,0,0)];return this.addRevolution(o,{name:r.name||"Arc",materialId:r.materialId,material:r.material,transform:r.transform,startAngle:s,endAngle:n,segments:r.segments||32,closed:!1,axis:new g(0,0,1),surfaceType:r.surfaceType})}build(){this.currentGroup=this.scene.root;const e=M.validateScene(this.scene);return e.valid||console.warn("CIF Scene validation failed:",e.errors),this.scene}resolveMaterial(e,t){if(e&&this.scene.materials.has(e))return this.scene.materials.get(e);if(t){const n={...M.createDefaultMaterial(),...t},r=`material_${this.scene.materials.size}`;return this.scene.materials.set(r,n),n}const s="default";return this.scene.materials.has(s)||this.scene.materials.set(s,M.createDefaultMaterial()),this.scene.materials.get(s)}}var os=Object.defineProperty,is=(a,e,t)=>e in a?os(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,as=(a,e,t)=>is(a,e+"",t);const dt=class Ae{static getMaterialByCategory(e){return Ae.MATERIALS.find(s=>s.category===e)||null}static getRandomMaterial(){const e=Math.floor(Math.random()*Ae.MATERIALS.length);return Ae.MATERIALS[e]}static createVariationOfMaterial(e,t=.1){const s=e.color.clone();return s.r=Math.max(0,Math.min(1,s.r+(Math.random()-.5)*t)),s.g=Math.max(0,Math.min(1,s.g+(Math.random()-.5)*t)),s.b=Math.max(0,Math.min(1,s.b+(Math.random()-.5)*t)),{...e,name:`${e.name} (Variant)`,color:s}}static getGradientMaterials(e,t,s){const n=[];for(let r=0;r<s;r++){const o=r/(s-1),i=new U().lerpColors(e.color,t.color,o),c=e.opacity+(t.opacity-e.opacity)*o;n.push({name:`Gradient ${r+1}`,color:i,opacity:c,transparent:c<1,category:e.category})}return n}};as(dt,"MATERIALS",[{name:"Audience Seating",color:new U(14483456),opacity:1,transparent:!1,category:"audience"},{name:"Stage Platform",color:new U(17152),opacity:1,transparent:!1,category:"stage"},{name:"Structural Wall",color:new U(54016),opacity:1,transparent:!1,category:"structural"},{name:"imag Panel",color:new U(4251856),opacity:.4,transparent:!0,category:"structural"}]);let X=dt;function cs(a){const e=a.toLowerCase();return e.includes("audience")||e.includes("seating")||e.includes("seat")||e.includes("chair")?X.getMaterialByCategory("audience")||X.getRandomMaterial():e.includes("stage")&&(e.includes("platform")||e.includes("floor")||e.includes("deck"))||e.includes("platform")&&(e.includes("stage")||e.includes("performance"))||e.includes("performance area")?X.getMaterialByCategory("stage")||X.getRandomMaterial():(e.includes("wall")||e.includes("ceiling")||e.includes("floor")||e.includes("structure")||e.includes("beam")||e.includes("column"),X.getMaterialByCategory("structural")||X.getRandomMaterial())}var ls=Object.defineProperty,us=(a,e,t)=>e in a?ls(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,_e=(a,e,t)=>us(a,typeof e!="symbol"?e+"":e,t);class ds{constructor(e={}){_e(this,"options"),_e(this,"groupColors",new Map),_e(this,"usedColors",new Set),this.options={preserveOriginalColors:e.preserveOriginalColors??!0,enableGroupColoring:e.enableGroupColoring??!0,variationAmount:e.variationAmount||.05}}getMaterialForObject(e,t,s,n){if(this.options.preserveOriginalColors&&t!==void 0){const r=this.normalizeColor(t);if(!this.isDefaultColor(r))return this.createMaterialFromColor(r,e)}return this.options.enableGroupColoring&&s?this.getMaterialForGroup(s,e,n):this.getContextBasedMaterial(e,n)}getMaterialForGroup(e,t,s){if(!this.groupColors.has(e)){const o=this.getContextBasedMaterial(e,s);this.groupColors.set(e,{baseColor:o.color.clone(),materialDef:o,memberCount:0,lastVariation:0})}const n=this.groupColors.get(e);n.memberCount++;const r=this.createGroupMemberVariation(n.materialDef,n.memberCount,t);return{name:r.name,color:r.color.clone(),opacity:r.opacity,transparent:r.transparent}}createGroupMemberVariation(e,t,s){const n=X.createVariationOfMaterial(e,this.options.variationAmount*.5),r=t*.03%.1,o=this.rgbToHsv(n.color);return o.h=(o.h+r)%1,n.color=this.hsvToRgb(o),n.name=`${e.name} (${s})`,n}getContextBasedMaterial(e,t){let s=cs(e);return t&&(s=this.adjustMaterialForSurfaceType(s,t)),s}adjustMaterialForSurfaceType(e,t){const s={...e};switch(t){case"listen":s.color=this.adjustColorTemperature(e.color,.1);break;case"obstacle":s.color=this.adjustColorTemperature(e.color,-.1);break}return s}createMaterialFromColor(e,t){return{name:`${t} Material`,color:e.clone(),opacity:1,transparent:!1}}normalizeColor(e){return typeof e=="number"?new U(e):e.clone()}isDefaultColor(e){const t=[8947848,8421504,12632256,16777215,0],s=e.getHex();return t.includes(s)}adjustColorTemperature(e,t){const s=e.clone();return t>0?(s.r=Math.min(1,s.r+t),s.b=Math.max(0,s.b-t*.5)):(s.r=Math.max(0,s.r+t),s.b=Math.min(1,s.b-t*.5)),s}rgbToHsv(e){const t=e.r,s=e.g,n=e.b,r=Math.max(t,s,n),o=Math.min(t,s,n),i=r-o;let c=0;const l=r===0?0:i/r,u=r;return i!==0&&(r===t?c=(s-n)/i%6:r===s?c=(n-t)/i+2:c=(t-s)/i+4,c/=6,c<0&&(c+=1)),{h:c,s:l,v:u}}hsvToRgb({h:e,s:t,v:s}){const n=s*t,r=n*(1-Math.abs(e*6%2-1)),o=s-n;let i=0,c=0,l=0;return e>=0&&e<1/6?(i=n,c=r,l=0):e>=1/6&&e<2/6?(i=r,c=n,l=0):e>=2/6&&e<3/6?(i=0,c=n,l=r):e>=3/6&&e<4/6?(i=0,c=r,l=n):e>=4/6&&e<5/6?(i=r,c=0,l=n):(i=n,c=0,l=r),new U(i+o,c+o,l+o)}reset(){this.groupColors.clear(),this.usedColors.clear()}getColorStats(){const e=Array.from(this.groupColors.values()).reduce((t,s)=>t+s.memberCount,0);return{totalGroups:this.groupColors.size,totalObjects:e}}}function fe(a,e={}){const s={...{obj:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.2},dbacv:{preserveOriginalColors:!0,enableGroupColoring:!0,variationAmount:.1},fc3:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.15},cvf:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.15},general:{preserveOriginalColors:!0,enableGroupColoring:!0,variationAmount:.15}}[a],...e};return new ds(s)}class T{static parseFloat(e,t,s=0){const n=e.getAttribute(t);if(!n)return s;const r=parseFloat(n);return isNaN(r)?s:r}static parseInt(e,t,s=0){const n=e.getAttribute(t);if(!n)return s;const r=parseInt(n,10);return isNaN(r)?s:r}static parseString(e,t,s=""){return e.getAttribute(t)||s}static parseBoolean(e,t,s=!1){const n=e.getAttribute(t);return n?n.toLowerCase()==="true"||n==="1":s}static parseVector3(e,t,s,n,r=new g(0,0,0)){const o=T.parseFloat(e,t,r.x),i=T.parseFloat(e,s,r.y),c=T.parseFloat(e,n,r.z);return new g(o,i,c)}static parseVector3FromCSV(e,t,s=new g(0,0,0)){const n=e.getAttribute(t);if(!n)return s.clone();const r=n.split(",").map(o=>parseFloat(o.trim()));return r.length!==3||r.some(isNaN)?s.clone():new g(r[0],r[1],r[2])}static parseRotationDegToRad(e,t,s,n,r=new g(0,0,0)){const o=T.parseFloat(e,t,r.x*180/Math.PI)*Math.PI/180,i=T.parseFloat(e,s,r.y*180/Math.PI)*Math.PI/180,c=T.parseFloat(e,n,r.z*180/Math.PI)*Math.PI/180;return new g(o,i,c)}static getChildrenByTagName(e,t){return Array.from(e.getElementsByTagName(t))}static getFirstChildByTagName(e,t){const s=e.getElementsByTagName(t);return s.length>0?s[0]:null}static getChildTextContent(e,t,s=""){return T.getFirstChildByTagName(e,t)?.textContent||s}static hasAttribute(e,t){return e.hasAttribute(t)}static getAttributeCaseInsensitive(e,t,s=""){let n=e.getAttribute(t);return n!==null||(n=e.getAttribute(t.toLowerCase()),n!==null)||(n=e.getAttribute(t.toUpperCase()),n!==null)?n:s}static getElementsByTagNameCaseInsensitive(e,t){let s=Array.from(e.getElementsByTagName(t));return s.length>0||(s=Array.from(e.getElementsByTagName(t.toLowerCase()))),s}static getFirstChildByTagNameCaseInsensitive(e,t){const s=T.getElementsByTagNameCaseInsensitive(e,t);return s.length>0?s[0]:null}static parseHexColor(e,t,s=16777215){const n=e.getAttribute(t);if(!n)return s;const r=n.replace(/^(#|0x)/,""),o=parseInt(r,16);return isNaN(o)?s:o}}class hs{convert(e,t){const s=new oe({originalFormat:"dbacv",originalFileName:t,author:"D&B ArrayCalc",comments:"Converted from DBACV format"});s.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const n=fe("dbacv"),r=new DOMParser().parseFromString(e,"application/xml"),o=T.getElementsByTagNameCaseInsensitive(r,"RoomObject");for(let i=0;i<o.length;i++){const c=o[i];T.getAttributeCaseInsensitive(c,"Shape")!=="5"&&this.processRoomObject(c,s,n)}return s.build()}processRoomObject(e,t,s){const n=T.getAttributeCaseInsensitive(e,"Shape"),r=T.getAttributeCaseInsensitive(e,"Name","Unnamed"),o=this.parseColor(T.getAttributeCaseInsensitive(e,"Color")),i=o!==8947848?new U(o):void 0,c=s.getMaterialForObject(r,i,"dbacv_objects",this.extractSurfaceType(e));T.getAttributeCaseInsensitive(e,"Transparent")==="1"&&(c.opacity=.8,c.transparent=!0);const l=this.extractSurfaceType(e),u=this.extractOriginFromObjectAndGroup(e),d=this.extractZRotation(e);switch(n){case"1":this.createQuadPrimitive(e,t,r,c,u,d,l);break;case"2":this.createArcSegment(e,t,r,c,u,d,!1,l);break;case"3":this.createArcSegment(e,t,r,c,u,d,!0,l);break;case"4":this.createCube(e,t,r,c,u,d,l);break;case"6":this.createTrianglePrimitive(e,t,r,c,u,d,l);break}}createTrianglePrimitive(e,t,s,n,r,o,i){const c=this.extractVertices(e,3);c.length===3&&this.isValidGeometry(c)&&t.addTriangle(c[0],c[1],c[2],{name:s,material:n,surfaceType:i,transform:{position:r,rotation:new g(0,0,o)}})}createQuadPrimitive(e,t,s,n,r,o,i){const c=this.extractVertices(e,4);c.length===4&&this.isValidGeometry(c)&&t.addQuad(c[0],c[1],c[2],c[3],{name:s,material:n,surfaceType:i,transform:{position:r,rotation:new g(0,0,o)}})}createCube(e,t,s,n,r,o,i){const c=this.extractVertices(e,8);c.length===8&&this.isValidGeometry(c)&&t.addCube(c,{name:s,material:n,surfaceType:i,transform:{position:r,rotation:new g(0,0,o)}})}createArcSegment(e,t,s,n,r,o,i,c){let l,u,d,p;if(i){l=T.parseFloat(e,"InnerA"),u=T.parseFloat(e,"OuterA");const E=T.parseFloat(e,"InnerB"),z=T.parseFloat(e,"OuterB");d=isNaN(E)?l:E,p=isNaN(z)?u:z}else l=T.parseFloat(e,"InnerRadiusA"),u=T.parseFloat(e,"OuterRadiusA"),d=l,p=u;const f=V(T.parseFloat(e,"StartAngle")),h=V(T.parseFloat(e,"SpanAngle")),m=parseFloat(T.getAttributeCaseInsensitive(e,"InnerZ","0")),y=parseFloat(T.getAttributeCaseInsensitive(e,"OuterZ","0")),b=i?d:l,A=i?p:u,x=[new g(A,0,y),new g(b,0,m)],w=Math.max(8,Math.ceil(Math.abs(te(h))/10)),v={name:s,material:n,surfaceType:c,startAngle:f,endAngle:f+h,segments:w};i&&(d!==l||p!==u)&&(v.ellipticalScaling={innerRadii:{major:l,minor:d},outerRadii:{major:u,minor:p}}),v.closed=Math.abs(h)>=2*Math.PI-.01,v.axis=new g(0,0,1),v.transform={position:r,rotation:new g(0,0,o)},t.addRevolution(x,v)}extractVertices(e,t){const s=[];for(let n=1;n<=t;n++){const r=T.getFirstChildByTagNameCaseInsensitive(e,`P${n}`);if(r){const o=parseFloat(T.getAttributeCaseInsensitive(r,"x","0")),i=parseFloat(T.getAttributeCaseInsensitive(r,"y","0")),c=parseFloat(T.getAttributeCaseInsensitive(r,"z","0"));s.push(new g(o,i,c))}}return s}parseColor(e){if(!e)return 8947848;const t=parseInt(e);return isNaN(t)?8947848:t&16777215}extractZRotation(e){const t=T.getFirstChildByTagNameCaseInsensitive(e,"Rotation");if(t){const s=parseFloat(T.getAttributeCaseInsensitive(t,"z","0"));return V(s)}return 0}extractOriginFromObjectAndGroup(e){const t=T.getFirstChildByTagNameCaseInsensitive(e,"Origin"),s=new g(parseFloat(T.getAttributeCaseInsensitive(t||e,"x","0")),parseFloat(T.getAttributeCaseInsensitive(t||e,"y","0")),parseFloat(T.getAttributeCaseInsensitive(t||e,"z","0"))),n=new g(0,0,0),r=e.parentNode,o=r?T.getElementsByTagNameCaseInsensitive(r,"Origin"):[];for(let i=0;i<o.length;i++){const c=o[i].parentNode;c&&T.getAttributeCaseInsensitive(c,"ObjectGroup")==="true"&&(n.x=parseFloat(T.getAttributeCaseInsensitive(o[i],"x","0")),n.y=parseFloat(T.getAttributeCaseInsensitive(o[i],"y","0")),n.z=parseFloat(T.getAttributeCaseInsensitive(o[i],"z","0")))}return r&&T.getAttributeCaseInsensitive(r,"ObjectGroup")==="true"&&(s.x+=n.x,s.y+=n.y,s.z+=n.z),s}isValidGeometry(e){if(e.length<2)return!1;const t=e[0],s=1e-6;for(let n=1;n<e.length;n++)if(t.distanceTo(e[n])>s)return!0;return!1}extractSurfaceType(e){const t=T.getAttributeCaseInsensitive(e,"PlaneType"),s=parseFloat(T.getAttributeCaseInsensitive(e,"ListenerHeight","0"));if(t==="1"&&s>1)return"listen";if(t==="4"||s<.1)return"structure";const n=T.getAttributeCaseInsensitive(e,"Type");if(n){const o=n.toLowerCase();if(o==="listen")return"listen";if(o==="obstacle")return"obstacle";if(o==="structure")return"structure"}const r=T.getAttributeCaseInsensitive(e,"SurfaceType");if(r){const o=r.toLowerCase();if(o==="listen")return"listen";if(o==="obstacle")return"obstacle";if(o==="structure")return"structure"}return"structure"}}var ps=Jt();class fs{convert(e,t){const s=new oe({originalFormat:"fc3",originalFileName:t,author:"AFMG EASE",comments:"Converted from EASE Focus format"});s.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const n=fe("fc3"),r=this.extractEaseData(e);if(!r)throw new Error("Failed to extract EASE data from FC3 file");const o={x:parseFloat(r.Project?.Origin?.X||"0"),y:parseFloat(r.Project?.Origin?.Y||"0")},i=r.Project?.AudienceZoneManager;if(!i)throw new Error("No audience zone manager found in FC3 file");s.beginGroup("FC3_Import"),s.rotate(0,0,V(90));for(const[c,l]of Object.entries(i))if(c.slice(0,5)==="Zone["){const u=l,d=u.Label||c;s.beginGroup(d);const p=new g(parseFloat(u.X)-o.x,parseFloat(u.Y)-o.y,0);s.translate(p.x,p.y,p.z),u.Orientation&&s.rotate(0,0,V(parseFloat(u.Orientation)));for(const[f,h]of Object.entries(u))if(f.slice(0,5)==="Area["){const m=h;this.processZoneArea(u,m,s,n,d)}s.endGroup()}return s.endGroup(),s.build()}extractEaseData(e){try{const t=new Uint8Array(e),s=[31,139],n=this.findOffset(t,s);if(n===-1)throw new Error("GZIP signature not found in FC3 file");const r=ps.ungzip(t.slice(n),{to:"string"}),o=new DOMParser().parseFromString(r,"application/xml"),i=o.getElementsByTagName("Keys")[0],c=o.getElementsByTagName("Values")[0];if(!i||!c)throw new Error("Invalid FC3 file structure");const l=i.getAttribute("href")?.slice(1),u=c.getAttribute("href")?.slice(1);if(!l||!u)throw new Error("Missing keys or values reference in FC3 file");const d=[],p=o.getElementById(l);if(p)for(const y of p.children)d.push(y.innerHTML);const f=[],h=o.getElementById(u);if(h)for(const y of h.children)f.push(y.innerHTML);const m={};for(let y=0;y<d.length;y++)this.createObjects(m,d[y].split("."),f[y]);return m}catch(t){return console.error("Error extracting EASE data:",t),null}}createObjects(e,t,s){return t.length===1?(e[t[0]]=s,e):(e[t[0]]=e[t[0]]||{},this.createObjects(e[t[0]],t.slice(1),s))}processZoneArea(e,t,s,n,r){(!e.Type||e.Type==="")&&(e.Width!==void 0&&(e.Type="Rectangle"),e.Radius!==void 0&&(e.Type="Arc"),e.FrontEdge!==void 0&&(e.Type="Trapezoid"),e.RightAngleLeft!==void 0&&(e.Type="Right Trapezoid"));const o=t.Label||"Area",i=n.getMaterialForObject(`${e.Type} ${o}`,void 0,r,"listen");switch(e.Type){case"Annulus":case"Arc":this.createArcGeometry(e,t,s,o,i);break;case"Right Trapezoid":this.createRightTrapezoid(e,t,s,o,i);break;case"Trapezoid":this.createTrapezoid(e,t,s,o,i);break;case"Rectangle":this.createRectangle(e,t,s,o,i);break;default:console.warn(`Unknown EASE zone type: ${e.Type}`)}}createArcGeometry(e,t,s,n,r){const o=(parseFloat(e.InnerRadius||"0")||0)+parseFloat(t.D1),i=(parseFloat(e.InnerRadius||"0")||0)+parseFloat(t.D2),c=parseFloat(e.SweepAngle||"360"),l=360-c/2,u=l+c,d=[new g(i,0,parseFloat(t.Z2)),new g(o,0,parseFloat(t.Z1))];s.addRevolution(d,{name:n,material:r,startAngle:V(l),endAngle:V(u),segments:Math.max(8,Math.ceil(c/10)),closed:c>=360,axis:new g(0,0,1),surfaceType:"listen"})}createRightTrapezoid(e,t,s,n,r){const o=e.RightAngleLeft||0,i=parseFloat(t.D1),c=parseFloat(t.D2),l=parseFloat(e.FrontEdge?.toString()||"0"),u=parseFloat(e.BackEdge?.toString()||"0"),d=e.Depth||0,p=(u-l)/d,f=new g(-d/2+i,l+i*p,parseFloat(t.Z1)),h=new g(-d/2+c,l+c*p,parseFloat(t.Z2)),m=new g(-d/2+c,0,parseFloat(t.Z2)),y=new g(-d/2+i,0,parseFloat(t.Z1));o==0?(f.y=-f.y,h.y=-h.y,s.addQuad(y,m,h,f,{name:n,material:r,surfaceType:"listen"})):s.addQuad(f,h,m,y,{name:n,material:r,surfaceType:"listen"})}createTrapezoid(e,t,s,n,r){const o=e.Depth||0,i=parseFloat(e.FrontEdge?.toString()||"0"),l=(parseFloat(e.BackEdge?.toString()||"0")-i)/o,u=parseFloat(t.D1),d=parseFloat(t.D2),p=new g(-(o/2)+u,-u*l/2-i/2,parseFloat(t.Z1)),f=new g(-(o/2)+d,-d*l/2-i/2,parseFloat(t.Z2)),h=new g(-(o/2)+d,d*l/2+i/2,parseFloat(t.Z2)),m=new g(-(o/2)+u,u*l/2+i/2,parseFloat(t.Z1));s.addQuad(m,p,f,h,{name:n,material:r,surfaceType:"listen"})}createRectangle(e,t,s,n,r){const o=e.Depth||0,i=e.Width||0,c=parseFloat(t.D1),l=parseFloat(t.D2),u=new g(-(o/2)+c,-i/2,parseFloat(t.Z1)),d=new g(-(o/2)+l,-i/2,parseFloat(t.Z2)),p=new g(-(o/2)+l,i/2,parseFloat(t.Z2)),f=new g(-(o/2)+c,i/2,parseFloat(t.Z1));s.addQuad(u,d,p,f,{name:n,material:r,surfaceType:"listen"})}findOffset(e,t){return e.findIndex((s,n,r)=>{if(n+t.length>r.length)return!1;const o=r.slice(n,n+t.length);return t.every((i,c)=>o[c]===i)})}}class ms{convert(e,t){const s=new oe({originalFormat:"obj",originalFileName:t,author:"Wavefront OBJ",comments:"Converted from OBJ format"});s.setCoordinateSystem("right-handed").setUpAxis("y").setUnits("meters");const n=fe("obj"),r=this.parseObjData(e);for(const o of r.objects)if(o.faces.length>0){const i=n.getMaterialForObject(o.name||"OBJ Mesh",void 0,"obj_objects","structure");s.addMesh(r.vertices,o.faces,{name:o.name||"OBJ Mesh",material:i,normals:r.normals.length>0?r.normals:void 0,uvs:r.uvs.length>0?r.uvs:void 0})}return s.build()}parseObjData(e){const t=[],s=[],n=[],r=[];let o={name:"default",faces:[]};r.push(o);const i=e.split(`
`);for(const l of i){const u=l.trim();if(!u||u.startsWith("#"))continue;const d=u.split(/\s+/);switch(d[0]){case"v":if(d.length>=4){const f=parseFloat(d[1]),h=parseFloat(d[2]),m=parseFloat(d[3]);t.push(new g(f,h,m))}break;case"vn":if(d.length>=4){const f=parseFloat(d[1]),h=parseFloat(d[2]),m=parseFloat(d[3]);s.push(new g(f,h,m))}break;case"vt":if(d.length>=3){const f=parseFloat(d[1]),h=parseFloat(d[2]);n.push(new Ie(f,h))}break;case"f":if(d.length>=4){const f=this.parseFace(d.slice(1));f.length>=3&&o.faces.push(f)}break;case"o":case"g":d.length>=2&&(o={name:d.slice(1).join(" "),faces:[]},r.push(o));break}}const c=r.filter(l=>l.faces.length>0);return{vertices:t,normals:s,uvs:n,objects:c.length>0?c:[o]}}parseFace(e){const t=[];for(const s of e){const n=s.split("/"),r=parseInt(n[0]);isNaN(r)||t.push(r-1)}if(t.length>4){const s=[];for(let n=1;n<t.length-1;n++)s.push(t[0],t[n],t[n+1]);return s}return t}static fromThreeObject(e,t){const s=new oe({originalFormat:"threejs",originalFileName:t,author:"Three.js Object",comments:"Converted from Three.js Object3D"});s.setCoordinateSystem("right-handed").setUpAxis("y").setUnits("meters");const n=fe("general");function r(o,i,c=0){if(o.isMesh&&o.geometry){const l=o.geometry,u=l.getAttribute("position");if(u){const d=[],p=[];for(let y=0;y<u.count;y++){const b=u.getX(y),A=u.getY(y),x=u.getZ(y);d.push(new g(b,A,x))}const f=l.index;if(f)for(let y=0;y<f.count;y+=3){const b=f.getX(y),A=f.getX(y+1),x=f.getX(y+2);p.push([b,A,x])}else for(let y=0;y<u.count;y+=3)p.push([y,y+1,y+2]);const h=o.matrixWorld;d.forEach(y=>{y.applyMatrix4(h)});const m=n.getMaterialForObject(o.name||"Three.js Mesh",void 0,"threejs_objects","structure");i.addMesh(d,p,{name:o.name||"Three.js Mesh",material:m})}}if(o.children)for(const l of o.children)l.children&&l.children.length>0?(i.beginGroup(l.name||"Group"),r(l,i,c+1),i.endGroup()):r(l,i,c+1)}return r(e,s),s.build()}}let gs=class{convert(e,t){const s=JSON.parse(e),n=new oe({originalFormat:s.metadata.originalFormat||"cif",originalFileName:t||s.metadata.originalFileName,author:s.metadata.author,comments:s.metadata.comments,version:s.metadata.version,created:s.metadata.created?new Date(s.metadata.created):new Date,formatSpecific:s.metadata.formatSpecific});if(n.setUnits(s.units||"meters").setCoordinateSystem(s.coordinateSystem||"right-handed").setUpAxis(s.upAxis||"z"),s.materials)for(const[r,o]of Object.entries(s.materials)){const i=o;n.addMaterial(r,{name:i.name,color:new U(i.color.r,i.color.g,i.color.b),opacity:i.opacity,transparent:i.transparent,properties:i.properties})}if(s.root&&s.root.children)for(const r of s.root.children)this.processObject(r,n);return n.build()}processObject(e,t){if(e.type==="group"){if(t.beginGroup(e.name),this.setObjectProperties(e,t),e.children)for(const s of e.children)this.processObject(s,t);t.endGroup()}else{const s=this.parseTransform(e.transform),n=this.parseMaterial(e.material);switch(e.type){case"triangle":const r=this.parseVertices(e.vertices,3);t.addTriangle(r[0],r[1],r[2],{name:e.name,material:n,transform:s});break;case"quad":const o=this.parseVertices(e.vertices,4);t.addQuad(o[0],o[1],o[2],o[3],{name:e.name,material:n,transform:s});break;case"cube":t.addCube(this.parseVertices(e.vertices,8),{name:e.name,material:n,transform:s});break;case"revolution":t.addRevolution(this.parseVertices(e.profile),{name:e.name,material:n,transform:s,axis:this.parseVector3(e.axis),startAngle:e.startAngle,endAngle:e.endAngle,segments:e.segments});break;case"mesh":t.addMesh(this.parseVertices(e.vertices),e.faces,{name:e.name,material:n,transform:s});break}}}setObjectProperties(e,t){if(e.transform){const s=this.parseTransform(e.transform);t.setTransform(s)}}parseTransform(e){return{position:this.parseVector3(e.position),rotation:this.parseVector3(e.rotation),scale:this.parseVector3(e.scale)}}parseVector3(e){return new g(e.x,e.y,e.z)}parseVertices(e,t){const s=e.map(n=>this.parseVector3(n));if(t&&s.length!==t)throw new Error(`Expected ${t} vertices, got ${s.length}`);return s}parseMaterial(e){return{name:e.name,color:new U(e.color.r,e.color.g,e.color.b),opacity:e.opacity,transparent:e.transparent,properties:e.properties}}};class ys{convert(e,t){const s=JSON.parse(e),n=new oe({originalFormat:"cvf",originalFileName:t,author:s.title||"Clair Venue Exchange",comments:s.notes||"Converted from CVF format"});n.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const r=fe("cvf");n.beginGroup("CVF_Import"),n.rotate(0,0,V(90));for(const o of s.zones)this.processZone(o,s.projectOrigin,n,r);return n.endGroup(),n.build()}processZone(e,t,s,n){s.beginGroup(e.name);const r=new g(e.position.x-t.x,e.position.y-t.y,0);s.translate(r.x,r.y,r.z),s.rotate(0,0,V(e.rotation));for(const o of e.sections)this.processSection(e,o,s,n);s.endGroup()}processSection(e,t,s,n){if(t.points.length<3){console.warn(`Section ${t.name} has fewer than 3 points, skipping`);return}const o=n.getMaterialForObject(`${e.params.type} ${t.name}`,void 0,e.name,"listen");switch(e.params.type){case"SymmetricPolygon":this.createSymmetricPolygonSection(e,t,s,o);break;case"AsymmetricPolygon":this.createAsymmetricPolygonSection(e,t,s,o);break;case"Circular":this.createCircularSection(e,t,s,o);break;default:console.warn(`Unknown CVF zone type: ${e.params.type}`)}}createSymmetricPolygonSection(e,t,s,n){const r=e.params,o=r.frontWidth||0,i=r.rearWidth||0,c=e.depth;for(let l=0;l<t.points.length-1;l++){const u=t.points[l],d=t.points[l+1],p=this.interpolateWidth(u.x,c,o,i),f=this.interpolateWidth(d.x,c,o,i),h=new g(u.x-c/2,-p/2,u.z),m=new g(d.x-c/2,-f/2,d.z),y=new g(u.x-c/2,p/2,u.z),b=new g(d.x-c/2,f/2,d.z);s.addQuad(h,m,b,y,{name:`${t.name}_segment_${l}`,material:n,surfaceType:"listen"})}}createAsymmetricPolygonSection(e,t,s,n){const r=e.params,o=r.frontRightWidth||0,i=r.frontLeftWidth||0,c=r.rearRightWidth||0,l=r.rearLeftWidth||0,u=e.depth;for(let d=0;d<t.points.length-1;d++){const p=t.points[d],f=t.points[d+1],h=this.interpolateWidth(p.x,u,o,c),m=this.interpolateWidth(p.x,u,i,l),y=this.interpolateWidth(f.x,u,o,c),b=this.interpolateWidth(f.x,u,i,l),A=new g(p.x-u/2,h,p.z),x=new g(f.x-u/2,y,f.z),w=new g(p.x-u/2,-m,p.z),v=new g(f.x-u/2,-b,f.z);s.addQuad(w,v,x,A,{name:`${t.name}_segment_${d}`,material:n,surfaceType:"listen"})}}createCircularSection(e,t,s,n){const r=e.params,o=r.frontRadius||0,i=r.angle||360,c=[];for(const d of t.points){const p=o+d.x;c.push(new g(p,0,d.z))}const l=360-i/2,u=l+i;s.addRevolution(c,{name:t.name,material:n,startAngle:V(l),endAngle:V(u),segments:Math.max(8,Math.ceil(i/10)),closed:i>=360,axis:new g(0,0,1),surfaceType:"listen"})}interpolateWidth(e,t,s,n){const r=(e+t/2)/t;return s+(n-s)*r}}var xs=Object.defineProperty,bs=(a,e,t)=>e in a?xs(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,ws=(a,e,t)=>bs(a,e+"",t);const ht=class pt{static getSupportedExtensions(){return this.SUPPORTED_EXTENSIONS}static isSupported(e){return this.SUPPORTED_EXTENSIONS.includes(e.toLowerCase())}async processFile(e,t){const s=performance.now(),n=this.getFileExtension(t);if(!pt.isSupported(n))throw new Error(`Unsupported file format: ${n}`);try{let r,o;switch(n){case"dbacv":r=await this.processDbacv(e,t);break;case"fc3":case"fc2":r=await this.processFc3(e,t);break;case"obj":r=await this.processObj(e,t);break;case"cvf":r=await this.processCvf(e,t);break;case"cif":case"json":r=await this.processCIF(e,t);break;default:throw new Error(`Unsupported format: ${n}`)}const i=performance.now()-s;return{cifScene:r,threeObject:o,metadata:{format:n.toUpperCase(),fileName:t,processingTime:i,objectCount:r?.root?.children?.length||0}}}catch(r){throw console.error(`Error processing ${n} file:`,r),new Error(`Failed to process ${n} file: ${r instanceof Error?r.message:"Unknown error"}`)}}async processDbacv(e,t){try{let s;if(e.startsWith("data:")){const r=e.split(",")[1];s=atob(r)}else s=e;return new hs().convert(s,t)}catch(s){throw new Error(`DBACV processing failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async processFc3(e,t){try{return new fs().convert(e,t)}catch(s){throw new Error(`FC3 processing failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async processObj(e,t){try{let s;if(e.startsWith("data:")){const r=e.split(",")[1];s=atob(r)}else s=e;return new ms().convert(s,t)}catch(s){throw new Error(`OBJ processing failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async processCvf(e,t){try{let s;if(e.startsWith("data:")){const r=e.split(",")[1];s=atob(r)}else s=e;return new ys().convert(s,t)}catch(s){throw new Error(`CVF processing failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async processCIF(e,t){try{let s;if(e.startsWith("data:")){const r=e.split(",")[1];s=atob(r)}else s=e;return new gs().convert(s,t)}catch(s){throw new Error(`CIF processing failed: ${s instanceof Error?s.message:"Unknown error"}`)}}getFileExtension(e){return e.split(".").pop()?.toLowerCase()||""}static validateFile(e){if(e.size>52428800)return{valid:!1,error:"File too large. Maximum size is 50MB."};const s=e.name.split(".").pop()?.toLowerCase()||"";return this.isSupported(s)?{valid:!0}:{valid:!1,error:`Unsupported file type: ${s}. Supported types: ${this.SUPPORTED_EXTENSIONS.join(", ")}`}}static async readFile(e){return new Promise((t,s)=>{const n=new FileReader,r=e.name.split(".").pop()?.toLowerCase()||"";n.onload=o=>{o.target?.result?t(o.target.result):s(new Error("Failed to read file"))},n.onerror=()=>s(new Error("Error reading file")),r==="fc3"||r==="fc2"?n.readAsArrayBuffer(e):n.readAsDataURL(e)})}};ws(ht,"SUPPORTED_EXTENSIONS",["dbacv","fc3","fc2","obj","cif","json","cvf"]);let Ge=ht;class Ue{static applyTransform(e,t){return e.map(s=>{const n=s.clone();n.multiply(t.scale);const r=new re(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return n.applyEuler(r),n.add(t.position),n})}static applyTransformToVertex(e,t){const s=e.clone();s.multiply(t.scale);const n=new re(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return s.applyEuler(n),s.add(t.position),s}static applyTransformToNormals(e,t){return e.map(s=>{const n=s.clone();n.divide(t.scale);const r=new re(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return n.applyEuler(r),n.normalize(),n})}static combineTransforms(e,t){const s=t.position.clone();s.multiply(e.scale);const n=new re(e.rotation.x,e.rotation.y,e.rotation.z,"XYZ");s.applyEuler(n),s.add(e.position);const r=new g(e.rotation.x+t.rotation.x,e.rotation.y+t.rotation.y,e.rotation.z+t.rotation.z),o=new g().copy(e.scale).multiply(t.scale);return{position:s,rotation:r,scale:o}}static createIdentityTransform(){return{position:new g(0,0,0),rotation:new g(0,0,0),scale:new g(1,1,1)}}}class vs{export(e){let t=this.generateHeader();return e.root.traverse(s=>{if(s instanceof q){const n=this.primitiveToTriangles(s);for(const r of n)t+=this.writeTriangle(r,s.name)}}),t}generateHeader(){return`"; Exported by CIF to SoundVision Exporter"
"; "
";   using Outside is front (white)"
";   using Name By Layer"
";   using Visible Entities"
";"
";"
";"
"; LengthUnit", "m"
";"
`}primitiveToTriangles(e){const t=[];switch(e.type){case"triangle":t.push(...this.triangleToTriangles(e));break;case"quad":t.push(...this.quadToTriangles(e));break;case"revolution":t.push(...this.revolutionToTriangles(e));break;case"mesh":t.push(...this.meshToTriangles(e));break}return t.map(s=>Ue.applyTransform(s,e.transform))}triangleToTriangles(e){return[e.vertices.map(t=>t.clone())]}quadToTriangles(e){const[t,s,n,r]=e.vertices;return[[t.clone(),s.clone(),n.clone()],[n.clone(),r.clone(),t.clone()]]}revolutionToTriangles(e){const t=[],{profile:s,segments:n,startAngle:r,endAngle:o}=e;if(s.length<2)return t;const i=o-r,c=[];for(let u=0;u<=n;u++){const d=r+i*u/n,p=Math.cos(d),f=Math.sin(d);for(const h of s){const m=h.x*p-h.y*f,y=h.x*f+h.y*p,b=h.z;c.push(new g(m,y,b))}}const l=s.length;for(let u=0;u<n;u++)for(let d=0;d<l-1;d++){const p=u*l+d,f=u*l+d+1,h=(u+1)*l+d+1,m=(u+1)*l+d;t.push([c[p].clone(),c[f].clone(),c[h].clone()]),t.push([c[h].clone(),c[m].clone(),c[p].clone()])}return t}meshToTriangles(e){const t=[];for(const s of e.faces)if(s.length===3)t.push([e.vertices[s[0]].clone(),e.vertices[s[1]].clone(),e.vertices[s[2]].clone()]);else if(s.length===4){const[n,r,o,i]=s;t.push([e.vertices[n].clone(),e.vertices[r].clone(),e.vertices[o].clone()]),t.push([e.vertices[o].clone(),e.vertices[i].clone(),e.vertices[n].clone()])}else for(let n=1;n<s.length-1;n++)t.push([e.vertices[s[0]].clone(),e.vertices[s[n]].clone(),e.vertices[s[n+1]].clone()]);return t}writeTriangle(e,t){let s=`"Label","${t}"
`;for(const n of e)s+=`${n.x},${n.y},${n.z}
`;return s+=`";"
`,s}}class Ts{export(e){const t=this.extractVertexData(e);return this.generateOBJ(t,e)}extractVertexData(e){const t=[],s=[],n=[],r=[],o=new Map,i=new Map,c=new Map;let l=0,u=0,d=0;const p=m=>{const y=`${m.x.toFixed(6)},${m.y.toFixed(6)},${m.z.toFixed(6)}`;return o.has(y)?o.get(y):(t.push(m.clone()),o.set(y,l),l++)},f=m=>{const y=`${m.x.toFixed(6)},${m.y.toFixed(6)},${m.z.toFixed(6)}`;return i.has(y)?i.get(y):(s.push(m.clone().normalize()),i.set(y,u),u++)},h=m=>{const y=`${m.x.toFixed(6)},${m.y.toFixed(6)}`;return c.has(y)?c.get(y):(n.push({x:m.x,y:m.y}),c.set(y,d),d++)};return e.root.traverse(m=>{if(m instanceof q){const y=this.primitiveToVertexData(m);for(const b of y.faces){const A=[],x=[],w=[];for(let v=0;v<b.vertices.length;v++)A.push(p(b.vertices[v])),b.normals&&b.normals[v]&&x.push(f(b.normals[v])),b.uvs&&b.uvs[v]&&w.push(h(b.uvs[v]));r.push({vertices:A,normals:x.length>0?x:void 0,uvs:w.length>0?w:void 0,objectName:m.name})}}}),{vertices:t,normals:s,uvs:n,faces:r}}primitiveToVertexData(e){const t=[];switch(e.type){case"triangle":t.push(...this.triangleToFaces(e));break;case"quad":t.push(...this.quadToFaces(e));break;case"revolution":t.push(...this.revolutionToFaces(e));break;case"mesh":t.push(...this.meshToFaces(e));break}return{faces:t.map(s=>({vertices:Ue.applyTransform(s.vertices,e.transform),normals:s.normals?Ue.applyTransformToNormals(s.normals,e.transform):void 0,uvs:s.uvs}))}}triangleToFaces(e){return[{vertices:e.vertices.map(t=>t.clone()),normals:e.normals?.map(t=>t.clone()),uvs:e.uvs}]}quadToFaces(e){const[t,s,n,r]=e.vertices,o=e.normals,i=e.uvs;return[{vertices:[t.clone(),s.clone(),n.clone()],normals:o?[o[0].clone(),o[1].clone(),o[2].clone()]:void 0,uvs:i?[i[0],i[1],i[2]]:void 0},{vertices:[n.clone(),r.clone(),t.clone()],normals:o?[o[2].clone(),o[3].clone(),o[0].clone()]:void 0,uvs:i?[i[2],i[3],i[0]]:void 0}]}revolutionToFaces(e){const t=[],{profile:s,segments:n,startAngle:r,endAngle:o}=e;if(s.length<2)return t;const i=o-r,c=[];for(let u=0;u<=n;u++){const d=r+i*u/n,p=Math.cos(d),f=Math.sin(d);for(const h of s){const m=h.x*p-h.y*f,y=h.x*f+h.y*p,b=h.z;c.push(new g(m,y,b))}}const l=s.length;for(let u=0;u<n;u++)for(let d=0;d<l-1;d++){const p=u*l+d,f=u*l+d+1,h=(u+1)*l+d+1,m=(u+1)*l+d;t.push({vertices:[c[p].clone(),c[f].clone(),c[h].clone()]}),t.push({vertices:[c[h].clone(),c[m].clone(),c[p].clone()]})}return t}meshToFaces(e){const t=[];for(const s of e.faces)if(s.length===3)t.push({vertices:[e.vertices[s[0]].clone(),e.vertices[s[1]].clone(),e.vertices[s[2]].clone()],normals:e.normals?[e.normals[s[0]].clone(),e.normals[s[1]].clone(),e.normals[s[2]].clone()]:void 0,uvs:e.uvs?[e.uvs[s[0]],e.uvs[s[1]],e.uvs[s[2]]]:void 0});else if(s.length===4){const[n,r,o,i]=s;t.push({vertices:[e.vertices[n].clone(),e.vertices[r].clone(),e.vertices[o].clone()],normals:e.normals?[e.normals[n].clone(),e.normals[r].clone(),e.normals[o].clone()]:void 0,uvs:e.uvs?[e.uvs[n],e.uvs[r],e.uvs[o]]:void 0}),t.push({vertices:[e.vertices[o].clone(),e.vertices[i].clone(),e.vertices[n].clone()],normals:e.normals?[e.normals[o].clone(),e.normals[i].clone(),e.normals[n].clone()]:void 0,uvs:e.uvs?[e.uvs[o],e.uvs[i],e.uvs[n]]:void 0})}return t}generateOBJ(e,t){let s="";s+=`# Exported by CIF to OBJ Exporter
`,s+=`# Source: ${t.metadata.originalFileName||"Unknown"}
`,s+=`# Created: ${new Date().toISOString()}
`,s+=`# Vertices: ${e.vertices.length}
`,s+=`# Faces: ${e.faces.length}

`;for(const r of e.vertices)s+=`v ${r.x.toFixed(6)} ${r.y.toFixed(6)} ${r.z.toFixed(6)}
`;if(e.uvs.length>0){s+=`
`;for(const r of e.uvs)s+=`vt ${r.x.toFixed(6)} ${r.y.toFixed(6)}
`}if(e.normals.length>0){s+=`
`;for(const r of e.normals)s+=`vn ${r.x.toFixed(6)} ${r.y.toFixed(6)} ${r.z.toFixed(6)}
`}const n=new Map;for(const r of e.faces)n.has(r.objectName)||n.set(r.objectName,[]),n.get(r.objectName).push(r);for(const[r,o]of n){s+=`
# Object: ${r}
`,s+=`o ${r.replace(/\s+/g,"_")}
`;for(const i of o){s+="f ";for(let c=0;c<i.vertices.length;c++){let u=`${i.vertices[c]+1}`;i.uvs&&i.uvs[c]!==void 0?u+=`/${i.uvs[c]+1}`:i.normals&&i.normals[c]!==void 0&&(u+="/"),i.normals&&i.normals[c]!==void 0&&(u+=`/${i.normals[c]+1}`),s+=u,c<i.vertices.length-1&&(s+=" ")}s+=`
`}}return s}}var As=Object.defineProperty,Is=(a,e,t)=>e in a?As(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,xe=(a,e,t)=>Is(a,typeof e!="symbol"?e+"":e,t);class Es{constructor(){xe(this,"outputDoc"),xe(this,"nameList",[]),xe(this,"objectIdCounter",1),xe(this,"parentChildMap",new Map),this.outputDoc=document.implementation.createDocument("","",null)}export(e){this.nameList=[],this.objectIdCounter=1,this.parentChildMap.clear();const t=this.outputDoc.createElement("ArrayCalc");t.setAttribute("Version","11.1.1");const s=this.outputDoc.createElement("Project");s.setAttribute("Name",e.metadata.originalFileName||"Convertifer3D");let n=this.outputDoc.createElement("Date");n.textContent=new Date().toLocaleDateString(),s.appendChild(n),n=this.outputDoc.createElement("Author"),n.textContent=e.metadata.author||"Convertifer 3D",s.appendChild(n),n=this.outputDoc.createElement("Comments"),n.textContent=e.metadata.comments||"Converted from CIF format",s.appendChild(n),t.appendChild(s);const r=this.outputDoc.createElement("Venue");r.setAttribute("Version","9"),t.appendChild(r);const o=this.createWrapperGroup();r.appendChild(o),this.convertGroup(e.root,o);let i=new XMLSerializer().serializeToString(t);return i=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ArrayCalc>`+i,i}convertGroup(e,t){const s=e.name!=="Root"&&this.hasNonIdentityTransform(e.transform);let n=t;s&&(n=this.createGroupElement(e),t.appendChild(n));for(const r of e.children)if("type"in r){const o=r;!s&&e.name!=="Root"&&(o.transform=this.combineTransforms(e.transform,o.transform));const i=this.convertPrimitive(o);for(const c of i)n.appendChild(c)}else{const o=r;!s&&e.name!=="Root"&&(o.transform=this.combineTransforms(e.transform,o.transform)),this.convertGroup(o,n)}}createWrapperGroup(){const e=this.outputDoc.createElement("RoomObject"),t=this.objectIdCounter++;return e.setAttribute("Id",t.toString()),e.setAttribute("ObjectGroup","true"),e.setAttribute("Shape","5"),e.setAttribute("PlaneType","1"),e.setAttribute("Name",this.getUniqueName("Scene")),e.setAttribute("Enabled","1"),e.setAttribute("Transparent","1"),e.setAttribute("Locked","0"),e.setAttribute("ListenerHeight","1.7"),e.setAttribute("Color",this.colorToDbacv(8947848)),e.setAttribute("PrintColor","4294945280"),e.setAttribute("ParentVenueObjectId","0"),e.setAttribute("OrderIndex","4"),this.addWrapperTransform(e),e}createGroupElement(e){const t=this.outputDoc.createElement("RoomObject"),s=this.objectIdCounter++;return t.setAttribute("Id",s.toString()),t.setAttribute("ObjectGroup","true"),t.setAttribute("Shape","5"),t.setAttribute("PlaneType","1"),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent","1"),t.setAttribute("Locked",e.locked?"1":"0"),t.setAttribute("ListenerHeight","1.7"),t.setAttribute("Color",this.colorToDbacv(8947848)),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),this.addTransformElements(t,e.transform),t}convertPrimitive(e){const t=[];switch(e.type){case"triangle":t.push(this.convertTriangle(e));break;case"quad":t.push(this.convertQuad(e));break;case"cube":t.push(this.convertCube(e));break;case"revolution":t.push(...this.convertRevolution(e));break;case"mesh":t.push(...this.convertMesh(e));break}return t}convertTriangle(e){const t=this.outputDoc.createElement("RoomObject"),s=this.objectIdCounter++;t.setAttribute("Id",s.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","6"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const n=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",n.listenerHeight),t.setAttribute("PlaneType",n.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);for(let r=0;r<3;r++)this.addVertex(t,e.vertices[r],r+1);return this.addTransformElements(t,e.transform),t}convertQuad(e){const t=this.outputDoc.createElement("RoomObject"),s=this.objectIdCounter++;t.setAttribute("Id",s.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","1"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const n=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",n.listenerHeight),t.setAttribute("PlaneType",n.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);const r=this.ensureQuadAntiClockwise(e.vertices);for(let o=0;o<4;o++)this.addVertex(t,r[o],o+1);return this.addTransformElements(t,e.transform),t}ensureQuadAntiClockwise(e){if(e.length!==4)return e;let t=0;for(let s=0;s<4;s++){const n=e[s],r=e[(s+1)%4];t+=(r.x-n.x)*(r.y+n.y)}return t<0?[e[0],e[3],e[2],e[1]]:e}convertCube(e){const t=this.outputDoc.createElement("RoomObject"),s=this.objectIdCounter++;t.setAttribute("Id",s.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","4"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const n=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",n.listenerHeight),t.setAttribute("PlaneType",n.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);for(let r=0;r<8;r++)this.addVertex(t,e.vertices[r],r+1);return this.addTransformElements(t,e.transform),t}convertRevolution(e){if(this.canConvertToArcSegment(e))return this.convertRevolutionToArcSegments(e);const t=this.revolutionToMesh(e);return this.convertMeshElements(t,`${e.name}_revolution`,e.material,e.transform,e.visible,e.locked,e.surfaceType)}convertMesh(e){return this.convertMeshElements({vertices:e.vertices,faces:e.faces},e.name,e.material,e.transform,e.visible,e.locked,e.surfaceType)}convertMeshElements(e,t,s,n,r,o,i){const c=[];for(let l=0;l<e.faces.length;l++){const u=e.faces[l],d=this.createFaceRoomObject(u,e.vertices,e.faces.length===1?t:`${t}_face_${l}`,s,n,r,o,i);d&&c.push(d)}return c}createFaceRoomObject(e,t,s,n,r,o,i,c){if(e.length===3){const l=this.outputDoc.createElement("RoomObject"),u=this.objectIdCounter++;if(l.setAttribute("Id",u.toString()),l.setAttribute("Name",this.getUniqueName(s)),l.setAttribute("Shape","6"),l.setAttribute("Enabled",o?"1":"0"),l.setAttribute("Transparent",n.transparent?"1":"0"),l.setAttribute("Locked",i?"1":"0"),c){const d=this.getPlaneTypeAndHeight(c);l.setAttribute("ListenerHeight",d.listenerHeight),l.setAttribute("PlaneType",d.planeType),l.setAttribute("Type",c)}else l.setAttribute("ListenerHeight","1.2"),l.setAttribute("PlaneType","1");l.setAttribute("Color",this.colorToDbacv(n.color.getHex())),l.setAttribute("PrintColor","4294945280"),l.setAttribute("ParentVenueObjectId","0"),l.setAttribute("OrderIndex","4");for(let d=0;d<3;d++)this.addVertex(l,t[e[d]],d+1);return this.addTransformElementsWithRotation(l,r),l}else if(e.length===4){const l=this.outputDoc.createElement("RoomObject"),u=this.objectIdCounter++;if(l.setAttribute("Id",u.toString()),l.setAttribute("Name",this.getUniqueName(s)),l.setAttribute("Shape","1"),l.setAttribute("Enabled",o?"1":"0"),l.setAttribute("Transparent",n.transparent?"1":"0"),l.setAttribute("Locked",i?"1":"0"),c){const d=this.getPlaneTypeAndHeight(c);l.setAttribute("ListenerHeight",d.listenerHeight),l.setAttribute("PlaneType",d.planeType),l.setAttribute("Type",c)}else l.setAttribute("ListenerHeight","1.2"),l.setAttribute("PlaneType","1");l.setAttribute("Color",this.colorToDbacv(n.color.getHex())),l.setAttribute("PrintColor","4294945280"),l.setAttribute("ParentVenueObjectId","0"),l.setAttribute("OrderIndex","4");for(let d=0;d<4;d++)this.addVertex(l,t[e[d]],d+1);return this.addTransformElementsWithRotation(l,r),l}return null}revolutionToMesh(e){const{profile:t,segments:s,startAngle:n,endAngle:r}=e,o=[],i=[];if(t.length<2)return{vertices:o,faces:i};const c=r-n;for(let u=0;u<=s;u++){const d=n+c*u/s,p=Math.cos(d),f=Math.sin(d);for(const h of t){const m=h.x*p-h.y*f,y=h.x*f+h.y*p,b=h.z;o.push(new g(m,y,b))}}const l=t.length;for(let u=0;u<s;u++)for(let d=0;d<l-1;d++){const p=u*l+d,f=u*l+d+1,h=(u+1)*l+d+1,m=(u+1)*l+d;i.push([p,f,h]),i.push([h,m,p])}return{vertices:o,faces:i}}addVertex(e,t,s){const n=this.outputDoc.createElement(`P${s}`);n.setAttribute("x",t.x.toString()),n.setAttribute("y",t.y.toString()),n.setAttribute("z",t.z.toString()),e.appendChild(n)}addTransformElements(e,t){this.addTransformElementsWithRotation(e,t)}addWrapperTransform(e){let t=this.outputDoc.createElement("Origin");t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("z","0"),e.appendChild(t),t=this.outputDoc.createElement("Rotation"),t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("z","270"),e.appendChild(t),t=this.outputDoc.createElement("Scaling"),t.setAttribute("x","1"),t.setAttribute("y","1"),t.setAttribute("z","1"),e.appendChild(t)}addTransformElementsWithRotation(e,t){const s=t.position.x,n=t.position.y,r=t.position.z;let o=this.outputDoc.createElement("Origin");o.setAttribute("x",s.toString()),o.setAttribute("y",n.toString()),o.setAttribute("z",r.toString()),e.appendChild(o),o=this.outputDoc.createElement("Rotation"),o.setAttribute("x",te(t.rotation.x).toString()),o.setAttribute("y",te(t.rotation.y).toString()),o.setAttribute("z",te(t.rotation.z).toString()),e.appendChild(o),o=this.outputDoc.createElement("Scaling"),o.setAttribute("x",t.scale.x.toString()),o.setAttribute("y",t.scale.y.toString()),o.setAttribute("z",t.scale.z.toString()),e.appendChild(o)}colorToDbacv(e){return((4278190080|e)>>>0).toString()}getPlaneTypeAndHeight(e){switch(e){case"listen":return{planeType:"1",listenerHeight:"1.7"};case"obstacle":return{planeType:"1",listenerHeight:"1.2"};case"structure":return{planeType:"4",listenerHeight:"0.01"};default:return{planeType:"1",listenerHeight:"1.2"}}}getUniqueName(e){(!e||e==="")&&(e="element");const t=this.nameList.filter(s=>s.includes(e));return this.nameList.push(e),t.length===0?e:`${e}#${t.length}`}canConvertToArcSegment(e){if(e.profile.length<2)return!1;const t=e.axis.normalize(),s=new g(0,0,1);return!(t.distanceTo(s)>.01)}convertRevolutionToArcSegments(e){const t=[],s=e.profile;for(let n=0;n<s.length-1;n++){const r=s[n],o=s[n+1],i=this.createSingleArcSegment(e,r,o,`${e.name}_arc_${n}`);t.push(i)}return t}createSingleArcSegment(e,t,s,n){const r=this.outputDoc.createElement("RoomObject"),o=this.objectIdCounter++;r.setAttribute("Id",o.toString()),r.setAttribute("Name",this.getUniqueName(n)),r.setAttribute("Shape","2"),r.setAttribute("Enabled",e.visible?"1":"0"),r.setAttribute("Transparent",e.material.transparent?"1":"0"),r.setAttribute("Locked",e.locked?"1":"0");const i=this.getPlaneTypeAndHeight(e.surfaceType);r.setAttribute("ListenerHeight",i.listenerHeight),r.setAttribute("PlaneType",i.planeType),r.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),r.setAttribute("PrintColor","4294945280"),r.setAttribute("ParentVenueObjectId","0"),r.setAttribute("OrderIndex","4"),r.setAttribute("Type",e.surfaceType);const c=Math.abs(t.x),l=Math.abs(s.x),u=t.z,d=s.z,p=te(e.startAngle),f=e.endAngle-e.startAngle;let h=f*180/Math.PI;return(Math.abs(f-2*Math.PI)<.001||Math.abs(h)<.001)&&(h=360),r.setAttribute("OuterRadiusA",c.toString()),r.setAttribute("OuterRadiusB",c.toString()),r.setAttribute("InnerRadiusA",l.toString()),r.setAttribute("InnerRadiusB",l.toString()),r.setAttribute("StartAngle",p.toString()),r.setAttribute("SpanAngle",h.toString()),r.setAttribute("OuterZ",u.toString()),r.setAttribute("InnerZ",d.toString()),this.addTransformElements(r,e.transform),r}hasNonIdentityTransform(e){const t=e.position,s=e.rotation,n=e.scale;return Math.abs(t.x)>1e-6||Math.abs(t.y)>1e-6||Math.abs(t.z)>1e-6||Math.abs(s.x)>1e-6||Math.abs(s.y)>1e-6||Math.abs(s.z)>1e-6||Math.abs(n.x-1)>1e-6||Math.abs(n.y-1)>1e-6||Math.abs(n.z-1)>1e-6}combineTransforms(e,t){return{position:new g(e.position.x+t.position.x,e.position.y+t.position.y,e.position.z+t.position.z),rotation:new g(e.rotation.x+t.rotation.x,e.rotation.y+t.rotation.y,e.rotation.z+t.rotation.z),scale:new g(e.scale.x*t.scale.x,e.scale.y*t.scale.y,e.scale.z*t.scale.z)}}}class Cs{export(e){const t=this.sceneToSerializable(e);return JSON.stringify(t,null,2)}sceneToSerializable(e){return{metadata:{...e.metadata,created:e.metadata.created.toISOString()},root:this.objectToSerializable(e.root),materials:this.materialsToSerializable(e.materials),units:e.units,coordinateSystem:e.coordinateSystem,upAxis:e.upAxis}}objectToSerializable(e){const t={id:e.id,name:e.name,transform:{position:{x:e.transform.position.x,y:e.transform.position.y,z:e.transform.position.z},rotation:{x:e.transform.rotation.x,y:e.transform.rotation.y,z:e.transform.rotation.z},scale:{x:e.transform.scale.x,y:e.transform.scale.y,z:e.transform.scale.z}},visible:e.visible,locked:e.locked,parentId:e.parentId,userData:e.userData};if("children"in e)return{...t,type:"group",children:e.children.map(n=>this.objectToSerializable(n))};{const s=e,n={...t,type:s.type,material:this.materialToSerializable(s.material)};switch(s.type){case"triangle":const r=s;n.vertices=r.vertices.map(u=>({x:u.x,y:u.y,z:u.z})),r.normals&&(n.normals=r.normals.map(u=>({x:u.x,y:u.y,z:u.z}))),r.uvs&&(n.uvs=r.uvs.map(u=>({x:u.x,y:u.y})));break;case"quad":const o=s;n.vertices=o.vertices.map(u=>({x:u.x,y:u.y,z:u.z})),o.normals&&(n.normals=o.normals.map(u=>({x:u.x,y:u.y,z:u.z}))),o.uvs&&(n.uvs=o.uvs.map(u=>({x:u.x,y:u.y})));break;case"cube":const i=s;n.vertices=i.vertices.map(u=>({x:u.x,y:u.y,z:u.z}));break;case"revolution":const c=s;n.profile=c.profile.map(u=>({x:u.x,y:u.y,z:u.z})),n.axis={x:c.axis.x,y:c.axis.y,z:c.axis.z},n.startAngle=c.startAngle,n.endAngle=c.endAngle,n.segments=c.segments,n.closed=c.closed;break;case"mesh":const l=s;n.vertices=l.vertices.map(u=>({x:u.x,y:u.y,z:u.z})),n.faces=l.faces,l.normals&&(n.normals=l.normals.map(u=>({x:u.x,y:u.y,z:u.z}))),l.uvs&&(n.uvs=l.uvs.map(u=>({x:u.x,y:u.y})));break}return n}}materialToSerializable(e){return{name:e.name,color:{r:e.color.r,g:e.color.g,b:e.color.b},opacity:e.opacity,transparent:e.transparent,properties:e.properties}}materialsToSerializable(e){const t={};return e.forEach((s,n)=>{t[n]=this.materialToSerializable(s)}),t}}class Ss{export(e){const t={version:"1.0",projectOrigin:{x:0,y:0},zones:[],title:e.metadata.originalFileName||"Converted Venue",notes:e.metadata.comments||"Converted from CIF format"};return this.processGroup(e.root,t,new ve),JSON.stringify(t,null,2)}processGroup(e,t,s){const n=new ve;if(e.transform.position&&n.makeTranslation(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation){const p=new ve;p.makeRotationFromEuler(new re(e.transform.rotation.x,e.transform.rotation.y,e.transform.rotation.z,"XYZ")),n.multiply(p)}const r=s.clone().multiply(n);if(e.name==="CVF_Import"||e.name==="FC3_Import"||e.name==="Root"){for(const p of e.children)if("children"in p)this.processGroup(p,t,r);else if("type"in p){const f=new k(p.id+"_temp",p.name||"Geometry");f.children.push(p);const h=this.reconstructZone(f,new g,0);h&&t.zones.push(h)}return}const o=new g,i=new Ct,c=new g;r.decompose(o,i,c);const l=new re().setFromRotationMatrix(r),u=te(l.z)-90,d=this.reconstructZone(e,o,u);d&&t.zones.push(d);for(const p of e.children)"children"in p&&this.processGroup(p,t,r)}reconstructZone(e,t,s){const n=[];for(const d of e.children)"type"in d&&n.push(d);if(n.length===0)return null;const r=n.some(d=>d.type==="revolution"),o=n.some(d=>d.type==="quad"),i=n.some(d=>d.type==="triangle");let c,l,u=10;if(r){const d=n.find(p=>p.type==="revolution");if(d)c={type:"Circular",frontRadius:0,angle:te(d.endAngle-d.startAngle)},l=this.extractSectionsFromRevolution(d);else return null}else if(o||i)c={type:"SymmetricPolygon",frontWidth:10,rearWidth:10},l=this.extractSectionsFromQuads(n),u=this.estimateDepthFromQuads(n);else return null;return{name:e.name||"Zone",position:{x:t.x,y:t.y},rotation:s,sections:l,depth:u,params:c}}extractSectionsFromRevolution(e){const t={name:e.name||"Section",audienceHeight:0,points:[]};for(const s of e.profile)t.points.push({x:s.x,z:s.z});return t.points.length>0&&(t.audienceHeight=t.points.reduce((s,n)=>s+n.z,0)/t.points.length),[t]}extractSectionsFromQuads(e){const t={name:"Section",audienceHeight:0,points:[]},s=new Map;for(const n of e)if(n.type==="quad"||n.type==="triangle"){const r=(n.type==="quad",n.vertices);for(const o of r){const i=`${o.x.toFixed(3)},${o.z.toFixed(3)}`;s.has(i)||s.set(i,{x:o.x,z:o.z})}}return t.points=Array.from(s.values()).sort((n,r)=>n.x-r.x),t.points.length<3&&(t.points=[{x:0,z:0},{x:5,z:0},{x:10,z:0}]),t.points.length>0&&(t.audienceHeight=t.points.reduce((n,r)=>n+r.z,0)/t.points.length),[t]}estimateDepthFromQuads(e){let t=1/0,s=-1/0;for(const r of e)if(r.type==="quad"||r.type==="triangle"){const o=(r.type==="quad",r.vertices);for(const i of o)t=Math.min(t,i.x),s=Math.max(s,i.x)}const n=s-t;return n>0?n:10}}const tt={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class Ze{constructor(){this.pluginCallbacks=[],this.register(function(e){return new Ds(e)}),this.register(function(e){return new Bs(e)}),this.register(function(e){return new Gs(e)}),this.register(function(e){return new Us(e)}),this.register(function(e){return new Hs(e)}),this.register(function(e){return new js(e)}),this.register(function(e){return new ks(e)}),this.register(function(e){return new $s(e)}),this.register(function(e){return new Vs(e)}),this.register(function(e){return new Ws(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){const r=new Ls,o=[];for(let i=0,c=this.pluginCallbacks.length;i<c;i++)o.push(this.pluginCallbacks[i](r));r.setPlugins(o),r.write(e,t,n).catch(s)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,n,r,t)})}}const S={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},Le="KHR_mesh_quantization",H={};H[Nt]=S.NEAREST;H[zt]=S.NEAREST_MIPMAP_NEAREST;H[Pt]=S.NEAREST_MIPMAP_LINEAR;H[Rt]=S.LINEAR;H[_t]=S.LINEAR_MIPMAP_NEAREST;H[Lt]=S.LINEAR_MIPMAP_LINEAR;H[Dt]=S.CLAMP_TO_EDGE;H[Bt]=S.REPEAT;H[kt]=S.MIRRORED_REPEAT;const st={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Ms=new U,nt=12,Fs=1179937895,Os=2,rt=8,Ns=1313821514,zs=5130562;function le(a,e){return a.length===e.length&&a.every(function(t,s){return t===e[s]})}function Ps(a){return new TextEncoder().encode(a).buffer}function Rs(a){return le(a.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function _s(a,e,t){const s={min:new Array(a.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(a.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let n=e;n<e+t;n++)for(let r=0;r<a.itemSize;r++){let o;a.itemSize>4?o=a.array[n*a.itemSize+r]:(r===0?o=a.getX(n):r===1?o=a.getY(n):r===2?o=a.getZ(n):r===3&&(o=a.getW(n)),a.normalized===!0&&(o=ke.normalize(o,a.array))),s.min[r]=Math.min(s.min[r],o),s.max[r]=Math.max(s.max[r],o)}return s}function ft(a){return Math.ceil(a/4)*4}function De(a,e=0){const t=ft(a.byteLength);if(t!==a.byteLength){const s=new Uint8Array(t);if(s.set(new Uint8Array(a)),e!==0)for(let n=a.byteLength;n<t;n++)s[n]=e;return s.buffer}return a}function ot(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function it(a,e){if(a.toBlob!==void 0)return new Promise(s=>a.toBlob(s,e));let t;return e==="image/jpeg"?t=.92:e==="image/webp"&&(t=.8),a.convertToBlob({type:e,quality:t})}class Ls{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const n=this,r=n.buffers,o=n.json;s=n.options;const i=n.extensionsUsed,c=n.extensionsRequired,l=new Blob(r,{type:"application/octet-stream"}),u=Object.keys(i),d=Object.keys(c);if(u.length>0&&(o.extensionsUsed=u),d.length>0&&(o.extensionsRequired=d),o.buffers&&o.buffers.length>0&&(o.buffers[0].byteLength=l.size),s.binary===!0){const p=new FileReader;p.readAsArrayBuffer(l),p.onloadend=function(){const f=De(p.result),h=new DataView(new ArrayBuffer(rt));h.setUint32(0,f.byteLength,!0),h.setUint32(4,zs,!0);const m=De(Ps(JSON.stringify(o)),32),y=new DataView(new ArrayBuffer(rt));y.setUint32(0,m.byteLength,!0),y.setUint32(4,Ns,!0);const b=new ArrayBuffer(nt),A=new DataView(b);A.setUint32(0,Fs,!0),A.setUint32(4,Os,!0);const x=nt+y.byteLength+m.byteLength+h.byteLength+f.byteLength;A.setUint32(8,x,!0);const w=new Blob([b,y,m,h,f],{type:"application/octet-stream"}),v=new FileReader;v.readAsArrayBuffer(w),v.onloadend=function(){t(v.result)}}}else if(o.buffers&&o.buffers.length>0){const p=new FileReader;p.readAsDataURL(l),p.onloadend=function(){const f=p.result;o.buffers[0].uri=f,t(o)}}else t(o)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;const s=this.options,n=this.extensionsUsed;try{const r=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&r.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(const o in r.gltfExtensions)t.extensions[o]=r.gltfExtensions[o],n[o]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(r){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+r.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){const n=new Map;n.set(!0,this.uid++),n.set(!1,this.uid++),this.uids.set(e,n)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const s=new g;for(let n=0,r=e.count;n<r;n++)if(Math.abs(s.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const s=e.clone(),n=new g;for(let r=0,o=s.count;r<o;r++)n.fromBufferAttribute(s,r),n.x===0&&n.y===0&&n.z===0?n.setX(1):n.normalize(),s.setXYZ(r,n.x,n.y,n.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1;const n={};(t.offset.x!==0||t.offset.y!==0)&&(n.offset=t.offset.toArray(),s=!0),t.rotation!==0&&(n.rotation=t.rotation,s=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(n.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function s(f){return f.colorSpace===lt?function(m){return m<.04045?m*.0773993808:Math.pow(m*.9478672986+.0521327014,2.4)}:function(m){return m}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures.");const n=e?e.image:null,r=t?t.image:null,o=Math.max(n?n.width:0,r?r.width:0),i=Math.max(n?n.height:0,r?r.height:0),c=ot();c.width=o,c.height=i;const l=c.getContext("2d");l.fillStyle="#00ffff",l.fillRect(0,0,o,i);const u=l.getImageData(0,0,o,i);if(n){l.drawImage(n,0,0,o,i);const f=s(e),h=l.getImageData(0,0,o,i).data;for(let m=2;m<h.length;m+=4)u.data[m]=f(h[m]/256)*256}if(r){l.drawImage(r,0,0,o,i);const f=s(t),h=l.getImageData(0,0,o,i).data;for(let m=1;m<h.length;m+=4)u.data[m]=f(h[m]/256)*256}l.putImageData(u,0,0);const p=(e||t).clone();return p.source=new St(c),p.colorSpace=Mt,p.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),p}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,n,r){const o=this.json;o.bufferViews||(o.bufferViews=[]);let i;switch(t){case S.BYTE:case S.UNSIGNED_BYTE:i=1;break;case S.SHORT:case S.UNSIGNED_SHORT:i=2;break;default:i=4}const c=ft(n*e.itemSize*i),l=new DataView(new ArrayBuffer(c));let u=0;for(let f=s;f<s+n;f++)for(let h=0;h<e.itemSize;h++){let m;e.itemSize>4?m=e.array[f*e.itemSize+h]:(h===0?m=e.getX(f):h===1?m=e.getY(f):h===2?m=e.getZ(f):h===3&&(m=e.getW(f)),e.normalized===!0&&(m=ke.normalize(m,e.array))),t===S.FLOAT?l.setFloat32(u,m,!0):t===S.INT?l.setInt32(u,m,!0):t===S.UNSIGNED_INT?l.setUint32(u,m,!0):t===S.SHORT?l.setInt16(u,m,!0):t===S.UNSIGNED_SHORT?l.setUint16(u,m,!0):t===S.BYTE?l.setInt8(u,m):t===S.UNSIGNED_BYTE&&l.setUint8(u,m),u+=i}const d={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:c};return r!==void 0&&(d.target=r),r===S.ARRAY_BUFFER&&(d.byteStride=e.itemSize*i),this.byteOffset+=c,o.bufferViews.push(d),{id:o.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise(function(n){const r=new FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){const o=De(r.result),i={buffer:t.processBuffer(o),byteOffset:t.byteOffset,byteLength:o.byteLength};t.byteOffset+=o.byteLength,n(s.bufferViews.push(i)-1)}})}processAccessor(e,t,s,n){const r=this.json,o={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let i;if(e.array.constructor===Float32Array)i=S.FLOAT;else if(e.array.constructor===Int32Array)i=S.INT;else if(e.array.constructor===Uint32Array)i=S.UNSIGNED_INT;else if(e.array.constructor===Int16Array)i=S.SHORT;else if(e.array.constructor===Uint16Array)i=S.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)i=S.BYTE;else if(e.array.constructor===Uint8Array)i=S.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");if(s===void 0&&(s=0),n===void 0&&(n=e.count),n===0)return null;const c=_s(e,s,n);let l;t!==void 0&&(l=e===t.index?S.ELEMENT_ARRAY_BUFFER:S.ARRAY_BUFFER);const u=this.processBufferView(e,i,s,n,l),d={bufferView:u.id,byteOffset:u.byteOffset,componentType:i,count:n,max:c.max,min:c.min,type:o[e.itemSize]};return e.normalized===!0&&(d.normalized=!0),r.accessors||(r.accessors=[]),r.accessors.push(d)-1}processImage(e,t,s,n="image/png"){if(e!==null){const r=this,o=r.cache,i=r.json,c=r.options,l=r.pending;o.images.has(e)||o.images.set(e,{});const u=o.images.get(e),d=n+":flipY/"+s.toString();if(u[d]!==void 0)return u[d];i.images||(i.images=[]);const p={mimeType:n},f=ot();f.width=Math.min(e.width,c.maxTextureSize),f.height=Math.min(e.height,c.maxTextureSize);const h=f.getContext("2d");if(s===!0&&(h.translate(0,f.height),h.scale(1,-1)),e.data!==void 0){t!==Ft&&console.error("GLTFExporter: Only RGBAFormat is supported."),(e.width>c.maxTextureSize||e.height>c.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const y=new Uint8ClampedArray(e.height*e.width*4);for(let b=0;b<y.length;b+=4)y[b+0]=e.data[b+0],y[b+1]=e.data[b+1],y[b+2]=e.data[b+2],y[b+3]=e.data[b+3];h.putImageData(new ImageData(y,e.width,e.height),0,0)}else h.drawImage(e,0,0,f.width,f.height);c.binary===!0?l.push(it(f,n).then(y=>r.processBufferViewImage(y)).then(y=>{p.bufferView=y})):f.toDataURL!==void 0?p.uri=f.toDataURL(n):l.push(it(f,n).then(y=>new FileReader().readAsDataURL(y)).then(y=>{p.uri=y}));const m=i.images.push(p)-1;return u[d]=m,m}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:H[e.magFilter],minFilter:H[e.minFilter],wrapS:H[e.wrapS],wrapT:H[e.wrapT]};return t.samplers.push(s)-1}processTexture(e){const t=this.cache,s=this.json;if(t.textures.has(e))return t.textures.get(e);s.textures||(s.textures=[]);let n=e.userData.mimeType;n==="image/webp"&&(n="image/png");const r={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,n)};e.name&&(r.name=e.name),this._invokeAll(function(i){i.writeTexture&&i.writeTexture(e,r)});const o=s.textures.push(r)-1;return t.textures.set(e,o),o}processMaterial(e){const t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);const n={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const r=e.color.toArray().concat([e.opacity]);if(le(r,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=r),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const i=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),c={index:this.processTexture(i),channel:i.channel};this.applyTextureTransform(c,i),n.pbrMetallicRoughness.metallicRoughnessTexture=c}if(e.map){const i={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(i,e.map),n.pbrMetallicRoughness.baseColorTexture=i}if(e.emissive){const i=e.emissive;if(Math.max(i.r,i.g,i.b)>0&&(n.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const l={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(l,e.emissiveMap),n.emissiveTexture=l}}if(e.normalMap){const i={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&e.normalScale.x!==1&&(i.scale=e.normalScale.x),this.applyTextureTransform(i,e.normalMap),n.normalTexture=i}if(e.aoMap){const i={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};e.aoMapIntensity!==1&&(i.strength=e.aoMapIntensity),this.applyTextureTransform(i,e.aoMap),n.occlusionTexture=i}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===Ne&&(n.doubleSided=!0),e.name!==""&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll(function(i){i.writeMaterial&&i.writeMaterial(e,n)});const o=s.materials.push(n)-1;return t.materials.set(e,o),o}processMesh(e){const t=this.cache,s=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let x=0,w=e.material.length;x<w;x++)n.push(e.material[x].uuid);else n.push(e.material.uuid);const r=n.join(":");if(t.meshes.has(r))return t.meshes.get(r);const o=e.geometry;let i;e.isLineSegments?i=S.LINES:e.isLineLoop?i=S.LINE_LOOP:e.isLine?i=S.LINE_STRIP:e.isPoints?i=S.POINTS:i=e.material.wireframe?S.LINES:S.TRIANGLES;const c={},l={},u=[],d=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},f=o.getAttribute("normal");f!==void 0&&!this.isNormalizedNormalAttribute(f)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),o.setAttribute("normal",this.createNormalizedNormalAttribute(f)));let h=null;for(let x in o.attributes){if(x.slice(0,5)==="morph")continue;const w=o.attributes[x];if(x=p[x]||x.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(x)||(x="_"+x),t.attributes.has(this.getUID(w))){l[x]=t.attributes.get(this.getUID(w));continue}h=null;const E=w.array;x==="JOINTS_0"&&!(E instanceof Uint16Array)&&!(E instanceof Uint8Array)&&(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),h=new N(new Uint16Array(E),w.itemSize,w.normalized));const z=this.processAccessor(h||w,o);z!==null&&(x.startsWith("_")||this.detectMeshQuantization(x,w),l[x]=z,t.attributes.set(this.getUID(w),z))}if(f!==void 0&&o.setAttribute("normal",f),Object.keys(l).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){const x=[],w=[],v={};if(e.morphTargetDictionary!==void 0)for(const E in e.morphTargetDictionary)v[e.morphTargetDictionary[E]]=E;for(let E=0;E<e.morphTargetInfluences.length;++E){const z={};let j=!1;for(const L in o.morphAttributes){if(L!=="position"&&L!=="normal"){j||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),j=!0);continue}const Y=o.morphAttributes[L][E],Pe=L.toUpperCase(),ie=o.attributes[L];if(t.attributes.has(this.getUID(Y,!0))){z[Pe]=t.attributes.get(this.getUID(Y,!0));continue}const ae=Y.clone();if(!o.morphTargetsRelative)for(let D=0,Et=Y.count;D<Et;D++)for(let ne=0;ne<Y.itemSize;ne++)ne===0&&ae.setX(D,Y.getX(D)-ie.getX(D)),ne===1&&ae.setY(D,Y.getY(D)-ie.getY(D)),ne===2&&ae.setZ(D,Y.getZ(D)-ie.getZ(D)),ne===3&&ae.setW(D,Y.getW(D)-ie.getW(D));z[Pe]=this.processAccessor(ae,o),t.attributes.set(this.getUID(ie,!0),z[Pe])}d.push(z),x.push(e.morphTargetInfluences[E]),e.morphTargetDictionary!==void 0&&w.push(v[E])}c.weights=x,w.length>0&&(c.extras={},c.extras.targetNames=w)}const m=Array.isArray(e.material);if(m&&o.groups.length===0)return null;const y=m?e.material:[e.material],b=m?o.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let x=0,w=b.length;x<w;x++){const v={mode:i,attributes:l};if(this.serializeUserData(o,v),d.length>0&&(v.targets=d),o.index!==null){let z=this.getUID(o.index);(b[x].start!==void 0||b[x].count!==void 0)&&(z+=":"+b[x].start+":"+b[x].count),t.attributes.has(z)?v.indices=t.attributes.get(z):(v.indices=this.processAccessor(o.index,o,b[x].start,b[x].count),t.attributes.set(z,v.indices)),v.indices===null&&delete v.indices}const E=this.processMaterial(y[b[x].materialIndex]);E!==null&&(v.material=E),u.push(v)}c.primitives=u,s.meshes||(s.meshes=[]),this._invokeAll(function(x){x.writeMesh&&x.writeMesh(e,c)});const A=s.meshes.push(c)-1;return t.meshes.set(r,A),A}detectMeshQuantization(e,t){if(this.extensionsUsed[Le])return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");const n=e.split("_",1)[0];tt[n]&&tt[n].includes(s)&&(this.extensionsUsed[Le]=!0,this.extensionsRequired[Le]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const s=e.isOrthographicCamera,n={type:s?"orthographic":"perspective"};return s?n.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:ke.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){const s=this.json,n=this.nodeMap;s.animations||(s.animations=[]),e=Ze.Utils.mergeMorphTargetTracks(e.clone(),t);const r=e.tracks,o=[],i=[];for(let c=0;c<r.length;++c){const l=r[c],u=Ee.parseTrackName(l.name);let d=Ee.findNode(t,u.nodeName);const p=st[u.propertyName];if(u.objectName==="bones"&&(d.isSkinnedMesh===!0?d=d.skeleton.getBoneByName(u.objectIndex):d=void 0),!d||!p)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',l.name),null;const f=1;let h=l.values.length/l.times.length;p===st.morphTargetInfluences&&(h/=d.morphTargetInfluences.length);let m;l.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(m="CUBICSPLINE",h/=3):l.getInterpolation()===Ot?m="STEP":m="LINEAR",i.push({input:this.processAccessor(new N(l.times,f)),output:this.processAccessor(new N(l.values,h)),interpolation:m}),o.push({sampler:i.length-1,target:{node:n.get(d),path:p}})}return s.animations.push({name:e.name||"clip_"+s.animations.length,samplers:i,channels:o}),s.animations.length-1}processSkin(e){const t=this.json,s=this.nodeMap,n=t.nodes[s.get(e)],r=e.skeleton;if(r===void 0)return null;const o=e.skeleton.bones[0];if(o===void 0)return null;const i=[],c=new Float32Array(r.bones.length*16),l=new ve;for(let d=0;d<r.bones.length;++d)i.push(s.get(r.bones[d])),l.copy(r.boneInverses[d]),l.multiply(e.bindMatrix).toArray(c,d*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new N(c,16)),joints:i,skeleton:s.get(o)}),n.skin=t.skins.length-1}processNode(e){const t=this.json,s=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const r={};if(s.trs){const i=e.quaternion.toArray(),c=e.position.toArray(),l=e.scale.toArray();le(i,[0,0,0,1])||(r.rotation=i),le(c,[0,0,0])||(r.translation=c),le(l,[1,1,1])||(r.scale=l)}else e.matrixAutoUpdate&&e.updateMatrix(),Rs(e.matrix)===!1&&(r.matrix=e.matrix.elements);if(e.name!==""&&(r.name=String(e.name)),this.serializeUserData(e,r),e.isMesh||e.isLine||e.isPoints){const i=this.processMesh(e);i!==null&&(r.mesh=i)}else e.isCamera&&(r.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const i=[];for(let c=0,l=e.children.length;c<l;c++){const u=e.children[c];if(u.visible||s.onlyVisible===!1){const d=this.processNode(u);d!==null&&i.push(d)}}i.length>0&&(r.children=i)}this._invokeAll(function(i){i.writeNode&&i.writeNode(e,r)});const o=t.nodes.push(r)-1;return n.set(e,o),o}processScene(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};e.name!==""&&(n.name=e.name),t.scenes.push(n);const r=[];for(let o=0,i=e.children.length;o<i;o++){const c=e.children[o];if(c.visible||s.onlyVisible===!1){const l=this.processNode(c);l!==null&&r.push(l)}}r.length>0&&(n.nodes=r),this.serializeUserData(e,n)}processObjects(e){const t=new Ce;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(n){n.beforeParse&&n.beforeParse(e)});const s=[];for(let n=0;n<e.length;n++)e[n]instanceof Ce?this.processScene(e[n]):s.push(e[n]);s.length>0&&this.processObjects(s);for(let n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);this._invokeAll(function(n){n.afterParse&&n.afterParse(e)})}_invokeAll(e){for(let t=0,s=this.plugins.length;t<s;t++)e(this.plugins[t])}}class Ds{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}const s=this.writer,n=s.json,r=s.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,o.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),r[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},r[this.name]=!0);const i=n.extensions[this.name].lights;i.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:i.length-1}}}class Bs{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class ks{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.clearcoat===0)return;const s=this.writer,n=s.extensionsUsed,r={};if(r.clearcoatFactor=e.clearcoat,e.clearcoatMap){const o={index:s.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(o,e.clearcoatMap),r.clearcoatTexture=o}if(r.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const o={index:s.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(o,e.clearcoatRoughnessMap),r.clearcoatRoughnessTexture=o}if(e.clearcoatNormalMap){const o={index:s.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};s.applyTextureTransform(o,e.clearcoatNormalMap),r.clearcoatNormalTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class $s{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.iridescence===0)return;const s=this.writer,n=s.extensionsUsed,r={};if(r.iridescenceFactor=e.iridescence,e.iridescenceMap){const o={index:s.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(o,e.iridescenceMap),r.iridescenceTexture=o}if(r.iridescenceIor=e.iridescenceIOR,r.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],r.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const o={index:s.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(o,e.iridescenceThicknessMap),r.iridescenceThicknessTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class Gs{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const s=this.writer,n=s.extensionsUsed,r={};if(r.transmissionFactor=e.transmission,e.transmissionMap){const o={index:s.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(o,e.transmissionMap),r.transmissionTexture=o}t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class Us{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const s=this.writer,n=s.extensionsUsed,r={};if(r.thicknessFactor=e.thickness,e.thicknessMap){const o={index:s.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(o,e.thicknessMap),r.thicknessTexture=o}r.attenuationDistance=e.attenuationDistance,r.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class Hs{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.ior===1.5)return;const n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class js{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.specularIntensity===1&&e.specularColor.equals(Ms)&&!e.specularIntensityMap&&!e.specularColorTexture)return;const s=this.writer,n=s.extensionsUsed,r={};if(e.specularIntensityMap){const o={index:s.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(o,e.specularIntensityMap),r.specularTexture=o}if(e.specularColorMap){const o={index:s.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(o,e.specularColorMap),r.specularColorTexture=o}r.specularFactor=e.specularIntensity,r.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class Vs{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.sheen==0)return;const s=this.writer,n=s.extensionsUsed,r={};if(e.sheenRoughnessMap){const o={index:s.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(o,e.sheenRoughnessMap),r.sheenRoughnessTexture=o}if(e.sheenColorMap){const o={index:s.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(o,e.sheenColorMap),r.sheenColorTexture=o}r.sheenRoughnessFactor=e.sheenRoughness,r.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class Ws{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||e.emissiveIntensity===1)return;const n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}Ze.Utils={insertKeyframe:function(a,e){const s=a.getValueSize(),n=new a.TimeBufferType(a.times.length+1),r=new a.ValueBufferType(a.values.length+s),o=a.createInterpolant(new a.ValueBufferType(s));let i;if(a.times.length===0){n[0]=e;for(let c=0;c<s;c++)r[c]=0;i=0}else if(e<a.times[0]){if(Math.abs(a.times[0]-e)<.001)return 0;n[0]=e,n.set(a.times,1),r.set(o.evaluate(e),0),r.set(a.values,s),i=0}else if(e>a.times[a.times.length-1]){if(Math.abs(a.times[a.times.length-1]-e)<.001)return a.times.length-1;n[n.length-1]=e,n.set(a.times,0),r.set(a.values,0),r.set(o.evaluate(e),a.values.length),i=n.length-1}else for(let c=0;c<a.times.length;c++){if(Math.abs(a.times[c]-e)<.001)return c;if(a.times[c]<e&&a.times[c+1]>e){n.set(a.times.slice(0,c+1),0),n[c+1]=e,n.set(a.times.slice(c+1),c+2),r.set(a.values.slice(0,(c+1)*s),0),r.set(o.evaluate(e),(c+1)*s),r.set(a.values.slice((c+1)*s),(c+2)*s),i=c+1;break}}return a.times=n,a.values=r,i},mergeMorphTargetTracks:function(a,e){const t=[],s={},n=a.tracks;for(let r=0;r<n.length;++r){let o=n[r];const i=Ee.parseTrackName(o.name),c=Ee.findNode(e,i.nodeName);if(i.propertyName!=="morphTargetInfluences"||i.propertyIndex===void 0){t.push(o);continue}if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),o=o.clone(),o.setInterpolation($t)}const l=c.morphTargetInfluences.length,u=c.morphTargetDictionary[i.propertyIndex];if(u===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+i.propertyIndex);let d;if(s[c.uuid]===void 0){d=o.clone();const f=new d.ValueBufferType(l*d.times.length);for(let h=0;h<d.times.length;h++)f[h*l+u]=d.values[h];d.name=(i.nodeName||"")+".morphTargetInfluences",d.values=f,s[c.uuid]=d,t.push(d);continue}const p=o.createInterpolant(new o.ValueBufferType(1));d=s[c.uuid];for(let f=0;f<d.times.length;f++)d.values[f*l+u]=p.evaluate(d.times[f]);for(let f=0;f<o.times.length;f++){const h=this.insertKeyframe(d,o.times[f]);d.values[h*l+u]=o.values[f]}}return a.tracks=t,a}};class Zs{async export(e){const t=new Ce,s=new _;s.rotation.x=-Math.PI/2,s.rotation.z=-Math.PI/2,t.add(s),this.processGroup(e.root,s);const n=new Ze;return new Promise((r,o)=>{n.parse(t,i=>{i instanceof ArrayBuffer?r(i):o(new Error("Expected ArrayBuffer from GLTFExporter but got JSON"))},i=>{o(i)},{binary:!0,onlyVisible:!1,truncateDrawRange:!0,embedImages:!0,maxTextureSize:4096})})}processGroup(e,t){for(const s of e.children)if(s instanceof q){const n=this.createMeshFromPrimitive(s);n&&t.add(n)}else if(s instanceof k){const n=new _;n.name=s.name,this.applyTransform(n,s.transform),t.add(n),this.processGroup(s,n)}}createMeshFromPrimitive(e){let t=null;switch(e.type){case"triangle":t=this.triangleToGeometry(e);break;case"quad":t=this.quadToGeometry(e);break;case"cube":t=this.cubeToGeometry(e);break;case"revolution":t=this.revolutionToGeometry(e);break;case"mesh":t=this.meshToGeometry(e);break}if(!t)return null;const s=this.createMaterial(e.material),n=new O(t,s);return n.name=e.name,this.applyTransform(n,e.transform),n.userData={...e.userData,cifId:e.id,cifType:e.type,surfaceType:e.surfaceType},n}shouldFlipWinding(e,t,s){const n=new g().subVectors(t,e),r=new g().subVectors(s,e);return new g().crossVectors(n,r).z<0}triangleToGeometry(e){const t=new W,s=new g(e.vertices[0].x,e.vertices[0].y,e.vertices[0].z),n=new g(e.vertices[1].x,e.vertices[1].y,e.vertices[1].z),r=new g(e.vertices[2].x,e.vertices[2].y,e.vertices[2].z),o=this.shouldFlipWinding(s,n,r),i=o?[s,r,n]:[s,n,r],c=new Float32Array(9);for(let l=0;l<3;l++)c[l*3]=i[l].x,c[l*3+1]=i[l].y,c[l*3+2]=i[l].z;if(t.setAttribute("position",new N(c,3)),e.normals&&e.normals.length===3){const l=o?[0,2,1]:[0,1,2],u=new Float32Array(9);for(let d=0;d<3;d++)u[d*3]=e.normals[l[d]].x,u[d*3+1]=e.normals[l[d]].y,u[d*3+2]=e.normals[l[d]].z;t.setAttribute("normal",new N(u,3))}else t.computeVertexNormals();if(e.uvs&&e.uvs.length===3){const l=o?[0,2,1]:[0,1,2],u=new Float32Array(6);for(let d=0;d<3;d++)u[d*2]=e.uvs[l[d]].x,u[d*2+1]=e.uvs[l[d]].y;t.setAttribute("uv",new N(u,2))}return t}quadToGeometry(e){const t=new W,s=new g(e.vertices[0].x,e.vertices[0].y,e.vertices[0].z),n=new g(e.vertices[1].x,e.vertices[1].y,e.vertices[1].z),r=new g(e.vertices[2].x,e.vertices[2].y,e.vertices[2].z),o=new g(e.vertices[3].x,e.vertices[3].y,e.vertices[3].z),i=this.shouldFlipWinding(s,n,r),c=i?[s,r,n]:[s,n,r],l=i?[s,o,r]:[s,r,o],u=i?[0,2,1]:[0,1,2],d=i?[0,3,2]:[0,2,3],p=new Float32Array(18);if(p[0]=c[0].x,p[1]=c[0].y,p[2]=c[0].z,p[3]=c[1].x,p[4]=c[1].y,p[5]=c[1].z,p[6]=c[2].x,p[7]=c[2].y,p[8]=c[2].z,p[9]=l[0].x,p[10]=l[0].y,p[11]=l[0].z,p[12]=l[1].x,p[13]=l[1].y,p[14]=l[1].z,p[15]=l[2].x,p[16]=l[2].y,p[17]=l[2].z,t.setAttribute("position",new N(p,3)),e.normals&&e.normals.length===4){const f=new Float32Array(18);for(let h=0;h<3;h++)f[h*3]=e.normals[u[h]].x,f[h*3+1]=e.normals[u[h]].y,f[h*3+2]=e.normals[u[h]].z;for(let h=0;h<3;h++)f[9+h*3]=e.normals[d[h]].x,f[9+h*3+1]=e.normals[d[h]].y,f[9+h*3+2]=e.normals[d[h]].z;t.setAttribute("normal",new N(f,3))}else t.computeVertexNormals();if(e.uvs&&e.uvs.length===4){const f=new Float32Array(12);for(let h=0;h<3;h++)f[h*2]=e.uvs[u[h]].x,f[h*2+1]=e.uvs[u[h]].y;for(let h=0;h<3;h++)f[6+h*2]=e.uvs[d[h]].x,f[6+h*2+1]=e.uvs[d[h]].y;t.setAttribute("uv",new N(f,2))}return t}cubeToGeometry(e){const t=new W,s=e.vertices,n=[];return n.push(s[0].x,s[0].y,s[0].z),n.push(s[1].x,s[1].y,s[1].z),n.push(s[2].x,s[2].y,s[2].z),n.push(s[0].x,s[0].y,s[0].z),n.push(s[2].x,s[2].y,s[2].z),n.push(s[3].x,s[3].y,s[3].z),n.push(s[5].x,s[5].y,s[5].z),n.push(s[4].x,s[4].y,s[4].z),n.push(s[7].x,s[7].y,s[7].z),n.push(s[5].x,s[5].y,s[5].z),n.push(s[7].x,s[7].y,s[7].z),n.push(s[6].x,s[6].y,s[6].z),n.push(s[3].x,s[3].y,s[3].z),n.push(s[2].x,s[2].y,s[2].z),n.push(s[6].x,s[6].y,s[6].z),n.push(s[3].x,s[3].y,s[3].z),n.push(s[6].x,s[6].y,s[6].z),n.push(s[7].x,s[7].y,s[7].z),n.push(s[0].x,s[0].y,s[0].z),n.push(s[4].x,s[4].y,s[4].z),n.push(s[5].x,s[5].y,s[5].z),n.push(s[0].x,s[0].y,s[0].z),n.push(s[5].x,s[5].y,s[5].z),n.push(s[1].x,s[1].y,s[1].z),n.push(s[1].x,s[1].y,s[1].z),n.push(s[5].x,s[5].y,s[5].z),n.push(s[6].x,s[6].y,s[6].z),n.push(s[1].x,s[1].y,s[1].z),n.push(s[6].x,s[6].y,s[6].z),n.push(s[2].x,s[2].y,s[2].z),n.push(s[4].x,s[4].y,s[4].z),n.push(s[0].x,s[0].y,s[0].z),n.push(s[3].x,s[3].y,s[3].z),n.push(s[4].x,s[4].y,s[4].z),n.push(s[3].x,s[3].y,s[3].z),n.push(s[7].x,s[7].y,s[7].z),t.setAttribute("position",new N(new Float32Array(n),3)),t.computeVertexNormals(),t}revolutionToGeometry(e){const t=new W,{profile:s,segments:n,startAngle:r,endAngle:o}=e;if(s.length<2)return t;const i=o-r,c=[];for(let l=0;l<n;l++)for(let u=0;u<s.length-1;u++){const d=r+i*l/n,p=r+i*(l+1)/n,f=Math.cos(d),h=Math.sin(d),m=Math.cos(p),y=Math.sin(p),b=s[u],A=s[u+1],x=new g(b.x*f-b.y*h,b.x*h+b.y*f,b.z),w=new g(A.x*f-A.y*h,A.x*h+A.y*f,A.z),v=new g(A.x*m-A.y*y,A.x*y+A.y*m,A.z),E=new g(b.x*m-b.y*y,b.x*y+b.y*m,b.z),z=1e-6;Math.abs(A.x)<z&&Math.abs(A.y)<z?this.shouldFlipWinding(x,w,E)?c.push(x.x,x.y,x.z,E.x,E.y,E.z,w.x,w.y,w.z):c.push(x.x,x.y,x.z,w.x,w.y,w.z,E.x,E.y,E.z):this.shouldFlipWinding(x,w,v)?(c.push(x.x,x.y,x.z,v.x,v.y,v.z,w.x,w.y,w.z),c.push(x.x,x.y,x.z,E.x,E.y,E.z,v.x,v.y,v.z)):(c.push(x.x,x.y,x.z,w.x,w.y,w.z,v.x,v.y,v.z),c.push(x.x,x.y,x.z,v.x,v.y,v.z,E.x,E.y,E.z))}return t.setAttribute("position",new N(new Float32Array(c),3)),t.computeVertexNormals(),t}meshToGeometry(e){const t=new W,s=[],n=[],r=[];for(const o of e.faces)if(o.length===3){const i=new g(e.vertices[o[0]].x,e.vertices[o[0]].y,e.vertices[o[0]].z),c=new g(e.vertices[o[1]].x,e.vertices[o[1]].y,e.vertices[o[1]].z),l=new g(e.vertices[o[2]].x,e.vertices[o[2]].y,e.vertices[o[2]].z),d=this.shouldFlipWinding(i,c,l)?[o[0],o[2],o[1]]:o;for(const p of d){const f=e.vertices[p];if(s.push(f.x,f.y,f.z),e.normals&&e.normals[p]){const h=e.normals[p];n.push(h.x,h.y,h.z)}if(e.uvs&&e.uvs[p]){const h=e.uvs[p];r.push(h.x,h.y)}}}else if(o.length===4){const[i,c,l,u]=o,d=new g(e.vertices[i].x,e.vertices[i].y,e.vertices[i].z),p=new g(e.vertices[c].x,e.vertices[c].y,e.vertices[c].z),f=new g(e.vertices[l].x,e.vertices[l].y,e.vertices[l].z),h=this.shouldFlipWinding(d,p,f),m=h?[i,l,c]:[i,c,l],y=h?[i,u,l]:[i,l,u];for(const b of m){const A=e.vertices[b];if(s.push(A.x,A.y,A.z),e.normals&&e.normals[b]){const x=e.normals[b];n.push(x.x,x.y,x.z)}if(e.uvs&&e.uvs[b]){const x=e.uvs[b];r.push(x.x,x.y)}}for(const b of y){const A=e.vertices[b];if(s.push(A.x,A.y,A.z),e.normals&&e.normals[b]){const x=e.normals[b];n.push(x.x,x.y,x.z)}if(e.uvs&&e.uvs[b]){const x=e.uvs[b];r.push(x.x,x.y)}}}return t.setAttribute("position",new N(new Float32Array(s),3)),n.length>0?t.setAttribute("normal",new N(new Float32Array(n),3)):t.computeVertexNormals(),r.length>0&&t.setAttribute("uv",new N(new Float32Array(r),2)),t}createMaterial(e){return new G({color:e.color,opacity:e.opacity,transparent:e.transparent,side:Ne,metalness:.1,roughness:.8})}applyTransform(e,t){e.position.copy(t.position),e.rotation.setFromVector3(t.rotation),e.scale.copy(t.scale)}}var Ys=Object.defineProperty,Xs=(a,e,t)=>e in a?Ys(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,qs=(a,e,t)=>Xs(a,e+"",t);const mt=class gt{static getSupportedExportFormats(){return this.EXPORT_FORMATS}static isFormatSupported(e){return this.EXPORT_FORMATS.includes(e)}async exportScene(e,t){if(!gt.isFormatSupported(t.format))throw new Error(`Unsupported export format: ${t.format}`);let s,n=t.fileName||"exported";n=n.replace(/\.[^/.]+$/,"");try{switch(t.format){case"sv":s=this.exportSV(e),n+=".txt";break;case"obj":s=this.exportOBJ(e),n+=".obj";break;case"dbacv":s=this.exportDbacv(e),n+=".dbacv";break;case"cif":s=this.exportCIF(e),n+=".cif.json";break;case"cvf":s=this.exportCVF(e),n+=".cvf";break;case"glb":s=await this.exportGLB(e),n+=".glb";break;default:throw new Error(`Unsupported format: ${t.format}`)}return{data:s,fileName:n,format:t.format,mimeType:this.getMimeType(t.format),size:s instanceof ArrayBuffer?s.byteLength:new Blob([s]).size}}catch(r){throw new Error(`Export failed: ${r instanceof Error?r.message:"Unknown error"}`)}}exportSV(e){return new vs().export(e)}exportOBJ(e){return new Ts().export(e)}exportDbacv(e){return new Es().export(e)}exportCIF(e){return new Cs().export(e)}exportCVF(e){return new Ss().export(e)}async exportGLB(e){return new Zs().export(e)}getMimeType(e){switch(e){case"sv":return"text/plain";case"obj":return"text/plain";case"dbacv":return"application/xml";case"cif":return"application/json";case"cvf":return"application/json";case"glb":return"model/gltf-binary";default:return"text/plain"}}static createDownloadBlob(e){return e.data instanceof ArrayBuffer?new Blob([e.data],{type:e.mimeType}):new Blob([e.data],{type:e.mimeType})}static downloadResult(e){const t=this.createDownloadBlob(e),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=e.fileName,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}static getFileExtension(e){switch(e){case"sv":return".txt";case"obj":return".obj";case"dbacv":return".dbacv";case"cif":return".cif.json";case"cvf":return".cvf";case"glb":return".glb";default:return".txt"}}};qs(mt,"EXPORT_FORMATS",["sv","obj","dbacv","cif","cvf","glb"]);let Ks=mt;const Js="modulepreload",Qs=function(a,e){return new URL(a,e).href},at={},ee=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let o=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};const i=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),l=c?.nonce||c?.getAttribute("nonce");n=o(t.map(u=>{if(u=Qs(u,s),u in at)return;at[u]=!0;const d=u.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(!!s)for(let m=i.length-1;m>=0;m--){const y=i[m];if(y.href===u&&(!d||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${u}"]${p}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Js,d||(h.as="script"),h.crossOrigin="",h.href=u,l&&h.setAttribute("nonce",l),document.head.appendChild(h),d)return new Promise((m,y)=>{h.addEventListener("load",m),h.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(o){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=o,window.dispatchEvent(i),!i.defaultPrevented)throw o}return n.then(o=>{for(const i of o||[])i.status==="rejected"&&r(i.reason);return e().catch(r)})};var en=Object.defineProperty,tn=(a,e,t)=>e in a?en(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,ce=(a,e,t)=>tn(a,typeof e!="symbol"?e+"":e,t);class sn{constructor(e,t,s,n={}){ce(this,"renderer"),ce(this,"scene"),ce(this,"camera"),ce(this,"composer"),ce(this,"options"),this.renderer=e,this.scene=t,this.camera=s,this.options={enableSSAO:!0,enableBloom:!0,enableFXAA:!0,enableOutlines:!1,bloomThreshold:.8,bloomStrength:.5,bloomRadius:.4,ssaoRadius:.3,ssaoMinDistance:.005,ssaoMaxDistance:.1,outlineThickness:.003,outlineColor:0,...n},this.setupPostProcessing()}async setupPostProcessing(){try{const{EffectComposer:e}=await ee(async()=>{const{EffectComposer:l}=await import("./EffectComposer-DiPw_UWQ.js");return{EffectComposer:l}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),{RenderPass:t}=await ee(async()=>{const{RenderPass:l}=await import("./RenderPass-izMPNzSc.js");return{RenderPass:l}},__vite__mapDeps([5,1,4]),import.meta.url),{ShaderPass:s}=await ee(async()=>{const{ShaderPass:l}=await import("./ShaderPass-B1yiaKM_.js");return{ShaderPass:l}},__vite__mapDeps([3,1,4]),import.meta.url),{UnrealBloomPass:n}=await ee(async()=>{const{UnrealBloomPass:l}=await import("./UnrealBloomPass-Bq7yDCkQ.js");return{UnrealBloomPass:l}},__vite__mapDeps([6,1,4,2]),import.meta.url),{SSAOPass:r}=await ee(async()=>{const{SSAOPass:l}=await import("./SSAOPass-D3mFbYdI.js");return{SSAOPass:l}},__vite__mapDeps([7,1,4,2]),import.meta.url),{FXAAShader:o}=await ee(async()=>{const{FXAAShader:l}=await import("./FXAAShader-WBPB6ysx.js");return{FXAAShader:l}},__vite__mapDeps([8,1]),import.meta.url),{OutlinePass:i}=await ee(async()=>{const{OutlinePass:l}=await import("./OutlinePass-BgQqcNOP.js");return{OutlinePass:l}},__vite__mapDeps([9,1,4,2]),import.meta.url);this.composer=new e(this.renderer);const c=new t(this.scene,this.camera);if(this.composer.addPass(c),this.options.enableSSAO){const l=new r(this.scene,this.camera,window.innerWidth,window.innerHeight);l.kernelRadius=this.options.ssaoRadius,l.minDistance=this.options.ssaoMinDistance,l.maxDistance=this.options.ssaoMaxDistance,this.composer.addPass(l)}if(this.options.enableBloom){const l=new n(new Ie(window.innerWidth,window.innerHeight),this.options.bloomStrength,this.options.bloomRadius,this.options.bloomThreshold);this.composer.addPass(l)}if(this.options.enableOutlines){const l=new i(new Ie(window.innerWidth,window.innerHeight),this.scene,this.camera);l.edgeStrength=3,l.edgeGlow=.5,l.edgeThickness=this.options.outlineThickness,l.pulsePeriod=2,l.visibleEdgeColor.setHex(this.options.outlineColor),l.hiddenEdgeColor.setHex(1640965),this.composer.addPass(l)}if(this.options.enableFXAA){const l=new s(o);l.material.uniforms.resolution.value.x=1/window.innerWidth,l.material.uniforms.resolution.value.y=1/window.innerHeight,this.composer.addPass(l)}}catch(e){console.warn("Post-processing effects not available:",e),this.composer=null}}render(){this.composer?this.composer.render():this.renderer.render(this.scene,this.camera)}resize(e,t){this.composer&&(this.composer.setSize(e,t),this.composer.passes.forEach(s=>{s.material&&s.material.uniforms&&s.material.uniforms.resolution&&(s.material.uniforms.resolution.value.x=1/e,s.material.uniforms.resolution.value.y=1/t)}))}setOutlineObjects(e){if(this.composer&&this.options.enableOutlines){const t=this.composer.passes.find(s=>s.constructor.name==="OutlinePass");t&&(t.selectedObjects=e)}}updateOptions(e){if(this.options={...this.options,...e},this.composer){const t=this.composer.passes.find(r=>r.constructor.name==="UnrealBloomPass");t&&(t.threshold=this.options.bloomThreshold,t.strength=this.options.bloomStrength,t.radius=this.options.bloomRadius);const s=this.composer.passes.find(r=>r.constructor.name==="SSAOPass");s&&(s.kernelRadius=this.options.ssaoRadius,s.minDistance=this.options.ssaoMinDistance,s.maxDistance=this.options.ssaoMaxDistance);const n=this.composer.passes.find(r=>r.constructor.name==="OutlinePass");n&&(n.edgeThickness=this.options.outlineThickness,n.visibleEdgeColor.setHex(this.options.outlineColor))}}dispose(){this.composer&&this.composer.dispose()}}var nn=Object.defineProperty,rn=(a,e,t)=>e in a?nn(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,Me=(a,e,t)=>rn(a,typeof e!="symbol"?e+"":e,t);class Fe{static createWireframe(e,t={}){const s={...this.DEFAULT_WIREFRAME_OPTIONS,...t};let n;switch(s.mode){case"edges":n=new Re(e,15);break;case"silhouette":n=this.createSilhouetteGeometry(e);break;case"basic":default:n=new Gt(e);break}const r=new qe({color:s.color,opacity:s.opacity,transparent:s.opacity<1,linewidth:s.lineWidth,depthTest:s.depthTest}),o=new Ke(n,r);return o.renderOrder=s.renderOrder,o}static createSelectionOutline(e,t={}){const s={...this.DEFAULT_OUTLINE_OPTIONS,...t},n=new _,r=new O(e.geometry,e.material);r.position.copy(e.position),r.rotation.copy(e.rotation),r.scale.copy(e.scale),r.userData={...e.userData};const o=new be({color:s.color,side:we,transparent:!0,opacity:.8}),i=new O(e.geometry,o);if(i.position.copy(e.position),i.rotation.copy(e.rotation),i.scale.copy(e.scale).multiplyScalar(1+s.thickness),i.renderOrder=-1,n.add(i),n.add(r),s.glow){const c=new be({color:s.color,transparent:!0,opacity:.3,side:we}),l=new O(e.geometry,c);l.position.copy(e.position),l.rotation.copy(e.rotation),l.scale.copy(e.scale).multiplyScalar(1+s.thickness*2),l.renderOrder=-2,n.add(l)}return s.pulse&&(n.pulseOptions=s,n.startTime=Date.now()),n.__isOutlineGroup=!0,n}static updatePulsingOutlines(e){const t=Date.now();e.forEach(s=>{const n=s.pulseOptions,r=s.startTime;if(n&&r){const o=(t-r)/1e3,i=(Math.sin(o*Math.PI*2/n.pulsePeriod)+1)/2;s.children.forEach(c=>{if(c instanceof O&&c.material instanceof be){const l=c.material;l.side===we&&(l.opacity=.5+i*.3)}})}})}static createSilhouetteGeometry(e){return new Re(e,30)}static createEnhancedMaterial(e,t={}){const s=new G({color:e,side:Ne});return t.wireframeOverlay&&(s.wireframeOverlay=!0),s}static toggleWireframeMode(e,t){e.traverse(s=>{s instanceof O&&(t?Array.isArray(s.material)?s.material.forEach(n=>{n instanceof G&&(n.wireframe=!0)}):s.material instanceof G&&(s.material.wireframe=!0):Array.isArray(s.material)?s.material.forEach(n=>{n instanceof G&&(n.wireframe=!1)}):s.material instanceof G&&(s.material.wireframe=!1))})}static createEdgeHighlight(e,t=16777215,s=2){const n=new Re(e,10),r=new qe({color:t,linewidth:s,transparent:!0,opacity:.9,depthTest:!1}),o=new Ke(n,r);return o.renderOrder=999,o}}Me(Fe,"DEFAULT_WIREFRAME_OPTIONS",{enabled:!0,color:4210752,opacity:.8,lineWidth:1,mode:"edges",depthTest:!0,renderOrder:1});Me(Fe,"DEFAULT_OUTLINE_OPTIONS",{color:65280,thickness:.005,glow:!0,animated:!1,pulse:!0,pulsePeriod:2});class on{constructor(){Me(this,"selectedObjects",new Set),Me(this,"outlineGroups",new Map)}isOutlineGroup(e){return e.__isOutlineGroup===!0}isChildOfOutlineGroup(e){let t=e.parent;for(;t;){if(t.__isOutlineGroup===!0)return!0;t=t.parent}return!1}selectObject(e,t){if(!this.selectedObjects.has(e)&&!(this.isOutlineGroup(e)||this.isChildOfOutlineGroup(e))&&(this.selectedObjects.add(e),e instanceof O)){const s=Fe.createSelectionOutline(e,t);s.__isOutlineGroup=!0,this.outlineGroups.set(e,s);const n=e.parent;n&&(n.remove(e),n.add(s))}}deselectObject(e){if(!this.selectedObjects.has(e))return;this.selectedObjects.delete(e);const t=this.outlineGroups.get(e);if(t&&e instanceof O){const s=t.parent;s&&(s.remove(t),s.add(e)),this.outlineGroups.delete(e)}}clearSelection(){Array.from(this.selectedObjects).forEach(t=>this.deselectObject(t))}updateAnimations(){const e=Array.from(this.outlineGroups.values());Fe.updatePulsingOutlines(e)}getSelectedObjects(){return Array.from(this.selectedObjects)}deleteObject(e){if(!this.selectedObjects.has(e))return!1;const t=this.outlineGroups.get(e);if(t&&e instanceof O){const s=t.parent;s&&(s.remove(t),t.traverse(n=>{n instanceof O&&(n.geometry&&n.geometry.dispose(),n.material&&(Array.isArray(n.material)?n.material.forEach(r=>r.dispose()):n.material.dispose()))})),this.outlineGroups.delete(e)}else{const s=e.parent;s&&s.remove(e)}return e.traverse(s=>{s instanceof O&&(s.geometry&&s.geometry.dispose(),s.material&&(Array.isArray(s.material)?s.material.forEach(n=>n.dispose()):s.material.dispose()))}),this.selectedObjects.delete(e),!0}}var an=Object.defineProperty,cn=(a,e,t)=>e in a?an(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,K=(a,e,t)=>cn(a,typeof e!="symbol"?e+"":e,t);class ln{constructor(){K(this,"treePanel",null),K(this,"treeContent",null),K(this,"currentScene",null),K(this,"threeScene",null),K(this,"selectedNodeId",null),K(this,"onNodeSelect"),K(this,"collapsedNodes",new Set),K(this,"isInitialLoad",!0),this.initializeUI()}initializeUI(){if(this.treePanel=document.getElementById("sceneTreePanel"),this.treeContent=document.getElementById("sceneTreeRoot"),!this.treePanel||!this.treeContent){console.error("Scene tree UI elements not found");return}this.setupEventListeners()}setupEventListeners(){document.getElementById("showSceneTree")?.addEventListener("click",()=>{this.togglePanel()}),document.getElementById("closeTreePanel")?.addEventListener("click",()=>{this.hidePanel()}),document.getElementById("toggleTreePanel")?.addEventListener("click",()=>{this.toggleCollapse()}),document.getElementById("refreshSceneTree")?.addEventListener("click",()=>{this.refresh()})}setScene(e,t){this.currentScene=e,this.threeScene=t,this.buildTree()}setNodeSelectCallback(e){this.onNodeSelect=e}showPanel(){this.treePanel&&(this.treePanel.style.display="block",this.refresh())}hidePanel(){this.treePanel&&(this.treePanel.style.display="none")}togglePanel(){this.treePanel&&(this.treePanel.style.display==="none"||!this.treePanel.style.display?this.showPanel():this.hidePanel())}toggleCollapse(){this.treePanel&&this.treePanel.classList.toggle("collapsed")}refresh(){if(this.currentScene&&this.threeScene){const e=this.selectedNodeId;this.saveCollapseState(),this.isInitialLoad=!1,this.buildTree(),this.restoreCollapseState(),e&&this.restoreSelection(e)}}restoreSelection(e){const t=this.treeContent?.querySelector(`[data-node-id="${e}"]`);t?(this.selectedNodeId=e,t.classList.add("selected")):this.selectedNodeId=null}saveCollapseState(){if(this.collapsedNodes.clear(),!this.treeContent)return;this.treeContent.querySelectorAll(".tree-children.collapsed").forEach(t=>{const s=t.closest(".tree-node");if(s){const n=s.querySelector(".tree-item");if(n){const r=n.getAttribute("data-node-id");r&&this.collapsedNodes.add(r)}}})}restoreCollapseState(){this.treeContent&&this.collapsedNodes.forEach(e=>{const t=this.treeContent.querySelector(`[data-node-id="${e}"]`);if(t){const s=t.closest(".tree-node");if(s){const n=s.querySelector(".tree-children"),r=s.querySelector(".tree-toggle");n&&r&&(n.classList.add("collapsed"),r.textContent="")}}})}buildTree(){if(!this.currentScene||!this.treeContent)return;this.treeContent.innerHTML="";const e=this.createTreeNodeFromCIF(this.currentScene.root);if(e){const t=this.createTreeElement(e,!0);this.treeContent.appendChild(t)}this.isInitialLoad&&(this.isInitialLoad=!1)}createTreeNodeFromCIF(e){const t={id:e.id,name:e.name||"Unnamed",type:"children"in e?"group":"primitive",visible:e.visible,locked:e.locked,cifObject:e,children:[]};if("type"in e&&(t.primitiveType=e.type),this.threeScene&&(t.object=this.findThreeObjectByCifId(this.threeScene,e.id)),"children"in e)for(const s of e.children){const n=this.createTreeNodeFromCIF(s);t.children.push(n)}return t}findThreeObjectByCifId(e,t){if(e.userData.cifId===t)return e;for(const s of e.children){const n=this.findThreeObjectByCifId(s,t);if(n)return n}}createTreeElement(e,t=!1){const s=document.createElement("div");s.className="tree-node";const n=document.createElement("div");n.className=`tree-item ${e.type}`,n.dataset.nodeId=e.id;const r=document.createElement("div");if(r.className="tree-toggle",e.type==="group"&&e.children.length>0){const c=this.isInitialLoad&&!t&&!this.collapsedNodes.has(e.id),l=this.collapsedNodes.has(e.id);r.textContent=c||l?"":"",r.addEventListener("click",u=>{u.stopPropagation(),this.toggleNode(s)})}else r.textContent="";n.appendChild(r);const o=document.createElement("div");o.className="tree-icon",o.textContent=this.getNodeIcon(e),n.appendChild(o);const i=document.createElement("div");if(i.className="tree-label",i.textContent=e.name,n.appendChild(i),e.type==="group"&&e.children.length>0){const c=document.createElement("div");c.className="tree-stats",c.textContent=`(${e.children.length})`,n.appendChild(c)}if(n.addEventListener("click",c=>{c.stopPropagation(),this.selectNode(e)}),s.appendChild(n),e.children.length>0){const c=document.createElement("div");c.className="tree-children";const l=this.isInitialLoad&&!t&&!this.collapsedNodes.has(e.id),u=this.collapsedNodes.has(e.id);(l||u)&&(c.classList.add("collapsed"),l&&this.collapsedNodes.add(e.id));for(const d of e.children){const p=this.createTreeElement(d,!1);c.appendChild(p)}s.appendChild(c)}return s}getNodeIcon(e){if(e.type==="group")return"";switch(e.primitiveType){case"triangle":return"";case"quad":return"";case"cube":return"";case"revolution":return"";case"mesh":return"";default:return""}}toggleNode(e){const t=e.querySelector(".tree-children"),s=e.querySelector(".tree-toggle"),n=e.querySelector(".tree-item");if(t&&s&&n){const r=n.getAttribute("data-node-id"),o=t.classList.contains("collapsed");t.classList.toggle("collapsed"),s.textContent=t.classList.contains("collapsed")?"":"",r&&(o?this.collapsedNodes.delete(r):this.collapsedNodes.add(r))}}selectNode(e){this.selectedNodeId&&this.treeContent?.querySelector(`[data-node-id="${this.selectedNodeId}"]`)?.classList.remove("selected"),this.selectedNodeId=e.id,this.treeContent?.querySelector(`[data-node-id="${e.id}"]`)?.classList.add("selected"),this.onNodeSelect&&this.onNodeSelect(e)}selectNodeById(e){if(this.selectedNodeId===e)return;const t=s=>{if(s.id===e)return s;for(const n of s.children){const r=t(n);if(r)return r}return null};if(this.currentScene){const s=this.createTreeNodeFromCIF(this.currentScene.root),n=t(s);n&&this.selectNode(n)}}expandToNode(e){const t=this.findPathToNode(e);for(const s of t){const n=this.treeContent?.querySelector(`[data-node-id="${s}"]`)?.closest(".tree-node");if(n){const r=n.querySelector(".tree-children"),o=n.querySelector(".tree-toggle");r&&o&&(r.classList.remove("collapsed"),o.textContent="")}}}findPathToNode(e){const t=(s,n)=>{const r=[...n,s.id];if(s.id===e)return r;for(const o of s.children){const i=t(o,r);if(i)return i}return null};if(this.currentScene){const s=this.createTreeNodeFromCIF(this.currentScene.root);return t(s,[])||[]}return[]}}const J=new ln,un=new Ge,dn=new Ks,Z=document.getElementById("drop"),I=new Ce;let R=null,$=null,me=null,ge=null,Be=null,F=null;const B=new Set;let se=!1;const Q=[],hn=10;document.body.addEventListener("dragover",a=>{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy",Z&&(Z.style.backgroundColor="#e8f5e8",Z.style.borderColor="#4CAF50")});document.body.addEventListener("dragleave",a=>{Z&&!Z.contains(a.relatedTarget)&&(Z.style.backgroundColor="",Z.style.borderColor="")});async function ye(a){try{if(!R){P("No scene loaded to export","error");return}const e=pn()||"Convertifer3d",t=await dn.exportScene(R,{format:a,fileName:e}),s=t.data instanceof ArrayBuffer?new Blob([t.data],{type:t.mimeType}):new Blob([t.data],{type:t.mimeType});Qt(s,t.fileName),P(`${a.toUpperCase()} file exported successfully!`,"success")}catch(e){console.error("Export error:",e),P(`Error exporting ${a.toUpperCase()} file`,"error")}}document.getElementById("exportSV")?.addEventListener("click",()=>ye("sv"));document.getElementById("exportOBJ")?.addEventListener("click",()=>ye("obj"));document.getElementById("exportDBACV")?.addEventListener("click",()=>ye("dbacv"));document.getElementById("exportCIF")?.addEventListener("click",()=>ye("cif"));document.getElementById("exportGLB")?.addEventListener("click",()=>ye("glb"));document.getElementById("file_upload")?.addEventListener("change",a=>{const e=a;e.target.files&&yt(a,e.target.files)});document.body.addEventListener("drop",a=>{a.stopPropagation(),a.preventDefault(),Z&&(Z.style.backgroundColor="",Z.style.borderColor=""),a.dataTransfer?.files&&yt(a,a.dataTransfer.files)});function pn(){if(R?.metadata.originalFileName)return R.metadata.originalFileName.replace(/\.[^/.]+$/,"");let a="Convertifer3d";return I.traverse(e=>{if(e.userData.originalFileName){a=e.userData.originalFileName.replace(/\.[^/.]+$/,"");return}}),a}async function yt(a,e){if(a.stopPropagation(),a.preventDefault(),e.length===0){P("No file selected","error");return}const t=e[0],s=Ge.validateFile(t);if(!s.valid){P(s.error,"error");return}const n=fn(t.name);P(`Loading ${n.toUpperCase()} file...`,"info");try{const r=await Ge.readFile(t),o=await un.processFile(r,t.name);if(o.cifScene)R=o.cifScene,mn(o.cifScene),P(`File loaded successfully! Objects: ${o.metadata.objectCount} (${o.metadata.processingTime.toFixed(1)}ms)`,"success");else throw new Error("No scene data generated from file")}catch(r){console.error("File processing error:",r),P(r instanceof Error?r.message:"Error loading file. Please check the file format.","error")}}function fn(a){return a.split(".").pop()?.toLowerCase()||""}function mn(a){bt(I),I.clear(),B.clear(),se=!1,R=a,Se.onSelectionChange=t=>{Ye(t)},Se.onDelete=t=>{"removeNode"in J&&J.removeNode(t.id)};const e=a.root.render();I.add(e),xt(),J.setScene(a,I),J.setNodeSelectCallback(t=>{t.cifObject&&wt(t.cifObject)})}function xt(){const a=new Ut(75,window.innerWidth/window.innerHeight,.1,1e3),e=new Ht({antialias:!0,alpha:!0,powerPreference:"high-performance"});me=e,ge=a,e.shadowMap.enabled=!0,e.shadowMap.type=jt,e.toneMapping=Vt,e.toneMappingExposure=1.5,e.outputColorSpace=lt,e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(Math.min(window.devicePixelRatio,2));const t=document.getElementById("drop");t&&(t.style.display="none"),I.background=new U(15790320);const s=document.querySelector("canvas");s&&s.remove(),document.body.appendChild(e.domElement);const n=new Kt(a,e.domElement,I);$=new sn(e,I,a,{enableSSAO:!1,enableBloom:!1,enableFXAA:!0,enableOutlines:!1,bloomThreshold:.8,bloomStrength:.3,bloomRadius:.4}),n.addEventListener("change",()=>{a.up=new g(0,0,1),$?$.render():e.render(I,a)});const r=new Te().setFromObject(I);if(r.isEmpty())a.position.set(-30,-30,30),a.lookAt(0,0,0);else{const w=r.getCenter(new g),v=r.getSize(new g),E=Math.max(v.x,v.y,v.z),z=a.fov*(Math.PI/180);let j=Math.abs(E/2/Math.tan(z/2));j*=2,a.position.set(w.x-j,w.y-j,w.z+j),a.lookAt(w)}a.up=new g(0,0,1),n.update();const o=new Wt,i=new Ie;let c=null;if(!I.getObjectByName("axes")){const w=new Zt(5);w.name="axes",I.add(w)}function u(w){i.x=w.clientX/window.innerWidth*2-1,i.y=-(w.clientY/window.innerHeight)*2+1,o.setFromCamera(i,a);const v=o.intersectObjects(I.children,!0);if(c&&c instanceof O){const E=c.userData.originalMaterial;E&&(c.material=E,delete c.userData.originalMaterial),c=null}if(v.length>0){const j=v[0].object.userData.cifObject?.getThreeObject();if(j instanceof O&&j!==c){c=j;const L=c;L.userData.originalMaterial=L.material,L.material=L.material.clone(),L.material instanceof G&&L.material.emissive.setHex(4473924)}}document.body.style.cursor=c?"pointer":"default"}if(Be=new on,!I.getObjectByName("ambientLight")){const w=new Yt(8421504,.8);w.name="ambientLight",I.add(w)}if(!I.getObjectByName("directionalLight")){const w=new Je(16777215,1.2);w.position.set(10,10,5),w.name="directionalLight",I.add(w)}if(!I.getObjectByName("fillLight")){const w=new Je(16777215,.7);w.position.set(-10,5,-5),w.name="fillLight",I.add(w)}function h(w){i.x=w.clientX/window.innerWidth*2-1,i.y=-(w.clientY/window.innerHeight)*2+1,o.setFromCamera(i,a);const v=o.intersectObjects(I.children,!0);if(v.length>0){const E=v[0].object,z=gn(E,w);z?F===z?ue():wt(z):ue()}else ue()}const m=window.onPointerMoveHandler;m&&window.removeEventListener("pointermove",m);const y=window.onPointerClickHandler;y&&window.removeEventListener("click",y),window.onPointerMoveHandler=u,window.onPointerClickHandler=h,window.addEventListener("pointermove",u),window.addEventListener("click",h);function b(){a.aspect=window.innerWidth/window.innerHeight,a.updateProjectionMatrix(),e.setSize(window.innerWidth,window.innerHeight),$&&$.resize(window.innerWidth,window.innerHeight)}const A=window.onWindowResizeHandler;A&&window.removeEventListener("resize",A),window.onWindowResizeHandler=b,window.addEventListener("resize",b);function x(){requestAnimationFrame(x),n.update(),Be&&Be?.updateAnimations(),$?$.render():e.render(I,a)}$?$.render():e.render(I,a),x()}function P(a,e="info"){let t=document.getElementById("notification");t||(t=document.createElement("div"),t.id="notification",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            transition: opacity 0.3s ease;
        `,document.body.appendChild(t));const s={success:"#4CAF50",error:"#f44336",info:"#2196F3"};t.style.backgroundColor=s[e],t.textContent=a,t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},5e3)}function bt(a){a.traverse(e=>{if(e instanceof O){const t=e;t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(s=>s.dispose()):t.material.dispose())}})}function gn(a,e){if(a.userData.cifObject){let s=a.userData.cifObject;if(e.shiftKey&&s.parentId){let n=R?.findById(s.parentId);for(;n&&n.parentId;){const r=R?.findById(n.parentId);if(r)n=r;else break}n instanceof k&&(s=n)}else if(e.ctrlKey&&s.parentId){const n=R?.findById(s.parentId);n instanceof k&&(s=n)}return s}let t=a.parent;for(;t&&t!==I;){if(t.userData.cifObject)return t.userData.cifObject;t=t.parent}return null}function wt(a){ue(),F=a,a.select(),J.selectNodeById(a.id),J.expandToNode(a.id)}function ue(){F&&(F.deselect(),F=null,vt())}function Ye(a){const e=vn(a);Tn(e)}function He(){ue()}function yn(){if(Q.length===0){P("Nothing to undo","info");return}if(!R){P("No scene available for undo","error");return}const a=Q.pop(),{cifObject:e,parentId:t,childIndex:s,objectName:n,objectType:r}=a;try{let o;if(t){const d=R.findById(t);if(!d||!("children"in d))throw new Error(`Parent object with ID ${t} not found or is not a group`);o=d}else o=R.root;const i=e.name,c=e.clone();c.name=i,c.parentId=t||void 0,s>=0&&s<=o.children.length?o.children.splice(s,0,c):o.children.push(c);const l=c.render();let u;if(t){const p=R.findById(t)?.getThreeObject();p instanceof _?u=p:u=I.children[0]}else u=I.children[0];u?u.add(l):I.add(l),$?$.render():me&&ge&&me.render(I,ge),Oe(),J.refresh(),P(`${r} "${n}" restored successfully`,"success")}catch(o){console.error("Error during undo operation:",o),P(`Failed to restore ${r} "${n}": ${o}`,"error"),Q.push(a),Oe()}}function Oe(){const a=document.getElementById("undoDelete");a&&(Q.length>0?(a.removeAttribute("disabled"),a.textContent=`Undo Delete (${Q.length})`):(a.setAttribute("disabled","true"),a.textContent="Undo Delete"))}function xn(a){const e=document.getElementById("objectInfoPanel"),t=document.getElementById("objectInfoDetails");if(!e||!t)return;const s=An(a),n=a instanceof _;t.innerHTML=`
        <div><strong>Name:</strong> ${s.name}</div>
        <div><strong>Type:</strong> ${s.type}</div>
        ${n?`<div><strong>Children:</strong> ${s.children} meshes</div>`:""}
        <div><strong>Position:</strong> ${s.position}</div>
        <div><strong>Rotation:</strong> ${s.rotation}</div>
        <div><strong>Scale:</strong> ${s.scale}</div>
        <div><strong>Vertices:</strong> ${s.vertices}</div>
        <div><strong>Faces:</strong> ${s.faces}</div>
        ${s.material?`<div><strong>Material${n?"s":""}:</strong> ${s.material}</div>`:""}
        ${s.cifType?`<div><strong>CIF Type:</strong> ${s.cifType}</div>`:""}
        ${s.surfaceType?`
            <div>
                <strong>Surface Type:</strong>
                <select id="surfaceTypeSelector">
                    <option value="listen" ${s.surfaceType==="listen"?"selected":""}>Listen</option>
                    <option value="obstacle" ${s.surfaceType==="obstacle"?"selected":""}>Obstacle</option>
                    <option value="structure" ${s.surfaceType==="structure"?"selected":""}>Structure</option>
                </select>
            </div>
        `:""}
        <div class="solo-controls">
            <button id="soloButton" class="solo-btn ${B.has(a)?"active":""}">${B.has(a)?"Un-Solo":"Solo"}</button>
            ${se?'<button id="clearSoloButton" class="clear-solo-btn">Clear All Solo</button>':""}
        </div>
    `;const r=e._clickHandler;r&&e.removeEventListener("click",r);const o=document.getElementById("surfaceTypeSelector");o&&o.addEventListener("change",u=>{const d=u.target.value;bn(a,d)});const i=document.getElementById("soloButton");i&&i.addEventListener("click",u=>{u.stopPropagation(),Tt(a)});const c=document.getElementById("clearSoloButton");c&&c.addEventListener("click",u=>{u.stopPropagation(),At()});const l=u=>{u.stopPropagation()};e.addEventListener("click",l),e._clickHandler=l,e.style.display="block"}function bn(a,e){if(a.userData.surfaceType=e,R&&a.userData.cifId){const t=M.findObjectById(R.root,a.userData.cifId);t&&"surfaceType"in t&&(t.surfaceType=e)}a instanceof _&&a.traverse(t=>{if(t!==a&&t.userData.cifId&&(t.userData.surfaceType=e,R)){const s=M.findObjectById(R.root,t.userData.cifId);s&&"surfaceType"in s&&(s.surfaceType=e)}}),P(`Surface type updated to "${e}"`,"success")}function wn(a,e){"surfaceType"in a&&(a.surfaceType=e);const t=a.getThreeObject();t&&(t.userData.surfaceType=e),a instanceof k&&a.traverse(s=>{if(s!==a&&"surfaceType"in s){s.surfaceType=e;const n=s.getThreeObject();n&&(n.userData.surfaceType=e)}}),P(`Surface type updated to "${e}"`,"success")}function vt(){const a=document.getElementById("objectInfoPanel");if(a){const e=a._clickHandler;e&&(a.removeEventListener("click",e),delete a._clickHandler),a.style.display="none"}}function vn(a){const e={name:a.name||`${a.constructor.name} (${a.id})`,type:a instanceof k?"CIF Group":`CIF ${a.type}`,position:`${a.transform.position.x.toFixed(2)}, ${a.transform.position.y.toFixed(2)}, ${a.transform.position.z.toFixed(2)}`,rotation:`${(a.transform.rotation.x*180/Math.PI).toFixed(1)}, ${(a.transform.rotation.y*180/Math.PI).toFixed(1)}, ${(a.transform.rotation.z*180/Math.PI).toFixed(1)}`,scale:`${a.transform.scale.x.toFixed(2)}, ${a.transform.scale.y.toFixed(2)}, ${a.transform.scale.z.toFixed(2)}`,cifId:a.id,visible:a.visible,locked:a.locked};if(a instanceof k){e.childCount=a.children.length;let t=0,s=0;a.traverse(n=>{n instanceof de?(t+=3,s+=1):n instanceof he?(t+=4,s+=2):n instanceof pe&&(t+=n.vertices.length,s+=n.faces.length)}),e.vertices=t.toString(),e.faces=s.toString()}else{const t=a;"surfaceType"in t&&(e.surfaceType=t.surfaceType,e.materialColor=`#${t.material.color.getHexString()}`),a instanceof de?(e.vertices="3",e.faces="1"):a instanceof he?(e.vertices="4",e.faces="2"):a instanceof pe&&(e.vertices=a.vertices.length.toString(),e.faces=a.faces.length.toString())}return e}function Tn(a){const e=document.getElementById("objectInfoPanel"),t=document.getElementById("objectInfoDetails");if(!e||!t)return;let s="";for(const[l,u]of Object.entries(a)){if(l==="cifId")continue;const d=l.charAt(0).toUpperCase()+l.slice(1).replace(/([A-Z])/g," $1");l==="surfaceType"?s+=`
                <div>
                    <strong>Surface Type:</strong>
                    <select id="surfaceTypeSelector">
                        <option value="listen" ${u==="listen"?"selected":""}>Listen</option>
                        <option value="obstacle" ${u==="obstacle"?"selected":""}>Obstacle</option>
                        <option value="structure" ${u==="structure"?"selected":""}>Structure</option>
                    </select>
                </div>
            `:s+=`<div><strong>${d}:</strong> ${u}</div>`}if(F&&F.getThreeObject()){const l=F.getThreeObject();s+=`
            <div class="solo-controls">
                <button id="soloButton" class="solo-btn ${B.has(l)?"active":""}">${B.has(l)?"Un-Solo":"Solo"}</button>
                ${se?'<button id="clearSoloButton" class="clear-solo-btn">Clear All Solo</button>':""}
            </div>
        `}t.innerHTML=s;const n=document.getElementById("surfaceTypeSelector");n&&F&&n.addEventListener("change",l=>{const u=l.target.value;wn(F,u)});const r=document.getElementById("soloButton");if(r&&F&&F.getThreeObject()){const l=F.getThreeObject();r.addEventListener("click",u=>{u.stopPropagation(),Tt(l)})}const o=document.getElementById("clearSoloButton");o&&o.addEventListener("click",l=>{l.stopPropagation(),At()});const i=e._clickHandler;i&&e.removeEventListener("click",i);const c=l=>{l.stopPropagation()};e.addEventListener("click",c),e._clickHandler=c,e.style.display="block"}function An(a){let e=a.name;(!e||e.trim()==="")&&(a.userData.cifType?(e=`${a.userData.cifType.charAt(0).toUpperCase()+a.userData.cifType.slice(1)}`,a.userData.cifId&&(e+=` (${a.userData.cifId})`)):(e=`${a.type}`,a.userData.cifId&&(e+=` (${a.userData.cifId})`)));const t={name:e,type:a.type,position:`${a.position.x.toFixed(2)}, ${a.position.y.toFixed(2)}, ${a.position.z.toFixed(2)}`,rotation:`${(a.rotation.x*180/Math.PI).toFixed(1)}, ${(a.rotation.y*180/Math.PI).toFixed(1)}, ${(a.rotation.z*180/Math.PI).toFixed(1)}`,scale:`${a.scale.x.toFixed(2)}, ${a.scale.y.toFixed(2)}, ${a.scale.z.toFixed(2)}`,vertices:"N/A",faces:"N/A"};if(a instanceof _){let s=0,n=0,r=0;const o=new Set;a.traverse(i=>{i instanceof O&&i.geometry&&(r++,i.geometry.attributes.position&&(s+=i.geometry.attributes.position.count||0),i.geometry.index&&(n+=Math.floor(i.geometry.index.count/3)),i.material&&(Array.isArray(i.material)?i.material.forEach(c=>o.add(c.type)):o.add(i.material.type)))}),t.children=r.toString(),t.vertices=s>0?s.toString():"N/A",t.faces=n>0?n.toString():"N/A",t.material=o.size>0?Array.from(o).join(", "):"N/A"}else if(a instanceof O&&a.geometry){const s=a.geometry;if(s.attributes.position&&(t.vertices=(s.attributes.position.count||0).toString()),s.index&&(t.faces=Math.floor(s.index.count/3).toString()),a.material)if(Array.isArray(a.material))t.material=`Multiple (${a.material.length})`;else if(a.material instanceof G){const n=a.material.color;t.material=`Standard (#${n.getHexString()})`}else t.material=a.material.type}return a.userData.cifType&&(t.cifType=a.userData.cifType),a.userData.surfaceType&&(t.surfaceType=a.userData.surfaceType),t}function In(){const a=document.getElementById("objectInfoPanel");a&&a.classList.toggle("collapsed")}document.addEventListener("keydown",a=>{if(a.ctrlKey||a.metaKey)switch(a.key.toLowerCase()){case"o":a.preventDefault(),document.getElementById("file_upload")?.click();break;case"s":a.preventDefault(),document.getElementById("exportOBJ")?.click();break;case"t":a.preventDefault(),En();break}else switch(a.key){case"Delete":case"Backspace":a.preventDefault(),F&&It();break;case"Escape":a.preventDefault(),He();break}});function En(){bt(I),I.clear();const a=new Qe(2,2,2),e=new G({color:16007990}),t=new O(a,e);t.name="Red Cube",t.position.set(-3,0,0),t.userData.cifId="test-cube-1",t.userData.cifType="cube",I.add(t);const s=new Xt(1.5,32,32),n=new G({color:5025616}),r=new O(s,n);r.name="Green Sphere",r.position.set(3,0,0),r.userData.cifId="test-sphere-1",r.userData.cifType="sphere",I.add(r);const o=new _;o.name="Test Group",o.userData.cifId="test-group-1",o.userData.cifType="group",o.position.set(0,0,3);const i=new qt(1,1,3,16),c=new G({color:2201331}),l=new O(i,c);l.name="",l.userData.cifId="test-cylinder-1",l.userData.cifType="cylinder";const u=new O(new Qe(.5,.5,.5),new G({color:16771899}));u.name="Small Yellow Cube",u.position.set(1,2,0),u.userData.cifId="test-small-cube-1",u.userData.cifType="cube",o.add(l),o.add(u),I.add(o),xt(),P("Test scene loaded: Click objects to select meshes. Ctrl+Click for groups. Shift+Click for root groups.","info")}function Tt(a){B.has(a)?(B.delete(a),B.size===0?(se=!1,Xe()):ct()):(B.add(a),se=!0,ct()),F&&F.getThreeObject()===a?Ye(F):xn(a),P(B.has(a)?`"${a.name}" soloed`:`"${a.name}" un-soloed`,"info")}function At(){B.clear(),se=!1,Xe(),F&&Ye(F),P("All solo cleared","info")}function ct(){if(!se||B.size===0){Xe();return}const a=new Set;B.forEach(t=>{t.traverse(n=>{a.add(n)});let s=t.parent;for(;s&&s!==I;)a.add(s),s=s.parent;if(t.userData.cifId){const n=t.name?.split("_")[0]||"";I.traverse(r=>{if(r instanceof _&&r.userData.cifId&&!a.has(r)){const o=r.name||"",i=o.split("_")[0]||o;let c=!1;n&&i&&(n.toLowerCase().includes(i.toLowerCase())||i.toLowerCase().includes(n.toLowerCase()))&&(c=!0),(o.toLowerCase().includes("root")||o.toLowerCase().includes("group")||o.toLowerCase().includes("container")||o.toLowerCase()==="scene")&&(c=!0),c&&a.add(r)}})}}),I.traverse(t=>{t instanceof _&&(!t.name||t.name==="")&&!a.has(t)&&t.parent&&a.has(t.parent)&&a.add(t)});const e=new Te;B.forEach(t=>{const s=new Te().setFromObject(t);e.union(s)}),I.traverse(t=>{if(t instanceof O&&(!t.name||t.name==="")&&!a.has(t)&&!t.userData.cifId){const s=new Te().setFromObject(t),n=s.getCenter(new g);(e.intersectsBox(s)||e.distanceToPoint(n)<5)&&a.add(t)}}),I.traverse(t=>{t===I||t.name==="axes"||t.type.includes("Light")||(t instanceof O||t instanceof _)&&(t.visible=a.has(t))})}function Xe(){I.traverse(a=>{a!==I&&(a instanceof O||a instanceof _)&&(a.visible=!0)})}function It(){if(!F||!R)return;const a=F instanceof k?"group":"object",e=F.name||"unnamed "+a,t=F.parentId;let s=null,n=-1;if(t?(s=R.findById(t),s&&"children"in s&&(n=s.children.findIndex(r=>r.id===F.id))):(s=R.root,n=s.children.findIndex(r=>r.id===F.id)),!s||n===-1){P(`Failed to locate ${a} "${e}" in scene hierarchy`,"error");return}try{const r=F.clone();r.name=F.name;const o={cifObject:r,parentId:t??null,childIndex:n,objectName:e,objectType:a},i=F.getThreeObject();s.children.splice(n,1),i&&i.parent&&(i.parent.remove(i),F.dispose()),F.deselect(),F=null,$?$.render():me&&ge&&me.render(I,ge),Q.push(o),Q.length>hn&&Q.shift().cifObject.dispose(),Oe(),J.refresh(),vt(),P(`${a} "${e}" deleted successfully`,"success")}catch(r){console.error("Error during deletion:",r),P(`Failed to delete ${a} "${e}": ${r}`,"error")}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("toggleInfoPanel")?.addEventListener("click",()=>{In()}),document.getElementById("closeInfoPanel")?.addEventListener("click",()=>{He()}),document.getElementById("deleteObject")?.addEventListener("click",()=>{F&&confirm("Are you sure you want to delete this object?")&&It()}),document.getElementById("undoDelete")?.addEventListener("click",()=>{yn()}),document.getElementById("deselectObject")?.addEventListener("click",()=>{He()}),Oe()});
