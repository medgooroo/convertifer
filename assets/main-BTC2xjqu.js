const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./EffectComposer-DiPw_UWQ.js","./three-D29c9MRG.js","./CopyShader-B0dke3by.js","./ShaderPass-B1yiaKM_.js","./Pass-DIKeR8G_.js","./RenderPass-izMPNzSc.js","./UnrealBloomPass-Bq7yDCkQ.js","./SSAOPass-D3mFbYdI.js","./FXAAShader-WBPB6ysx.js","./OutlinePass-BgQqcNOP.js"])))=>i.map(i=>d[i]);
import{V as k,e as Qe,g as fe,G as Fe,h as le,i as Gt,j as $t,k as Pe,D as Qt,C as Be,a as Vt,l as Et,M as Ht,Q as Er,m as Ir,N as Sr,b as vn,n as Cr,P as Wt,I as Mr,o as Yt,p as sr,q as kr,r as Fr,s as Or,t as zr,u as Nr,v as Rr,w as Lr,x as Dr,y as Pr,z as Br,W as Ur,A as tn,L as Mn,F as kn,H as Gr,J as $r,K as Hr,O as Zr,B as Zt,R as jr,T as Vr,U as Wr,X as Fn,Y as On,Z as Yr,_ as Kr}from"./three-D29c9MRG.js";import{A as Xr}from"./controls-CG9ErnIQ.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();function et(l){return l*Math.PI/180}function It(l){return(l*180/Math.PI+360)%360}function en(l){const e=new Float32Array(l.length);let t=0;for(let n=0;n<l.length/9;n++){const r=new k().fromArray(l,n*9),s=new k().fromArray(l,n*9+3),i=new k().fromArray(l,n*9+6),a=new k().subVectors(r,s),c=new k().subVectors(r,i),u=new k().crossVectors(a,c);u.normalize();for(let d=0;d<3;d++)e[t++]=u.x,e[t++]=u.y,e[t++]=u.z}return e}function qr(l,e){const t=window.URL.createObjectURL(l),n=document.createElement("a");n.style.display="none",n.href=t,n.setAttribute("download",e),typeof n.download>"u"&&n.setAttribute("target","_blank"),document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>{window.URL.revokeObjectURL(t)},100)}function ir(l,e){const t=new Qe,n=[];for(const i of e)if(i.length===3)for(const a of i)n.push(l[a*3],l[a*3+1],l[a*3+2]);else if(i.length===4){const[a,c,u,d]=i;n.push(l[a*3],l[a*3+1],l[a*3+2],l[c*3],l[c*3+1],l[c*3+2],l[u*3],l[u*3+1],l[u*3+2]),n.push(l[u*3],l[u*3+1],l[u*3+2],l[d*3],l[d*3+1],l[d*3+2],l[a*3],l[a*3+1],l[a*3+2])}const r=new Float32Array(n);t.setAttribute("position",new fe(r,3));const s=en(r);return t.setAttribute("normal",new fe(s,3)),t}var Jr=Object.defineProperty,Qr=(l,e,t)=>e in l?Jr(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,J=(l,e,t)=>Qr(l,typeof e!="symbol"?e+"":e,t);const _n=class yn{constructor(e,t,n){J(this,"id"),J(this,"name"),J(this,"transform"),J(this,"visible"),J(this,"locked"),J(this,"parentId"),J(this,"userData"),J(this,"_threeObject"),J(this,"_isSelected",!1),J(this,"_selectionOutline"),this.id=e,this.name=t,this.transform=n||re.createDefaultTransform(),this.visible=!0,this.locked=!1}getThreeObject(){return this._threeObject}updateTransform(){this._threeObject&&(this._threeObject.position.copy(this.transform.position),this._threeObject.rotation.setFromVector3(this.transform.rotation),this._threeObject.scale.copy(this.transform.scale))}setVisible(e){this.visible=e,this._threeObject&&(this._threeObject.visible=e)}select(){this._isSelected||(this._isSelected=!0,this.createSelectionOutline(),yn.onSelectionChange?.(this))}deselect(){this._isSelected&&(this._isSelected=!1,this.removeSelectionOutline())}isSelected(){return this._isSelected}delete(){this.deselect(),this.dispose(),yn.onDelete?.(this)}createSelectionOutline(){if(!(!this._threeObject||this._selectionOutline)&&(this._selectionOutline=new Fe,this._threeObject instanceof le)){const e=new Gt({color:65280,side:$t,transparent:!0,opacity:.8}),t=new le(this._threeObject.geometry,e);t.renderOrder=-1,this._selectionOutline.add(t),this._selectionOutline.position.copy(this._threeObject.position),this._selectionOutline.rotation.copy(this._threeObject.rotation),this._selectionOutline.scale.copy(this._threeObject.scale),this._selectionOutline.scale.multiplyScalar(1.02),this._threeObject.parent?.add(this._selectionOutline)}}removeSelectionOutline(){this._selectionOutline&&(this._selectionOutline.parent?.remove(this._selectionOutline),this._selectionOutline.traverse(e=>{e instanceof le&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()))}),this._selectionOutline=void 0)}applyTransform(e){e.position.copy(this.transform.position),e.rotation.setFromVector3(this.transform.rotation),e.scale.copy(this.transform.scale)}createThreeMaterial(e){return new Pe({color:e.color,opacity:e.opacity,transparent:e.transparent||e.opacity<1,side:Qt,flatShading:!1,toneMapped:!0})}};J(_n,"onSelectionChange");J(_n,"onDelete");let Kt=_n;class ot extends Kt{constructor(e,t,n,r,s){super(e,t,s),J(this,"type"),J(this,"surfaceType"),J(this,"material"),this.type=n,this.surfaceType="structure",this.material=r}render(){if(!this._threeObject){const e=this.createGeometry(),t=this.createThreeMaterial(this.material);this._threeObject=new le(e,t),this._threeObject.name=this.name,this._threeObject.userData.cifObject=this,this._threeObject.userData.cifId=this.id,this._threeObject.userData.cifType=this.type,this._threeObject.userData.surfaceType=this.surfaceType,this._threeObject.visible=this.visible,this.applyTransform(this._threeObject)}return this._threeObject}dispose(){this.removeSelectionOutline(),this._threeObject instanceof le&&(this._threeObject.geometry&&this._threeObject.geometry.dispose(),this._threeObject.material&&(Array.isArray(this._threeObject.material)?this._threeObject.material.forEach(e=>e.dispose()):this._threeObject.material.dispose())),this._threeObject=void 0}}class Ft extends ot{constructor(e,t,n,r,s){super(e,t,"triangle",r,s),J(this,"vertices"),J(this,"normals"),J(this,"uvs"),this.vertices=n}createGeometry(){const e=new Qe,t=new Float32Array(9);for(let n=0;n<3;n++){const r=this.vertices[n];t[n*3]=r.x,t[n*3+1]=r.y,t[n*3+2]=r.z}if(e.setAttribute("position",new fe(t,3)),this.normals){const n=new Float32Array(9);for(let r=0;r<3;r++){const s=this.normals[r];n[r*3]=s.x,n[r*3+1]=s.y,n[r*3+2]=s.z}e.setAttribute("normal",new fe(n,3))}else{const n=en(t);e.setAttribute("normal",new fe(n,3))}if(this.uvs){const n=new Float32Array(6);for(let r=0;r<3;r++){const s=this.uvs[r];n[r*2]=s.x,n[r*2+1]=s.y}e.setAttribute("uv",new fe(n,2))}return e}clone(){return new Ft(re.generateId(),this.name+" (Copy)",[this.vertices[0].clone(),this.vertices[1].clone(),this.vertices[2].clone()],{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Ot extends ot{constructor(e,t,n,r,s){super(e,t,"quad",r,s),J(this,"vertices"),J(this,"normals"),J(this,"uvs"),this.vertices=n}createGeometry(){const e=new Qe,t=[0,1,2,2,3,0],n=new Float32Array(12);for(let s=0;s<4;s++){const i=this.vertices[s];n[s*3]=i.x,n[s*3+1]=i.y,n[s*3+2]=i.z}const r=new Float32Array(18);for(let s=0;s<6;s++){const i=t[s];r[s*3]=n[i*3],r[s*3+1]=n[i*3+1],r[s*3+2]=n[i*3+2]}if(e.setAttribute("position",new fe(r,3)),this.normals){const s=new Float32Array(18);for(let i=0;i<6;i++){const a=t[i],c=this.normals[a];s[i*3]=c.x,s[i*3+1]=c.y,s[i*3+2]=c.z}e.setAttribute("normal",new fe(s,3))}else{const s=en(r);e.setAttribute("normal",new fe(s,3))}if(this.uvs){const s=new Float32Array(12);for(let i=0;i<6;i++){const a=t[i],c=this.uvs[a];s[i*2]=c.x,s[i*2+1]=c.y}e.setAttribute("uv",new fe(s,2))}return e}clone(){return new Ot(re.generateId(),this.name+" (Copy)",[this.vertices[0].clone(),this.vertices[1].clone(),this.vertices[2].clone(),this.vertices[3].clone()],{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class wn extends ot{constructor(e,t,n,r,s){super(e,t,"cube",r,s),J(this,"vertices"),this.vertices=n}createGeometry(){const e=new Qe,t=[[0,1,2],[2,3,0],[4,7,6],[6,5,4],[0,4,5],[5,1,0],[2,6,7],[7,3,2],[0,3,7],[7,4,0],[1,5,6],[6,2,1]],n=[];for(const i of t)for(const a of i){const c=this.vertices[a];n.push(c.x,c.y,c.z)}const r=new Float32Array(n);e.setAttribute("position",new fe(r,3));const s=en(r);return e.setAttribute("normal",new fe(s,3)),e}clone(){return new wn(re.generateId(),this.name+" (Copy)",this.vertices.map(e=>e.clone()),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Tn extends ot{constructor(e,t,n,r,s){super(e,t,"revolution",r,s),J(this,"profile"),J(this,"axis"),J(this,"startAngle"),J(this,"endAngle"),J(this,"segments"),J(this,"closed"),this.profile=n,this.axis=new k(0,0,1),this.startAngle=0,this.endAngle=Math.PI*2,this.segments=32,this.closed=!0}createGeometry(){if(this.profile.length<2)return console.warn("Revolution profile must have at least 2 points"),new Qe;const e=this.endAngle-this.startAngle,t=[],n=[];for(let s=0;s<=this.segments;s++){const i=this.startAngle+e*s/this.segments,a=Math.cos(i),c=Math.sin(i);for(const u of this.profile){const d=u.x*a-u.y*c,p=u.x*c+u.y*a,m=u.z;t.push(d,p,m)}}const r=this.profile.length;for(let s=0;s<this.segments;s++)for(let i=0;i<r-1;i++){const a=s*r+i,c=s*r+i+1,u=(s+1)*r+i+1,d=(s+1)*r+i;n.push([a,c,u]),n.push([u,d,a])}return ir(t,n)}clone(){const e=new Tn(re.generateId(),this.name+" (Copy)",this.profile.map(t=>t.clone()),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()});return e.axis=this.axis.clone(),e.startAngle=this.startAngle,e.endAngle=this.endAngle,e.segments=this.segments,e.closed=this.closed,e}}class zt extends ot{constructor(e,t,n,r,s,i){super(e,t,"mesh",s,i),J(this,"vertices"),J(this,"faces"),J(this,"normals"),J(this,"uvs"),this.vertices=n,this.faces=r}createGeometry(){const e=[];for(const t of this.vertices)e.push(t.x,t.y,t.z);return ir(e,this.faces)}clone(){return new zt(re.generateId(),this.name+" (Copy)",this.vertices.map(e=>e.clone()),this.faces.map(e=>[...e]),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Me extends Kt{constructor(e,t,n){super(e,t,n),J(this,"children"),this.children=[]}addChild(e){if(e.parentId=this.id,this.children.push(e),this._threeObject&&this._threeObject instanceof Fe){const t=e.render();this._threeObject.add(t)}}removeChild(e){const t=this.children.indexOf(e);if(t!==-1&&(this.children.splice(t,1),e.parentId=void 0,this._threeObject)){const n=e.render();n&&this._threeObject.remove(n)}}render(){if(!this._threeObject){this._threeObject=new Fe,this._threeObject.name=this.name,this._threeObject.userData.cifObject=this,this._threeObject.userData.cifId=this.id,this._threeObject.userData.cifType="group",this._threeObject.visible=this.visible,this.applyTransform(this._threeObject);for(const e of this.children){const t=e.render();this._threeObject.add(t)}}return this._threeObject}clone(){const e=new Me(re.generateId(),this.name+" (Copy)",{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()});for(const t of this.children)e.addChild(t.clone());return e}dispose(){this.removeSelectionOutline();for(const e of this.children)e.dispose();this._threeObject=void 0}traverse(e){e(this);for(const t of this.children)t instanceof Me?t.traverse(e):e(t)}findById(e){if(this.id===e)return this;for(const t of this.children){if(t.id===e)return t;if(t instanceof Me){const n=t.findById(e);if(n)return n}}return null}}class es{constructor(e){J(this,"metadata"),J(this,"root"),J(this,"materials"),J(this,"units"),J(this,"coordinateSystem"),J(this,"upAxis"),this.metadata={created:new Date,version:"2.0",...e},this.root=new Me(re.generateId(),"Root"),this.materials=new Map,this.units="meters",this.coordinateSystem="right-handed",this.upAxis="z"}render(){return this.root.render()}findById(e){return this.root.findById(e)}addToRoot(e){this.root.addChild(e)}dispose(){this.root.dispose(),this.materials.clear()}}class re{static createDefaultTransform(){return{position:new k(0,0,0),rotation:new k(0,0,0),scale:new k(1,1,1)}}static createDefaultMaterial(e="default",t=13421772){return{name:e,color:new Be(t),opacity:1,transparent:!1}}static generateId(){return"cif_"+Math.random().toString(36).substr(2,9)+"_"+Date.now().toString(36)}static createScene(e){return new es(e)}static findObjectById(e,t){return e.findById(t)}static getAllOfType(e,t){const n=[];return e.traverse(r=>{r instanceof t&&n.push(r)}),n}static addToGroup(e,t){e.addChild(t)}static validateScene(e){const t=[];return e.root||t.push("Scene must have a root group"),e.materials.size===0&&console.warn("Scene has no materials defined"),e.root.traverse(n=>{n.id||t.push(`Object ${n.name||"unnamed"} has no ID`),n.name||t.push(`Object ${n.id} has no name`),n instanceof ot&&(n.material||t.push(`Primitive ${n.name} has no material`))}),{valid:t.length===0,errors:t}}}var ts=Object.defineProperty,ns=(l,e,t)=>e in l?ts(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,zn=(l,e,t)=>ns(l,typeof e!="symbol"?e+"":e,t);class St{constructor(e){zn(this,"scene"),zn(this,"currentGroup"),this.scene=re.createScene(e),this.currentGroup=this.scene.root}setUnits(e){return this.scene.units=e,this}setCoordinateSystem(e){return this.scene.coordinateSystem=e,this}setUpAxis(e){return this.scene.upAxis=e,this}addMaterial(e,t){const n={...re.createDefaultMaterial(),...t};return this.scene.materials.set(e,n),this}getMaterial(e){return this.scene.materials.get(e)}beginGroup(e){const t=new Me(re.generateId(),e,re.createDefaultTransform());return t.parentId=this.currentGroup.id,re.addToGroup(this.currentGroup,t),this.currentGroup=t,this}endGroup(){if(this.currentGroup.parentId){const e=re.findObjectById(this.scene.root,this.currentGroup.parentId);e&&"children"in e&&(this.currentGroup=e)}return this}setTransform(e){return Object.assign(this.currentGroup.transform,e),this}translate(e,t,n){return this.currentGroup.transform.position.set(e,t,n),this}rotate(e,t,n){return this.currentGroup.transform.rotation.set(e,t,n),this}scale(e,t,n){return this.currentGroup.transform.scale.set(e,t,n),this}addTriangle(e,t,n,r={}){[e,t,n].forEach((a,c)=>{if(!a||isNaN(a.x)||isNaN(a.y)||isNaN(a.z)||!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z))throw new Error(`Invalid vertex at index ${c}: ${a?`(${a.x}, ${a.y}, ${a.z})`:"null/undefined"}`)});const s=this.resolveMaterial(r.materialId,r.material),i=new Ft(re.generateId(),r.name||"Triangle",[e.clone(),t.clone(),n.clone()],s,{...re.createDefaultTransform(),...r.transform});return i.surfaceType=r.surfaceType||"structure",i.parentId=this.currentGroup.id,r.normals&&(i.normals=[r.normals[0].clone(),r.normals[1].clone(),r.normals[2].clone()]),r.uvs&&(i.uvs=[...r.uvs]),re.addToGroup(this.currentGroup,i),this}addQuad(e,t,n,r,s={}){[e,t,n,r].forEach((c,u)=>{if(!c||isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||!isFinite(c.x)||!isFinite(c.y)||!isFinite(c.z))throw new Error(`Invalid vertex at index ${u}: ${c?`(${c.x}, ${c.y}, ${c.z})`:"null/undefined"}`)});const i=this.resolveMaterial(s.materialId,s.material),a=new Ot(re.generateId(),s.name||"Quad",[e.clone(),t.clone(),n.clone(),r.clone()],i,{...re.createDefaultTransform(),...s.transform});return a.surfaceType=s.surfaceType||"structure",a.parentId=this.currentGroup.id,s.normals&&(a.normals=[s.normals[0].clone(),s.normals[1].clone(),s.normals[2].clone(),s.normals[3].clone()]),s.uvs&&(a.uvs=[...s.uvs]),re.addToGroup(this.currentGroup,a),this}addCube(e,t={}){const n=this.resolveMaterial(t.materialId,t.material),r=new wn(re.generateId(),t.name||"Cube",e.map(s=>s.clone()),n,{...re.createDefaultTransform(),...t.transform});return r.surfaceType=t.surfaceType||"structure",r.parentId=this.currentGroup.id,re.addToGroup(this.currentGroup,r),this}addRevolution(e,t={}){const n=this.resolveMaterial(t.materialId,t.material),r=new Tn(re.generateId(),t.name||"Revolution",e.map(s=>s.clone()),n,{...re.createDefaultTransform(),...t.transform});return r.surfaceType=t.surfaceType||"structure",r.axis=t.axis?.clone()||new k(0,0,1),r.startAngle=t.startAngle||0,r.endAngle=t.endAngle||Math.PI*2,r.segments=t.segments||32,r.closed=t.closed!==!1,r.parentId=this.currentGroup.id,re.addToGroup(this.currentGroup,r),this}addMesh(e,t,n={}){const r=e.filter((a,c)=>{const u=!a||isNaN(a.x)||isNaN(a.y)||isNaN(a.z)||!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z);return u&&console.error(`Invalid vertex at index ${c}: ${a?`(${a.x}, ${a.y}, ${a.z})`:"null/undefined"}`),u});if(r.length>0&&r.length>0)throw new Error(`Found ${r.length} invalid vertices out of ${e.length}`);t.forEach((a,c)=>{a.forEach((u,d)=>{if(u<0||u>=e.length)throw new Error(`Invalid vertex index ${u} at position ${d} in face ${c}. Valid range is 0-${e.length-1}`)})});const s=this.resolveMaterial(n.materialId,n.material),i=new zt(re.generateId(),n.name||"Mesh",e.map(a=>a.clone()),t.map(a=>[...a]),s,{...re.createDefaultTransform(),...n.transform});return i.surfaceType=n.surfaceType||"structure",i.parentId=this.currentGroup.id,n.normals&&(i.normals=n.normals.map(a=>a.clone())),n.uvs&&(i.uvs=[...n.uvs]),re.addToGroup(this.currentGroup,i),this}addRectangle(e,t,n={}){const r=n.center||new k(0,0,0),s=e/2,i=t/2;return this.addQuad(new k(r.x-s,r.y-i,r.z),new k(r.x+s,r.y-i,r.z),new k(r.x+s,r.y+i,r.z),new k(r.x-s,r.y+i,r.z),{name:n.name||"Rectangle",materialId:n.materialId,material:n.material,transform:n.transform,surfaceType:n.surfaceType})}addCircle(e,t=32,n={}){const r=[new k(e,0,0),new k(0,0,0)];return this.addRevolution(r,{name:n.name||"Circle",materialId:n.materialId,material:n.material,transform:n.transform,segments:t,axis:new k(0,0,1),surfaceType:n.surfaceType})}addArc(e,t,n,r,s={}){const i=[new k(t,0,0),new k(e,0,0)];return this.addRevolution(i,{name:s.name||"Arc",materialId:s.materialId,material:s.material,transform:s.transform,startAngle:n,endAngle:r,segments:s.segments||32,closed:!1,axis:new k(0,0,1),surfaceType:s.surfaceType})}build(){this.currentGroup=this.scene.root;const e=re.validateScene(this.scene);return e.valid||console.warn("CIF Scene validation failed:",e.errors),this.scene}resolveMaterial(e,t){if(e&&this.scene.materials.has(e))return this.scene.materials.get(e);if(t){const r={...re.createDefaultMaterial(),...t},s=`material_${this.scene.materials.size}`;return this.scene.materials.set(s,r),r}const n="default";return this.scene.materials.has(n)||this.scene.materials.set(n,re.createDefaultMaterial()),this.scene.materials.get(n)}}var rs=Object.defineProperty,ss=(l,e,t)=>e in l?rs(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,is=(l,e,t)=>ss(l,e+"",t);const or=class jt{static getMaterialByCategory(e){return jt.MATERIALS.find(n=>n.category===e)||null}static getRandomMaterial(){const e=Math.floor(Math.random()*jt.MATERIALS.length);return jt.MATERIALS[e]}static createVariationOfMaterial(e,t=.1){const n=e.color.clone();return n.r=Math.max(0,Math.min(1,n.r+(Math.random()-.5)*t)),n.g=Math.max(0,Math.min(1,n.g+(Math.random()-.5)*t)),n.b=Math.max(0,Math.min(1,n.b+(Math.random()-.5)*t)),{...e,name:`${e.name} (Variant)`,color:n}}static getGradientMaterials(e,t,n){const r=[];for(let s=0;s<n;s++){const i=s/(n-1),a=new Be().lerpColors(e.color,t.color,i),c=e.opacity+(t.opacity-e.opacity)*i;r.push({name:`Gradient ${s+1}`,color:a,opacity:c,transparent:c<1,category:e.category})}return r}};is(or,"MATERIALS",[{name:"Audience Seating",color:new Be(14483456),opacity:1,transparent:!1,category:"audience"},{name:"Stage Platform",color:new Be(17152),opacity:1,transparent:!1,category:"stage"},{name:"Structural Wall",color:new Be(54016),opacity:1,transparent:!1,category:"structural"},{name:"imag Panel",color:new Be(4251856),opacity:.4,transparent:!0,category:"structural"}]);let st=or;function os(l){const e=l.toLowerCase();return e.includes("audience")||e.includes("seating")||e.includes("seat")||e.includes("chair")?st.getMaterialByCategory("audience")||st.getRandomMaterial():e.includes("stage")&&(e.includes("platform")||e.includes("floor")||e.includes("deck"))||e.includes("platform")&&(e.includes("stage")||e.includes("performance"))||e.includes("performance area")?st.getMaterialByCategory("stage")||st.getRandomMaterial():(e.includes("wall")||e.includes("ceiling")||e.includes("floor")||e.includes("structure")||e.includes("beam")||e.includes("column"),st.getMaterialByCategory("structural")||st.getRandomMaterial())}var as=Object.defineProperty,cs=(l,e,t)=>e in l?as(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,nn=(l,e,t)=>cs(l,typeof e!="symbol"?e+"":e,t);class ls{constructor(e={}){nn(this,"options"),nn(this,"groupColors",new Map),nn(this,"usedColors",new Set),this.options={preserveOriginalColors:e.preserveOriginalColors??!0,enableGroupColoring:e.enableGroupColoring??!0,variationAmount:e.variationAmount||.05}}getMaterialForObject(e,t,n,r){if(this.options.preserveOriginalColors&&t!==void 0){const s=this.normalizeColor(t);if(!this.isDefaultColor(s))return this.createMaterialFromColor(s,e)}return this.options.enableGroupColoring&&n?this.getMaterialForGroup(n,e,r):this.getContextBasedMaterial(e,r)}getMaterialForGroup(e,t,n){if(!this.groupColors.has(e)){const i=this.getContextBasedMaterial(e,n);this.groupColors.set(e,{baseColor:i.color.clone(),materialDef:i,memberCount:0,lastVariation:0})}const r=this.groupColors.get(e);r.memberCount++;const s=this.createGroupMemberVariation(r.materialDef,r.memberCount,t);return{name:s.name,color:s.color.clone(),opacity:s.opacity,transparent:s.transparent}}createGroupMemberVariation(e,t,n){const r=st.createVariationOfMaterial(e,this.options.variationAmount*.5),s=t*.03%.1,i=this.rgbToHsv(r.color);return i.h=(i.h+s)%1,r.color=this.hsvToRgb(i),r.name=`${e.name} (${n})`,r}getContextBasedMaterial(e,t){let n=os(e);return t&&(n=this.adjustMaterialForSurfaceType(n,t)),n}adjustMaterialForSurfaceType(e,t){const n={...e};switch(t){case"listen":n.color=this.adjustColorTemperature(e.color,.1);break;case"obstacle":n.color=this.adjustColorTemperature(e.color,-.1);break}return n}createMaterialFromColor(e,t){return{name:`${t} Material`,color:e.clone(),opacity:1,transparent:!1}}normalizeColor(e){return typeof e=="number"?new Be(e):e.clone()}isDefaultColor(e){const t=[8947848,8421504,12632256,16777215,0],n=e.getHex();return t.includes(n)}adjustColorTemperature(e,t){const n=e.clone();return t>0?(n.r=Math.min(1,n.r+t),n.b=Math.max(0,n.b-t*.5)):(n.r=Math.max(0,n.r+t),n.b=Math.min(1,n.b-t*.5)),n}rgbToHsv(e){const t=e.r,n=e.g,r=e.b,s=Math.max(t,n,r),i=Math.min(t,n,r),a=s-i;let c=0;const u=s===0?0:a/s,d=s;return a!==0&&(s===t?c=(n-r)/a%6:s===n?c=(r-t)/a+2:c=(t-n)/a+4,c/=6,c<0&&(c+=1)),{h:c,s:u,v:d}}hsvToRgb({h:e,s:t,v:n}){const r=n*t,s=r*(1-Math.abs(e*6%2-1)),i=n-r;let a=0,c=0,u=0;return e>=0&&e<1/6?(a=r,c=s,u=0):e>=1/6&&e<2/6?(a=s,c=r,u=0):e>=2/6&&e<3/6?(a=0,c=r,u=s):e>=3/6&&e<4/6?(a=0,c=s,u=r):e>=4/6&&e<5/6?(a=s,c=0,u=r):(a=r,c=0,u=s),new Be(a+i,c+i,u+i)}reset(){this.groupColors.clear(),this.usedColors.clear()}getColorStats(){const e=Array.from(this.groupColors.values()).reduce((t,n)=>t+n.memberCount,0);return{totalGroups:this.groupColors.size,totalObjects:e}}}function Nt(l,e={}){const n={...{obj:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.2},dbacv:{preserveOriginalColors:!0,enableGroupColoring:!0,variationAmount:.1},fc3:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.15},cvf:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.15},general:{preserveOriginalColors:!0,enableGroupColoring:!0,variationAmount:.15}}[l],...e};return new ls(n)}class K{static parseFloat(e,t,n=0){const r=e.getAttribute(t);if(!r)return n;const s=parseFloat(r);return isNaN(s)?n:s}static parseInt(e,t,n=0){const r=e.getAttribute(t);if(!r)return n;const s=parseInt(r,10);return isNaN(s)?n:s}static parseString(e,t,n=""){return e.getAttribute(t)||n}static parseBoolean(e,t,n=!1){const r=e.getAttribute(t);return r?r.toLowerCase()==="true"||r==="1":n}static parseVector3(e,t,n,r,s=new k(0,0,0)){const i=K.parseFloat(e,t,s.x),a=K.parseFloat(e,n,s.y),c=K.parseFloat(e,r,s.z);return new k(i,a,c)}static parseVector3FromCSV(e,t,n=new k(0,0,0)){const r=e.getAttribute(t);if(!r)return n.clone();const s=r.split(",").map(i=>parseFloat(i.trim()));return s.length!==3||s.some(isNaN)?n.clone():new k(s[0],s[1],s[2])}static parseRotationDegToRad(e,t,n,r,s=new k(0,0,0)){const i=K.parseFloat(e,t,s.x*180/Math.PI)*Math.PI/180,a=K.parseFloat(e,n,s.y*180/Math.PI)*Math.PI/180,c=K.parseFloat(e,r,s.z*180/Math.PI)*Math.PI/180;return new k(i,a,c)}static getChildrenByTagName(e,t){return Array.from(e.getElementsByTagName(t))}static getFirstChildByTagName(e,t){const n=e.getElementsByTagName(t);return n.length>0?n[0]:null}static getChildTextContent(e,t,n=""){return K.getFirstChildByTagName(e,t)?.textContent||n}static hasAttribute(e,t){return e.hasAttribute(t)}static getAttributeCaseInsensitive(e,t,n=""){let r=e.getAttribute(t);return r!==null||(r=e.getAttribute(t.toLowerCase()),r!==null)||(r=e.getAttribute(t.toUpperCase()),r!==null)?r:n}static getElementsByTagNameCaseInsensitive(e,t){let n=Array.from(e.getElementsByTagName(t));return n.length>0||(n=Array.from(e.getElementsByTagName(t.toLowerCase()))),n}static getFirstChildByTagNameCaseInsensitive(e,t){const n=K.getElementsByTagNameCaseInsensitive(e,t);return n.length>0?n[0]:null}static parseHexColor(e,t,n=16777215){const r=e.getAttribute(t);if(!r)return n;const s=r.replace(/^(#|0x)/,""),i=parseInt(s,16);return isNaN(i)?n:i}}class us{convert(e,t){const n=new St({originalFormat:"dbacv",originalFileName:t,author:"D&B ArrayCalc",comments:"Converted from DBACV format"});n.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const r=Nt("dbacv"),s=new DOMParser().parseFromString(e,"application/xml"),i=K.getElementsByTagNameCaseInsensitive(s,"RoomObject");for(let a=0;a<i.length;a++){const c=i[a];K.getAttributeCaseInsensitive(c,"Shape")!=="5"&&this.processRoomObject(c,n,r)}return n.build()}processRoomObject(e,t,n){const r=K.getAttributeCaseInsensitive(e,"Shape"),s=K.getAttributeCaseInsensitive(e,"Name","Unnamed"),i=this.parseColor(K.getAttributeCaseInsensitive(e,"Color")),a=i!==8947848?new Be(i):void 0,c=n.getMaterialForObject(s,a,"dbacv_objects",this.extractSurfaceType(e));K.getAttributeCaseInsensitive(e,"Transparent")==="1"&&(c.opacity=.8,c.transparent=!0);const u=this.extractSurfaceType(e),d=this.extractOriginFromObjectAndGroup(e),p=this.extractZRotation(e);switch(r){case"1":this.createQuadPrimitive(e,t,s,c,d,p,u);break;case"2":this.createArcSegment(e,t,s,c,d,p,!1,u);break;case"3":this.createArcSegment(e,t,s,c,d,p,!0,u);break;case"4":this.createCube(e,t,s,c,d,p,u);break;case"6":this.createTrianglePrimitive(e,t,s,c,d,p,u);break}}createTrianglePrimitive(e,t,n,r,s,i,a){const c=this.extractVertices(e,3);c.length===3&&this.isValidGeometry(c)&&t.addTriangle(c[0],c[1],c[2],{name:n,material:r,surfaceType:a,transform:{position:s,rotation:new k(0,0,i)}})}createQuadPrimitive(e,t,n,r,s,i,a){const c=this.extractVertices(e,4);c.length===4&&this.isValidGeometry(c)&&t.addQuad(c[0],c[1],c[2],c[3],{name:n,material:r,surfaceType:a,transform:{position:s,rotation:new k(0,0,i)}})}createCube(e,t,n,r,s,i,a){const c=this.extractVertices(e,8);c.length===8&&this.isValidGeometry(c)&&t.addCube(c,{name:n,material:r,surfaceType:a,transform:{position:s,rotation:new k(0,0,i)}})}createArcSegment(e,t,n,r,s,i,a,c){let u,d,p,m;if(a){u=K.parseFloat(e,"InnerA"),d=K.parseFloat(e,"OuterA");const M=K.parseFloat(e,"InnerB"),R=K.parseFloat(e,"OuterB");p=isNaN(M)?u:M,m=isNaN(R)?d:R}else u=K.parseFloat(e,"InnerRadiusA"),d=K.parseFloat(e,"OuterRadiusA"),p=u,m=d;const v=et(K.parseFloat(e,"StartAngle")),y=et(K.parseFloat(e,"SpanAngle")),S=parseFloat(K.getAttributeCaseInsensitive(e,"InnerZ","0")),_=parseFloat(K.getAttributeCaseInsensitive(e,"OuterZ","0"));if(a){const M=K.parseFloat(e,"InnerN"),R=K.parseFloat(e,"OuterN"),O=isNaN(M)?2:M,F=isNaN(R)?2:R,$=Math.abs(y)*180/Math.PI,j=Math.max(8,Math.ceil($/5)),G=[],te=[];for(let X=0;X<=j;X++){const H=v+y*X/j,W=this.superEllipsePoint(d,m,F,H);G.push(new k(W.x,W.y,_));const ue=this.superEllipsePoint(u,p,O,H);G.push(new k(ue.x,ue.y,S))}for(let X=0;X<j;X++){const H=X*2,W=X*2+1,ue=(X+1)*2,de=(X+1)*2+1;te.push([H,ue,de,W])}t.addMesh(G,te,{name:n,material:r,surfaceType:c,transform:{position:s,rotation:new k(0,0,i)}});return}const E=[new k(d,0,_),new k(u,0,S)],D=Math.abs(y)*180/Math.PI,T=Math.max(8,Math.ceil(D/5));t.addRevolution(E,{name:n,material:r,surfaceType:c,startAngle:v,endAngle:v+y,segments:T,closed:Math.abs(y)>=2*Math.PI-.01,axis:new k(0,0,1),transform:{position:s,rotation:new k(0,0,i)}})}superEllipsePoint(e,t,n,r){const s=Math.cos(r),i=Math.sin(r),a=2/n;return{x:e*Math.sign(s)*Math.pow(Math.abs(s),a),y:t*Math.sign(i)*Math.pow(Math.abs(i),a)}}extractVertices(e,t){const n=[];for(let r=1;r<=t;r++){const s=K.getFirstChildByTagNameCaseInsensitive(e,`P${r}`);if(s){const i=parseFloat(K.getAttributeCaseInsensitive(s,"x","0")),a=parseFloat(K.getAttributeCaseInsensitive(s,"y","0")),c=parseFloat(K.getAttributeCaseInsensitive(s,"z","0"));n.push(new k(i,a,c))}}return n}parseColor(e){if(!e)return 8947848;const t=parseInt(e);return isNaN(t)?8947848:t&16777215}extractZRotation(e){const t=K.getFirstChildByTagNameCaseInsensitive(e,"Rotation");if(t){const n=parseFloat(K.getAttributeCaseInsensitive(t,"z","0"));return et(n)}return 0}extractOriginFromObjectAndGroup(e){const t=K.getFirstChildByTagNameCaseInsensitive(e,"Origin"),n=new k(parseFloat(K.getAttributeCaseInsensitive(t||e,"x","0")),parseFloat(K.getAttributeCaseInsensitive(t||e,"y","0")),parseFloat(K.getAttributeCaseInsensitive(t||e,"z","0"))),r=new k(0,0,0),s=e.parentNode,i=s?K.getElementsByTagNameCaseInsensitive(s,"Origin"):[];for(let a=0;a<i.length;a++){const c=i[a].parentNode;c&&K.getAttributeCaseInsensitive(c,"ObjectGroup")==="true"&&(r.x=parseFloat(K.getAttributeCaseInsensitive(i[a],"x","0")),r.y=parseFloat(K.getAttributeCaseInsensitive(i[a],"y","0")),r.z=parseFloat(K.getAttributeCaseInsensitive(i[a],"z","0")))}return s&&K.getAttributeCaseInsensitive(s,"ObjectGroup")==="true"&&(n.x+=r.x,n.y+=r.y,n.z+=r.z),n}isValidGeometry(e){if(e.length<2)return!1;const t=e[0],n=1e-6;for(let r=1;r<e.length;r++)if(t.distanceTo(e[r])>n)return!0;return!1}extractSurfaceType(e){const t=K.getAttributeCaseInsensitive(e,"PlaneType"),n=parseFloat(K.getAttributeCaseInsensitive(e,"ListenerHeight","0"));if(t==="1"&&n>1)return"listen";if(t==="4"||n<.1)return"structure";const r=K.getAttributeCaseInsensitive(e,"Type");if(r){const i=r.toLowerCase();if(i==="listen")return"listen";if(i==="obstacle")return"obstacle";if(i==="structure")return"structure"}const s=K.getAttributeCaseInsensitive(e,"SurfaceType");if(s){const i=s.toLowerCase();if(i==="listen")return"listen";if(i==="obstacle")return"obstacle";if(i==="structure")return"structure"}return"structure"}}var rn={},Nn;function ht(){return Nn||(Nn=1,(function(l){var e=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";function t(s,i){return Object.prototype.hasOwnProperty.call(s,i)}l.assign=function(s){for(var i=Array.prototype.slice.call(arguments,1);i.length;){var a=i.shift();if(a){if(typeof a!="object")throw new TypeError(a+"must be non-object");for(var c in a)t(a,c)&&(s[c]=a[c])}}return s},l.shrinkBuf=function(s,i){return s.length===i?s:s.subarray?s.subarray(0,i):(s.length=i,s)};var n={arraySet:function(s,i,a,c,u){if(i.subarray&&s.subarray){s.set(i.subarray(a,a+c),u);return}for(var d=0;d<c;d++)s[u+d]=i[a+d]},flattenChunks:function(s){var i,a,c,u,d,p;for(c=0,i=0,a=s.length;i<a;i++)c+=s[i].length;for(p=new Uint8Array(c),u=0,i=0,a=s.length;i<a;i++)d=s[i],p.set(d,u),u+=d.length;return p}},r={arraySet:function(s,i,a,c,u){for(var d=0;d<c;d++)s[u+d]=i[a+d]},flattenChunks:function(s){return[].concat.apply([],s)}};l.setTyped=function(s){s?(l.Buf8=Uint8Array,l.Buf16=Uint16Array,l.Buf32=Int32Array,l.assign(l,n)):(l.Buf8=Array,l.Buf16=Array,l.Buf32=Array,l.assign(l,r))},l.setTyped(e)})(rn)),rn}var Tt={},Xe={},gt={},Rn;function fs(){if(Rn)return gt;Rn=1;var l=ht(),e=4,t=0,n=1,r=2;function s(g){for(var z=g.length;--z>=0;)g[z]=0}var i=0,a=1,c=2,u=3,d=258,p=29,m=256,v=m+1+p,y=30,S=19,_=2*v+1,E=15,D=16,T=7,M=256,R=16,O=17,F=18,$=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],j=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],G=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],te=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],X=512,H=new Array((v+2)*2);s(H);var W=new Array(y*2);s(W);var ue=new Array(X);s(ue);var de=new Array(d-u+1);s(de);var Y=new Array(p);s(Y);var ye=new Array(y);s(ye);function he(g,z,L,U,b){this.static_tree=g,this.extra_bits=z,this.extra_base=L,this.elems=U,this.max_length=b,this.has_stree=g&&g.length}var Ge,Re,Ae;function ge(g,z){this.dyn_tree=g,this.max_code=0,this.stat_desc=z}function ke(g){return g<256?ue[g]:ue[256+(g>>>7)]}function Te(g,z){g.pending_buf[g.pending++]=z&255,g.pending_buf[g.pending++]=z>>>8&255}function ae(g,z,L){g.bi_valid>D-L?(g.bi_buf|=z<<g.bi_valid&65535,Te(g,g.bi_buf),g.bi_buf=z>>D-g.bi_valid,g.bi_valid+=L-D):(g.bi_buf|=z<<g.bi_valid&65535,g.bi_valid+=L)}function me(g,z,L){ae(g,L[z*2],L[z*2+1])}function oe(g,z){var L=0;do L|=g&1,g>>>=1,L<<=1;while(--z>0);return L>>>1}function Ie(g){g.bi_valid===16?(Te(g,g.bi_buf),g.bi_buf=0,g.bi_valid=0):g.bi_valid>=8&&(g.pending_buf[g.pending++]=g.bi_buf&255,g.bi_buf>>=8,g.bi_valid-=8)}function $e(g,z){var L=z.dyn_tree,U=z.max_code,b=z.stat_desc.static_tree,C=z.stat_desc.has_stree,f=z.stat_desc.extra_bits,N=z.stat_desc.extra_base,V=z.stat_desc.max_length,o,A,I,h,x,w,Z=0;for(h=0;h<=E;h++)g.bl_count[h]=0;for(L[g.heap[g.heap_max]*2+1]=0,o=g.heap_max+1;o<_;o++)A=g.heap[o],h=L[L[A*2+1]*2+1]+1,h>V&&(h=V,Z++),L[A*2+1]=h,!(A>U)&&(g.bl_count[h]++,x=0,A>=N&&(x=f[A-N]),w=L[A*2],g.opt_len+=w*(h+x),C&&(g.static_len+=w*(b[A*2+1]+x)));if(Z!==0){do{for(h=V-1;g.bl_count[h]===0;)h--;g.bl_count[h]--,g.bl_count[h+1]+=2,g.bl_count[V]--,Z-=2}while(Z>0);for(h=V;h!==0;h--)for(A=g.bl_count[h];A!==0;)I=g.heap[--o],!(I>U)&&(L[I*2+1]!==h&&(g.opt_len+=(h-L[I*2+1])*L[I*2],L[I*2+1]=h),A--)}}function He(g,z,L){var U=new Array(E+1),b=0,C,f;for(C=1;C<=E;C++)U[C]=b=b+L[C-1]<<1;for(f=0;f<=z;f++){var N=g[f*2+1];N!==0&&(g[f*2]=oe(U[N]++,N))}}function ce(){var g,z,L,U,b,C=new Array(E+1);for(L=0,U=0;U<p-1;U++)for(Y[U]=L,g=0;g<1<<$[U];g++)de[L++]=U;for(de[L-1]=U,b=0,U=0;U<16;U++)for(ye[U]=b,g=0;g<1<<j[U];g++)ue[b++]=U;for(b>>=7;U<y;U++)for(ye[U]=b<<7,g=0;g<1<<j[U]-7;g++)ue[256+b++]=U;for(z=0;z<=E;z++)C[z]=0;for(g=0;g<=143;)H[g*2+1]=8,g++,C[8]++;for(;g<=255;)H[g*2+1]=9,g++,C[9]++;for(;g<=279;)H[g*2+1]=7,g++,C[7]++;for(;g<=287;)H[g*2+1]=8,g++,C[8]++;for(He(H,v+1,C),g=0;g<y;g++)W[g*2+1]=5,W[g*2]=oe(g,5);Ge=new he(H,$,m+1,v,E),Re=new he(W,j,0,y,E),Ae=new he(new Array(0),G,0,S,T)}function Oe(g){var z;for(z=0;z<v;z++)g.dyn_ltree[z*2]=0;for(z=0;z<y;z++)g.dyn_dtree[z*2]=0;for(z=0;z<S;z++)g.bl_tree[z*2]=0;g.dyn_ltree[M*2]=1,g.opt_len=g.static_len=0,g.last_lit=g.matches=0}function pt(g){g.bi_valid>8?Te(g,g.bi_buf):g.bi_valid>0&&(g.pending_buf[g.pending++]=g.bi_buf),g.bi_buf=0,g.bi_valid=0}function Ze(g,z,L,U){pt(g),Te(g,L),Te(g,~L),l.arraySet(g.pending_buf,g.window,z,L,g.pending),g.pending+=L}function Le(g,z,L,U){var b=z*2,C=L*2;return g[b]<g[C]||g[b]===g[C]&&U[z]<=U[L]}function pe(g,z,L){for(var U=g.heap[L],b=L<<1;b<=g.heap_len&&(b<g.heap_len&&Le(z,g.heap[b+1],g.heap[b],g.depth)&&b++,!Le(z,U,g.heap[b],g.depth));)g.heap[L]=g.heap[b],L=b,b<<=1;g.heap[L]=U}function Q(g,z,L){var U,b,C=0,f,N;if(g.last_lit!==0)do U=g.pending_buf[g.d_buf+C*2]<<8|g.pending_buf[g.d_buf+C*2+1],b=g.pending_buf[g.l_buf+C],C++,U===0?me(g,b,z):(f=de[b],me(g,f+m+1,z),N=$[f],N!==0&&(b-=Y[f],ae(g,b,N)),U--,f=ke(U),me(g,f,L),N=j[f],N!==0&&(U-=ye[f],ae(g,U,N)));while(C<g.last_lit);me(g,M,z)}function je(g,z){var L=z.dyn_tree,U=z.stat_desc.static_tree,b=z.stat_desc.has_stree,C=z.stat_desc.elems,f,N,V=-1,o;for(g.heap_len=0,g.heap_max=_,f=0;f<C;f++)L[f*2]!==0?(g.heap[++g.heap_len]=V=f,g.depth[f]=0):L[f*2+1]=0;for(;g.heap_len<2;)o=g.heap[++g.heap_len]=V<2?++V:0,L[o*2]=1,g.depth[o]=0,g.opt_len--,b&&(g.static_len-=U[o*2+1]);for(z.max_code=V,f=g.heap_len>>1;f>=1;f--)pe(g,L,f);o=C;do f=g.heap[1],g.heap[1]=g.heap[g.heap_len--],pe(g,L,1),N=g.heap[1],g.heap[--g.heap_max]=f,g.heap[--g.heap_max]=N,L[o*2]=L[f*2]+L[N*2],g.depth[o]=(g.depth[f]>=g.depth[N]?g.depth[f]:g.depth[N])+1,L[f*2+1]=L[N*2+1]=o,g.heap[1]=o++,pe(g,L,1);while(g.heap_len>=2);g.heap[--g.heap_max]=g.heap[1],$e(g,z),He(L,V,g.bl_count)}function xt(g,z,L){var U,b=-1,C,f=z[1],N=0,V=7,o=4;for(f===0&&(V=138,o=3),z[(L+1)*2+1]=65535,U=0;U<=L;U++)C=f,f=z[(U+1)*2+1],!(++N<V&&C===f)&&(N<o?g.bl_tree[C*2]+=N:C!==0?(C!==b&&g.bl_tree[C*2]++,g.bl_tree[R*2]++):N<=10?g.bl_tree[O*2]++:g.bl_tree[F*2]++,N=0,b=C,f===0?(V=138,o=3):C===f?(V=6,o=3):(V=7,o=4))}function at(g,z,L){var U,b=-1,C,f=z[1],N=0,V=7,o=4;for(f===0&&(V=138,o=3),U=0;U<=L;U++)if(C=f,f=z[(U+1)*2+1],!(++N<V&&C===f)){if(N<o)do me(g,C,g.bl_tree);while(--N!==0);else C!==0?(C!==b&&(me(g,C,g.bl_tree),N--),me(g,R,g.bl_tree),ae(g,N-3,2)):N<=10?(me(g,O,g.bl_tree),ae(g,N-3,3)):(me(g,F,g.bl_tree),ae(g,N-11,7));N=0,b=C,f===0?(V=138,o=3):C===f?(V=6,o=3):(V=7,o=4)}}function Ve(g){var z;for(xt(g,g.dyn_ltree,g.l_desc.max_code),xt(g,g.dyn_dtree,g.d_desc.max_code),je(g,g.bl_desc),z=S-1;z>=3&&g.bl_tree[te[z]*2+1]===0;z--);return g.opt_len+=3*(z+1)+5+5+4,z}function bt(g,z,L,U){var b;for(ae(g,z-257,5),ae(g,L-1,5),ae(g,U-4,4),b=0;b<U;b++)ae(g,g.bl_tree[te[b]*2+1],3);at(g,g.dyn_ltree,z-1),at(g,g.dyn_dtree,L-1)}function ct(g){var z=4093624447,L;for(L=0;L<=31;L++,z>>>=1)if(z&1&&g.dyn_ltree[L*2]!==0)return t;if(g.dyn_ltree[18]!==0||g.dyn_ltree[20]!==0||g.dyn_ltree[26]!==0)return n;for(L=32;L<m;L++)if(g.dyn_ltree[L*2]!==0)return n;return t}var Ke=!1;function _t(g){Ke||(ce(),Ke=!0),g.l_desc=new ge(g.dyn_ltree,Ge),g.d_desc=new ge(g.dyn_dtree,Re),g.bl_desc=new ge(g.bl_tree,Ae),g.bi_buf=0,g.bi_valid=0,Oe(g)}function lt(g,z,L,U){ae(g,(i<<1)+(U?1:0),3),Ze(g,z,L)}function Se(g){ae(g,a<<1,3),me(g,M,H),Ie(g)}function qe(g,z,L,U){var b,C,f=0;g.level>0?(g.strm.data_type===r&&(g.strm.data_type=ct(g)),je(g,g.l_desc),je(g,g.d_desc),f=Ve(g),b=g.opt_len+3+7>>>3,C=g.static_len+3+7>>>3,C<=b&&(b=C)):b=C=L+5,L+4<=b&&z!==-1?lt(g,z,L,U):g.strategy===e||C===b?(ae(g,(a<<1)+(U?1:0),3),Q(g,H,W)):(ae(g,(c<<1)+(U?1:0),3),bt(g,g.l_desc.max_code+1,g.d_desc.max_code+1,f+1),Q(g,g.dyn_ltree,g.dyn_dtree)),Oe(g),U&&pt(g)}function wt(g,z,L){return g.pending_buf[g.d_buf+g.last_lit*2]=z>>>8&255,g.pending_buf[g.d_buf+g.last_lit*2+1]=z&255,g.pending_buf[g.l_buf+g.last_lit]=L&255,g.last_lit++,z===0?g.dyn_ltree[L*2]++:(g.matches++,z--,g.dyn_ltree[(de[L]+m+1)*2]++,g.dyn_dtree[ke(z)*2]++),g.last_lit===g.lit_bufsize-1}return gt._tr_init=_t,gt._tr_stored_block=lt,gt._tr_flush_block=qe,gt._tr_tally=wt,gt._tr_align=Se,gt}var sn,Ln;function ar(){if(Ln)return sn;Ln=1;function l(e,t,n,r){for(var s=e&65535|0,i=e>>>16&65535|0,a=0;n!==0;){a=n>2e3?2e3:n,n-=a;do s=s+t[r++]|0,i=i+s|0;while(--a);s%=65521,i%=65521}return s|i<<16|0}return sn=l,sn}var on,Dn;function cr(){if(Dn)return on;Dn=1;function l(){for(var n,r=[],s=0;s<256;s++){n=s;for(var i=0;i<8;i++)n=n&1?3988292384^n>>>1:n>>>1;r[s]=n}return r}var e=l();function t(n,r,s,i){var a=e,c=i+s;n^=-1;for(var u=i;u<c;u++)n=n>>>8^a[(n^r[u])&255];return n^-1}return on=t,on}var an,Pn;function An(){return Pn||(Pn=1,an={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}),an}var Bn;function ds(){if(Bn)return Xe;Bn=1;var l=ht(),e=fs(),t=ar(),n=cr(),r=An(),s=0,i=1,a=3,c=4,u=5,d=0,p=1,m=-2,v=-3,y=-5,S=-1,_=1,E=2,D=3,T=4,M=0,R=2,O=8,F=9,$=15,j=8,G=29,te=256,X=te+1+G,H=30,W=19,ue=2*X+1,de=15,Y=3,ye=258,he=ye+Y+1,Ge=32,Re=42,Ae=69,ge=73,ke=91,Te=103,ae=113,me=666,oe=1,Ie=2,$e=3,He=4,ce=3;function Oe(o,A){return o.msg=r[A],A}function pt(o){return(o<<1)-(o>4?9:0)}function Ze(o){for(var A=o.length;--A>=0;)o[A]=0}function Le(o){var A=o.state,I=A.pending;I>o.avail_out&&(I=o.avail_out),I!==0&&(l.arraySet(o.output,A.pending_buf,A.pending_out,I,o.next_out),o.next_out+=I,A.pending_out+=I,o.total_out+=I,o.avail_out-=I,A.pending-=I,A.pending===0&&(A.pending_out=0))}function pe(o,A){e._tr_flush_block(o,o.block_start>=0?o.block_start:-1,o.strstart-o.block_start,A),o.block_start=o.strstart,Le(o.strm)}function Q(o,A){o.pending_buf[o.pending++]=A}function je(o,A){o.pending_buf[o.pending++]=A>>>8&255,o.pending_buf[o.pending++]=A&255}function xt(o,A,I,h){var x=o.avail_in;return x>h&&(x=h),x===0?0:(o.avail_in-=x,l.arraySet(A,o.input,o.next_in,x,I),o.state.wrap===1?o.adler=t(o.adler,A,x,I):o.state.wrap===2&&(o.adler=n(o.adler,A,x,I)),o.next_in+=x,o.total_in+=x,x)}function at(o,A){var I=o.max_chain_length,h=o.strstart,x,w,Z=o.prev_length,P=o.nice_match,B=o.strstart>o.w_size-he?o.strstart-(o.w_size-he):0,ne=o.window,nt=o.w_mask,ve=o.prev,se=o.strstart+ye,we=ne[h+Z-1],Ce=ne[h+Z];o.prev_length>=o.good_match&&(I>>=2),P>o.lookahead&&(P=o.lookahead);do if(x=A,!(ne[x+Z]!==Ce||ne[x+Z-1]!==we||ne[x]!==ne[h]||ne[++x]!==ne[h+1])){h+=2,x++;do;while(ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&ne[++h]===ne[++x]&&h<se);if(w=ye-(se-h),h=se-ye,w>Z){if(o.match_start=A,Z=w,w>=P)break;we=ne[h+Z-1],Ce=ne[h+Z]}}while((A=ve[A&nt])>B&&--I!==0);return Z<=o.lookahead?Z:o.lookahead}function Ve(o){var A=o.w_size,I,h,x,w,Z;do{if(w=o.window_size-o.lookahead-o.strstart,o.strstart>=A+(A-he)){l.arraySet(o.window,o.window,A,A,0),o.match_start-=A,o.strstart-=A,o.block_start-=A,h=o.hash_size,I=h;do x=o.head[--I],o.head[I]=x>=A?x-A:0;while(--h);h=A,I=h;do x=o.prev[--I],o.prev[I]=x>=A?x-A:0;while(--h);w+=A}if(o.strm.avail_in===0)break;if(h=xt(o.strm,o.window,o.strstart+o.lookahead,w),o.lookahead+=h,o.lookahead+o.insert>=Y)for(Z=o.strstart-o.insert,o.ins_h=o.window[Z],o.ins_h=(o.ins_h<<o.hash_shift^o.window[Z+1])&o.hash_mask;o.insert&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[Z+Y-1])&o.hash_mask,o.prev[Z&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=Z,Z++,o.insert--,!(o.lookahead+o.insert<Y)););}while(o.lookahead<he&&o.strm.avail_in!==0)}function bt(o,A){var I=65535;for(I>o.pending_buf_size-5&&(I=o.pending_buf_size-5);;){if(o.lookahead<=1){if(Ve(o),o.lookahead===0&&A===s)return oe;if(o.lookahead===0)break}o.strstart+=o.lookahead,o.lookahead=0;var h=o.block_start+I;if((o.strstart===0||o.strstart>=h)&&(o.lookahead=o.strstart-h,o.strstart=h,pe(o,!1),o.strm.avail_out===0)||o.strstart-o.block_start>=o.w_size-he&&(pe(o,!1),o.strm.avail_out===0))return oe}return o.insert=0,A===c?(pe(o,!0),o.strm.avail_out===0?$e:He):(o.strstart>o.block_start&&(pe(o,!1),o.strm.avail_out===0),oe)}function ct(o,A){for(var I,h;;){if(o.lookahead<he){if(Ve(o),o.lookahead<he&&A===s)return oe;if(o.lookahead===0)break}if(I=0,o.lookahead>=Y&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+Y-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),I!==0&&o.strstart-I<=o.w_size-he&&(o.match_length=at(o,I)),o.match_length>=Y)if(h=e._tr_tally(o,o.strstart-o.match_start,o.match_length-Y),o.lookahead-=o.match_length,o.match_length<=o.max_lazy_match&&o.lookahead>=Y){o.match_length--;do o.strstart++,o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+Y-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart;while(--o.match_length!==0);o.strstart++}else o.strstart+=o.match_length,o.match_length=0,o.ins_h=o.window[o.strstart],o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+1])&o.hash_mask;else h=e._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++;if(h&&(pe(o,!1),o.strm.avail_out===0))return oe}return o.insert=o.strstart<Y-1?o.strstart:Y-1,A===c?(pe(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(pe(o,!1),o.strm.avail_out===0)?oe:Ie}function Ke(o,A){for(var I,h,x;;){if(o.lookahead<he){if(Ve(o),o.lookahead<he&&A===s)return oe;if(o.lookahead===0)break}if(I=0,o.lookahead>=Y&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+Y-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),o.prev_length=o.match_length,o.prev_match=o.match_start,o.match_length=Y-1,I!==0&&o.prev_length<o.max_lazy_match&&o.strstart-I<=o.w_size-he&&(o.match_length=at(o,I),o.match_length<=5&&(o.strategy===_||o.match_length===Y&&o.strstart-o.match_start>4096)&&(o.match_length=Y-1)),o.prev_length>=Y&&o.match_length<=o.prev_length){x=o.strstart+o.lookahead-Y,h=e._tr_tally(o,o.strstart-1-o.prev_match,o.prev_length-Y),o.lookahead-=o.prev_length-1,o.prev_length-=2;do++o.strstart<=x&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+Y-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart);while(--o.prev_length!==0);if(o.match_available=0,o.match_length=Y-1,o.strstart++,h&&(pe(o,!1),o.strm.avail_out===0))return oe}else if(o.match_available){if(h=e._tr_tally(o,0,o.window[o.strstart-1]),h&&pe(o,!1),o.strstart++,o.lookahead--,o.strm.avail_out===0)return oe}else o.match_available=1,o.strstart++,o.lookahead--}return o.match_available&&(h=e._tr_tally(o,0,o.window[o.strstart-1]),o.match_available=0),o.insert=o.strstart<Y-1?o.strstart:Y-1,A===c?(pe(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(pe(o,!1),o.strm.avail_out===0)?oe:Ie}function _t(o,A){for(var I,h,x,w,Z=o.window;;){if(o.lookahead<=ye){if(Ve(o),o.lookahead<=ye&&A===s)return oe;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=Y&&o.strstart>0&&(x=o.strstart-1,h=Z[x],h===Z[++x]&&h===Z[++x]&&h===Z[++x])){w=o.strstart+ye;do;while(h===Z[++x]&&h===Z[++x]&&h===Z[++x]&&h===Z[++x]&&h===Z[++x]&&h===Z[++x]&&h===Z[++x]&&h===Z[++x]&&x<w);o.match_length=ye-(w-x),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=Y?(I=e._tr_tally(o,1,o.match_length-Y),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(I=e._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),I&&(pe(o,!1),o.strm.avail_out===0))return oe}return o.insert=0,A===c?(pe(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(pe(o,!1),o.strm.avail_out===0)?oe:Ie}function lt(o,A){for(var I;;){if(o.lookahead===0&&(Ve(o),o.lookahead===0)){if(A===s)return oe;break}if(o.match_length=0,I=e._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,I&&(pe(o,!1),o.strm.avail_out===0))return oe}return o.insert=0,A===c?(pe(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(pe(o,!1),o.strm.avail_out===0)?oe:Ie}function Se(o,A,I,h,x){this.good_length=o,this.max_lazy=A,this.nice_length=I,this.max_chain=h,this.func=x}var qe;qe=[new Se(0,0,0,0,bt),new Se(4,4,8,4,ct),new Se(4,5,16,8,ct),new Se(4,6,32,32,ct),new Se(4,4,16,16,Ke),new Se(8,16,32,32,Ke),new Se(8,16,128,128,Ke),new Se(8,32,128,256,Ke),new Se(32,128,258,1024,Ke),new Se(32,258,258,4096,Ke)];function wt(o){o.window_size=2*o.w_size,Ze(o.head),o.max_lazy_match=qe[o.level].max_lazy,o.good_match=qe[o.level].good_length,o.nice_match=qe[o.level].nice_length,o.max_chain_length=qe[o.level].max_chain,o.strstart=0,o.block_start=0,o.lookahead=0,o.insert=0,o.match_length=o.prev_length=Y-1,o.match_available=0,o.ins_h=0}function g(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=O,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new l.Buf16(ue*2),this.dyn_dtree=new l.Buf16((2*H+1)*2),this.bl_tree=new l.Buf16((2*W+1)*2),Ze(this.dyn_ltree),Ze(this.dyn_dtree),Ze(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new l.Buf16(de+1),this.heap=new l.Buf16(2*X+1),Ze(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new l.Buf16(2*X+1),Ze(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function z(o){var A;return!o||!o.state?Oe(o,m):(o.total_in=o.total_out=0,o.data_type=R,A=o.state,A.pending=0,A.pending_out=0,A.wrap<0&&(A.wrap=-A.wrap),A.status=A.wrap?Re:ae,o.adler=A.wrap===2?0:1,A.last_flush=s,e._tr_init(A),d)}function L(o){var A=z(o);return A===d&&wt(o.state),A}function U(o,A){return!o||!o.state||o.state.wrap!==2?m:(o.state.gzhead=A,d)}function b(o,A,I,h,x,w){if(!o)return m;var Z=1;if(A===S&&(A=6),h<0?(Z=0,h=-h):h>15&&(Z=2,h-=16),x<1||x>F||I!==O||h<8||h>15||A<0||A>9||w<0||w>T)return Oe(o,m);h===8&&(h=9);var P=new g;return o.state=P,P.strm=o,P.wrap=Z,P.gzhead=null,P.w_bits=h,P.w_size=1<<P.w_bits,P.w_mask=P.w_size-1,P.hash_bits=x+7,P.hash_size=1<<P.hash_bits,P.hash_mask=P.hash_size-1,P.hash_shift=~~((P.hash_bits+Y-1)/Y),P.window=new l.Buf8(P.w_size*2),P.head=new l.Buf16(P.hash_size),P.prev=new l.Buf16(P.w_size),P.lit_bufsize=1<<x+6,P.pending_buf_size=P.lit_bufsize*4,P.pending_buf=new l.Buf8(P.pending_buf_size),P.d_buf=1*P.lit_bufsize,P.l_buf=3*P.lit_bufsize,P.level=A,P.strategy=w,P.method=I,L(o)}function C(o,A){return b(o,A,O,$,j,M)}function f(o,A){var I,h,x,w;if(!o||!o.state||A>u||A<0)return o?Oe(o,m):m;if(h=o.state,!o.output||!o.input&&o.avail_in!==0||h.status===me&&A!==c)return Oe(o,o.avail_out===0?y:m);if(h.strm=o,I=h.last_flush,h.last_flush=A,h.status===Re)if(h.wrap===2)o.adler=0,Q(h,31),Q(h,139),Q(h,8),h.gzhead?(Q(h,(h.gzhead.text?1:0)+(h.gzhead.hcrc?2:0)+(h.gzhead.extra?4:0)+(h.gzhead.name?8:0)+(h.gzhead.comment?16:0)),Q(h,h.gzhead.time&255),Q(h,h.gzhead.time>>8&255),Q(h,h.gzhead.time>>16&255),Q(h,h.gzhead.time>>24&255),Q(h,h.level===9?2:h.strategy>=E||h.level<2?4:0),Q(h,h.gzhead.os&255),h.gzhead.extra&&h.gzhead.extra.length&&(Q(h,h.gzhead.extra.length&255),Q(h,h.gzhead.extra.length>>8&255)),h.gzhead.hcrc&&(o.adler=n(o.adler,h.pending_buf,h.pending,0)),h.gzindex=0,h.status=Ae):(Q(h,0),Q(h,0),Q(h,0),Q(h,0),Q(h,0),Q(h,h.level===9?2:h.strategy>=E||h.level<2?4:0),Q(h,ce),h.status=ae);else{var Z=O+(h.w_bits-8<<4)<<8,P=-1;h.strategy>=E||h.level<2?P=0:h.level<6?P=1:h.level===6?P=2:P=3,Z|=P<<6,h.strstart!==0&&(Z|=Ge),Z+=31-Z%31,h.status=ae,je(h,Z),h.strstart!==0&&(je(h,o.adler>>>16),je(h,o.adler&65535)),o.adler=1}if(h.status===Ae)if(h.gzhead.extra){for(x=h.pending;h.gzindex<(h.gzhead.extra.length&65535)&&!(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>x&&(o.adler=n(o.adler,h.pending_buf,h.pending-x,x)),Le(o),x=h.pending,h.pending===h.pending_buf_size));)Q(h,h.gzhead.extra[h.gzindex]&255),h.gzindex++;h.gzhead.hcrc&&h.pending>x&&(o.adler=n(o.adler,h.pending_buf,h.pending-x,x)),h.gzindex===h.gzhead.extra.length&&(h.gzindex=0,h.status=ge)}else h.status=ge;if(h.status===ge)if(h.gzhead.name){x=h.pending;do{if(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>x&&(o.adler=n(o.adler,h.pending_buf,h.pending-x,x)),Le(o),x=h.pending,h.pending===h.pending_buf_size)){w=1;break}h.gzindex<h.gzhead.name.length?w=h.gzhead.name.charCodeAt(h.gzindex++)&255:w=0,Q(h,w)}while(w!==0);h.gzhead.hcrc&&h.pending>x&&(o.adler=n(o.adler,h.pending_buf,h.pending-x,x)),w===0&&(h.gzindex=0,h.status=ke)}else h.status=ke;if(h.status===ke)if(h.gzhead.comment){x=h.pending;do{if(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>x&&(o.adler=n(o.adler,h.pending_buf,h.pending-x,x)),Le(o),x=h.pending,h.pending===h.pending_buf_size)){w=1;break}h.gzindex<h.gzhead.comment.length?w=h.gzhead.comment.charCodeAt(h.gzindex++)&255:w=0,Q(h,w)}while(w!==0);h.gzhead.hcrc&&h.pending>x&&(o.adler=n(o.adler,h.pending_buf,h.pending-x,x)),w===0&&(h.status=Te)}else h.status=Te;if(h.status===Te&&(h.gzhead.hcrc?(h.pending+2>h.pending_buf_size&&Le(o),h.pending+2<=h.pending_buf_size&&(Q(h,o.adler&255),Q(h,o.adler>>8&255),o.adler=0,h.status=ae)):h.status=ae),h.pending!==0){if(Le(o),o.avail_out===0)return h.last_flush=-1,d}else if(o.avail_in===0&&pt(A)<=pt(I)&&A!==c)return Oe(o,y);if(h.status===me&&o.avail_in!==0)return Oe(o,y);if(o.avail_in!==0||h.lookahead!==0||A!==s&&h.status!==me){var B=h.strategy===E?lt(h,A):h.strategy===D?_t(h,A):qe[h.level].func(h,A);if((B===$e||B===He)&&(h.status=me),B===oe||B===$e)return o.avail_out===0&&(h.last_flush=-1),d;if(B===Ie&&(A===i?e._tr_align(h):A!==u&&(e._tr_stored_block(h,0,0,!1),A===a&&(Ze(h.head),h.lookahead===0&&(h.strstart=0,h.block_start=0,h.insert=0))),Le(o),o.avail_out===0))return h.last_flush=-1,d}return A!==c?d:h.wrap<=0?p:(h.wrap===2?(Q(h,o.adler&255),Q(h,o.adler>>8&255),Q(h,o.adler>>16&255),Q(h,o.adler>>24&255),Q(h,o.total_in&255),Q(h,o.total_in>>8&255),Q(h,o.total_in>>16&255),Q(h,o.total_in>>24&255)):(je(h,o.adler>>>16),je(h,o.adler&65535)),Le(o),h.wrap>0&&(h.wrap=-h.wrap),h.pending!==0?d:p)}function N(o){var A;return!o||!o.state?m:(A=o.state.status,A!==Re&&A!==Ae&&A!==ge&&A!==ke&&A!==Te&&A!==ae&&A!==me?Oe(o,m):(o.state=null,A===ae?Oe(o,v):d))}function V(o,A){var I=A.length,h,x,w,Z,P,B,ne,nt;if(!o||!o.state||(h=o.state,Z=h.wrap,Z===2||Z===1&&h.status!==Re||h.lookahead))return m;for(Z===1&&(o.adler=t(o.adler,A,I,0)),h.wrap=0,I>=h.w_size&&(Z===0&&(Ze(h.head),h.strstart=0,h.block_start=0,h.insert=0),nt=new l.Buf8(h.w_size),l.arraySet(nt,A,I-h.w_size,h.w_size,0),A=nt,I=h.w_size),P=o.avail_in,B=o.next_in,ne=o.input,o.avail_in=I,o.next_in=0,o.input=A,Ve(h);h.lookahead>=Y;){x=h.strstart,w=h.lookahead-(Y-1);do h.ins_h=(h.ins_h<<h.hash_shift^h.window[x+Y-1])&h.hash_mask,h.prev[x&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=x,x++;while(--w);h.strstart=x,h.lookahead=Y-1,Ve(h)}return h.strstart+=h.lookahead,h.block_start=h.strstart,h.insert=h.lookahead,h.lookahead=0,h.match_length=h.prev_length=Y-1,h.match_available=0,o.next_in=B,o.input=ne,o.avail_in=P,h.wrap=Z,d}return Xe.deflateInit=C,Xe.deflateInit2=b,Xe.deflateReset=L,Xe.deflateResetKeep=z,Xe.deflateSetHeader=U,Xe.deflate=f,Xe.deflateEnd=N,Xe.deflateSetDictionary=V,Xe.deflateInfo="pako deflate (from Nodeca project)",Xe}var mt={},Un;function lr(){if(Un)return mt;Un=1;var l=ht(),e=!0,t=!0;try{String.fromCharCode.apply(null,[0])}catch{e=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{t=!1}for(var n=new l.Buf8(256),r=0;r<256;r++)n[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;n[254]=n[254]=1,mt.string2buf=function(i){var a,c,u,d,p,m=i.length,v=0;for(d=0;d<m;d++)c=i.charCodeAt(d),(c&64512)===55296&&d+1<m&&(u=i.charCodeAt(d+1),(u&64512)===56320&&(c=65536+(c-55296<<10)+(u-56320),d++)),v+=c<128?1:c<2048?2:c<65536?3:4;for(a=new l.Buf8(v),p=0,d=0;p<v;d++)c=i.charCodeAt(d),(c&64512)===55296&&d+1<m&&(u=i.charCodeAt(d+1),(u&64512)===56320&&(c=65536+(c-55296<<10)+(u-56320),d++)),c<128?a[p++]=c:c<2048?(a[p++]=192|c>>>6,a[p++]=128|c&63):c<65536?(a[p++]=224|c>>>12,a[p++]=128|c>>>6&63,a[p++]=128|c&63):(a[p++]=240|c>>>18,a[p++]=128|c>>>12&63,a[p++]=128|c>>>6&63,a[p++]=128|c&63);return a};function s(i,a){if(a<65534&&(i.subarray&&t||!i.subarray&&e))return String.fromCharCode.apply(null,l.shrinkBuf(i,a));for(var c="",u=0;u<a;u++)c+=String.fromCharCode(i[u]);return c}return mt.buf2binstring=function(i){return s(i,i.length)},mt.binstring2buf=function(i){for(var a=new l.Buf8(i.length),c=0,u=a.length;c<u;c++)a[c]=i.charCodeAt(c);return a},mt.buf2string=function(i,a){var c,u,d,p,m=a||i.length,v=new Array(m*2);for(u=0,c=0;c<m;){if(d=i[c++],d<128){v[u++]=d;continue}if(p=n[d],p>4){v[u++]=65533,c+=p-1;continue}for(d&=p===2?31:p===3?15:7;p>1&&c<m;)d=d<<6|i[c++]&63,p--;if(p>1){v[u++]=65533;continue}d<65536?v[u++]=d:(d-=65536,v[u++]=55296|d>>10&1023,v[u++]=56320|d&1023)}return s(v,u)},mt.utf8border=function(i,a){var c;for(a=a||i.length,a>i.length&&(a=i.length),c=a-1;c>=0&&(i[c]&192)===128;)c--;return c<0||c===0?a:c+n[i[c]]>a?c:a},mt}var cn,Gn;function ur(){if(Gn)return cn;Gn=1;function l(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}return cn=l,cn}var $n;function hs(){if($n)return Tt;$n=1;var l=ds(),e=ht(),t=lr(),n=An(),r=ur(),s=Object.prototype.toString,i=0,a=4,c=0,u=1,d=2,p=-1,m=0,v=8;function y(D){if(!(this instanceof y))return new y(D);this.options=e.assign({level:p,method:v,chunkSize:16384,windowBits:15,memLevel:8,strategy:m,to:""},D||{});var T=this.options;T.raw&&T.windowBits>0?T.windowBits=-T.windowBits:T.gzip&&T.windowBits>0&&T.windowBits<16&&(T.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new r,this.strm.avail_out=0;var M=l.deflateInit2(this.strm,T.level,T.method,T.windowBits,T.memLevel,T.strategy);if(M!==c)throw new Error(n[M]);if(T.header&&l.deflateSetHeader(this.strm,T.header),T.dictionary){var R;if(typeof T.dictionary=="string"?R=t.string2buf(T.dictionary):s.call(T.dictionary)==="[object ArrayBuffer]"?R=new Uint8Array(T.dictionary):R=T.dictionary,M=l.deflateSetDictionary(this.strm,R),M!==c)throw new Error(n[M]);this._dict_set=!0}}y.prototype.push=function(D,T){var M=this.strm,R=this.options.chunkSize,O,F;if(this.ended)return!1;F=T===~~T?T:T===!0?a:i,typeof D=="string"?M.input=t.string2buf(D):s.call(D)==="[object ArrayBuffer]"?M.input=new Uint8Array(D):M.input=D,M.next_in=0,M.avail_in=M.input.length;do{if(M.avail_out===0&&(M.output=new e.Buf8(R),M.next_out=0,M.avail_out=R),O=l.deflate(M,F),O!==u&&O!==c)return this.onEnd(O),this.ended=!0,!1;(M.avail_out===0||M.avail_in===0&&(F===a||F===d))&&(this.options.to==="string"?this.onData(t.buf2binstring(e.shrinkBuf(M.output,M.next_out))):this.onData(e.shrinkBuf(M.output,M.next_out)))}while((M.avail_in>0||M.avail_out===0)&&O!==u);return F===a?(O=l.deflateEnd(this.strm),this.onEnd(O),this.ended=!0,O===c):(F===d&&(this.onEnd(c),M.avail_out=0),!0)},y.prototype.onData=function(D){this.chunks.push(D)},y.prototype.onEnd=function(D){D===c&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=e.flattenChunks(this.chunks)),this.chunks=[],this.err=D,this.msg=this.strm.msg};function S(D,T){var M=new y(T);if(M.push(D,!0),M.err)throw M.msg||n[M.err];return M.result}function _(D,T){return T=T||{},T.raw=!0,S(D,T)}function E(D,T){return T=T||{},T.gzip=!0,S(D,T)}return Tt.Deflate=y,Tt.deflate=S,Tt.deflateRaw=_,Tt.gzip=E,Tt}var At={},Ye={},ln,Hn;function ps(){if(Hn)return ln;Hn=1;var l=30,e=12;return ln=function(n,r){var s,i,a,c,u,d,p,m,v,y,S,_,E,D,T,M,R,O,F,$,j,G,te,X,H;s=n.state,i=n.next_in,X=n.input,a=i+(n.avail_in-5),c=n.next_out,H=n.output,u=c-(r-n.avail_out),d=c+(n.avail_out-257),p=s.dmax,m=s.wsize,v=s.whave,y=s.wnext,S=s.window,_=s.hold,E=s.bits,D=s.lencode,T=s.distcode,M=(1<<s.lenbits)-1,R=(1<<s.distbits)-1;e:do{E<15&&(_+=X[i++]<<E,E+=8,_+=X[i++]<<E,E+=8),O=D[_&M];t:for(;;){if(F=O>>>24,_>>>=F,E-=F,F=O>>>16&255,F===0)H[c++]=O&65535;else if(F&16){$=O&65535,F&=15,F&&(E<F&&(_+=X[i++]<<E,E+=8),$+=_&(1<<F)-1,_>>>=F,E-=F),E<15&&(_+=X[i++]<<E,E+=8,_+=X[i++]<<E,E+=8),O=T[_&R];n:for(;;){if(F=O>>>24,_>>>=F,E-=F,F=O>>>16&255,F&16){if(j=O&65535,F&=15,E<F&&(_+=X[i++]<<E,E+=8,E<F&&(_+=X[i++]<<E,E+=8)),j+=_&(1<<F)-1,j>p){n.msg="invalid distance too far back",s.mode=l;break e}if(_>>>=F,E-=F,F=c-u,j>F){if(F=j-F,F>v&&s.sane){n.msg="invalid distance too far back",s.mode=l;break e}if(G=0,te=S,y===0){if(G+=m-F,F<$){$-=F;do H[c++]=S[G++];while(--F);G=c-j,te=H}}else if(y<F){if(G+=m+y-F,F-=y,F<$){$-=F;do H[c++]=S[G++];while(--F);if(G=0,y<$){F=y,$-=F;do H[c++]=S[G++];while(--F);G=c-j,te=H}}}else if(G+=y-F,F<$){$-=F;do H[c++]=S[G++];while(--F);G=c-j,te=H}for(;$>2;)H[c++]=te[G++],H[c++]=te[G++],H[c++]=te[G++],$-=3;$&&(H[c++]=te[G++],$>1&&(H[c++]=te[G++]))}else{G=c-j;do H[c++]=H[G++],H[c++]=H[G++],H[c++]=H[G++],$-=3;while($>2);$&&(H[c++]=H[G++],$>1&&(H[c++]=H[G++]))}}else if((F&64)===0){O=T[(O&65535)+(_&(1<<F)-1)];continue n}else{n.msg="invalid distance code",s.mode=l;break e}break}}else if((F&64)===0){O=D[(O&65535)+(_&(1<<F)-1)];continue t}else if(F&32){s.mode=e;break e}else{n.msg="invalid literal/length code",s.mode=l;break e}break}}while(i<a&&c<d);$=E>>3,i-=$,E-=$<<3,_&=(1<<E)-1,n.next_in=i,n.next_out=c,n.avail_in=i<a?5+(a-i):5-(i-a),n.avail_out=c<d?257+(d-c):257-(c-d),s.hold=_,s.bits=E},ln}var un,Zn;function gs(){if(Zn)return un;Zn=1;var l=ht(),e=15,t=852,n=592,r=0,s=1,i=2,a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],c=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],u=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],d=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];return un=function(m,v,y,S,_,E,D,T){var M=T.bits,R=0,O=0,F=0,$=0,j=0,G=0,te=0,X=0,H=0,W=0,ue,de,Y,ye,he,Ge=null,Re=0,Ae,ge=new l.Buf16(e+1),ke=new l.Buf16(e+1),Te=null,ae=0,me,oe,Ie;for(R=0;R<=e;R++)ge[R]=0;for(O=0;O<S;O++)ge[v[y+O]]++;for(j=M,$=e;$>=1&&ge[$]===0;$--);if(j>$&&(j=$),$===0)return _[E++]=1<<24|64<<16|0,_[E++]=1<<24|64<<16|0,T.bits=1,0;for(F=1;F<$&&ge[F]===0;F++);for(j<F&&(j=F),X=1,R=1;R<=e;R++)if(X<<=1,X-=ge[R],X<0)return-1;if(X>0&&(m===r||$!==1))return-1;for(ke[1]=0,R=1;R<e;R++)ke[R+1]=ke[R]+ge[R];for(O=0;O<S;O++)v[y+O]!==0&&(D[ke[v[y+O]]++]=O);if(m===r?(Ge=Te=D,Ae=19):m===s?(Ge=a,Re-=257,Te=c,ae-=257,Ae=256):(Ge=u,Te=d,Ae=-1),W=0,O=0,R=F,he=E,G=j,te=0,Y=-1,H=1<<j,ye=H-1,m===s&&H>t||m===i&&H>n)return 1;for(;;){me=R-te,D[O]<Ae?(oe=0,Ie=D[O]):D[O]>Ae?(oe=Te[ae+D[O]],Ie=Ge[Re+D[O]]):(oe=96,Ie=0),ue=1<<R-te,de=1<<G,F=de;do de-=ue,_[he+(W>>te)+de]=me<<24|oe<<16|Ie|0;while(de!==0);for(ue=1<<R-1;W&ue;)ue>>=1;if(ue!==0?(W&=ue-1,W+=ue):W=0,O++,--ge[R]===0){if(R===$)break;R=v[y+D[O]]}if(R>j&&(W&ye)!==Y){for(te===0&&(te=j),he+=F,G=R-te,X=1<<G;G+te<$&&(X-=ge[G+te],!(X<=0));)G++,X<<=1;if(H+=1<<G,m===s&&H>t||m===i&&H>n)return 1;Y=W&ye,_[Y]=j<<24|G<<16|he-E|0}}return W!==0&&(_[he+W]=R-te<<24|64<<16|0),T.bits=j,0},un}var jn;function ms(){if(jn)return Ye;jn=1;var l=ht(),e=ar(),t=cr(),n=ps(),r=gs(),s=0,i=1,a=2,c=4,u=5,d=6,p=0,m=1,v=2,y=-2,S=-3,_=-4,E=-5,D=8,T=1,M=2,R=3,O=4,F=5,$=6,j=7,G=8,te=9,X=10,H=11,W=12,ue=13,de=14,Y=15,ye=16,he=17,Ge=18,Re=19,Ae=20,ge=21,ke=22,Te=23,ae=24,me=25,oe=26,Ie=27,$e=28,He=29,ce=30,Oe=31,pt=32,Ze=852,Le=592,pe=15,Q=pe;function je(b){return(b>>>24&255)+(b>>>8&65280)+((b&65280)<<8)+((b&255)<<24)}function xt(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new l.Buf16(320),this.work=new l.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function at(b){var C;return!b||!b.state?y:(C=b.state,b.total_in=b.total_out=C.total=0,b.msg="",C.wrap&&(b.adler=C.wrap&1),C.mode=T,C.last=0,C.havedict=0,C.dmax=32768,C.head=null,C.hold=0,C.bits=0,C.lencode=C.lendyn=new l.Buf32(Ze),C.distcode=C.distdyn=new l.Buf32(Le),C.sane=1,C.back=-1,p)}function Ve(b){var C;return!b||!b.state?y:(C=b.state,C.wsize=0,C.whave=0,C.wnext=0,at(b))}function bt(b,C){var f,N;return!b||!b.state||(N=b.state,C<0?(f=0,C=-C):(f=(C>>4)+1,C<48&&(C&=15)),C&&(C<8||C>15))?y:(N.window!==null&&N.wbits!==C&&(N.window=null),N.wrap=f,N.wbits=C,Ve(b))}function ct(b,C){var f,N;return b?(N=new xt,b.state=N,N.window=null,f=bt(b,C),f!==p&&(b.state=null),f):y}function Ke(b){return ct(b,Q)}var _t=!0,lt,Se;function qe(b){if(_t){var C;for(lt=new l.Buf32(512),Se=new l.Buf32(32),C=0;C<144;)b.lens[C++]=8;for(;C<256;)b.lens[C++]=9;for(;C<280;)b.lens[C++]=7;for(;C<288;)b.lens[C++]=8;for(r(i,b.lens,0,288,lt,0,b.work,{bits:9}),C=0;C<32;)b.lens[C++]=5;r(a,b.lens,0,32,Se,0,b.work,{bits:5}),_t=!1}b.lencode=lt,b.lenbits=9,b.distcode=Se,b.distbits=5}function wt(b,C,f,N){var V,o=b.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new l.Buf8(o.wsize)),N>=o.wsize?(l.arraySet(o.window,C,f-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):(V=o.wsize-o.wnext,V>N&&(V=N),l.arraySet(o.window,C,f-N,V,o.wnext),N-=V,N?(l.arraySet(o.window,C,f-N,N,0),o.wnext=N,o.whave=o.wsize):(o.wnext+=V,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=V))),0}function g(b,C){var f,N,V,o,A,I,h,x,w,Z,P,B,ne,nt,ve=0,se,we,Ce,ze,Pt,Bt,xe,We,Ee=new l.Buf8(4),rt,Je,Cn=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!b||!b.state||!b.output||!b.input&&b.avail_in!==0)return y;f=b.state,f.mode===W&&(f.mode=ue),A=b.next_out,V=b.output,h=b.avail_out,o=b.next_in,N=b.input,I=b.avail_in,x=f.hold,w=f.bits,Z=I,P=h,We=p;e:for(;;)switch(f.mode){case T:if(f.wrap===0){f.mode=ue;break}for(;w<16;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(f.wrap&2&&x===35615){f.check=0,Ee[0]=x&255,Ee[1]=x>>>8&255,f.check=t(f.check,Ee,2,0),x=0,w=0,f.mode=M;break}if(f.flags=0,f.head&&(f.head.done=!1),!(f.wrap&1)||(((x&255)<<8)+(x>>8))%31){b.msg="incorrect header check",f.mode=ce;break}if((x&15)!==D){b.msg="unknown compression method",f.mode=ce;break}if(x>>>=4,w-=4,xe=(x&15)+8,f.wbits===0)f.wbits=xe;else if(xe>f.wbits){b.msg="invalid window size",f.mode=ce;break}f.dmax=1<<xe,b.adler=f.check=1,f.mode=x&512?X:W,x=0,w=0;break;case M:for(;w<16;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(f.flags=x,(f.flags&255)!==D){b.msg="unknown compression method",f.mode=ce;break}if(f.flags&57344){b.msg="unknown header flags set",f.mode=ce;break}f.head&&(f.head.text=x>>8&1),f.flags&512&&(Ee[0]=x&255,Ee[1]=x>>>8&255,f.check=t(f.check,Ee,2,0)),x=0,w=0,f.mode=R;case R:for(;w<32;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}f.head&&(f.head.time=x),f.flags&512&&(Ee[0]=x&255,Ee[1]=x>>>8&255,Ee[2]=x>>>16&255,Ee[3]=x>>>24&255,f.check=t(f.check,Ee,4,0)),x=0,w=0,f.mode=O;case O:for(;w<16;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}f.head&&(f.head.xflags=x&255,f.head.os=x>>8),f.flags&512&&(Ee[0]=x&255,Ee[1]=x>>>8&255,f.check=t(f.check,Ee,2,0)),x=0,w=0,f.mode=F;case F:if(f.flags&1024){for(;w<16;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}f.length=x,f.head&&(f.head.extra_len=x),f.flags&512&&(Ee[0]=x&255,Ee[1]=x>>>8&255,f.check=t(f.check,Ee,2,0)),x=0,w=0}else f.head&&(f.head.extra=null);f.mode=$;case $:if(f.flags&1024&&(B=f.length,B>I&&(B=I),B&&(f.head&&(xe=f.head.extra_len-f.length,f.head.extra||(f.head.extra=new Array(f.head.extra_len)),l.arraySet(f.head.extra,N,o,B,xe)),f.flags&512&&(f.check=t(f.check,N,B,o)),I-=B,o+=B,f.length-=B),f.length))break e;f.length=0,f.mode=j;case j:if(f.flags&2048){if(I===0)break e;B=0;do xe=N[o+B++],f.head&&xe&&f.length<65536&&(f.head.name+=String.fromCharCode(xe));while(xe&&B<I);if(f.flags&512&&(f.check=t(f.check,N,B,o)),I-=B,o+=B,xe)break e}else f.head&&(f.head.name=null);f.length=0,f.mode=G;case G:if(f.flags&4096){if(I===0)break e;B=0;do xe=N[o+B++],f.head&&xe&&f.length<65536&&(f.head.comment+=String.fromCharCode(xe));while(xe&&B<I);if(f.flags&512&&(f.check=t(f.check,N,B,o)),I-=B,o+=B,xe)break e}else f.head&&(f.head.comment=null);f.mode=te;case te:if(f.flags&512){for(;w<16;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(x!==(f.check&65535)){b.msg="header crc mismatch",f.mode=ce;break}x=0,w=0}f.head&&(f.head.hcrc=f.flags>>9&1,f.head.done=!0),b.adler=f.check=0,f.mode=W;break;case X:for(;w<32;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}b.adler=f.check=je(x),x=0,w=0,f.mode=H;case H:if(f.havedict===0)return b.next_out=A,b.avail_out=h,b.next_in=o,b.avail_in=I,f.hold=x,f.bits=w,v;b.adler=f.check=1,f.mode=W;case W:if(C===u||C===d)break e;case ue:if(f.last){x>>>=w&7,w-=w&7,f.mode=Ie;break}for(;w<3;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}switch(f.last=x&1,x>>>=1,w-=1,x&3){case 0:f.mode=de;break;case 1:if(qe(f),f.mode=Ae,C===d){x>>>=2,w-=2;break e}break;case 2:f.mode=he;break;case 3:b.msg="invalid block type",f.mode=ce}x>>>=2,w-=2;break;case de:for(x>>>=w&7,w-=w&7;w<32;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if((x&65535)!==(x>>>16^65535)){b.msg="invalid stored block lengths",f.mode=ce;break}if(f.length=x&65535,x=0,w=0,f.mode=Y,C===d)break e;case Y:f.mode=ye;case ye:if(B=f.length,B){if(B>I&&(B=I),B>h&&(B=h),B===0)break e;l.arraySet(V,N,o,B,A),I-=B,o+=B,h-=B,A+=B,f.length-=B;break}f.mode=W;break;case he:for(;w<14;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(f.nlen=(x&31)+257,x>>>=5,w-=5,f.ndist=(x&31)+1,x>>>=5,w-=5,f.ncode=(x&15)+4,x>>>=4,w-=4,f.nlen>286||f.ndist>30){b.msg="too many length or distance symbols",f.mode=ce;break}f.have=0,f.mode=Ge;case Ge:for(;f.have<f.ncode;){for(;w<3;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}f.lens[Cn[f.have++]]=x&7,x>>>=3,w-=3}for(;f.have<19;)f.lens[Cn[f.have++]]=0;if(f.lencode=f.lendyn,f.lenbits=7,rt={bits:f.lenbits},We=r(s,f.lens,0,19,f.lencode,0,f.work,rt),f.lenbits=rt.bits,We){b.msg="invalid code lengths set",f.mode=ce;break}f.have=0,f.mode=Re;case Re:for(;f.have<f.nlen+f.ndist;){for(;ve=f.lencode[x&(1<<f.lenbits)-1],se=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(se<=w);){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(Ce<16)x>>>=se,w-=se,f.lens[f.have++]=Ce;else{if(Ce===16){for(Je=se+2;w<Je;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(x>>>=se,w-=se,f.have===0){b.msg="invalid bit length repeat",f.mode=ce;break}xe=f.lens[f.have-1],B=3+(x&3),x>>>=2,w-=2}else if(Ce===17){for(Je=se+3;w<Je;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}x>>>=se,w-=se,xe=0,B=3+(x&7),x>>>=3,w-=3}else{for(Je=se+7;w<Je;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}x>>>=se,w-=se,xe=0,B=11+(x&127),x>>>=7,w-=7}if(f.have+B>f.nlen+f.ndist){b.msg="invalid bit length repeat",f.mode=ce;break}for(;B--;)f.lens[f.have++]=xe}}if(f.mode===ce)break;if(f.lens[256]===0){b.msg="invalid code -- missing end-of-block",f.mode=ce;break}if(f.lenbits=9,rt={bits:f.lenbits},We=r(i,f.lens,0,f.nlen,f.lencode,0,f.work,rt),f.lenbits=rt.bits,We){b.msg="invalid literal/lengths set",f.mode=ce;break}if(f.distbits=6,f.distcode=f.distdyn,rt={bits:f.distbits},We=r(a,f.lens,f.nlen,f.ndist,f.distcode,0,f.work,rt),f.distbits=rt.bits,We){b.msg="invalid distances set",f.mode=ce;break}if(f.mode=Ae,C===d)break e;case Ae:f.mode=ge;case ge:if(I>=6&&h>=258){b.next_out=A,b.avail_out=h,b.next_in=o,b.avail_in=I,f.hold=x,f.bits=w,n(b,P),A=b.next_out,V=b.output,h=b.avail_out,o=b.next_in,N=b.input,I=b.avail_in,x=f.hold,w=f.bits,f.mode===W&&(f.back=-1);break}for(f.back=0;ve=f.lencode[x&(1<<f.lenbits)-1],se=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(se<=w);){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(we&&(we&240)===0){for(ze=se,Pt=we,Bt=Ce;ve=f.lencode[Bt+((x&(1<<ze+Pt)-1)>>ze)],se=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(ze+se<=w);){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}x>>>=ze,w-=ze,f.back+=ze}if(x>>>=se,w-=se,f.back+=se,f.length=Ce,we===0){f.mode=oe;break}if(we&32){f.back=-1,f.mode=W;break}if(we&64){b.msg="invalid literal/length code",f.mode=ce;break}f.extra=we&15,f.mode=ke;case ke:if(f.extra){for(Je=f.extra;w<Je;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}f.length+=x&(1<<f.extra)-1,x>>>=f.extra,w-=f.extra,f.back+=f.extra}f.was=f.length,f.mode=Te;case Te:for(;ve=f.distcode[x&(1<<f.distbits)-1],se=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(se<=w);){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if((we&240)===0){for(ze=se,Pt=we,Bt=Ce;ve=f.distcode[Bt+((x&(1<<ze+Pt)-1)>>ze)],se=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(ze+se<=w);){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}x>>>=ze,w-=ze,f.back+=ze}if(x>>>=se,w-=se,f.back+=se,we&64){b.msg="invalid distance code",f.mode=ce;break}f.offset=Ce,f.extra=we&15,f.mode=ae;case ae:if(f.extra){for(Je=f.extra;w<Je;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}f.offset+=x&(1<<f.extra)-1,x>>>=f.extra,w-=f.extra,f.back+=f.extra}if(f.offset>f.dmax){b.msg="invalid distance too far back",f.mode=ce;break}f.mode=me;case me:if(h===0)break e;if(B=P-h,f.offset>B){if(B=f.offset-B,B>f.whave&&f.sane){b.msg="invalid distance too far back",f.mode=ce;break}B>f.wnext?(B-=f.wnext,ne=f.wsize-B):ne=f.wnext-B,B>f.length&&(B=f.length),nt=f.window}else nt=V,ne=A-f.offset,B=f.length;B>h&&(B=h),h-=B,f.length-=B;do V[A++]=nt[ne++];while(--B);f.length===0&&(f.mode=ge);break;case oe:if(h===0)break e;V[A++]=f.length,h--,f.mode=ge;break;case Ie:if(f.wrap){for(;w<32;){if(I===0)break e;I--,x|=N[o++]<<w,w+=8}if(P-=h,b.total_out+=P,f.total+=P,P&&(b.adler=f.check=f.flags?t(f.check,V,P,A-P):e(f.check,V,P,A-P)),P=h,(f.flags?x:je(x))!==f.check){b.msg="incorrect data check",f.mode=ce;break}x=0,w=0}f.mode=$e;case $e:if(f.wrap&&f.flags){for(;w<32;){if(I===0)break e;I--,x+=N[o++]<<w,w+=8}if(x!==(f.total&4294967295)){b.msg="incorrect length check",f.mode=ce;break}x=0,w=0}f.mode=He;case He:We=m;break e;case ce:We=S;break e;case Oe:return _;case pt:default:return y}return b.next_out=A,b.avail_out=h,b.next_in=o,b.avail_in=I,f.hold=x,f.bits=w,(f.wsize||P!==b.avail_out&&f.mode<ce&&(f.mode<Ie||C!==c))&&wt(b,b.output,b.next_out,P-b.avail_out),Z-=b.avail_in,P-=b.avail_out,b.total_in+=Z,b.total_out+=P,f.total+=P,f.wrap&&P&&(b.adler=f.check=f.flags?t(f.check,V,P,b.next_out-P):e(f.check,V,P,b.next_out-P)),b.data_type=f.bits+(f.last?64:0)+(f.mode===W?128:0)+(f.mode===Ae||f.mode===Y?256:0),(Z===0&&P===0||C===c)&&We===p&&(We=E),We}function z(b){if(!b||!b.state)return y;var C=b.state;return C.window&&(C.window=null),b.state=null,p}function L(b,C){var f;return!b||!b.state||(f=b.state,(f.wrap&2)===0)?y:(f.head=C,C.done=!1,p)}function U(b,C){var f=C.length,N,V,o;return!b||!b.state||(N=b.state,N.wrap!==0&&N.mode!==H)?y:N.mode===H&&(V=1,V=e(V,C,f,0),V!==N.check)?S:(o=wt(b,C,f,f),o?(N.mode=Oe,_):(N.havedict=1,p))}return Ye.inflateReset=Ve,Ye.inflateReset2=bt,Ye.inflateResetKeep=at,Ye.inflateInit=Ke,Ye.inflateInit2=ct,Ye.inflate=g,Ye.inflateEnd=z,Ye.inflateGetHeader=L,Ye.inflateSetDictionary=U,Ye.inflateInfo="pako inflate (from Nodeca project)",Ye}var fn,Vn;function fr(){return Vn||(Vn=1,fn={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}),fn}var dn,Wn;function vs(){if(Wn)return dn;Wn=1;function l(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}return dn=l,dn}var Yn;function ys(){if(Yn)return At;Yn=1;var l=ms(),e=ht(),t=lr(),n=fr(),r=An(),s=ur(),i=vs(),a=Object.prototype.toString;function c(p){if(!(this instanceof c))return new c(p);this.options=e.assign({chunkSize:16384,windowBits:0,to:""},p||{});var m=this.options;m.raw&&m.windowBits>=0&&m.windowBits<16&&(m.windowBits=-m.windowBits,m.windowBits===0&&(m.windowBits=-15)),m.windowBits>=0&&m.windowBits<16&&!(p&&p.windowBits)&&(m.windowBits+=32),m.windowBits>15&&m.windowBits<48&&(m.windowBits&15)===0&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new s,this.strm.avail_out=0;var v=l.inflateInit2(this.strm,m.windowBits);if(v!==n.Z_OK)throw new Error(r[v]);if(this.header=new i,l.inflateGetHeader(this.strm,this.header),m.dictionary&&(typeof m.dictionary=="string"?m.dictionary=t.string2buf(m.dictionary):a.call(m.dictionary)==="[object ArrayBuffer]"&&(m.dictionary=new Uint8Array(m.dictionary)),m.raw&&(v=l.inflateSetDictionary(this.strm,m.dictionary),v!==n.Z_OK)))throw new Error(r[v])}c.prototype.push=function(p,m){var v=this.strm,y=this.options.chunkSize,S=this.options.dictionary,_,E,D,T,M,R=!1;if(this.ended)return!1;E=m===~~m?m:m===!0?n.Z_FINISH:n.Z_NO_FLUSH,typeof p=="string"?v.input=t.binstring2buf(p):a.call(p)==="[object ArrayBuffer]"?v.input=new Uint8Array(p):v.input=p,v.next_in=0,v.avail_in=v.input.length;do{if(v.avail_out===0&&(v.output=new e.Buf8(y),v.next_out=0,v.avail_out=y),_=l.inflate(v,n.Z_NO_FLUSH),_===n.Z_NEED_DICT&&S&&(_=l.inflateSetDictionary(this.strm,S)),_===n.Z_BUF_ERROR&&R===!0&&(_=n.Z_OK,R=!1),_!==n.Z_STREAM_END&&_!==n.Z_OK)return this.onEnd(_),this.ended=!0,!1;v.next_out&&(v.avail_out===0||_===n.Z_STREAM_END||v.avail_in===0&&(E===n.Z_FINISH||E===n.Z_SYNC_FLUSH))&&(this.options.to==="string"?(D=t.utf8border(v.output,v.next_out),T=v.next_out-D,M=t.buf2string(v.output,D),v.next_out=T,v.avail_out=y-T,T&&e.arraySet(v.output,v.output,D,T,0),this.onData(M)):this.onData(e.shrinkBuf(v.output,v.next_out))),v.avail_in===0&&v.avail_out===0&&(R=!0)}while((v.avail_in>0||v.avail_out===0)&&_!==n.Z_STREAM_END);return _===n.Z_STREAM_END&&(E=n.Z_FINISH),E===n.Z_FINISH?(_=l.inflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===n.Z_OK):(E===n.Z_SYNC_FLUSH&&(this.onEnd(n.Z_OK),v.avail_out=0),!0)},c.prototype.onData=function(p){this.chunks.push(p)},c.prototype.onEnd=function(p){p===n.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=e.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg};function u(p,m){var v=new c(m);if(v.push(p,!0),v.err)throw v.msg||r[v.err];return v.result}function d(p,m){return m=m||{},m.raw=!0,u(p,m)}return At.Inflate=c,At.inflate=u,At.inflateRaw=d,At.ungzip=u,At}var hn,Kn;function xs(){if(Kn)return hn;Kn=1;var l=ht().assign,e=hs(),t=ys(),n=fr(),r={};return l(r,e,t,n),hn=r,hn}var bs=xs();class _s{convert(e,t){const n=new St({originalFormat:"fc3",originalFileName:t,author:"AFMG EASE",comments:"Converted from EASE Focus format"});n.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const r=Nt("fc3"),s=this.extractEaseData(e);if(!s)throw new Error("Failed to extract EASE data from FC3 file");const i={x:parseFloat(s.Project?.Origin?.X||"0"),y:parseFloat(s.Project?.Origin?.Y||"0")},a=s.Project?.AudienceZoneManager;if(!a)throw new Error("No audience zone manager found in FC3 file");for(const[c,u]of Object.entries(a))if(c.slice(0,5)==="Zone["){const d=u,p=d.Label||c;n.beginGroup(p);const m=new k(parseFloat(d.X)-i.x,parseFloat(d.Y)-i.y,0);n.translate(m.x,m.y,m.z),d.Orientation&&n.rotate(0,0,et(parseFloat(d.Orientation)));for(const[v,y]of Object.entries(d))if(v.slice(0,5)==="Area["){const S=y;this.processZoneArea(d,S,n,r,p)}n.endGroup()}return n.build()}extractEaseData(e){try{const t=new Uint8Array(e),n=[31,139],r=this.findOffset(t,n);if(r===-1)throw new Error("GZIP signature not found in FC3 file");const s=bs.ungzip(t.slice(r),{to:"string"}),i=new DOMParser().parseFromString(s,"application/xml"),a=i.getElementsByTagName("Keys")[0],c=i.getElementsByTagName("Values")[0];if(!a||!c)throw new Error("Invalid FC3 file structure");const u=a.getAttribute("href")?.slice(1),d=c.getAttribute("href")?.slice(1);if(!u||!d)throw new Error("Missing keys or values reference in FC3 file");const p=[],m=i.getElementById(u);if(m)for(const _ of m.children)p.push(_.innerHTML);const v=[],y=i.getElementById(d);if(y)for(const _ of y.children)v.push(_.innerHTML);const S={};for(let _=0;_<p.length;_++)this.createObjects(S,p[_].split("."),v[_]);return S}catch(t){return console.error("Error extracting EASE data:",t),null}}createObjects(e,t,n){return t.length===1?(e[t[0]]=n,e):(e[t[0]]=e[t[0]]||{},this.createObjects(e[t[0]],t.slice(1),n))}processZoneArea(e,t,n,r,s){(!e.Type||e.Type==="")&&(e.Width!==void 0&&(e.Type="Rectangle"),e.Radius!==void 0&&(e.Type="Arc"),e.FrontEdge!==void 0&&(e.Type="Trapezoid"),e.RightAngleLeft!==void 0&&(e.Type="Right Trapezoid"));const i=t.Label||"Area",a=r.getMaterialForObject(`${e.Type} ${i}`,void 0,s,"listen");switch(e.Type){case"Annulus":case"Arc":this.createArcGeometry(e,t,n,i,a);break;case"Right Trapezoid":this.createRightTrapezoid(e,t,n,i,a);break;case"Trapezoid":this.createTrapezoid(e,t,n,i,a);break;case"Rectangle":this.createRectangle(e,t,n,i,a);break;default:console.warn(`Unknown EASE zone type: ${e.Type}`)}}createArcGeometry(e,t,n,r,s){const i=(parseFloat(e.InnerRadius||"0")||0)+parseFloat(t.D1),a=(parseFloat(e.InnerRadius||"0")||0)+parseFloat(t.D2),c=parseFloat(e.SweepAngle||"360"),u=360-c/2,d=u+c,p=[new k(a,0,parseFloat(t.Z2)),new k(i,0,parseFloat(t.Z1))];n.addRevolution(p,{name:r,material:s,startAngle:et(u),endAngle:et(d),segments:Math.max(8,Math.ceil(c/10)),closed:c>=360,axis:new k(0,0,1),surfaceType:"listen"})}createRightTrapezoid(e,t,n,r,s){const i=e.RightAngleLeft||0,a=parseFloat(t.D1),c=parseFloat(t.D2),u=parseFloat(e.FrontEdge?.toString()||"0"),d=parseFloat(e.BackEdge?.toString()||"0"),p=e.Depth||0,m=(d-u)/p,v=new k(-p/2+a,u+a*m,parseFloat(t.Z1)),y=new k(-p/2+c,u+c*m,parseFloat(t.Z2)),S=new k(-p/2+c,0,parseFloat(t.Z2)),_=new k(-p/2+a,0,parseFloat(t.Z1));i==0?(v.y=-v.y,y.y=-y.y,n.addQuad(_,S,y,v,{name:r,material:s,surfaceType:"listen"})):n.addQuad(v,y,S,_,{name:r,material:s,surfaceType:"listen"})}createTrapezoid(e,t,n,r,s){const i=e.Depth||0,a=parseFloat(e.FrontEdge?.toString()||"0"),u=(parseFloat(e.BackEdge?.toString()||"0")-a)/i,d=parseFloat(t.D1),p=parseFloat(t.D2),m=new k(-(i/2)+d,-d*u/2-a/2,parseFloat(t.Z1)),v=new k(-(i/2)+p,-p*u/2-a/2,parseFloat(t.Z2)),y=new k(-(i/2)+p,p*u/2+a/2,parseFloat(t.Z2)),S=new k(-(i/2)+d,d*u/2+a/2,parseFloat(t.Z1));n.addQuad(S,m,v,y,{name:r,material:s,surfaceType:"listen"})}createRectangle(e,t,n,r,s){const i=e.Depth||0,a=e.Width||0,c=parseFloat(t.D1),u=parseFloat(t.D2),d=new k(-(i/2)+c,-a/2,parseFloat(t.Z1)),p=new k(-(i/2)+u,-a/2,parseFloat(t.Z2)),m=new k(-(i/2)+u,a/2,parseFloat(t.Z2)),v=new k(-(i/2)+c,a/2,parseFloat(t.Z1));n.addQuad(d,p,m,v,{name:r,material:s,surfaceType:"listen"})}findOffset(e,t){return e.findIndex((n,r,s)=>{if(r+t.length>s.length)return!1;const i=s.slice(r,r+t.length);return t.every((a,c)=>i[c]===a)})}}class ws{convert(e,t){const n=new St({originalFormat:"obj",originalFileName:t,author:"Wavefront OBJ",comments:"Converted from OBJ format"});n.setCoordinateSystem("right-handed").setUpAxis("y").setUnits("meters");const r=Nt("obj"),s=this.parseObjData(e);for(const i of s.objects)if(i.faces.length>0){const a=r.getMaterialForObject(i.name||"OBJ Mesh",void 0,"obj_objects","structure");n.addMesh(s.vertices,i.faces,{name:i.name||"OBJ Mesh",material:a,normals:s.normals.length>0?s.normals:void 0,uvs:s.uvs.length>0?s.uvs:void 0})}return n.build()}parseObjData(e){const t=[],n=[],r=[],s=[];let i={name:"default",faces:[]};s.push(i);const a=e.split(`
`);for(const u of a){const d=u.trim();if(!d||d.startsWith("#"))continue;const p=d.split(/\s+/);switch(p[0]){case"v":if(p.length>=4){const v=parseFloat(p[1]),y=parseFloat(p[2]),S=parseFloat(p[3]);t.push(new k(v,y,S))}break;case"vn":if(p.length>=4){const v=parseFloat(p[1]),y=parseFloat(p[2]),S=parseFloat(p[3]);n.push(new k(v,y,S))}break;case"vt":if(p.length>=3){const v=parseFloat(p[1]),y=parseFloat(p[2]);r.push(new Vt(v,y))}break;case"f":if(p.length>=4){const v=this.parseFace(p.slice(1));v.length>=3&&i.faces.push(v)}break;case"o":case"g":p.length>=2&&(i={name:p.slice(1).join(" "),faces:[]},s.push(i));break}}const c=s.filter(u=>u.faces.length>0);return{vertices:t,normals:n,uvs:r,objects:c.length>0?c:[i]}}parseFace(e){const t=[];for(const n of e){const r=n.split("/"),s=parseInt(r[0]);isNaN(s)||t.push(s-1)}if(t.length>4){const n=[];for(let r=1;r<t.length-1;r++)n.push(t[0],t[r],t[r+1]);return n}return t}static fromThreeObject(e,t){const n=new St({originalFormat:"threejs",originalFileName:t,author:"Three.js Object",comments:"Converted from Three.js Object3D"});n.setCoordinateSystem("right-handed").setUpAxis("y").setUnits("meters");const r=Nt("general");function s(i,a,c=0){if(i.isMesh&&i.geometry){const u=i.geometry,d=u.getAttribute("position");if(d){const p=[],m=[];for(let _=0;_<d.count;_++){const E=d.getX(_),D=d.getY(_),T=d.getZ(_);p.push(new k(E,D,T))}const v=u.index;if(v)for(let _=0;_<v.count;_+=3){const E=v.getX(_),D=v.getX(_+1),T=v.getX(_+2);m.push([E,D,T])}else for(let _=0;_<d.count;_+=3)m.push([_,_+1,_+2]);const y=i.matrixWorld;p.forEach(_=>{_.applyMatrix4(y)});const S=r.getMaterialForObject(i.name||"Three.js Mesh",void 0,"threejs_objects","structure");a.addMesh(p,m,{name:i.name||"Three.js Mesh",material:S})}}if(i.children)for(const u of i.children)u.children&&u.children.length>0?(a.beginGroup(u.name||"Group"),s(u,a,c+1),a.endGroup()):s(u,a,c+1)}return s(e,n),n.build()}}let Ts=class{convert(e,t){const n=JSON.parse(e),r=new St({originalFormat:n.metadata.originalFormat||"cif",originalFileName:t||n.metadata.originalFileName,author:n.metadata.author,comments:n.metadata.comments,version:n.metadata.version,created:n.metadata.created?new Date(n.metadata.created):new Date,formatSpecific:n.metadata.formatSpecific});if(r.setUnits(n.units||"meters").setCoordinateSystem(n.coordinateSystem||"right-handed").setUpAxis(n.upAxis||"z"),n.materials)for(const[s,i]of Object.entries(n.materials)){const a=i;r.addMaterial(s,{name:a.name,color:new Be(a.color.r,a.color.g,a.color.b),opacity:a.opacity,transparent:a.transparent,properties:a.properties})}if(n.root&&n.root.children)for(const s of n.root.children)this.processObject(s,r);return r.build()}processObject(e,t){if(e.type==="group"){if(t.beginGroup(e.name),this.setObjectProperties(e,t),e.children)for(const n of e.children)this.processObject(n,t);t.endGroup()}else{const n=this.parseTransform(e.transform),r=this.parseMaterial(e.material);switch(e.type){case"triangle":const s=this.parseVertices(e.vertices,3);t.addTriangle(s[0],s[1],s[2],{name:e.name,material:r,transform:n});break;case"quad":const i=this.parseVertices(e.vertices,4);t.addQuad(i[0],i[1],i[2],i[3],{name:e.name,material:r,transform:n});break;case"cube":t.addCube(this.parseVertices(e.vertices,8),{name:e.name,material:r,transform:n});break;case"revolution":t.addRevolution(this.parseVertices(e.profile),{name:e.name,material:r,transform:n,axis:this.parseVector3(e.axis),startAngle:e.startAngle,endAngle:e.endAngle,segments:e.segments});break;case"mesh":t.addMesh(this.parseVertices(e.vertices),e.faces,{name:e.name,material:r,transform:n});break}}}setObjectProperties(e,t){if(e.transform){const n=this.parseTransform(e.transform);t.setTransform(n)}}parseTransform(e){return{position:this.parseVector3(e.position),rotation:this.parseVector3(e.rotation),scale:this.parseVector3(e.scale)}}parseVector3(e){return new k(e.x,e.y,e.z)}parseVertices(e,t){const n=e.map(r=>this.parseVector3(r));if(t&&n.length!==t)throw new Error(`Expected ${t} vertices, got ${n.length}`);return n}parseMaterial(e){return{name:e.name,color:new Be(e.color.r,e.color.g,e.color.b),opacity:e.opacity,transparent:e.transparent,properties:e.properties}}};class As{convert(e,t){const n=JSON.parse(e),r=new St({originalFormat:"cvf",originalFileName:t,author:n.title||"Clair Venue Exchange",comments:n.notes||"Converted from CVF format"});r.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const s=Nt("cvf");r.beginGroup("CVF_Import"),r.rotate(0,0,et(90));for(const i of n.zones)this.processZone(i,n.projectOrigin,r,s);return r.endGroup(),r.build()}processZone(e,t,n,r){n.beginGroup(e.name);const s=new k(e.position.x-t.x,e.position.y-t.y,0);n.translate(s.x,s.y,s.z),n.rotate(0,0,et(e.rotation));for(const i of e.sections)this.processSection(e,i,n,r);n.endGroup()}processSection(e,t,n,r){if(t.points.length<3){console.warn(`Section ${t.name} has fewer than 3 points, skipping`);return}const i=r.getMaterialForObject(`${e.params.type} ${t.name}`,void 0,e.name,"listen");switch(e.params.type){case"SymmetricPolygon":this.createSymmetricPolygonSection(e,t,n,i);break;case"AsymmetricPolygon":this.createAsymmetricPolygonSection(e,t,n,i);break;case"Circular":this.createCircularSection(e,t,n,i);break;default:console.warn(`Unknown CVF zone type: ${e.params.type}`)}}createSymmetricPolygonSection(e,t,n,r){const s=e.params,i=s.frontWidth||0,a=s.rearWidth||0,c=e.depth;for(let u=0;u<t.points.length-1;u++){const d=t.points[u],p=t.points[u+1],m=this.interpolateWidth(d.x,c,i,a),v=this.interpolateWidth(p.x,c,i,a),y=new k(d.x-c/2,-m/2,d.z),S=new k(p.x-c/2,-v/2,p.z),_=new k(d.x-c/2,m/2,d.z),E=new k(p.x-c/2,v/2,p.z);n.addQuad(y,S,E,_,{name:`${t.name}_segment_${u}`,material:r,surfaceType:"listen"})}}createAsymmetricPolygonSection(e,t,n,r){const s=e.params,i=s.frontRightWidth||0,a=s.frontLeftWidth||0,c=s.rearRightWidth||0,u=s.rearLeftWidth||0,d=e.depth;for(let p=0;p<t.points.length-1;p++){const m=t.points[p],v=t.points[p+1],y=this.interpolateWidth(m.x,d,i,c),S=this.interpolateWidth(m.x,d,a,u),_=this.interpolateWidth(v.x,d,i,c),E=this.interpolateWidth(v.x,d,a,u),D=new k(m.x-d/2,y,m.z),T=new k(v.x-d/2,_,v.z),M=new k(m.x-d/2,-S,m.z),R=new k(v.x-d/2,-E,v.z);n.addQuad(M,R,T,D,{name:`${t.name}_segment_${p}`,material:r,surfaceType:"listen"})}}createCircularSection(e,t,n,r){const s=e.params,i=s.frontRadius||0,a=s.angle||360,c=[];for(const p of t.points){const m=i+p.x;c.push(new k(m,0,p.z))}const u=360-a/2,d=u+a;n.addRevolution(c,{name:t.name,material:r,startAngle:et(u),endAngle:et(d),segments:Math.max(8,Math.ceil(a/10)),closed:a>=360,axis:new k(0,0,1),surfaceType:"listen"})}interpolateWidth(e,t,n,r){const s=(e+t/2)/t;return n+(r-n)*s}}var Es=Object.defineProperty,Is=(l,e,t)=>e in l?Es(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Ss=(l,e,t)=>Is(l,e+"",t);const dr=class hr{static getSupportedExtensions(){return this.SUPPORTED_EXTENSIONS}static isSupported(e){return this.SUPPORTED_EXTENSIONS.includes(e.toLowerCase())}async processFile(e,t){const n=performance.now(),r=this.getFileExtension(t);if(!hr.isSupported(r))throw new Error(`Unsupported file format: ${r}`);try{let s,i;switch(r){case"dbacv":s=await this.processDbacv(e,t);break;case"fc3":case"fc2":s=await this.processFc3(e,t);break;case"obj":s=await this.processObj(e,t);break;case"cvf":s=await this.processCvf(e,t);break;case"cif":case"json":s=await this.processCIF(e,t);break;default:throw new Error(`Unsupported format: ${r}`)}const a=performance.now()-n;return{cifScene:s,threeObject:i,metadata:{format:r.toUpperCase(),fileName:t,processingTime:a,objectCount:s?.root?.children?.length||0}}}catch(s){throw console.error(`Error processing ${r} file:`,s),new Error(`Failed to process ${r} file: ${s instanceof Error?s.message:"Unknown error"}`)}}async processDbacv(e,t){try{let n;if(e.startsWith("data:")){const s=e.split(",")[1];n=atob(s)}else n=e;return new us().convert(n,t)}catch(n){throw new Error(`DBACV processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processFc3(e,t){try{return new _s().convert(e,t)}catch(n){throw new Error(`FC3 processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processObj(e,t){try{let n;if(e.startsWith("data:")){const s=e.split(",")[1];n=atob(s)}else n=e;return new ws().convert(n,t)}catch(n){throw new Error(`OBJ processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processCvf(e,t){try{let n;if(e.startsWith("data:")){const s=e.split(",")[1];n=atob(s)}else n=e;return new As().convert(n,t)}catch(n){throw new Error(`CVF processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processCIF(e,t){try{let n;if(e.startsWith("data:")){const s=e.split(",")[1];n=atob(s)}else n=e;return new Ts().convert(n,t)}catch(n){throw new Error(`CIF processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}getFileExtension(e){return e.split(".").pop()?.toLowerCase()||""}static validateFile(e){if(e.size>52428800)return{valid:!1,error:"File too large. Maximum size is 50MB."};const n=e.name.split(".").pop()?.toLowerCase()||"";return this.isSupported(n)?{valid:!0}:{valid:!1,error:`Unsupported file type: ${n}. Supported types: ${this.SUPPORTED_EXTENSIONS.join(", ")}`}}static async readFile(e){return new Promise((t,n)=>{const r=new FileReader,s=e.name.split(".").pop()?.toLowerCase()||"";r.onload=i=>{i.target?.result?t(i.target.result):n(new Error("Failed to read file"))},r.onerror=()=>n(new Error("Error reading file")),s==="fc3"||s==="fc2"?r.readAsArrayBuffer(e):r.readAsDataURL(e)})}};Ss(dr,"SUPPORTED_EXTENSIONS",["dbacv","fc3","fc2","obj","cif","json","cvf"]);let xn=dr;class it{static applyTransform(e,t){return e.map(n=>{const r=n.clone();r.multiply(t.scale);const s=new Et(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return r.applyEuler(s),r.add(t.position),r})}static applyTransformToVertex(e,t){const n=e.clone();n.multiply(t.scale);const r=new Et(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return n.applyEuler(r),n.add(t.position),n}static applyTransformToNormals(e,t){return e.map(n=>{const r=n.clone();r.divide(t.scale);const s=new Et(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return r.applyEuler(s),r.normalize(),r})}static combineTransforms(e,t){const n=t.position.clone();n.multiply(e.scale);const r=new Et(e.rotation.x,e.rotation.y,e.rotation.z,"XYZ");n.applyEuler(r),n.add(e.position);const s=new k(e.rotation.x+t.rotation.x,e.rotation.y+t.rotation.y,e.rotation.z+t.rotation.z),i=new k().copy(e.scale).multiply(t.scale);return{position:n,rotation:s,scale:i}}static createIdentityTransform(){return{position:new k(0,0,0),rotation:new k(0,0,0),scale:new k(1,1,1)}}}class Cs{export(e){let t=this.generateHeader();return this.processGroup(e.root,it.createIdentityTransform(),(n,r)=>{for(const s of n)t+=this.writeTriangle(s,r)}),t}processGroup(e,t,n){const r=it.combineTransforms(t,e.transform);for(const s of e.children)if(s instanceof Me)this.processGroup(s,r,n);else if(s instanceof ot){const i=this.primitiveToTriangles(s,r);n(i,s.name)}}generateHeader(){return`"; Exported by CIF to SoundVision Exporter"
"; "
";   using Outside is front (white)"
";   using Name By Layer"
";   using Visible Entities"
";"
";"
";"
"; LengthUnit", "m"
";"
`}primitiveToTriangles(e,t){const n=[];switch(e.type){case"triangle":n.push(...this.triangleToTriangles(e));break;case"quad":n.push(...this.quadToTriangles(e));break;case"revolution":n.push(...this.revolutionToTriangles(e));break;case"mesh":n.push(...this.meshToTriangles(e));break}const r=it.combineTransforms(t,e.transform);return n.map(s=>it.applyTransform(s,r))}triangleToTriangles(e){return[e.vertices.map(t=>t.clone())]}quadToTriangles(e){const[t,n,r,s]=e.vertices;return[[t.clone(),n.clone(),r.clone()],[r.clone(),s.clone(),t.clone()]]}revolutionToTriangles(e){const t=[],{profile:n,segments:r,startAngle:s,endAngle:i}=e;if(n.length<2)return t;const a=i-s,c=[];for(let d=0;d<=r;d++){const p=s+a*d/r,m=Math.cos(p),v=Math.sin(p);for(const y of n){const S=y.x*m-y.y*v,_=y.x*v+y.y*m,E=y.z;c.push(new k(S,_,E))}}const u=n.length;for(let d=0;d<r;d++)for(let p=0;p<u-1;p++){const m=d*u+p,v=d*u+p+1,y=(d+1)*u+p+1,S=(d+1)*u+p;t.push([c[m].clone(),c[v].clone(),c[y].clone()]),t.push([c[y].clone(),c[S].clone(),c[m].clone()])}return t}meshToTriangles(e){const t=[];for(const n of e.faces)if(n.length===3)t.push([e.vertices[n[0]].clone(),e.vertices[n[1]].clone(),e.vertices[n[2]].clone()]);else if(n.length===4){const[r,s,i,a]=n;t.push([e.vertices[r].clone(),e.vertices[s].clone(),e.vertices[i].clone()]),t.push([e.vertices[i].clone(),e.vertices[a].clone(),e.vertices[r].clone()])}else for(let r=1;r<n.length-1;r++)t.push([e.vertices[n[0]].clone(),e.vertices[n[r]].clone(),e.vertices[n[r+1]].clone()]);return t}writeTriangle(e,t){const n=e.map(c=>new k(-c.y,c.x,c.z)),r=n[1].clone().sub(n[0]),s=n[2].clone().sub(n[0]);r.cross(s).z<0&&n.reverse();let a=`"Label","${t}"
`;for(const c of n)a+=`${c.x},${c.y},${c.z}
`;return a+=`";"
`,a}}class Ms{export(e){const t=this.extractVertexData(e);return this.generateOBJ(t,e)}extractVertexData(e){const t=[],n=[],r=[],s=[],i=new Map,a=new Map,c=new Map;let u=0,d=0,p=0;const m=_=>{const E=`${_.x.toFixed(6)},${_.y.toFixed(6)},${_.z.toFixed(6)}`;return i.has(E)?i.get(E):(t.push(_.clone()),i.set(E,u),u++)},v=_=>{const E=`${_.x.toFixed(6)},${_.y.toFixed(6)},${_.z.toFixed(6)}`;return a.has(E)?a.get(E):(n.push(_.clone().normalize()),a.set(E,d),d++)},y=_=>{const E=`${_.x.toFixed(6)},${_.y.toFixed(6)}`;return c.has(E)?c.get(E):(r.push({x:_.x,y:_.y}),c.set(E,p),p++)},S=(_,E)=>{const D=it.combineTransforms(E,_.transform);for(const T of _.children)if(T instanceof ot){const M=it.combineTransforms(D,T.transform),R=this.primitiveToVertexData(T,M);for(const O of R.faces){const F=[],$=[],j=[];for(let G=0;G<O.vertices.length;G++)F.push(m(O.vertices[G])),O.normals&&O.normals[G]&&$.push(v(O.normals[G])),O.uvs&&O.uvs[G]&&j.push(y(O.uvs[G]));s.push({vertices:F,normals:$.length>0?$:void 0,uvs:j.length>0?j:void 0,objectName:T.name})}}else T instanceof Me&&S(T,D)};return S(e.root,it.createIdentityTransform()),{vertices:t,normals:n,uvs:r,faces:s}}primitiveToVertexData(e,t){const n=[];switch(e.type){case"triangle":n.push(...this.triangleToFaces(e));break;case"quad":n.push(...this.quadToFaces(e));break;case"revolution":n.push(...this.revolutionToFaces(e));break;case"mesh":n.push(...this.meshToFaces(e));break}return{faces:n.map(r=>({vertices:it.applyTransform(r.vertices,t),normals:r.normals?it.applyTransformToNormals(r.normals,t):void 0,uvs:r.uvs}))}}triangleToFaces(e){return[{vertices:e.vertices.map(t=>t.clone()),normals:e.normals?.map(t=>t.clone()),uvs:e.uvs}]}quadToFaces(e){const[t,n,r,s]=e.vertices,i=e.normals,a=e.uvs;return[{vertices:[t.clone(),n.clone(),r.clone()],normals:i?[i[0].clone(),i[1].clone(),i[2].clone()]:void 0,uvs:a?[a[0],a[1],a[2]]:void 0},{vertices:[r.clone(),s.clone(),t.clone()],normals:i?[i[2].clone(),i[3].clone(),i[0].clone()]:void 0,uvs:a?[a[2],a[3],a[0]]:void 0}]}revolutionToFaces(e){const t=[],{profile:n,segments:r,startAngle:s,endAngle:i}=e;if(n.length<2)return t;const a=i-s,c=[];for(let d=0;d<=r;d++){const p=s+a*d/r,m=Math.cos(p),v=Math.sin(p);for(const y of n){const S=y.x*m-y.y*v,_=y.x*v+y.y*m,E=y.z;c.push(new k(S,_,E))}}const u=n.length;for(let d=0;d<r;d++)for(let p=0;p<u-1;p++){const m=d*u+p,v=d*u+p+1,y=(d+1)*u+p+1,S=(d+1)*u+p;t.push({vertices:[c[m].clone(),c[v].clone(),c[y].clone()]}),t.push({vertices:[c[y].clone(),c[S].clone(),c[m].clone()]})}return t}meshToFaces(e){const t=[];for(const n of e.faces)if(n.length===3)t.push({vertices:[e.vertices[n[0]].clone(),e.vertices[n[1]].clone(),e.vertices[n[2]].clone()],normals:e.normals?[e.normals[n[0]].clone(),e.normals[n[1]].clone(),e.normals[n[2]].clone()]:void 0,uvs:e.uvs?[e.uvs[n[0]],e.uvs[n[1]],e.uvs[n[2]]]:void 0});else if(n.length===4){const[r,s,i,a]=n;t.push({vertices:[e.vertices[r].clone(),e.vertices[s].clone(),e.vertices[i].clone()],normals:e.normals?[e.normals[r].clone(),e.normals[s].clone(),e.normals[i].clone()]:void 0,uvs:e.uvs?[e.uvs[r],e.uvs[s],e.uvs[i]]:void 0}),t.push({vertices:[e.vertices[i].clone(),e.vertices[a].clone(),e.vertices[r].clone()],normals:e.normals?[e.normals[i].clone(),e.normals[a].clone(),e.normals[r].clone()]:void 0,uvs:e.uvs?[e.uvs[i],e.uvs[a],e.uvs[r]]:void 0})}return t}generateOBJ(e,t){let n="";n+=`# Exported by CIF to OBJ Exporter
`,n+=`# Source: ${t.metadata.originalFileName||"Unknown"}
`,n+=`# Created: ${new Date().toISOString()}
`,n+=`# Vertices: ${e.vertices.length}
`,n+=`# Faces: ${e.faces.length}

`;for(const s of e.vertices)n+=`v ${s.x.toFixed(6)} ${s.y.toFixed(6)} ${s.z.toFixed(6)}
`;if(e.uvs.length>0){n+=`
`;for(const s of e.uvs)n+=`vt ${s.x.toFixed(6)} ${s.y.toFixed(6)}
`}if(e.normals.length>0){n+=`
`;for(const s of e.normals)n+=`vn ${s.x.toFixed(6)} ${s.y.toFixed(6)} ${s.z.toFixed(6)}
`}const r=new Map;for(const s of e.faces)r.has(s.objectName)||r.set(s.objectName,[]),r.get(s.objectName).push(s);for(const[s,i]of r){n+=`
# Object: ${s}
`,n+=`o ${s.replace(/\s+/g,"_")}
`;for(const a of i){n+="f ";for(let c=0;c<a.vertices.length;c++){let d=`${a.vertices[c]+1}`;a.uvs&&a.uvs[c]!==void 0?d+=`/${a.uvs[c]+1}`:a.normals&&a.normals[c]!==void 0&&(d+="/"),a.normals&&a.normals[c]!==void 0&&(d+=`/${a.normals[c]+1}`),n+=d,c<a.vertices.length-1&&(n+=" ")}n+=`
`}}return n}}var ks=Object.defineProperty,Fs=(l,e,t)=>e in l?ks(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Ut=(l,e,t)=>Fs(l,typeof e!="symbol"?e+"":e,t);class Os{constructor(){Ut(this,"outputDoc"),Ut(this,"nameList",[]),Ut(this,"objectIdCounter",1),Ut(this,"parentChildMap",new Map),this.outputDoc=document.implementation.createDocument("","",null)}export(e){this.nameList=[],this.objectIdCounter=1,this.parentChildMap.clear();const t=this.outputDoc.createElement("ArrayCalc");t.setAttribute("Version","11.1.1");const n=this.outputDoc.createElement("Project");n.setAttribute("Name",e.metadata.originalFileName||"Convertifer3D");let r=this.outputDoc.createElement("Date");r.textContent=new Date().toLocaleDateString(),n.appendChild(r),r=this.outputDoc.createElement("Author"),r.textContent=e.metadata.author||"Convertifer 3D",n.appendChild(r),r=this.outputDoc.createElement("Comments"),r.textContent=e.metadata.comments||"Converted from CIF format",n.appendChild(r),t.appendChild(n);const s=this.outputDoc.createElement("Venue");s.setAttribute("Version","9"),t.appendChild(s);const i=this.createWrapperGroup();s.appendChild(i),this.convertGroup(e.root,i);let a=new XMLSerializer().serializeToString(t);return a=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ArrayCalc>`+a,a}convertGroup(e,t){const n=e.name!=="Root"&&this.hasNonIdentityTransform(e.transform);let r=t;n&&(r=this.createGroupElement(e),t.appendChild(r));for(const s of e.children)if("type"in s){const i=s;!n&&e.name!=="Root"&&(i.transform=this.combineTransforms(e.transform,i.transform));const a=this.convertPrimitive(i);for(const c of a)r.appendChild(c)}else{const i=s;!n&&e.name!=="Root"&&(i.transform=this.combineTransforms(e.transform,i.transform)),this.convertGroup(i,r)}}createWrapperGroup(){const e=this.outputDoc.createElement("RoomObject"),t=this.objectIdCounter++;return e.setAttribute("Id",t.toString()),e.setAttribute("ObjectGroup","true"),e.setAttribute("Shape","5"),e.setAttribute("PlaneType","1"),e.setAttribute("Name",this.getUniqueName("Scene")),e.setAttribute("Enabled","1"),e.setAttribute("Transparent","1"),e.setAttribute("Locked","0"),e.setAttribute("ListenerHeight","1.7"),e.setAttribute("Color",this.colorToDbacv(8947848)),e.setAttribute("PrintColor","4294945280"),e.setAttribute("ParentVenueObjectId","0"),e.setAttribute("OrderIndex","4"),this.addWrapperTransform(e),e}createGroupElement(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;return t.setAttribute("Id",n.toString()),t.setAttribute("ObjectGroup","true"),t.setAttribute("Shape","5"),t.setAttribute("PlaneType","1"),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent","1"),t.setAttribute("Locked",e.locked?"1":"0"),t.setAttribute("ListenerHeight","1.7"),t.setAttribute("Color",this.colorToDbacv(8947848)),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),this.addTransformElements(t,e.transform),t}convertPrimitive(e){const t=[];switch(e.type){case"triangle":t.push(this.convertTriangle(e));break;case"quad":t.push(this.convertQuad(e));break;case"cube":t.push(this.convertCube(e));break;case"revolution":t.push(...this.convertRevolution(e));break;case"mesh":t.push(...this.convertMesh(e));break}return t}convertTriangle(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;t.setAttribute("Id",n.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","6"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const r=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",r.listenerHeight),t.setAttribute("PlaneType",r.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);for(let s=0;s<3;s++)this.addVertex(t,e.vertices[s],s+1);return this.addTransformElements(t,e.transform),t}convertQuad(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;t.setAttribute("Id",n.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","1"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const r=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",r.listenerHeight),t.setAttribute("PlaneType",r.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);const s=this.ensureQuadAntiClockwise(e.vertices);for(let i=0;i<4;i++)this.addVertex(t,s[i],i+1);return this.addTransformElements(t,e.transform),t}ensureQuadAntiClockwise(e){if(e.length!==4)return e;let t=0;for(let n=0;n<4;n++){const r=e[n],s=e[(n+1)%4];t+=(s.x-r.x)*(s.y+r.y)}return t<0?[e[0],e[3],e[2],e[1]]:e}convertCube(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;t.setAttribute("Id",n.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","4"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const r=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",r.listenerHeight),t.setAttribute("PlaneType",r.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);for(let s=0;s<8;s++)this.addVertex(t,e.vertices[s],s+1);return this.addTransformElements(t,e.transform),t}convertRevolution(e){if(this.canConvertToArcSegment(e))return this.convertRevolutionToArcSegments(e);const t=this.revolutionToMesh(e);return this.convertMeshElements(t,`${e.name}_revolution`,e.material,e.transform,e.visible,e.locked,e.surfaceType)}convertMesh(e){return this.convertMeshElements({vertices:e.vertices,faces:e.faces},e.name,e.material,e.transform,e.visible,e.locked,e.surfaceType)}convertMeshElements(e,t,n,r,s,i,a){const c=[];for(let u=0;u<e.faces.length;u++){const d=e.faces[u],p=this.createFaceRoomObject(d,e.vertices,e.faces.length===1?t:`${t}_face_${u}`,n,r,s,i,a);p&&c.push(p)}return c}createFaceRoomObject(e,t,n,r,s,i,a,c){if(e.length===3){const u=this.outputDoc.createElement("RoomObject"),d=this.objectIdCounter++;if(u.setAttribute("Id",d.toString()),u.setAttribute("Name",this.getUniqueName(n)),u.setAttribute("Shape","6"),u.setAttribute("Enabled",i?"1":"0"),u.setAttribute("Transparent",r.transparent?"1":"0"),u.setAttribute("Locked",a?"1":"0"),c){const p=this.getPlaneTypeAndHeight(c);u.setAttribute("ListenerHeight",p.listenerHeight),u.setAttribute("PlaneType",p.planeType),u.setAttribute("Type",c)}else u.setAttribute("ListenerHeight","1.2"),u.setAttribute("PlaneType","1");u.setAttribute("Color",this.colorToDbacv(r.color.getHex())),u.setAttribute("PrintColor","4294945280"),u.setAttribute("ParentVenueObjectId","0"),u.setAttribute("OrderIndex","4");for(let p=0;p<3;p++)this.addVertex(u,t[e[p]],p+1);return this.addTransformElementsWithRotation(u,s),u}else if(e.length===4){const u=this.outputDoc.createElement("RoomObject"),d=this.objectIdCounter++;if(u.setAttribute("Id",d.toString()),u.setAttribute("Name",this.getUniqueName(n)),u.setAttribute("Shape","1"),u.setAttribute("Enabled",i?"1":"0"),u.setAttribute("Transparent",r.transparent?"1":"0"),u.setAttribute("Locked",a?"1":"0"),c){const p=this.getPlaneTypeAndHeight(c);u.setAttribute("ListenerHeight",p.listenerHeight),u.setAttribute("PlaneType",p.planeType),u.setAttribute("Type",c)}else u.setAttribute("ListenerHeight","1.2"),u.setAttribute("PlaneType","1");u.setAttribute("Color",this.colorToDbacv(r.color.getHex())),u.setAttribute("PrintColor","4294945280"),u.setAttribute("ParentVenueObjectId","0"),u.setAttribute("OrderIndex","4");for(let p=0;p<4;p++)this.addVertex(u,t[e[p]],p+1);return this.addTransformElementsWithRotation(u,s),u}return null}revolutionToMesh(e){const{profile:t,segments:n,startAngle:r,endAngle:s}=e,i=[],a=[];if(t.length<2)return{vertices:i,faces:a};const c=s-r;for(let d=0;d<=n;d++){const p=r+c*d/n,m=Math.cos(p),v=Math.sin(p);for(const y of t){const S=y.x*m-y.y*v,_=y.x*v+y.y*m,E=y.z;i.push(new k(S,_,E))}}const u=t.length;for(let d=0;d<n;d++)for(let p=0;p<u-1;p++){const m=d*u+p,v=d*u+p+1,y=(d+1)*u+p+1,S=(d+1)*u+p;a.push([m,v,y]),a.push([y,S,m])}return{vertices:i,faces:a}}addVertex(e,t,n){const r=this.outputDoc.createElement(`P${n}`);r.setAttribute("x",t.x.toString()),r.setAttribute("y",t.y.toString()),r.setAttribute("z",t.z.toString()),e.appendChild(r)}addTransformElements(e,t){this.addTransformElementsWithRotation(e,t)}addWrapperTransform(e){let t=this.outputDoc.createElement("Origin");t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("z","0"),e.appendChild(t),t=this.outputDoc.createElement("Rotation"),t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("z","0"),e.appendChild(t),t=this.outputDoc.createElement("Scaling"),t.setAttribute("x","1"),t.setAttribute("y","1"),t.setAttribute("z","1"),e.appendChild(t)}addTransformElementsWithRotation(e,t){const n=t.position.x,r=t.position.y,s=t.position.z;let i=this.outputDoc.createElement("Origin");i.setAttribute("x",n.toString()),i.setAttribute("y",r.toString()),i.setAttribute("z",s.toString()),e.appendChild(i),i=this.outputDoc.createElement("Rotation"),i.setAttribute("x",It(t.rotation.x).toString()),i.setAttribute("y",It(t.rotation.y).toString()),i.setAttribute("z",It(t.rotation.z).toString()),e.appendChild(i),i=this.outputDoc.createElement("Scaling"),i.setAttribute("x",t.scale.x.toString()),i.setAttribute("y",t.scale.y.toString()),i.setAttribute("z",t.scale.z.toString()),e.appendChild(i)}colorToDbacv(e){return((4278190080|e)>>>0).toString()}getPlaneTypeAndHeight(e){switch(e){case"listen":return{planeType:"1",listenerHeight:"1.7"};case"obstacle":return{planeType:"1",listenerHeight:"1.2"};case"structure":return{planeType:"4",listenerHeight:"0.01"};default:return{planeType:"1",listenerHeight:"1.2"}}}getUniqueName(e){(!e||e==="")&&(e="element");const t=this.nameList.filter(n=>n.includes(e));return this.nameList.push(e),t.length===0?e:`${e}#${t.length}`}canConvertToArcSegment(e){if(e.profile.length<2)return!1;const t=e.axis.normalize(),n=new k(0,0,1);return!(t.distanceTo(n)>.01)}convertRevolutionToArcSegments(e){const t=[],n=e.profile;for(let r=0;r<n.length-1;r++){const s=n[r],i=n[r+1],a=this.createSingleArcSegment(e,s,i,`${e.name}_arc_${r}`);t.push(a)}return t}createSingleArcSegment(e,t,n,r){const s=this.outputDoc.createElement("RoomObject"),i=this.objectIdCounter++;s.setAttribute("Id",i.toString()),s.setAttribute("Name",this.getUniqueName(r)),s.setAttribute("Shape","2"),s.setAttribute("Enabled",e.visible?"1":"0"),s.setAttribute("Transparent",e.material.transparent?"1":"0"),s.setAttribute("Locked",e.locked?"1":"0");const a=this.getPlaneTypeAndHeight(e.surfaceType);s.setAttribute("ListenerHeight",a.listenerHeight),s.setAttribute("PlaneType",a.planeType),s.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),s.setAttribute("PrintColor","4294945280"),s.setAttribute("ParentVenueObjectId","0"),s.setAttribute("OrderIndex","4"),s.setAttribute("Type",e.surfaceType);const c=Math.abs(t.x),u=Math.abs(n.x),d=t.z,p=n.z,m=It(e.startAngle),v=e.endAngle-e.startAngle;let y=v*180/Math.PI;return(Math.abs(v-2*Math.PI)<.001||Math.abs(y)<.001)&&(y=360),s.setAttribute("OuterRadiusA",c.toString()),s.setAttribute("OuterRadiusB",c.toString()),s.setAttribute("InnerRadiusA",u.toString()),s.setAttribute("InnerRadiusB",u.toString()),s.setAttribute("StartAngle",m.toString()),s.setAttribute("SpanAngle",y.toString()),s.setAttribute("OuterZ",d.toString()),s.setAttribute("InnerZ",p.toString()),this.addTransformElements(s,e.transform),s}hasNonIdentityTransform(e){const t=e.position,n=e.rotation,r=e.scale;return Math.abs(t.x)>1e-6||Math.abs(t.y)>1e-6||Math.abs(t.z)>1e-6||Math.abs(n.x)>1e-6||Math.abs(n.y)>1e-6||Math.abs(n.z)>1e-6||Math.abs(r.x-1)>1e-6||Math.abs(r.y-1)>1e-6||Math.abs(r.z-1)>1e-6}combineTransforms(e,t){return{position:new k(e.position.x+t.position.x,e.position.y+t.position.y,e.position.z+t.position.z),rotation:new k(e.rotation.x+t.rotation.x,e.rotation.y+t.rotation.y,e.rotation.z+t.rotation.z),scale:new k(e.scale.x*t.scale.x,e.scale.y*t.scale.y,e.scale.z*t.scale.z)}}}class zs{export(e){const t=this.sceneToSerializable(e);return JSON.stringify(t,null,2)}sceneToSerializable(e){return{metadata:{...e.metadata,created:e.metadata.created.toISOString()},root:this.objectToSerializable(e.root),materials:this.materialsToSerializable(e.materials),units:e.units,coordinateSystem:e.coordinateSystem,upAxis:e.upAxis}}objectToSerializable(e){const t={id:e.id,name:e.name,transform:{position:{x:e.transform.position.x,y:e.transform.position.y,z:e.transform.position.z},rotation:{x:e.transform.rotation.x,y:e.transform.rotation.y,z:e.transform.rotation.z},scale:{x:e.transform.scale.x,y:e.transform.scale.y,z:e.transform.scale.z}},visible:e.visible,locked:e.locked,parentId:e.parentId,userData:e.userData};if("children"in e)return{...t,type:"group",children:e.children.map(r=>this.objectToSerializable(r))};{const n=e,r={...t,type:n.type,material:this.materialToSerializable(n.material)};switch(n.type){case"triangle":const s=n;r.vertices=s.vertices.map(d=>({x:d.x,y:d.y,z:d.z})),s.normals&&(r.normals=s.normals.map(d=>({x:d.x,y:d.y,z:d.z}))),s.uvs&&(r.uvs=s.uvs.map(d=>({x:d.x,y:d.y})));break;case"quad":const i=n;r.vertices=i.vertices.map(d=>({x:d.x,y:d.y,z:d.z})),i.normals&&(r.normals=i.normals.map(d=>({x:d.x,y:d.y,z:d.z}))),i.uvs&&(r.uvs=i.uvs.map(d=>({x:d.x,y:d.y})));break;case"cube":const a=n;r.vertices=a.vertices.map(d=>({x:d.x,y:d.y,z:d.z}));break;case"revolution":const c=n;r.profile=c.profile.map(d=>({x:d.x,y:d.y,z:d.z})),r.axis={x:c.axis.x,y:c.axis.y,z:c.axis.z},r.startAngle=c.startAngle,r.endAngle=c.endAngle,r.segments=c.segments,r.closed=c.closed;break;case"mesh":const u=n;r.vertices=u.vertices.map(d=>({x:d.x,y:d.y,z:d.z})),r.faces=u.faces,u.normals&&(r.normals=u.normals.map(d=>({x:d.x,y:d.y,z:d.z}))),u.uvs&&(r.uvs=u.uvs.map(d=>({x:d.x,y:d.y})));break}return r}}materialToSerializable(e){return{name:e.name,color:{r:e.color.r,g:e.color.g,b:e.color.b},opacity:e.opacity,transparent:e.transparent,properties:e.properties}}materialsToSerializable(e){const t={};return e.forEach((n,r)=>{t[r]=this.materialToSerializable(n)}),t}}class Ns{export(e){const t={version:"1.0",projectOrigin:{x:0,y:0},zones:[],title:e.metadata.originalFileName||"Converted Venue",notes:e.metadata.comments||"Converted from CIF format"};return this.processGroup(e.root,t,new Ht),JSON.stringify(t,null,2)}processGroup(e,t,n){const r=new Ht;if(e.transform.position&&r.makeTranslation(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation){const m=new Ht;m.makeRotationFromEuler(new Et(e.transform.rotation.x,e.transform.rotation.y,e.transform.rotation.z,"XYZ")),r.multiply(m)}const s=n.clone().multiply(r);if(e.name==="CVF_Import"||e.name==="FC3_Import"||e.name==="Root"){for(const m of e.children)if("children"in m)this.processGroup(m,t,s);else if("type"in m){const v=new Me(m.id+"_temp",m.name||"Geometry");v.children.push(m);const y=this.reconstructZone(v,new k,0);y&&t.zones.push(y)}return}const i=new k,a=new Er,c=new k;s.decompose(i,a,c);const u=new Et().setFromRotationMatrix(s),d=It(u.z)-90,p=this.reconstructZone(e,i,d);p&&t.zones.push(p);for(const m of e.children)"children"in m&&this.processGroup(m,t,s)}reconstructZone(e,t,n){const r=[];for(const p of e.children)"type"in p&&r.push(p);if(r.length===0)return null;const s=r.some(p=>p.type==="revolution"),i=r.some(p=>p.type==="quad"),a=r.some(p=>p.type==="triangle");let c,u,d=10;if(s){const p=r.find(m=>m.type==="revolution");if(p)c={type:"Circular",frontRadius:0,angle:It(p.endAngle-p.startAngle)},u=this.extractSectionsFromRevolution(p);else return null}else if(i||a)c={type:"SymmetricPolygon",frontWidth:10,rearWidth:10},u=this.extractSectionsFromQuads(r),d=this.estimateDepthFromQuads(r);else return null;return{name:e.name||"Zone",position:{x:t.x,y:t.y},rotation:n,sections:u,depth:d,params:c}}extractSectionsFromRevolution(e){const t={name:e.name||"Section",audienceHeight:0,points:[]};for(const n of e.profile)t.points.push({x:n.x,z:n.z});return t.points.length>0&&(t.audienceHeight=t.points.reduce((n,r)=>n+r.z,0)/t.points.length),[t]}extractSectionsFromQuads(e){const t={name:"Section",audienceHeight:0,points:[]},n=new Map;for(const r of e)if(r.type==="quad"||r.type==="triangle"){const s=(r.type==="quad",r.vertices);for(const i of s){const a=`${i.x.toFixed(3)},${i.z.toFixed(3)}`;n.has(a)||n.set(a,{x:i.x,z:i.z})}}return t.points=Array.from(n.values()).sort((r,s)=>r.x-s.x),t.points.length<3&&(t.points=[{x:0,z:0},{x:5,z:0},{x:10,z:0}]),t.points.length>0&&(t.audienceHeight=t.points.reduce((r,s)=>r+s.z,0)/t.points.length),[t]}estimateDepthFromQuads(e){let t=1/0,n=-1/0;for(const s of e)if(s.type==="quad"||s.type==="triangle"){const i=(s.type==="quad",s.vertices);for(const a of i)t=Math.min(t,a.x),n=Math.max(n,a.x)}const r=n-t;return r>0?r:10}}const Xn={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class En{constructor(){this.pluginCallbacks=[],this.register(function(e){return new Zs(e)}),this.register(function(e){return new js(e)}),this.register(function(e){return new Ys(e)}),this.register(function(e){return new Ks(e)}),this.register(function(e){return new Xs(e)}),this.register(function(e){return new qs(e)}),this.register(function(e){return new Vs(e)}),this.register(function(e){return new Ws(e)}),this.register(function(e){return new Js(e)}),this.register(function(e){return new Qs(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){const s=new Hs,i=[];for(let a=0,c=this.pluginCallbacks.length;a<c;a++)i.push(this.pluginCallbacks[a](s));s.setPlugins(i),s.write(e,t,r).catch(n)}parseAsync(e,t){const n=this;return new Promise(function(r,s){n.parse(e,r,s,t)})}}const ee={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},pn="KHR_mesh_quantization",Ue={};Ue[kr]=ee.NEAREST;Ue[Fr]=ee.NEAREST_MIPMAP_NEAREST;Ue[Or]=ee.NEAREST_MIPMAP_LINEAR;Ue[zr]=ee.LINEAR;Ue[Nr]=ee.LINEAR_MIPMAP_NEAREST;Ue[Rr]=ee.LINEAR_MIPMAP_LINEAR;Ue[Lr]=ee.CLAMP_TO_EDGE;Ue[Dr]=ee.REPEAT;Ue[Pr]=ee.MIRRORED_REPEAT;const qn={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Rs=new Be,Jn=12,Ls=1179937895,Ds=2,Qn=8,Ps=1313821514,Bs=5130562;function Mt(l,e){return l.length===e.length&&l.every(function(t,n){return t===e[n]})}function Us(l){return new TextEncoder().encode(l).buffer}function Gs(l){return Mt(l.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function $s(l,e,t){const n={min:new Array(l.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(l.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let r=e;r<e+t;r++)for(let s=0;s<l.itemSize;s++){let i;l.itemSize>4?i=l.array[r*l.itemSize+s]:(s===0?i=l.getX(r):s===1?i=l.getY(r):s===2?i=l.getZ(r):s===3&&(i=l.getW(r)),l.normalized===!0&&(i=vn.normalize(i,l.array))),n.min[s]=Math.min(n.min[s],i),n.max[s]=Math.max(n.max[s],i)}return n}function pr(l){return Math.ceil(l/4)*4}function gn(l,e=0){const t=pr(l.byteLength);if(t!==l.byteLength){const n=new Uint8Array(t);if(n.set(new Uint8Array(l)),e!==0)for(let r=l.byteLength;r<t;r++)n[r]=e;return n.buffer}return l}function er(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function tr(l,e){if(l.toBlob!==void 0)return new Promise(n=>l.toBlob(n,e));let t;return e==="image/jpeg"?t=.92:e==="image/webp"&&(t=.8),l.convertToBlob({type:e,quality:t})}class Hs{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const r=this,s=r.buffers,i=r.json;n=r.options;const a=r.extensionsUsed,c=r.extensionsRequired,u=new Blob(s,{type:"application/octet-stream"}),d=Object.keys(a),p=Object.keys(c);if(d.length>0&&(i.extensionsUsed=d),p.length>0&&(i.extensionsRequired=p),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=u.size),n.binary===!0){const m=new FileReader;m.readAsArrayBuffer(u),m.onloadend=function(){const v=gn(m.result),y=new DataView(new ArrayBuffer(Qn));y.setUint32(0,v.byteLength,!0),y.setUint32(4,Bs,!0);const S=gn(Us(JSON.stringify(i)),32),_=new DataView(new ArrayBuffer(Qn));_.setUint32(0,S.byteLength,!0),_.setUint32(4,Ps,!0);const E=new ArrayBuffer(Jn),D=new DataView(E);D.setUint32(0,Ls,!0),D.setUint32(4,Ds,!0);const T=Jn+_.byteLength+S.byteLength+y.byteLength+v.byteLength;D.setUint32(8,T,!0);const M=new Blob([E,_,S,y,v],{type:"application/octet-stream"}),R=new FileReader;R.readAsArrayBuffer(M),R.onloadend=function(){t(R.result)}}}else if(i.buffers&&i.buffers.length>0){const m=new FileReader;m.readAsDataURL(u),m.onloadend=function(){const v=m.result;i.buffers[0].uri=v,t(i)}}else t(i)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;const n=this.options,r=this.extensionsUsed;try{const s=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&s.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(const i in s.gltfExtensions)t.extensions[i]=s.gltfExtensions[i],r[i]=!0;delete s.gltfExtensions}Object.keys(s).length>0&&(t.extras=s)}catch(s){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+s.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){const r=new Map;r.set(!0,this.uid++),r.set(!1,this.uid++),this.uids.set(e,r)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const n=new k;for(let r=0,s=e.count;r<s;r++)if(Math.abs(n.fromBufferAttribute(e,r).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const n=e.clone(),r=new k;for(let s=0,i=n.count;s<i;s++)r.fromBufferAttribute(n,s),r.x===0&&r.y===0&&r.z===0?r.setX(1):r.normalize(),n.setXYZ(s,r.x,r.y,r.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1;const r={};(t.offset.x!==0||t.offset.y!==0)&&(r.offset=t.offset.toArray(),n=!0),t.rotation!==0&&(r.rotation=t.rotation,n=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function n(v){return v.colorSpace===sr?function(S){return S<.04045?S*.0773993808:Math.pow(S*.9478672986+.0521327014,2.4)}:function(S){return S}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures.");const r=e?e.image:null,s=t?t.image:null,i=Math.max(r?r.width:0,s?s.width:0),a=Math.max(r?r.height:0,s?s.height:0),c=er();c.width=i,c.height=a;const u=c.getContext("2d");u.fillStyle="#00ffff",u.fillRect(0,0,i,a);const d=u.getImageData(0,0,i,a);if(r){u.drawImage(r,0,0,i,a);const v=n(e),y=u.getImageData(0,0,i,a).data;for(let S=2;S<y.length;S+=4)d.data[S]=v(y[S]/256)*256}if(s){u.drawImage(s,0,0,i,a);const v=n(t),y=u.getImageData(0,0,i,a).data;for(let S=1;S<y.length;S+=4)d.data[S]=v(y[S]/256)*256}u.putImageData(d,0,0);const m=(e||t).clone();return m.source=new Ir(c),m.colorSpace=Sr,m.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),m}processBuffer(e){const t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,r,s){const i=this.json;i.bufferViews||(i.bufferViews=[]);let a;switch(t){case ee.BYTE:case ee.UNSIGNED_BYTE:a=1;break;case ee.SHORT:case ee.UNSIGNED_SHORT:a=2;break;default:a=4}const c=pr(r*e.itemSize*a),u=new DataView(new ArrayBuffer(c));let d=0;for(let v=n;v<n+r;v++)for(let y=0;y<e.itemSize;y++){let S;e.itemSize>4?S=e.array[v*e.itemSize+y]:(y===0?S=e.getX(v):y===1?S=e.getY(v):y===2?S=e.getZ(v):y===3&&(S=e.getW(v)),e.normalized===!0&&(S=vn.normalize(S,e.array))),t===ee.FLOAT?u.setFloat32(d,S,!0):t===ee.INT?u.setInt32(d,S,!0):t===ee.UNSIGNED_INT?u.setUint32(d,S,!0):t===ee.SHORT?u.setInt16(d,S,!0):t===ee.UNSIGNED_SHORT?u.setUint16(d,S,!0):t===ee.BYTE?u.setInt8(d,S):t===ee.UNSIGNED_BYTE&&u.setUint8(d,S),d+=a}const p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return s!==void 0&&(p.target=s),s===ee.ARRAY_BUFFER&&(p.byteStride=e.itemSize*a),this.byteOffset+=c,i.bufferViews.push(p),{id:i.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){const s=new FileReader;s.readAsArrayBuffer(e),s.onloadend=function(){const i=gn(s.result),a={buffer:t.processBuffer(i),byteOffset:t.byteOffset,byteLength:i.byteLength};t.byteOffset+=i.byteLength,r(n.bufferViews.push(a)-1)}})}processAccessor(e,t,n,r){const s=this.json,i={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let a;if(e.array.constructor===Float32Array)a=ee.FLOAT;else if(e.array.constructor===Int32Array)a=ee.INT;else if(e.array.constructor===Uint32Array)a=ee.UNSIGNED_INT;else if(e.array.constructor===Int16Array)a=ee.SHORT;else if(e.array.constructor===Uint16Array)a=ee.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)a=ee.BYTE;else if(e.array.constructor===Uint8Array)a=ee.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");if(n===void 0&&(n=0),r===void 0&&(r=e.count),r===0)return null;const c=$s(e,n,r);let u;t!==void 0&&(u=e===t.index?ee.ELEMENT_ARRAY_BUFFER:ee.ARRAY_BUFFER);const d=this.processBufferView(e,a,n,r,u),p={bufferView:d.id,byteOffset:d.byteOffset,componentType:a,count:r,max:c.max,min:c.min,type:i[e.itemSize]};return e.normalized===!0&&(p.normalized=!0),s.accessors||(s.accessors=[]),s.accessors.push(p)-1}processImage(e,t,n,r="image/png"){if(e!==null){const s=this,i=s.cache,a=s.json,c=s.options,u=s.pending;i.images.has(e)||i.images.set(e,{});const d=i.images.get(e),p=r+":flipY/"+n.toString();if(d[p]!==void 0)return d[p];a.images||(a.images=[]);const m={mimeType:r},v=er();v.width=Math.min(e.width,c.maxTextureSize),v.height=Math.min(e.height,c.maxTextureSize);const y=v.getContext("2d");if(n===!0&&(y.translate(0,v.height),y.scale(1,-1)),e.data!==void 0){t!==Cr&&console.error("GLTFExporter: Only RGBAFormat is supported."),(e.width>c.maxTextureSize||e.height>c.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const _=new Uint8ClampedArray(e.height*e.width*4);for(let E=0;E<_.length;E+=4)_[E+0]=e.data[E+0],_[E+1]=e.data[E+1],_[E+2]=e.data[E+2],_[E+3]=e.data[E+3];y.putImageData(new ImageData(_,e.width,e.height),0,0)}else y.drawImage(e,0,0,v.width,v.height);c.binary===!0?u.push(tr(v,r).then(_=>s.processBufferViewImage(_)).then(_=>{m.bufferView=_})):v.toDataURL!==void 0?m.uri=v.toDataURL(r):u.push(tr(v,r).then(_=>new FileReader().readAsDataURL(_)).then(_=>{m.uri=_}));const S=a.images.push(m)-1;return d[p]=S,S}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const n={magFilter:Ue[e.magFilter],minFilter:Ue[e.minFilter],wrapS:Ue[e.wrapS],wrapT:Ue[e.wrapT]};return t.samplers.push(n)-1}processTexture(e){const t=this.cache,n=this.json;if(t.textures.has(e))return t.textures.get(e);n.textures||(n.textures=[]);let r=e.userData.mimeType;r==="image/webp"&&(r="image/png");const s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,r)};e.name&&(s.name=e.name),this._invokeAll(function(a){a.writeTexture&&a.writeTexture(e,s)});const i=n.textures.push(s)-1;return t.textures.set(e,i),i}processMaterial(e){const t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);const r={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const s=e.color.toArray().concat([e.opacity]);if(Mt(s,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=s),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const a=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),c={index:this.processTexture(a),channel:a.channel};this.applyTextureTransform(c,a),r.pbrMetallicRoughness.metallicRoughnessTexture=c}if(e.map){const a={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(a,e.map),r.pbrMetallicRoughness.baseColorTexture=a}if(e.emissive){const a=e.emissive;if(Math.max(a.r,a.g,a.b)>0&&(r.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const u={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(u,e.emissiveMap),r.emissiveTexture=u}}if(e.normalMap){const a={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&e.normalScale.x!==1&&(a.scale=e.normalScale.x),this.applyTextureTransform(a,e.normalMap),r.normalTexture=a}if(e.aoMap){const a={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};e.aoMapIntensity!==1&&(a.strength=e.aoMapIntensity),this.applyTextureTransform(a,e.aoMap),r.occlusionTexture=a}e.transparent?r.alphaMode="BLEND":e.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=e.alphaTest),e.side===Qt&&(r.doubleSided=!0),e.name!==""&&(r.name=e.name),this.serializeUserData(e,r),this._invokeAll(function(a){a.writeMaterial&&a.writeMaterial(e,r)});const i=n.materials.push(r)-1;return t.materials.set(e,i),i}processMesh(e){const t=this.cache,n=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let T=0,M=e.material.length;T<M;T++)r.push(e.material[T].uuid);else r.push(e.material.uuid);const s=r.join(":");if(t.meshes.has(s))return t.meshes.get(s);const i=e.geometry;let a;e.isLineSegments?a=ee.LINES:e.isLineLoop?a=ee.LINE_LOOP:e.isLine?a=ee.LINE_STRIP:e.isPoints?a=ee.POINTS:a=e.material.wireframe?ee.LINES:ee.TRIANGLES;const c={},u={},d=[],p=[],m={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},v=i.getAttribute("normal");v!==void 0&&!this.isNormalizedNormalAttribute(v)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),i.setAttribute("normal",this.createNormalizedNormalAttribute(v)));let y=null;for(let T in i.attributes){if(T.slice(0,5)==="morph")continue;const M=i.attributes[T];if(T=m[T]||T.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(T)||(T="_"+T),t.attributes.has(this.getUID(M))){u[T]=t.attributes.get(this.getUID(M));continue}y=null;const O=M.array;T==="JOINTS_0"&&!(O instanceof Uint16Array)&&!(O instanceof Uint8Array)&&(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),y=new fe(new Uint16Array(O),M.itemSize,M.normalized));const F=this.processAccessor(y||M,i);F!==null&&(T.startsWith("_")||this.detectMeshQuantization(T,M),u[T]=F,t.attributes.set(this.getUID(M),F))}if(v!==void 0&&i.setAttribute("normal",v),Object.keys(u).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){const T=[],M=[],R={};if(e.morphTargetDictionary!==void 0)for(const O in e.morphTargetDictionary)R[e.morphTargetDictionary[O]]=O;for(let O=0;O<e.morphTargetInfluences.length;++O){const F={};let $=!1;for(const j in i.morphAttributes){if(j!=="position"&&j!=="normal"){$||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),$=!0);continue}const G=i.morphAttributes[j][O],te=j.toUpperCase(),X=i.attributes[j];if(t.attributes.has(this.getUID(G,!0))){F[te]=t.attributes.get(this.getUID(G,!0));continue}const H=G.clone();if(!i.morphTargetsRelative)for(let W=0,ue=G.count;W<ue;W++)for(let de=0;de<G.itemSize;de++)de===0&&H.setX(W,G.getX(W)-X.getX(W)),de===1&&H.setY(W,G.getY(W)-X.getY(W)),de===2&&H.setZ(W,G.getZ(W)-X.getZ(W)),de===3&&H.setW(W,G.getW(W)-X.getW(W));F[te]=this.processAccessor(H,i),t.attributes.set(this.getUID(X,!0),F[te])}p.push(F),T.push(e.morphTargetInfluences[O]),e.morphTargetDictionary!==void 0&&M.push(R[O])}c.weights=T,M.length>0&&(c.extras={},c.extras.targetNames=M)}const S=Array.isArray(e.material);if(S&&i.groups.length===0)return null;const _=S?e.material:[e.material],E=S?i.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let T=0,M=E.length;T<M;T++){const R={mode:a,attributes:u};if(this.serializeUserData(i,R),p.length>0&&(R.targets=p),i.index!==null){let F=this.getUID(i.index);(E[T].start!==void 0||E[T].count!==void 0)&&(F+=":"+E[T].start+":"+E[T].count),t.attributes.has(F)?R.indices=t.attributes.get(F):(R.indices=this.processAccessor(i.index,i,E[T].start,E[T].count),t.attributes.set(F,R.indices)),R.indices===null&&delete R.indices}const O=this.processMaterial(_[E[T].materialIndex]);O!==null&&(R.material=O),d.push(R)}c.primitives=d,n.meshes||(n.meshes=[]),this._invokeAll(function(T){T.writeMesh&&T.writeMesh(e,c)});const D=n.meshes.push(c)-1;return t.meshes.set(s,D),D}detectMeshQuantization(e,t){if(this.extensionsUsed[pn])return;let n;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");const r=e.split("_",1)[0];Xn[r]&&Xn[r].includes(n)&&(this.extensionsUsed[pn]=!0,this.extensionsRequired[pn]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const n=e.isOrthographicCamera,r={type:n?"orthographic":"perspective"};return n?r.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:vn.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(r.name=e.type),t.cameras.push(r)-1}processAnimation(e,t){const n=this.json,r=this.nodeMap;n.animations||(n.animations=[]),e=En.Utils.mergeMorphTargetTracks(e.clone(),t);const s=e.tracks,i=[],a=[];for(let c=0;c<s.length;++c){const u=s[c],d=Wt.parseTrackName(u.name);let p=Wt.findNode(t,d.nodeName);const m=qn[d.propertyName];if(d.objectName==="bones"&&(p.isSkinnedMesh===!0?p=p.skeleton.getBoneByName(d.objectIndex):p=void 0),!p||!m)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',u.name),null;const v=1;let y=u.values.length/u.times.length;m===qn.morphTargetInfluences&&(y/=p.morphTargetInfluences.length);let S;u.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(S="CUBICSPLINE",y/=3):u.getInterpolation()===Mr?S="STEP":S="LINEAR",a.push({input:this.processAccessor(new fe(u.times,v)),output:this.processAccessor(new fe(u.values,y)),interpolation:S}),i.push({sampler:a.length-1,target:{node:r.get(p),path:m}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:a,channels:i}),n.animations.length-1}processSkin(e){const t=this.json,n=this.nodeMap,r=t.nodes[n.get(e)],s=e.skeleton;if(s===void 0)return null;const i=e.skeleton.bones[0];if(i===void 0)return null;const a=[],c=new Float32Array(s.bones.length*16),u=new Ht;for(let p=0;p<s.bones.length;++p)a.push(n.get(s.bones[p])),u.copy(s.boneInverses[p]),u.multiply(e.bindMatrix).toArray(c,p*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new fe(c,16)),joints:a,skeleton:n.get(i)}),r.skin=t.skins.length-1}processNode(e){const t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);const s={};if(n.trs){const a=e.quaternion.toArray(),c=e.position.toArray(),u=e.scale.toArray();Mt(a,[0,0,0,1])||(s.rotation=a),Mt(c,[0,0,0])||(s.translation=c),Mt(u,[1,1,1])||(s.scale=u)}else e.matrixAutoUpdate&&e.updateMatrix(),Gs(e.matrix)===!1&&(s.matrix=e.matrix.elements);if(e.name!==""&&(s.name=String(e.name)),this.serializeUserData(e,s),e.isMesh||e.isLine||e.isPoints){const a=this.processMesh(e);a!==null&&(s.mesh=a)}else e.isCamera&&(s.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const a=[];for(let c=0,u=e.children.length;c<u;c++){const d=e.children[c];if(d.visible||n.onlyVisible===!1){const p=this.processNode(d);p!==null&&a.push(p)}}a.length>0&&(s.children=a)}this._invokeAll(function(a){a.writeNode&&a.writeNode(e,s)});const i=t.nodes.push(s)-1;return r.set(e,i),i}processScene(e){const t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);const r={};e.name!==""&&(r.name=e.name),t.scenes.push(r);const s=[];for(let i=0,a=e.children.length;i<a;i++){const c=e.children[i];if(c.visible||n.onlyVisible===!1){const u=this.processNode(c);u!==null&&s.push(u)}}s.length>0&&(r.nodes=s),this.serializeUserData(e,r)}processObjects(e){const t=new Yt;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(r){r.beforeParse&&r.beforeParse(e)});const n=[];for(let r=0;r<e.length;r++)e[r]instanceof Yt?this.processScene(e[r]):n.push(e[r]);n.length>0&&this.processObjects(n);for(let r=0;r<this.skins.length;++r)this.processSkin(this.skins[r]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);this._invokeAll(function(r){r.afterParse&&r.afterParse(e)})}_invokeAll(e){for(let t=0,n=this.plugins.length;t<n;t++)e(this.plugins[t])}}class Zs{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}const n=this.writer,r=n.json,s=n.extensionsUsed,i={};e.name&&(i.name=e.name),i.color=e.color.toArray(),i.intensity=e.intensity,e.isDirectionalLight?i.type="directional":e.isPointLight?(i.type="point",e.distance>0&&(i.range=e.distance)):e.isSpotLight&&(i.type="spot",e.distance>0&&(i.range=e.distance),i.spot={},i.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,i.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),s[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},s[this.name]=!0);const a=r.extensions[this.name].lights;a.push(i),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class js{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class Vs{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.clearcoat===0)return;const n=this.writer,r=n.extensionsUsed,s={};if(s.clearcoatFactor=e.clearcoat,e.clearcoatMap){const i={index:n.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(i,e.clearcoatMap),s.clearcoatTexture=i}if(s.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const i={index:n.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(i,e.clearcoatRoughnessMap),s.clearcoatRoughnessTexture=i}if(e.clearcoatNormalMap){const i={index:n.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};n.applyTextureTransform(i,e.clearcoatNormalMap),s.clearcoatNormalTexture=i}t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class Ws{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.iridescence===0)return;const n=this.writer,r=n.extensionsUsed,s={};if(s.iridescenceFactor=e.iridescence,e.iridescenceMap){const i={index:n.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(i,e.iridescenceMap),s.iridescenceTexture=i}if(s.iridescenceIor=e.iridescenceIOR,s.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],s.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const i={index:n.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(i,e.iridescenceThicknessMap),s.iridescenceThicknessTexture=i}t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class Ys{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const n=this.writer,r=n.extensionsUsed,s={};if(s.transmissionFactor=e.transmission,e.transmissionMap){const i={index:n.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(i,e.transmissionMap),s.transmissionTexture=i}t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class Ks{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const n=this.writer,r=n.extensionsUsed,s={};if(s.thicknessFactor=e.thickness,e.thicknessMap){const i={index:n.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(i,e.thicknessMap),s.thicknessTexture=i}s.attenuationDistance=e.attenuationDistance,s.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class Xs{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.ior===1.5)return;const r=this.writer.extensionsUsed,s={};s.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class qs{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.specularIntensity===1&&e.specularColor.equals(Rs)&&!e.specularIntensityMap&&!e.specularColorTexture)return;const n=this.writer,r=n.extensionsUsed,s={};if(e.specularIntensityMap){const i={index:n.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(i,e.specularIntensityMap),s.specularTexture=i}if(e.specularColorMap){const i={index:n.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(i,e.specularColorMap),s.specularColorTexture=i}s.specularFactor=e.specularIntensity,s.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class Js{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.sheen==0)return;const n=this.writer,r=n.extensionsUsed,s={};if(e.sheenRoughnessMap){const i={index:n.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(i,e.sheenRoughnessMap),s.sheenRoughnessTexture=i}if(e.sheenColorMap){const i={index:n.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(i,e.sheenColorMap),s.sheenColorTexture=i}s.sheenRoughnessFactor=e.sheenRoughness,s.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}class Qs{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||e.emissiveIntensity===1)return;const r=this.writer.extensionsUsed,s={};s.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=s,r[this.name]=!0}}En.Utils={insertKeyframe:function(l,e){const n=l.getValueSize(),r=new l.TimeBufferType(l.times.length+1),s=new l.ValueBufferType(l.values.length+n),i=l.createInterpolant(new l.ValueBufferType(n));let a;if(l.times.length===0){r[0]=e;for(let c=0;c<n;c++)s[c]=0;a=0}else if(e<l.times[0]){if(Math.abs(l.times[0]-e)<.001)return 0;r[0]=e,r.set(l.times,1),s.set(i.evaluate(e),0),s.set(l.values,n),a=0}else if(e>l.times[l.times.length-1]){if(Math.abs(l.times[l.times.length-1]-e)<.001)return l.times.length-1;r[r.length-1]=e,r.set(l.times,0),s.set(l.values,0),s.set(i.evaluate(e),l.values.length),a=r.length-1}else for(let c=0;c<l.times.length;c++){if(Math.abs(l.times[c]-e)<.001)return c;if(l.times[c]<e&&l.times[c+1]>e){r.set(l.times.slice(0,c+1),0),r[c+1]=e,r.set(l.times.slice(c+1),c+2),s.set(l.values.slice(0,(c+1)*n),0),s.set(i.evaluate(e),(c+1)*n),s.set(l.values.slice((c+1)*n),(c+2)*n),a=c+1;break}}return l.times=r,l.values=s,a},mergeMorphTargetTracks:function(l,e){const t=[],n={},r=l.tracks;for(let s=0;s<r.length;++s){let i=r[s];const a=Wt.parseTrackName(i.name),c=Wt.findNode(e,a.nodeName);if(a.propertyName!=="morphTargetInfluences"||a.propertyIndex===void 0){t.push(i);continue}if(i.createInterpolant!==i.InterpolantFactoryMethodDiscrete&&i.createInterpolant!==i.InterpolantFactoryMethodLinear){if(i.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),i=i.clone(),i.setInterpolation(Br)}const u=c.morphTargetInfluences.length,d=c.morphTargetDictionary[a.propertyIndex];if(d===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let p;if(n[c.uuid]===void 0){p=i.clone();const v=new p.ValueBufferType(u*p.times.length);for(let y=0;y<p.times.length;y++)v[y*u+d]=p.values[y];p.name=(a.nodeName||"")+".morphTargetInfluences",p.values=v,n[c.uuid]=p,t.push(p);continue}const m=i.createInterpolant(new i.ValueBufferType(1));p=n[c.uuid];for(let v=0;v<p.times.length;v++)p.values[v*u+d]=m.evaluate(p.times[v]);for(let v=0;v<i.times.length;v++){const y=this.insertKeyframe(p,i.times[v]);p.values[y*u+d]=i.values[v]}}return l.tracks=t,l}};class ei{async export(e){const t=new Yt,n=new Fe;n.name=e.root.name||"Root",n.rotation.x=-Math.PI/2,t.add(n),this.processGroup(e.root,n);const r=new En;return new Promise((s,i)=>{r.parse(t,a=>{a instanceof ArrayBuffer?s(a):i(new Error("Expected ArrayBuffer from GLTFExporter but got JSON"))},a=>{i(a)},{binary:!0,onlyVisible:!1,truncateDrawRange:!0,embedImages:!0,maxTextureSize:4096})})}processGroup(e,t){for(const n of e.children)if(n instanceof ot){const r=this.createMeshFromPrimitive(n);r&&t.add(r)}else if(n instanceof Me){const r=new Fe;r.name=n.name,this.applyTransform(r,n.transform),t.add(r),this.processGroup(n,r)}}createMeshFromPrimitive(e){let t=null;switch(e.type){case"triangle":t=this.triangleToGeometry(e);break;case"quad":t=this.quadToGeometry(e);break;case"cube":t=this.cubeToGeometry(e);break;case"revolution":t=this.revolutionToGeometry(e);break;case"mesh":t=this.meshToGeometry(e);break}if(!t)return null;const n=this.createMaterial(e.material),r=new le(t,n);return r.name=e.name,this.applyTransform(r,e.transform),r.userData={...e.userData,cifId:e.id,cifType:e.type,surfaceType:e.surfaceType},r}shouldFlipWinding(e,t,n){const r=new k().subVectors(t,e),s=new k().subVectors(n,e);return new k().crossVectors(r,s).z<0}triangleToGeometry(e){const t=new Qe,n=new k(e.vertices[0].x,e.vertices[0].y,e.vertices[0].z),r=new k(e.vertices[1].x,e.vertices[1].y,e.vertices[1].z),s=new k(e.vertices[2].x,e.vertices[2].y,e.vertices[2].z),i=this.shouldFlipWinding(n,r,s),a=i?[n,s,r]:[n,r,s],c=new Float32Array(9);for(let u=0;u<3;u++)c[u*3]=a[u].x,c[u*3+1]=a[u].y,c[u*3+2]=a[u].z;if(t.setAttribute("position",new fe(c,3)),e.normals&&e.normals.length===3){const u=i?[0,2,1]:[0,1,2],d=new Float32Array(9);for(let p=0;p<3;p++)d[p*3]=e.normals[u[p]].x,d[p*3+1]=e.normals[u[p]].y,d[p*3+2]=e.normals[u[p]].z;t.setAttribute("normal",new fe(d,3))}else t.computeVertexNormals();if(e.uvs&&e.uvs.length===3){const u=i?[0,2,1]:[0,1,2],d=new Float32Array(6);for(let p=0;p<3;p++)d[p*2]=e.uvs[u[p]].x,d[p*2+1]=e.uvs[u[p]].y;t.setAttribute("uv",new fe(d,2))}return t}quadToGeometry(e){const t=new Qe,n=new k(e.vertices[0].x,e.vertices[0].y,e.vertices[0].z),r=new k(e.vertices[1].x,e.vertices[1].y,e.vertices[1].z),s=new k(e.vertices[2].x,e.vertices[2].y,e.vertices[2].z),i=new k(e.vertices[3].x,e.vertices[3].y,e.vertices[3].z),a=this.shouldFlipWinding(n,r,s),c=a?[n,s,r]:[n,r,s],u=a?[n,i,s]:[n,s,i],d=a?[0,2,1]:[0,1,2],p=a?[0,3,2]:[0,2,3],m=new Float32Array(18);if(m[0]=c[0].x,m[1]=c[0].y,m[2]=c[0].z,m[3]=c[1].x,m[4]=c[1].y,m[5]=c[1].z,m[6]=c[2].x,m[7]=c[2].y,m[8]=c[2].z,m[9]=u[0].x,m[10]=u[0].y,m[11]=u[0].z,m[12]=u[1].x,m[13]=u[1].y,m[14]=u[1].z,m[15]=u[2].x,m[16]=u[2].y,m[17]=u[2].z,t.setAttribute("position",new fe(m,3)),e.normals&&e.normals.length===4){const v=new Float32Array(18);for(let y=0;y<3;y++)v[y*3]=e.normals[d[y]].x,v[y*3+1]=e.normals[d[y]].y,v[y*3+2]=e.normals[d[y]].z;for(let y=0;y<3;y++)v[9+y*3]=e.normals[p[y]].x,v[9+y*3+1]=e.normals[p[y]].y,v[9+y*3+2]=e.normals[p[y]].z;t.setAttribute("normal",new fe(v,3))}else t.computeVertexNormals();if(e.uvs&&e.uvs.length===4){const v=new Float32Array(12);for(let y=0;y<3;y++)v[y*2]=e.uvs[d[y]].x,v[y*2+1]=e.uvs[d[y]].y;for(let y=0;y<3;y++)v[6+y*2]=e.uvs[p[y]].x,v[6+y*2+1]=e.uvs[p[y]].y;t.setAttribute("uv",new fe(v,2))}return t}cubeToGeometry(e){const t=new Qe,n=e.vertices,r=[];return r.push(n[0].x,n[0].y,n[0].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[7].x,n[7].y,n[7].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[7].x,n[7].y,n[7].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[7].x,n[7].y,n[7].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[7].x,n[7].y,n[7].z),t.setAttribute("position",new fe(new Float32Array(r),3)),t.computeVertexNormals(),t}revolutionToGeometry(e){const t=new Qe,{profile:n,segments:r,startAngle:s,endAngle:i}=e;if(n.length<2)return t;const a=i-s,c=[];for(let u=0;u<r;u++)for(let d=0;d<n.length-1;d++){const p=s+a*u/r,m=s+a*(u+1)/r,v=Math.cos(p),y=Math.sin(p),S=Math.cos(m),_=Math.sin(m),E=n[d],D=n[d+1],T=new k(E.x*v-E.y*y,E.x*y+E.y*v,E.z),M=new k(D.x*v-D.y*y,D.x*y+D.y*v,D.z),R=new k(D.x*S-D.y*_,D.x*_+D.y*S,D.z),O=new k(E.x*S-E.y*_,E.x*_+E.y*S,E.z),F=1e-6;Math.abs(D.x)<F&&Math.abs(D.y)<F?this.shouldFlipWinding(T,M,O)?c.push(T.x,T.y,T.z,O.x,O.y,O.z,M.x,M.y,M.z):c.push(T.x,T.y,T.z,M.x,M.y,M.z,O.x,O.y,O.z):this.shouldFlipWinding(T,M,R)?(c.push(T.x,T.y,T.z,R.x,R.y,R.z,M.x,M.y,M.z),c.push(T.x,T.y,T.z,O.x,O.y,O.z,R.x,R.y,R.z)):(c.push(T.x,T.y,T.z,M.x,M.y,M.z,R.x,R.y,R.z),c.push(T.x,T.y,T.z,R.x,R.y,R.z,O.x,O.y,O.z))}return t.setAttribute("position",new fe(new Float32Array(c),3)),t.computeVertexNormals(),t}meshToGeometry(e){const t=new Qe,n=[],r=[],s=[];for(const i of e.faces)if(i.length===3){const a=new k(e.vertices[i[0]].x,e.vertices[i[0]].y,e.vertices[i[0]].z),c=new k(e.vertices[i[1]].x,e.vertices[i[1]].y,e.vertices[i[1]].z),u=new k(e.vertices[i[2]].x,e.vertices[i[2]].y,e.vertices[i[2]].z),p=this.shouldFlipWinding(a,c,u)?[i[0],i[2],i[1]]:i;for(const m of p){const v=e.vertices[m];if(n.push(v.x,v.y,v.z),e.normals&&e.normals[m]){const y=e.normals[m];r.push(y.x,y.y,y.z)}if(e.uvs&&e.uvs[m]){const y=e.uvs[m];s.push(y.x,y.y)}}}else if(i.length===4){const[a,c,u,d]=i,p=new k(e.vertices[a].x,e.vertices[a].y,e.vertices[a].z),m=new k(e.vertices[c].x,e.vertices[c].y,e.vertices[c].z),v=new k(e.vertices[u].x,e.vertices[u].y,e.vertices[u].z),y=this.shouldFlipWinding(p,m,v),S=y?[a,u,c]:[a,c,u],_=y?[a,d,u]:[a,u,d];for(const E of S){const D=e.vertices[E];if(n.push(D.x,D.y,D.z),e.normals&&e.normals[E]){const T=e.normals[E];r.push(T.x,T.y,T.z)}if(e.uvs&&e.uvs[E]){const T=e.uvs[E];s.push(T.x,T.y)}}for(const E of _){const D=e.vertices[E];if(n.push(D.x,D.y,D.z),e.normals&&e.normals[E]){const T=e.normals[E];r.push(T.x,T.y,T.z)}if(e.uvs&&e.uvs[E]){const T=e.uvs[E];s.push(T.x,T.y)}}}return t.setAttribute("position",new fe(new Float32Array(n),3)),r.length>0?t.setAttribute("normal",new fe(new Float32Array(r),3)):t.computeVertexNormals(),s.length>0&&t.setAttribute("uv",new fe(new Float32Array(s),2)),t}createMaterial(e){return new Pe({color:e.color,opacity:e.opacity,transparent:e.transparent,side:Qt,metalness:.1,roughness:.8})}applyTransform(e,t){e.position.copy(t.position),e.rotation.setFromVector3(t.rotation),e.scale.copy(t.scale)}}var ti=Object.defineProperty,ni=(l,e,t)=>e in l?ti(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,ri=(l,e,t)=>ni(l,e+"",t);const gr=class mr{static getSupportedExportFormats(){return this.EXPORT_FORMATS}static isFormatSupported(e){return this.EXPORT_FORMATS.includes(e)}async exportScene(e,t){if(!mr.isFormatSupported(t.format))throw new Error(`Unsupported export format: ${t.format}`);let n,r=t.fileName||"exported";r=r.replace(/\.[^/.]+$/,"");try{switch(t.format){case"sv":n=this.exportSV(e),r+=".txt";break;case"obj":n=this.exportOBJ(e),r+=".obj";break;case"dbacv":n=this.exportDbacv(e),r+=".dbacv";break;case"cif":n=this.exportCIF(e),r+=".cif.json";break;case"cvf":n=this.exportCVF(e),r+=".cvf";break;case"glb":n=await this.exportGLB(e),r+=".glb";break;default:throw new Error(`Unsupported format: ${t.format}`)}return{data:n,fileName:r,format:t.format,mimeType:this.getMimeType(t.format),size:n instanceof ArrayBuffer?n.byteLength:new Blob([n]).size}}catch(s){throw new Error(`Export failed: ${s instanceof Error?s.message:"Unknown error"}`)}}exportSV(e){return new Cs().export(e)}exportOBJ(e){return new Ms().export(e)}exportDbacv(e){return new Os().export(e)}exportCIF(e){return new zs().export(e)}exportCVF(e){return new Ns().export(e)}async exportGLB(e){return new ei().export(e)}getMimeType(e){switch(e){case"sv":return"text/plain";case"obj":return"text/plain";case"dbacv":return"application/xml";case"cif":return"application/json";case"cvf":return"application/json";case"glb":return"model/gltf-binary";default:return"text/plain"}}static createDownloadBlob(e){return e.data instanceof ArrayBuffer?new Blob([e.data],{type:e.mimeType}):new Blob([e.data],{type:e.mimeType})}static downloadResult(e){const t=this.createDownloadBlob(e),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download=e.fileName,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}static getFileExtension(e){switch(e){case"sv":return".txt";case"obj":return".obj";case"dbacv":return".dbacv";case"cif":return".cif.json";case"cvf":return".cvf";case"glb":return".glb";default:return".txt"}}};ri(gr,"EXPORT_FORMATS",["sv","obj","dbacv","cif","cvf","glb"]);let si=gr;const ii="modulepreload",oi=function(l,e){return new URL(l,e).href},nr={},vt=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let i=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};const a=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),u=c?.nonce||c?.getAttribute("nonce");r=i(t.map(d=>{if(d=oi(d,n),d in nr)return;nr[d]=!0;const p=d.endsWith(".css"),m=p?'[rel="stylesheet"]':"";if(!!n)for(let S=a.length-1;S>=0;S--){const _=a[S];if(_.href===d&&(!p||_.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${m}`))return;const y=document.createElement("link");if(y.rel=p?"stylesheet":ii,p||(y.as="script"),y.crossOrigin="",y.href=d,u&&y.setAttribute("nonce",u),document.head.appendChild(y),p)return new Promise((S,_)=>{y.addEventListener("load",S),y.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${d}`)))})}))}function s(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return r.then(i=>{for(const a of i||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})};var ai=Object.defineProperty,ci=(l,e,t)=>e in l?ai(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Ct=(l,e,t)=>ci(l,typeof e!="symbol"?e+"":e,t);class li{constructor(e,t,n,r={}){Ct(this,"renderer"),Ct(this,"scene"),Ct(this,"camera"),Ct(this,"composer"),Ct(this,"options"),this.renderer=e,this.scene=t,this.camera=n,this.options={enableSSAO:!0,enableBloom:!0,enableFXAA:!0,enableOutlines:!1,bloomThreshold:.8,bloomStrength:.5,bloomRadius:.4,ssaoRadius:.3,ssaoMinDistance:.005,ssaoMaxDistance:.1,outlineThickness:.003,outlineColor:0,...r},this.setupPostProcessing()}async setupPostProcessing(){try{const{EffectComposer:e}=await vt(async()=>{const{EffectComposer:u}=await import("./EffectComposer-DiPw_UWQ.js");return{EffectComposer:u}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),{RenderPass:t}=await vt(async()=>{const{RenderPass:u}=await import("./RenderPass-izMPNzSc.js");return{RenderPass:u}},__vite__mapDeps([5,1,4]),import.meta.url),{ShaderPass:n}=await vt(async()=>{const{ShaderPass:u}=await import("./ShaderPass-B1yiaKM_.js");return{ShaderPass:u}},__vite__mapDeps([3,1,4]),import.meta.url),{UnrealBloomPass:r}=await vt(async()=>{const{UnrealBloomPass:u}=await import("./UnrealBloomPass-Bq7yDCkQ.js");return{UnrealBloomPass:u}},__vite__mapDeps([6,1,4,2]),import.meta.url),{SSAOPass:s}=await vt(async()=>{const{SSAOPass:u}=await import("./SSAOPass-D3mFbYdI.js");return{SSAOPass:u}},__vite__mapDeps([7,1,4,2]),import.meta.url),{FXAAShader:i}=await vt(async()=>{const{FXAAShader:u}=await import("./FXAAShader-WBPB6ysx.js");return{FXAAShader:u}},__vite__mapDeps([8,1]),import.meta.url),{OutlinePass:a}=await vt(async()=>{const{OutlinePass:u}=await import("./OutlinePass-BgQqcNOP.js");return{OutlinePass:u}},__vite__mapDeps([9,1,4,2]),import.meta.url);this.composer=new e(this.renderer);const c=new t(this.scene,this.camera);if(this.composer.addPass(c),this.options.enableSSAO){const u=new s(this.scene,this.camera,window.innerWidth,window.innerHeight);u.kernelRadius=this.options.ssaoRadius,u.minDistance=this.options.ssaoMinDistance,u.maxDistance=this.options.ssaoMaxDistance,this.composer.addPass(u)}if(this.options.enableBloom){const u=new r(new Vt(window.innerWidth,window.innerHeight),this.options.bloomStrength,this.options.bloomRadius,this.options.bloomThreshold);this.composer.addPass(u)}if(this.options.enableOutlines){const u=new a(new Vt(window.innerWidth,window.innerHeight),this.scene,this.camera);u.edgeStrength=3,u.edgeGlow=.5,u.edgeThickness=this.options.outlineThickness,u.pulsePeriod=2,u.visibleEdgeColor.setHex(this.options.outlineColor),u.hiddenEdgeColor.setHex(1640965),this.composer.addPass(u)}if(this.options.enableFXAA){const u=new n(i);u.material.uniforms.resolution.value.x=1/window.innerWidth,u.material.uniforms.resolution.value.y=1/window.innerHeight,this.composer.addPass(u)}}catch(e){console.warn("Post-processing effects not available:",e),this.composer=null}}render(){this.composer?this.composer.render():this.renderer.render(this.scene,this.camera)}resize(e,t){this.composer&&(this.composer.setSize(e,t),this.composer.passes.forEach(n=>{n.material&&n.material.uniforms&&n.material.uniforms.resolution&&(n.material.uniforms.resolution.value.x=1/e,n.material.uniforms.resolution.value.y=1/t)}))}setOutlineObjects(e){if(this.composer&&this.options.enableOutlines){const t=this.composer.passes.find(n=>n.constructor.name==="OutlinePass");t&&(t.selectedObjects=e)}}updateOptions(e){if(this.options={...this.options,...e},this.composer){const t=this.composer.passes.find(s=>s.constructor.name==="UnrealBloomPass");t&&(t.threshold=this.options.bloomThreshold,t.strength=this.options.bloomStrength,t.radius=this.options.bloomRadius);const n=this.composer.passes.find(s=>s.constructor.name==="SSAOPass");n&&(n.kernelRadius=this.options.ssaoRadius,n.minDistance=this.options.ssaoMinDistance,n.maxDistance=this.options.ssaoMaxDistance);const r=this.composer.passes.find(s=>s.constructor.name==="OutlinePass");r&&(r.edgeThickness=this.options.outlineThickness,r.visibleEdgeColor.setHex(this.options.outlineColor))}}dispose(){this.composer&&this.composer.dispose()}}var ui=Object.defineProperty,fi=(l,e,t)=>e in l?ui(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Xt=(l,e,t)=>fi(l,typeof e!="symbol"?e+"":e,t);class qt{static createWireframe(e,t={}){const n={...this.DEFAULT_WIREFRAME_OPTIONS,...t};let r;switch(n.mode){case"edges":r=new tn(e,15);break;case"silhouette":r=this.createSilhouetteGeometry(e);break;case"basic":default:r=new Ur(e);break}const s=new Mn({color:n.color,opacity:n.opacity,transparent:n.opacity<1,linewidth:n.lineWidth,depthTest:n.depthTest}),i=new kn(r,s);return i.renderOrder=n.renderOrder,i}static createSelectionOutline(e,t={}){const n={...this.DEFAULT_OUTLINE_OPTIONS,...t},r=new Fe,s=new le(e.geometry,e.material);s.position.copy(e.position),s.rotation.copy(e.rotation),s.scale.copy(e.scale),s.userData={...e.userData};const i=new Gt({color:n.color,side:$t,transparent:!0,opacity:.8}),a=new le(e.geometry,i);if(a.position.copy(e.position),a.rotation.copy(e.rotation),a.scale.copy(e.scale).multiplyScalar(1+n.thickness),a.renderOrder=-1,r.add(a),r.add(s),n.glow){const c=new Gt({color:n.color,transparent:!0,opacity:.3,side:$t}),u=new le(e.geometry,c);u.position.copy(e.position),u.rotation.copy(e.rotation),u.scale.copy(e.scale).multiplyScalar(1+n.thickness*2),u.renderOrder=-2,r.add(u)}return n.pulse&&(r.pulseOptions=n,r.startTime=Date.now()),r.__isOutlineGroup=!0,r}static updatePulsingOutlines(e){const t=Date.now();e.forEach(n=>{const r=n.pulseOptions,s=n.startTime;if(r&&s){const i=(t-s)/1e3,a=(Math.sin(i*Math.PI*2/r.pulsePeriod)+1)/2;n.children.forEach(c=>{if(c instanceof le&&c.material instanceof Gt){const u=c.material;u.side===$t&&(u.opacity=.5+a*.3)}})}})}static createSilhouetteGeometry(e){return new tn(e,30)}static createEnhancedMaterial(e,t={}){const n=new Pe({color:e,side:Qt});return t.wireframeOverlay&&(n.wireframeOverlay=!0),n}static toggleWireframeMode(e,t){e.traverse(n=>{n instanceof le&&(t?Array.isArray(n.material)?n.material.forEach(r=>{r instanceof Pe&&(r.wireframe=!0)}):n.material instanceof Pe&&(n.material.wireframe=!0):Array.isArray(n.material)?n.material.forEach(r=>{r instanceof Pe&&(r.wireframe=!1)}):n.material instanceof Pe&&(n.material.wireframe=!1))})}static createEdgeHighlight(e,t=16777215,n=2){const r=new tn(e,10),s=new Mn({color:t,linewidth:n,transparent:!0,opacity:.9,depthTest:!1}),i=new kn(r,s);return i.renderOrder=999,i}}Xt(qt,"DEFAULT_WIREFRAME_OPTIONS",{enabled:!0,color:4210752,opacity:.8,lineWidth:1,mode:"edges",depthTest:!0,renderOrder:1});Xt(qt,"DEFAULT_OUTLINE_OPTIONS",{color:65280,thickness:.005,glow:!0,animated:!1,pulse:!0,pulsePeriod:2});class di{constructor(){Xt(this,"selectedObjects",new Set),Xt(this,"outlineGroups",new Map)}isOutlineGroup(e){return e.__isOutlineGroup===!0}isChildOfOutlineGroup(e){let t=e.parent;for(;t;){if(t.__isOutlineGroup===!0)return!0;t=t.parent}return!1}selectObject(e,t){if(!this.selectedObjects.has(e)&&!(this.isOutlineGroup(e)||this.isChildOfOutlineGroup(e))&&(this.selectedObjects.add(e),e instanceof le)){const n=qt.createSelectionOutline(e,t);n.__isOutlineGroup=!0,this.outlineGroups.set(e,n);const r=e.parent;r&&(r.remove(e),r.add(n))}}deselectObject(e){if(!this.selectedObjects.has(e))return;this.selectedObjects.delete(e);const t=this.outlineGroups.get(e);if(t&&e instanceof le){const n=t.parent;n&&(n.remove(t),n.add(e)),this.outlineGroups.delete(e)}}clearSelection(){Array.from(this.selectedObjects).forEach(t=>this.deselectObject(t))}updateAnimations(){const e=Array.from(this.outlineGroups.values());qt.updatePulsingOutlines(e)}getSelectedObjects(){return Array.from(this.selectedObjects)}deleteObject(e){if(!this.selectedObjects.has(e))return!1;const t=this.outlineGroups.get(e);if(t&&e instanceof le){const n=t.parent;n&&(n.remove(t),t.traverse(r=>{r instanceof le&&(r.geometry&&r.geometry.dispose(),r.material&&(Array.isArray(r.material)?r.material.forEach(s=>s.dispose()):r.material.dispose()))})),this.outlineGroups.delete(e)}else{const n=e.parent;n&&n.remove(e)}return e.traverse(n=>{n instanceof le&&(n.geometry&&n.geometry.dispose(),n.material&&(Array.isArray(n.material)?n.material.forEach(r=>r.dispose()):n.material.dispose()))}),this.selectedObjects.delete(e),!0}}var hi=Object.defineProperty,pi=(l,e,t)=>e in l?hi(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,ut=(l,e,t)=>pi(l,typeof e!="symbol"?e+"":e,t);class gi{constructor(){ut(this,"treePanel",null),ut(this,"treeContent",null),ut(this,"currentScene",null),ut(this,"threeScene",null),ut(this,"selectedNodeId",null),ut(this,"onNodeSelect"),ut(this,"collapsedNodes",new Set),ut(this,"isInitialLoad",!0),this.initializeUI()}initializeUI(){if(this.treePanel=document.getElementById("sceneTreePanel"),this.treeContent=document.getElementById("sceneTreeRoot"),!this.treePanel||!this.treeContent){console.error("Scene tree UI elements not found");return}this.setupEventListeners()}setupEventListeners(){document.getElementById("showSceneTree")?.addEventListener("click",()=>{this.togglePanel()}),document.getElementById("closeTreePanel")?.addEventListener("click",()=>{this.hidePanel()}),document.getElementById("toggleTreePanel")?.addEventListener("click",()=>{this.toggleCollapse()}),document.getElementById("refreshSceneTree")?.addEventListener("click",()=>{this.refresh()})}setScene(e,t){this.currentScene=e,this.threeScene=t,this.buildTree()}setNodeSelectCallback(e){this.onNodeSelect=e}showPanel(){this.treePanel&&(this.treePanel.style.display="block",this.refresh())}hidePanel(){this.treePanel&&(this.treePanel.style.display="none")}togglePanel(){this.treePanel&&(this.treePanel.style.display==="none"||!this.treePanel.style.display?this.showPanel():this.hidePanel())}toggleCollapse(){this.treePanel&&this.treePanel.classList.toggle("collapsed")}refresh(){if(this.currentScene&&this.threeScene){const e=this.selectedNodeId;this.saveCollapseState(),this.isInitialLoad=!1,this.buildTree(),this.restoreCollapseState(),e&&this.restoreSelection(e)}}restoreSelection(e){const t=this.treeContent?.querySelector(`[data-node-id="${e}"]`);t?(this.selectedNodeId=e,t.classList.add("selected")):this.selectedNodeId=null}saveCollapseState(){if(this.collapsedNodes.clear(),!this.treeContent)return;this.treeContent.querySelectorAll(".tree-children.collapsed").forEach(t=>{const n=t.closest(".tree-node");if(n){const r=n.querySelector(".tree-item");if(r){const s=r.getAttribute("data-node-id");s&&this.collapsedNodes.add(s)}}})}restoreCollapseState(){this.treeContent&&this.collapsedNodes.forEach(e=>{const t=this.treeContent.querySelector(`[data-node-id="${e}"]`);if(t){const n=t.closest(".tree-node");if(n){const r=n.querySelector(".tree-children"),s=n.querySelector(".tree-toggle");r&&s&&(r.classList.add("collapsed"),s.textContent="")}}})}buildTree(){if(!this.currentScene||!this.treeContent)return;this.treeContent.innerHTML="";const e=this.createTreeNodeFromCIF(this.currentScene.root);if(e){const t=this.createTreeElement(e,!0);this.treeContent.appendChild(t)}this.isInitialLoad&&(this.isInitialLoad=!1)}createTreeNodeFromCIF(e){const t={id:e.id,name:e.name||"Unnamed",type:"children"in e?"group":"primitive",visible:e.visible,locked:e.locked,cifObject:e,children:[]};if("type"in e&&(t.primitiveType=e.type),this.threeScene&&(t.object=this.findThreeObjectByCifId(this.threeScene,e.id)),"children"in e)for(const n of e.children){const r=this.createTreeNodeFromCIF(n);t.children.push(r)}return t}findThreeObjectByCifId(e,t){if(e.userData.cifId===t)return e;for(const n of e.children){const r=this.findThreeObjectByCifId(n,t);if(r)return r}}createTreeElement(e,t=!1){const n=document.createElement("div");n.className="tree-node";const r=document.createElement("div");r.className=`tree-item ${e.type}`,r.dataset.nodeId=e.id;const s=document.createElement("div");if(s.className="tree-toggle",e.type==="group"&&e.children.length>0){const c=this.isInitialLoad&&!t&&!this.collapsedNodes.has(e.id),u=this.collapsedNodes.has(e.id);s.textContent=c||u?"":"",s.addEventListener("click",d=>{d.stopPropagation(),this.toggleNode(n)})}else s.textContent="";r.appendChild(s);const i=document.createElement("div");i.className="tree-icon",i.textContent=this.getNodeIcon(e),r.appendChild(i);const a=document.createElement("div");if(a.className="tree-label",a.textContent=e.name,r.appendChild(a),e.type==="group"&&e.children.length>0){const c=document.createElement("div");c.className="tree-stats",c.textContent=`(${e.children.length})`,r.appendChild(c)}if(r.addEventListener("click",c=>{c.stopPropagation(),this.selectNode(e)}),n.appendChild(r),e.children.length>0){const c=document.createElement("div");c.className="tree-children";const u=this.isInitialLoad&&!t&&!this.collapsedNodes.has(e.id),d=this.collapsedNodes.has(e.id);(u||d)&&(c.classList.add("collapsed"),u&&this.collapsedNodes.add(e.id));for(const p of e.children){const m=this.createTreeElement(p,!1);c.appendChild(m)}n.appendChild(c)}return n}getNodeIcon(e){if(e.type==="group")return"";switch(e.primitiveType){case"triangle":return"";case"quad":return"";case"cube":return"";case"revolution":return"";case"mesh":return"";default:return""}}toggleNode(e){const t=e.querySelector(".tree-children"),n=e.querySelector(".tree-toggle"),r=e.querySelector(".tree-item");if(t&&n&&r){const s=r.getAttribute("data-node-id"),i=t.classList.contains("collapsed");t.classList.toggle("collapsed"),n.textContent=t.classList.contains("collapsed")?"":"",s&&(i?this.collapsedNodes.delete(s):this.collapsedNodes.add(s))}}selectNode(e){this.selectedNodeId&&this.treeContent?.querySelector(`[data-node-id="${this.selectedNodeId}"]`)?.classList.remove("selected"),this.selectedNodeId=e.id,this.treeContent?.querySelector(`[data-node-id="${e.id}"]`)?.classList.add("selected"),this.onNodeSelect&&this.onNodeSelect(e)}selectNodeById(e){if(this.selectedNodeId===e)return;const t=n=>{if(n.id===e)return n;for(const r of n.children){const s=t(r);if(s)return s}return null};if(this.currentScene){const n=this.createTreeNodeFromCIF(this.currentScene.root),r=t(n);r&&this.selectNode(r)}}expandToNode(e){const t=this.findPathToNode(e);for(const n of t){const r=this.treeContent?.querySelector(`[data-node-id="${n}"]`)?.closest(".tree-node");if(r){const s=r.querySelector(".tree-children"),i=r.querySelector(".tree-toggle");s&&i&&(s.classList.remove("collapsed"),i.textContent="")}}}findPathToNode(e){const t=(n,r)=>{const s=[...r,n.id];if(n.id===e)return s;for(const i of n.children){const a=t(i,s);if(a)return a}return null};if(this.currentScene){const n=this.createTreeNodeFromCIF(this.currentScene.root);return t(n,[])||[]}return[]}}const ft=new gi,mi=new xn,vi=new si,tt=document.getElementById("drop"),q=new Yt;let _e=null,De=null,Rt=null,Lt=null,mn=null,ie=null;const Ne=new Set;let yt=!1;const dt=[],yi=10;document.body.addEventListener("dragover",l=>{l.stopPropagation(),l.preventDefault(),l.dataTransfer.dropEffect="copy",tt&&(tt.style.backgroundColor="#e8f5e8",tt.style.borderColor="#4CAF50")});document.body.addEventListener("dragleave",l=>{tt&&!tt.contains(l.relatedTarget)&&(tt.style.backgroundColor="",tt.style.borderColor="")});async function Dt(l){try{if(!_e){be("No scene loaded to export","error");return}const e=xi()||"Convertifer3d",t=await vi.exportScene(_e,{format:l,fileName:e}),n=t.data instanceof ArrayBuffer?new Blob([t.data],{type:t.mimeType}):new Blob([t.data],{type:t.mimeType});qr(n,t.fileName),be(`${l.toUpperCase()} file exported successfully!`,"success")}catch(e){console.error("Export error:",e),be(`Error exporting ${l.toUpperCase()} file`,"error")}}document.getElementById("exportSV")?.addEventListener("click",()=>Dt("sv"));document.getElementById("exportOBJ")?.addEventListener("click",()=>Dt("obj"));document.getElementById("exportDBACV")?.addEventListener("click",()=>Dt("dbacv"));document.getElementById("exportCIF")?.addEventListener("click",()=>Dt("cif"));document.getElementById("exportGLB")?.addEventListener("click",()=>Dt("glb"));document.getElementById("file_upload")?.addEventListener("change",l=>{const e=l;e.target.files&&vr(l,e.target.files)});document.body.addEventListener("drop",l=>{l.stopPropagation(),l.preventDefault(),tt&&(tt.style.backgroundColor="",tt.style.borderColor=""),l.dataTransfer?.files&&vr(l,l.dataTransfer.files)});function xi(){if(_e?.metadata.originalFileName)return _e.metadata.originalFileName.replace(/\.[^/.]+$/,"");let l="Convertifer3d";return q.traverse(e=>{if(e.userData.originalFileName){l=e.userData.originalFileName.replace(/\.[^/.]+$/,"");return}}),l}async function vr(l,e){if(l.stopPropagation(),l.preventDefault(),e.length===0){be("No file selected","error");return}const t=e[0],n=xn.validateFile(t);if(!n.valid){be(n.error,"error");return}const r=bi(t.name);be(`Loading ${r.toUpperCase()} file...`,"info");try{const s=await xn.readFile(t),i=await mi.processFile(s,t.name);if(i.cifScene)_e=i.cifScene,_i(i.cifScene),be(`File loaded successfully! Objects: ${i.metadata.objectCount} (${i.metadata.processingTime.toFixed(1)}ms)`,"success");else throw new Error("No scene data generated from file")}catch(s){console.error("File processing error:",s),be(s instanceof Error?s.message:"Error loading file. Please check the file format.","error")}}function bi(l){return l.split(".").pop()?.toLowerCase()||""}function _i(l){xr(q),q.clear(),Ne.clear(),yt=!1,_e=l,Kt.onSelectionChange=t=>{In(t)},Kt.onDelete=t=>{"removeNode"in ft&&ft.removeNode(t.id)};const e=l.root.render();q.add(e),yr(),ft.setScene(l,q),ft.setNodeSelectCallback(t=>{t.cifObject&&br(t.cifObject)})}function yr(){const l=new Gr(75,window.innerWidth/window.innerHeight,.1,1e3),e=new $r({antialias:!0,alpha:!0,powerPreference:"high-performance"});Rt=e,Lt=l,e.shadowMap.enabled=!0,e.shadowMap.type=Hr,e.toneMapping=Zr,e.toneMappingExposure=1.5,e.outputColorSpace=sr,e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(Math.min(window.devicePixelRatio,2));const t=document.getElementById("drop");t&&(t.style.display="none"),q.background=new Be(15790320);const n=document.querySelector("canvas");n&&n.remove(),document.body.appendChild(e.domElement);const r=new Xr(l,e.domElement,q);De=new li(e,q,l,{enableSSAO:!1,enableBloom:!1,enableFXAA:!0,enableOutlines:!1,bloomThreshold:.8,bloomStrength:.3,bloomRadius:.4}),r.addEventListener("change",()=>{l.up=new k(0,0,1),De?De.render():e.render(q,l)});const s=new Zt().setFromObject(q);if(s.isEmpty())l.position.set(-30,-30,30),l.lookAt(0,0,0);else{const M=s.getCenter(new k),R=s.getSize(new k),O=Math.max(R.x,R.y,R.z),F=l.fov*(Math.PI/180);let $=Math.abs(O/2/Math.tan(F/2));$*=2,l.position.set(M.x-$,M.y-$,M.z+$),l.lookAt(M)}l.up=new k(0,0,1),r.update();const i=new jr,a=new Vt;let c=null;if(!q.getObjectByName("axes")){const M=new Vr(5);M.name="axes",q.add(M)}function d(M){a.x=M.clientX/window.innerWidth*2-1,a.y=-(M.clientY/window.innerHeight)*2+1,i.setFromCamera(a,l);const R=i.intersectObjects(q.children,!0);if(c&&c instanceof le){const O=c.userData.originalMaterial;O&&(c.material=O,delete c.userData.originalMaterial),c=null}if(R.length>0){const $=R[0].object.userData.cifObject?.getThreeObject();if($ instanceof le&&$!==c){c=$;const j=c;j.userData.originalMaterial=j.material,j.material=j.material.clone(),j.material instanceof Pe&&j.material.emissive.setHex(4473924)}}document.body.style.cursor=c?"pointer":"default"}if(mn=new di,!q.getObjectByName("ambientLight")){const M=new Wr(8421504,.8);M.name="ambientLight",q.add(M)}if(!q.getObjectByName("directionalLight")){const M=new Fn(16777215,1.2);M.position.set(10,10,5),M.name="directionalLight",q.add(M)}if(!q.getObjectByName("fillLight")){const M=new Fn(16777215,.7);M.position.set(-10,5,-5),M.name="fillLight",q.add(M)}function y(M){a.x=M.clientX/window.innerWidth*2-1,a.y=-(M.clientY/window.innerHeight)*2+1,i.setFromCamera(a,l);const R=i.intersectObjects(q.children,!0);if(R.length>0){const O=R[0].object,F=wi(O,M);F?ie===F?kt():br(F):kt()}else kt()}const S=window.onPointerMoveHandler;S&&window.removeEventListener("pointermove",S);const _=window.onPointerClickHandler;_&&window.removeEventListener("click",_),window.onPointerMoveHandler=d,window.onPointerClickHandler=y,window.addEventListener("pointermove",d),window.addEventListener("click",y);function E(){l.aspect=window.innerWidth/window.innerHeight,l.updateProjectionMatrix(),e.setSize(window.innerWidth,window.innerHeight),De&&De.resize(window.innerWidth,window.innerHeight)}const D=window.onWindowResizeHandler;D&&window.removeEventListener("resize",D),window.onWindowResizeHandler=E,window.addEventListener("resize",E);function T(){requestAnimationFrame(T),r.update(),mn&&mn?.updateAnimations(),De?De.render():e.render(q,l)}De?De.render():e.render(q,l),T()}function be(l,e="info"){let t=document.getElementById("notification");t||(t=document.createElement("div"),t.id="notification",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            transition: opacity 0.3s ease;
        `,document.body.appendChild(t));const n={success:"#4CAF50",error:"#f44336",info:"#2196F3"};t.style.backgroundColor=n[e],t.textContent=l,t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},5e3)}function xr(l){l.traverse(e=>{if(e instanceof le){const t=e;t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(n=>n.dispose()):t.material.dispose())}})}function wi(l,e){if(l.userData.cifObject){let n=l.userData.cifObject;if(e.shiftKey&&n.parentId){let r=_e?.findById(n.parentId);for(;r&&r.parentId;){const s=_e?.findById(r.parentId);if(s)r=s;else break}r instanceof Me&&(n=r)}else if(e.ctrlKey&&n.parentId){const r=_e?.findById(n.parentId);r instanceof Me&&(n=r)}return n}let t=l.parent;for(;t&&t!==q;){if(t.userData.cifObject)return t.userData.cifObject;t=t.parent}return null}function br(l){kt(),ie=l,l.select(),ft.selectNodeById(l.id),ft.expandToNode(l.id)}function kt(){ie&&(ie.deselect(),ie=null,_r())}function In(l){const e=Si(l);Ci(e)}function bn(){kt()}function Ti(){if(dt.length===0){be("Nothing to undo","info");return}if(!_e){be("No scene available for undo","error");return}const l=dt.pop(),{cifObject:e,parentId:t,childIndex:n,objectName:r,objectType:s}=l;try{let i;if(t){const p=_e.findById(t);if(!p||!("children"in p))throw new Error(`Parent object with ID ${t} not found or is not a group`);i=p}else i=_e.root;const a=e.name,c=e.clone();c.name=a,c.parentId=t||void 0,n>=0&&n<=i.children.length?i.children.splice(n,0,c):i.children.push(c);const u=c.render();let d;if(t){const m=_e.findById(t)?.getThreeObject();m instanceof Fe?d=m:d=q.children[0]}else d=q.children[0];d?d.add(u):q.add(u),De?De.render():Rt&&Lt&&Rt.render(q,Lt),Jt(),ft.refresh(),be(`${s} "${r}" restored successfully`,"success")}catch(i){console.error("Error during undo operation:",i),be(`Failed to restore ${s} "${r}": ${i}`,"error"),dt.push(l),Jt()}}function Jt(){const l=document.getElementById("undoDelete");l&&(dt.length>0?(l.removeAttribute("disabled"),l.textContent=`Undo Delete (${dt.length})`):(l.setAttribute("disabled","true"),l.textContent="Undo Delete"))}function Ai(l){const e=document.getElementById("objectInfoPanel"),t=document.getElementById("objectInfoDetails");if(!e||!t)return;const n=Mi(l),r=l instanceof Fe;t.innerHTML=`
        <div><strong>Name:</strong> ${n.name}</div>
        <div><strong>Type:</strong> ${n.type}</div>
        ${r?`<div><strong>Children:</strong> ${n.children} meshes</div>`:""}
        <div><strong>Position:</strong> ${n.position}</div>
        <div><strong>Rotation:</strong> ${n.rotation}</div>
        <div><strong>Scale:</strong> ${n.scale}</div>
        <div><strong>Vertices:</strong> ${n.vertices}</div>
        <div><strong>Faces:</strong> ${n.faces}</div>
        ${n.material?`<div><strong>Material${r?"s":""}:</strong> ${n.material}</div>`:""}
        ${n.cifType?`<div><strong>CIF Type:</strong> ${n.cifType}</div>`:""}
        ${n.surfaceType?`
            <div>
                <strong>Surface Type:</strong>
                <select id="surfaceTypeSelector">
                    <option value="listen" ${n.surfaceType==="listen"?"selected":""}>Listen</option>
                    <option value="obstacle" ${n.surfaceType==="obstacle"?"selected":""}>Obstacle</option>
                    <option value="structure" ${n.surfaceType==="structure"?"selected":""}>Structure</option>
                </select>
            </div>
        `:""}
        <div class="solo-controls">
            <button id="soloButton" class="solo-btn ${Ne.has(l)?"active":""}">${Ne.has(l)?"Un-Solo":"Solo"}</button>
            ${yt?'<button id="clearSoloButton" class="clear-solo-btn">Clear All Solo</button>':""}
        </div>
    `;const s=e._clickHandler;s&&e.removeEventListener("click",s);const i=document.getElementById("surfaceTypeSelector");i&&i.addEventListener("change",d=>{const p=d.target.value;Ei(l,p)});const a=document.getElementById("soloButton");a&&a.addEventListener("click",d=>{d.stopPropagation(),wr(l)});const c=document.getElementById("clearSoloButton");c&&c.addEventListener("click",d=>{d.stopPropagation(),Tr()});const u=d=>{d.stopPropagation()};e.addEventListener("click",u),e._clickHandler=u,e.style.display="block"}function Ei(l,e){if(l.userData.surfaceType=e,_e&&l.userData.cifId){const t=re.findObjectById(_e.root,l.userData.cifId);t&&"surfaceType"in t&&(t.surfaceType=e)}l instanceof Fe&&l.traverse(t=>{if(t!==l&&t.userData.cifId&&(t.userData.surfaceType=e,_e)){const n=re.findObjectById(_e.root,t.userData.cifId);n&&"surfaceType"in n&&(n.surfaceType=e)}}),be(`Surface type updated to "${e}"`,"success")}function Ii(l,e){"surfaceType"in l&&(l.surfaceType=e);const t=l.getThreeObject();t&&(t.userData.surfaceType=e),l instanceof Me&&l.traverse(n=>{if(n!==l&&"surfaceType"in n){n.surfaceType=e;const r=n.getThreeObject();r&&(r.userData.surfaceType=e)}}),be(`Surface type updated to "${e}"`,"success")}function _r(){const l=document.getElementById("objectInfoPanel");if(l){const e=l._clickHandler;e&&(l.removeEventListener("click",e),delete l._clickHandler),l.style.display="none"}}function Si(l){const e={name:l.name||`${l.constructor.name} (${l.id})`,type:l instanceof Me?"CIF Group":`CIF ${l.type}`,position:`${l.transform.position.x.toFixed(2)}, ${l.transform.position.y.toFixed(2)}, ${l.transform.position.z.toFixed(2)}`,rotation:`${(l.transform.rotation.x*180/Math.PI).toFixed(1)}, ${(l.transform.rotation.y*180/Math.PI).toFixed(1)}, ${(l.transform.rotation.z*180/Math.PI).toFixed(1)}`,scale:`${l.transform.scale.x.toFixed(2)}, ${l.transform.scale.y.toFixed(2)}, ${l.transform.scale.z.toFixed(2)}`,cifId:l.id,visible:l.visible,locked:l.locked};if(l instanceof Me){e.childCount=l.children.length;let t=0,n=0;l.traverse(r=>{r instanceof Ft?(t+=3,n+=1):r instanceof Ot?(t+=4,n+=2):r instanceof zt&&(t+=r.vertices.length,n+=r.faces.length)}),e.vertices=t.toString(),e.faces=n.toString()}else{const t=l;"surfaceType"in t&&(e.surfaceType=t.surfaceType,e.materialColor=`#${t.material.color.getHexString()}`),l instanceof Ft?(e.vertices="3",e.faces="1"):l instanceof Ot?(e.vertices="4",e.faces="2"):l instanceof zt&&(e.vertices=l.vertices.length.toString(),e.faces=l.faces.length.toString())}return e}function Ci(l){const e=document.getElementById("objectInfoPanel"),t=document.getElementById("objectInfoDetails");if(!e||!t)return;let n="";for(const[u,d]of Object.entries(l)){if(u==="cifId")continue;const p=u.charAt(0).toUpperCase()+u.slice(1).replace(/([A-Z])/g," $1");u==="surfaceType"?n+=`
                <div>
                    <strong>Surface Type:</strong>
                    <select id="surfaceTypeSelector">
                        <option value="listen" ${d==="listen"?"selected":""}>Listen</option>
                        <option value="obstacle" ${d==="obstacle"?"selected":""}>Obstacle</option>
                        <option value="structure" ${d==="structure"?"selected":""}>Structure</option>
                    </select>
                </div>
            `:n+=`<div><strong>${p}:</strong> ${d}</div>`}if(ie&&ie.getThreeObject()){const u=ie.getThreeObject();n+=`
            <div class="solo-controls">
                <button id="soloButton" class="solo-btn ${Ne.has(u)?"active":""}">${Ne.has(u)?"Un-Solo":"Solo"}</button>
                ${yt?'<button id="clearSoloButton" class="clear-solo-btn">Clear All Solo</button>':""}
            </div>
        `}t.innerHTML=n;const r=document.getElementById("surfaceTypeSelector");r&&ie&&r.addEventListener("change",u=>{const d=u.target.value;Ii(ie,d)});const s=document.getElementById("soloButton");if(s&&ie&&ie.getThreeObject()){const u=ie.getThreeObject();s.addEventListener("click",d=>{d.stopPropagation(),wr(u)})}const i=document.getElementById("clearSoloButton");i&&i.addEventListener("click",u=>{u.stopPropagation(),Tr()});const a=e._clickHandler;a&&e.removeEventListener("click",a);const c=u=>{u.stopPropagation()};e.addEventListener("click",c),e._clickHandler=c,e.style.display="block"}function Mi(l){let e=l.name;(!e||e.trim()==="")&&(l.userData.cifType?(e=`${l.userData.cifType.charAt(0).toUpperCase()+l.userData.cifType.slice(1)}`,l.userData.cifId&&(e+=` (${l.userData.cifId})`)):(e=`${l.type}`,l.userData.cifId&&(e+=` (${l.userData.cifId})`)));const t={name:e,type:l.type,position:`${l.position.x.toFixed(2)}, ${l.position.y.toFixed(2)}, ${l.position.z.toFixed(2)}`,rotation:`${(l.rotation.x*180/Math.PI).toFixed(1)}, ${(l.rotation.y*180/Math.PI).toFixed(1)}, ${(l.rotation.z*180/Math.PI).toFixed(1)}`,scale:`${l.scale.x.toFixed(2)}, ${l.scale.y.toFixed(2)}, ${l.scale.z.toFixed(2)}`,vertices:"N/A",faces:"N/A"};if(l instanceof Fe){let n=0,r=0,s=0;const i=new Set;l.traverse(a=>{a instanceof le&&a.geometry&&(s++,a.geometry.attributes.position&&(n+=a.geometry.attributes.position.count||0),a.geometry.index&&(r+=Math.floor(a.geometry.index.count/3)),a.material&&(Array.isArray(a.material)?a.material.forEach(c=>i.add(c.type)):i.add(a.material.type)))}),t.children=s.toString(),t.vertices=n>0?n.toString():"N/A",t.faces=r>0?r.toString():"N/A",t.material=i.size>0?Array.from(i).join(", "):"N/A"}else if(l instanceof le&&l.geometry){const n=l.geometry;if(n.attributes.position&&(t.vertices=(n.attributes.position.count||0).toString()),n.index&&(t.faces=Math.floor(n.index.count/3).toString()),l.material)if(Array.isArray(l.material))t.material=`Multiple (${l.material.length})`;else if(l.material instanceof Pe){const r=l.material.color;t.material=`Standard (#${r.getHexString()})`}else t.material=l.material.type}return l.userData.cifType&&(t.cifType=l.userData.cifType),l.userData.surfaceType&&(t.surfaceType=l.userData.surfaceType),t}function ki(){const l=document.getElementById("objectInfoPanel");l&&l.classList.toggle("collapsed")}document.addEventListener("keydown",l=>{if(l.ctrlKey||l.metaKey)switch(l.key.toLowerCase()){case"o":l.preventDefault(),document.getElementById("file_upload")?.click();break;case"s":l.preventDefault(),document.getElementById("exportOBJ")?.click();break;case"t":l.preventDefault(),Fi();break}else switch(l.key){case"Delete":case"Backspace":l.preventDefault(),ie&&Ar();break;case"Escape":l.preventDefault(),bn();break}});function Fi(){xr(q),q.clear();const l=new On(2,2,2),e=new Pe({color:16007990}),t=new le(l,e);t.name="Red Cube",t.position.set(-3,0,0),t.userData.cifId="test-cube-1",t.userData.cifType="cube",q.add(t);const n=new Yr(1.5,32,32),r=new Pe({color:5025616}),s=new le(n,r);s.name="Green Sphere",s.position.set(3,0,0),s.userData.cifId="test-sphere-1",s.userData.cifType="sphere",q.add(s);const i=new Fe;i.name="Test Group",i.userData.cifId="test-group-1",i.userData.cifType="group",i.position.set(0,0,3);const a=new Kr(1,1,3,16),c=new Pe({color:2201331}),u=new le(a,c);u.name="",u.userData.cifId="test-cylinder-1",u.userData.cifType="cylinder";const d=new le(new On(.5,.5,.5),new Pe({color:16771899}));d.name="Small Yellow Cube",d.position.set(1,2,0),d.userData.cifId="test-small-cube-1",d.userData.cifType="cube",i.add(u),i.add(d),q.add(i),yr(),be("Test scene loaded: Click objects to select meshes. Ctrl+Click for groups. Shift+Click for root groups.","info")}function wr(l){Ne.has(l)?(Ne.delete(l),Ne.size===0?(yt=!1,Sn()):rr()):(Ne.add(l),yt=!0,rr()),ie&&ie.getThreeObject()===l?In(ie):Ai(l),be(Ne.has(l)?`"${l.name}" soloed`:`"${l.name}" un-soloed`,"info")}function Tr(){Ne.clear(),yt=!1,Sn(),ie&&In(ie),be("All solo cleared","info")}function rr(){if(!yt||Ne.size===0){Sn();return}const l=new Set;Ne.forEach(t=>{t.traverse(r=>{l.add(r)});let n=t.parent;for(;n&&n!==q;)l.add(n),n=n.parent;if(t.userData.cifId){const r=t.name?.split("_")[0]||"";q.traverse(s=>{if(s instanceof Fe&&s.userData.cifId&&!l.has(s)){const i=s.name||"",a=i.split("_")[0]||i;let c=!1;r&&a&&(r.toLowerCase().includes(a.toLowerCase())||a.toLowerCase().includes(r.toLowerCase()))&&(c=!0),(i.toLowerCase().includes("root")||i.toLowerCase().includes("group")||i.toLowerCase().includes("container")||i.toLowerCase()==="scene")&&(c=!0),c&&l.add(s)}})}}),q.traverse(t=>{t instanceof Fe&&(!t.name||t.name==="")&&!l.has(t)&&t.parent&&l.has(t.parent)&&l.add(t)});const e=new Zt;Ne.forEach(t=>{const n=new Zt().setFromObject(t);e.union(n)}),q.traverse(t=>{if(t instanceof le&&(!t.name||t.name==="")&&!l.has(t)&&!t.userData.cifId){const n=new Zt().setFromObject(t),r=n.getCenter(new k);(e.intersectsBox(n)||e.distanceToPoint(r)<5)&&l.add(t)}}),q.traverse(t=>{t===q||t.name==="axes"||t.type.includes("Light")||(t instanceof le||t instanceof Fe)&&(t.visible=l.has(t))})}function Sn(){q.traverse(l=>{l!==q&&(l instanceof le||l instanceof Fe)&&(l.visible=!0)})}function Ar(){if(!ie||!_e)return;const l=ie instanceof Me?"group":"object",e=ie.name||"unnamed "+l,t=ie.parentId;let n=null,r=-1;if(t?(n=_e.findById(t),n&&"children"in n&&(r=n.children.findIndex(s=>s.id===ie.id))):(n=_e.root,r=n.children.findIndex(s=>s.id===ie.id)),!n||r===-1){be(`Failed to locate ${l} "${e}" in scene hierarchy`,"error");return}try{const s=ie.clone();s.name=ie.name;const i={cifObject:s,parentId:t??null,childIndex:r,objectName:e,objectType:l},a=ie.getThreeObject();n.children.splice(r,1),a&&a.parent&&(a.parent.remove(a),ie.dispose()),ie.deselect(),ie=null,De?De.render():Rt&&Lt&&Rt.render(q,Lt),dt.push(i),dt.length>yi&&dt.shift().cifObject.dispose(),Jt(),ft.refresh(),_r(),be(`${l} "${e}" deleted successfully`,"success")}catch(s){console.error("Error during deletion:",s),be(`Failed to delete ${l} "${e}": ${s}`,"error")}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("toggleInfoPanel")?.addEventListener("click",()=>{ki()}),document.getElementById("closeInfoPanel")?.addEventListener("click",()=>{bn()}),document.getElementById("deleteObject")?.addEventListener("click",()=>{ie&&confirm("Are you sure you want to delete this object?")&&Ar()}),document.getElementById("undoDelete")?.addEventListener("click",()=>{Ti()}),document.getElementById("deselectObject")?.addEventListener("click",()=>{bn()}),Jt()});
