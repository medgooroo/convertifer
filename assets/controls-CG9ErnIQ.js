import{E as G,V as M,a as k,M as y,Q as L,G as Z,b as d,B as j,S as q,c as Y,d as C,e as w,L as A,f as R,R as V}from"./three-D29c9MRG.js";const r={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},l={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},m={x:0,y:0},P={camera:new y,gizmos:new y},u={type:"change"},z={type:"start"},S={type:"end"},U=new V,f=new M,O=new y,D=new y,E=new M;class it extends G{constructor(t,i,s=null){super(),this.camera=null,this.domElement=i,this.scene=s,this.target=new M,this._currentTarget=new M,this.radiusFactor=.67,this.mouseActions=[],this._mouseOp=null,this._v2_1=new k,this._v3_1=new M,this._v3_2=new M,this._m4_1=new y,this._m4_2=new y,this._quat=new L,this._translationMatrix=new y,this._rotationMatrix=new y,this._scaleMatrix=new y,this._rotationAxis=new M,this._cameraMatrixState=new y,this._cameraProjectionState=new y,this._fovState=1,this._upState=new M,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new y,this._up0=new M,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new y,this._gizmoMatrixState0=new y,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=l.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._downStart=0,this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new M,this._startCursorPosition=new M,this._grid=null,this._gridPosition=new M,this._gizmos=new Z,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new M,this._cursorPosCurr=new M,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.enableGizmos=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this._tbRadius=1,this._state=r.IDLE,this.setCamera(t),this.scene!=null&&this.scene.add(this._gizmos),this.domElement.style.touchAction="none",this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this._onContextMenu=W.bind(this),this._onWheel=J.bind(this),this._onPointerUp=B.bind(this),this._onPointerMove=K.bind(this),this._onPointerDown=Q.bind(this),this._onPointerCancel=H.bind(this),this._onWindowResize=X.bind(this),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onWheel),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerCancel),window.addEventListener("resize",this._onWindowResize)}onSinglePanStart(t,i){if(this.enabled)switch(this.dispatchEvent(z),this.setCenter(t.clientX,t.clientY),i){case"PAN":if(!this.enablePan)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(u)),this.updateTbState(r.PAN,!0),this._startCursorPosition.copy(this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement)),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(u));break;case"ROTATE":if(!this.enableRotate)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.updateTbState(r.ROTATE,!0),this._startCursorPosition.copy(this.unprojectOnTbSurface(this.camera,m.x,m.y,this.domElement,this._tbRadius)),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr),this.dispatchEvent(u);break;case"FOV":if(!this.camera.isPerspectiveCamera||!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(u)),this.updateTbState(r.FOV,!0),this._startCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break;case"ZOOM":if(!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(u)),this.updateTbState(r.SCALE,!0),this._startCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break}}onSinglePanMove(t,i){if(this.enabled){const s=i!=this._state;switch(this.setCenter(t.clientX,t.clientY),i){case r.PAN:this.enablePan&&(s?(this.dispatchEvent(S),this.dispatchEvent(z),this.updateTbState(i,!0),this._startCursorPosition.copy(this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement)),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)):(this._currentCursorPosition.copy(this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement)),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))));break;case r.ROTATE:if(this.enableRotate)if(s)this.dispatchEvent(S),this.dispatchEvent(z),this.updateTbState(i,!0),this._startCursorPosition.copy(this.unprojectOnTbSurface(this.camera,m.x,m.y,this.domElement,this._tbRadius)),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0);else{this._currentCursorPosition.copy(this.unprojectOnTbSurface(this.camera,m.x,m.y,this.domElement,this._tbRadius));const e=this._startCursorPosition.distanceTo(this._currentCursorPosition),a=this._startCursorPosition.angleTo(this._currentCursorPosition),o=Math.max(e/this._tbRadius,a);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),o)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=o,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case r.SCALE:if(this.enableZoom)if(s)this.dispatchEvent(S),this.dispatchEvent(z),this.updateTbState(i,!0),this._startCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5);const a=this._currentCursorPosition.y-this._startCursorPosition.y;let o=1;a<0?o=1/Math.pow(this.scaleFactor,-a*8):a>0&&(o=Math.pow(this.scaleFactor,a*8)),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this.applyTransformMatrix(this.scale(o,this._v3_1))}break;case r.FOV:if(this.enableZoom&&this.camera.isPerspectiveCamera)if(s)this.dispatchEvent(S),this.dispatchEvent(z),this.updateTbState(i,!0),this._startCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5);const a=this._currentCursorPosition.y-this._startCursorPosition.y;let o=1;a<0?o=1/Math.pow(this.scaleFactor,-a*8):a>0&&(o=Math.pow(this.scaleFactor,a*8)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const h=this._v3_1.distanceTo(this._gizmos.position);let c=h/o;c=d.clamp(c,this.minDistance,this.maxDistance);const _=h*Math.tan(d.DEG2RAD*this._fovState*.5);let p=d.RAD2DEG*(Math.atan(_/c)*2);p=d.clamp(p,this.minFov,this.maxFov);const v=_/Math.tan(d.DEG2RAD*(p/2));o=h/v,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(p),this.applyTransformMatrix(this.scale(o,this._v3_2,!1)),f.copy(this._gizmos.position).sub(this.camera.position).normalize().multiplyScalar(v/h),this._m4_1.makeTranslation(f.x,f.y,f.z)}break}this.dispatchEvent(u)}}onSinglePanEnd(){if(this._state==r.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const i=Math.abs((this._wPrev+this._wCurr)/2),s=this;this._animationId=window.requestAnimationFrame(function(e){s.updateTbState(r.ANIMATION_ROTATE,!0);const a=s.calculateRotationAxis(s._cursorPosPrev,s._cursorPosCurr);s.onRotationAnim(e,a,Math.min(i,s.wMax))})}else this.updateTbState(r.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(u);else this.updateTbState(r.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(u)}else(this._state==r.PAN||this._state==r.IDLE)&&(this.updateTbState(r.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(u));this.dispatchEvent(S)}onDoubleTap(t){if(this.enabled&&this.enablePan&&this.scene!=null){this.dispatchEvent(z),this.setCenter(t.clientX,t.clientY);const i=this.unprojectOnObj(this.getCursorNDC(m.x,m.y,this.domElement),this.camera);if(i!=null&&this.enableAnimations){const s=this;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(e){s.updateTbState(r.ANIMATION_FOCUS,!0),s.onFocusAnim(e,i,s._cameraMatrixState,s._gizmoMatrixState)})}else i!=null&&!this.enableAnimations&&(this.updateTbState(r.FOCUS,!0),this.focus(i,this.scaleFactor),this.updateTbState(r.IDLE,!1),this.dispatchEvent(u))}this.dispatchEvent(S)}onDoublePanStart(){this.enabled&&this.enablePan&&(this.dispatchEvent(z),this.updateTbState(r.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._startCursorPosition.copy(this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement,!0)),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1))}onDoublePanMove(){this.enabled&&this.enablePan&&(this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=r.PAN&&(this.updateTbState(r.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition)),this._currentCursorPosition.copy(this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement,!0)),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(u))}onDoublePanEnd(){this.updateTbState(r.IDLE,!1),this.dispatchEvent(S)}onRotateStart(){this.enabled&&this.enableRotate&&(this.dispatchEvent(z),this.updateTbState(r.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,this.camera.getWorldDirection(this._rotationAxis),!this.enablePan&&!this.enableZoom&&this.activateGizmos(!0))}onRotateMove(){if(this.enabled&&this.enableRotate){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let t;this._state!=r.ZROTATE&&(this.updateTbState(r.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),t=this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement).applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):t=new M().setFromMatrixPosition(this._gizmoMatrixState);const i=d.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);this.applyTransformMatrix(this.zRotate(t,i)),this.dispatchEvent(u)}}onRotateEnd(){this.updateTbState(r.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(S)}onPinchStart(){this.enabled&&this.enableZoom&&(this.dispatchEvent(z),this.updateTbState(r.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))}onPinchMove(){if(this.enabled&&this.enableZoom){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const t=12;this._state!=r.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(r.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),t*this._devPxRatio);const i=this._currentFingerDistance/this._startFingerDistance;let s;this.enablePan?this.camera.isOrthographicCamera?s=this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement).applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera.isPerspectiveCamera&&(s=this.unprojectOnTbPlane(this.camera,m.x,m.y,this.domElement).applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):s=this._gizmos.position,this.applyTransformMatrix(this.scale(i,s)),this.dispatchEvent(u)}}onPinchEnd(){this.updateTbState(r.IDLE,!1),this.dispatchEvent(S)}onTriplePanStart(){if(this.enabled&&this.enableZoom){this.dispatchEvent(z),this.updateTbState(r.SCALE,!0);let t=0,i=0;const s=this._touchCurrent.length;for(let e=0;e<s;e++)t+=this._touchCurrent[e].clientX,i+=this._touchCurrent[e].clientY;this.setCenter(t/s,i/s),this._startCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition)}}onTriplePanMove(){if(this.enabled&&this.enableZoom){let t=0,i=0;const s=this._touchCurrent.length;for(let g=0;g<s;g++)t+=this._touchCurrent[g].clientX,i+=this._touchCurrent[g].clientY;this.setCenter(t/s,i/s);const e=8;this._currentCursorPosition.setY(this.getCursorNDC(m.x,m.y,this.domElement).y*.5);const a=this._currentCursorPosition.y-this._startCursorPosition.y;let o=1;a<0?o=1/Math.pow(this.scaleFactor,-a*e):a>0&&(o=Math.pow(this.scaleFactor,a*e)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const h=this._v3_1.distanceTo(this._gizmos.position);let c=h/o;c=d.clamp(c,this.minDistance,this.maxDistance);const _=h*Math.tan(d.DEG2RAD*this._fovState*.5);let p=d.RAD2DEG*(Math.atan(_/c)*2);p=d.clamp(p,this.minFov,this.maxFov);const v=_/Math.tan(d.DEG2RAD*(p/2));o=h/v,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(p),this.applyTransformMatrix(this.scale(o,this._v3_2,!1)),f.copy(this._gizmos.position).sub(this.camera.position).normalize().multiplyScalar(v/h),this._m4_1.makeTranslation(f.x,f.y,f.z),this.dispatchEvent(u)}}onTriplePanEnd(){this.updateTbState(r.IDLE,!1),this.dispatchEvent(S)}setCenter(t,i){m.x=t,m.y=i}initializeMouseActions(){this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")}compareMouseAction(t,i){return t.operation==i.operation?t.mouse==i.mouse&&t.key==i.key:!1}setMouseAction(t,i,s=null){const e=["PAN","ROTATE","ZOOM","FOV"],a=[0,1,2,"WHEEL"],o=["CTRL","SHIFT",null];let h;if(!e.includes(t)||!a.includes(i)||!o.includes(s)||i=="WHEEL"&&t!="ZOOM"&&t!="FOV")return!1;switch(t){case"PAN":h=r.PAN;break;case"ROTATE":h=r.ROTATE;break;case"ZOOM":h=r.SCALE;break;case"FOV":h=r.FOV;break}const c={operation:t,mouse:i,key:s,state:h};for(let _=0;_<this.mouseActions.length;_++)if(this.mouseActions[_].mouse==c.mouse&&this.mouseActions[_].key==c.key)return this.mouseActions.splice(_,1,c),!0;return this.mouseActions.push(c),!0}unsetMouseAction(t,i=null){for(let s=0;s<this.mouseActions.length;s++)if(this.mouseActions[s].mouse==t&&this.mouseActions[s].key==i)return this.mouseActions.splice(s,1),!0;return!1}getOpFromAction(t,i){let s;for(let e=0;e<this.mouseActions.length;e++)if(s=this.mouseActions[e],s.mouse==t&&s.key==i)return s.operation;if(i!=null){for(let e=0;e<this.mouseActions.length;e++)if(s=this.mouseActions[e],s.mouse==t&&s.key==null)return s.operation}return null}getOpStateFromAction(t,i){let s;for(let e=0;e<this.mouseActions.length;e++)if(s=this.mouseActions[e],s.mouse==t&&s.key==i)return s.state;if(i!=null){for(let e=0;e<this.mouseActions.length;e++)if(s=this.mouseActions[e],s.mouse==t&&s.key==null)return s.state}return null}getAngle(t,i){return Math.atan2(i.clientY-t.clientY,i.clientX-t.clientX)*180/Math.PI}updateTouchEvent(t){for(let i=0;i<this._touchCurrent.length;i++)if(this._touchCurrent[i].pointerId==t.pointerId){this._touchCurrent.splice(i,1,t);break}}applyTransformMatrix(t){if(t.camera!=null&&(this._m4_1.copy(this._cameraMatrixState).premultiply(t.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),(this._state==r.ROTATE||this._state==r.ZROTATE||this._state==r.ANIMATION_ROTATE)&&this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),t.gizmos!=null&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(t.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),this._state==r.SCALE||this._state==r.FOCUS||this._state==r.ANIMATION_FOCUS)if(this._tbRadius=this.calculateTbRadius(this.camera),this.adjustNearFar){const i=this.camera.position.distanceTo(this._gizmos.position),s=new j;s.setFromObject(this._gizmos);const e=new q;s.getBoundingSphere(e);const a=Math.max(this._nearPos0,e.radius+e.center.length()),o=i-this._initialNear,h=Math.min(a,o);this.camera.near=i-h;const c=Math.min(this._farPos0,-e.radius+e.center.length()),_=i-this._initialFar,p=Math.min(c,_);this.camera.far=i-p,this.camera.updateProjectionMatrix()}else{let i=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,i=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,i=!0),i&&this.camera.updateProjectionMatrix()}}calculateAngularSpeed(t,i,s,e){const a=i-t,o=(e-s)/1e3;return o==0?0:a/o}calculatePointersDistance(t,i){return Math.sqrt(Math.pow(i.clientX-t.clientX,2)+Math.pow(i.clientY-t.clientY,2))}calculateRotationAxis(t,i){return this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(t,i).applyQuaternion(this._quat),this._rotationAxis.normalize().clone()}calculateTbRadius(t){const i=t.position.distanceTo(this._gizmos.position);if(t.type=="PerspectiveCamera"){const s=d.DEG2RAD*t.fov*.5,e=Math.atan(t.aspect*Math.tan(s));return Math.tan(Math.min(s,e))*i*this.radiusFactor}else if(t.type=="OrthographicCamera")return Math.min(t.top,t.right)*this.radiusFactor}focus(t,i,s=1){f.copy(t).sub(this._gizmos.position).multiplyScalar(s),this._translationMatrix.makeTranslation(f.x,f.y,f.z),O.copy(this._gizmoMatrixState),this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),D.copy(this._cameraMatrixState),this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.scale(i,this._gizmos.position)),this._gizmoMatrixState.copy(O),this._cameraMatrixState.copy(D)}drawGrid(){if(this.scene!=null){let s,e,a,o;if(this.camera.isOrthographicCamera){const h=this.camera.right-this.camera.left,c=this.camera.bottom-this.camera.top;a=Math.max(h,c),o=a/20,s=a/this.camera.zoom*3,e=s/o*this.camera.zoom}else if(this.camera.isPerspectiveCamera){const h=this.camera.position.distanceTo(this._gizmos.position),c=d.DEG2RAD*this.camera.fov*.5,_=Math.atan(this.camera.aspect*Math.tan(c));a=Math.tan(Math.max(c,_))*h*2,o=a/20,s=a*3,e=s/o}this._grid==null&&(this._grid=new Y(s,e,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(Math.PI*.5),this.scene.add(this._grid))}}dispose(){this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("wheel",this._onWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),window.removeEventListener("resize",this._onWindowResize),this.scene!==null&&this.scene.remove(this._gizmos),this.disposeGrid()}disposeGrid(){this._grid!=null&&this.scene!=null&&(this.scene.remove(this._grid),this._grid=null)}easeOutCubic(t){return 1-Math.pow(1-t,3)}activateGizmos(t){const i=this._gizmos.children[0],s=this._gizmos.children[1],e=this._gizmos.children[2];t?(i.material.setValues({opacity:1}),s.material.setValues({opacity:1}),e.material.setValues({opacity:1})):(i.material.setValues({opacity:.6}),s.material.setValues({opacity:.6}),e.material.setValues({opacity:.6}))}getCursorNDC(t,i,s){const e=s.getBoundingClientRect();return this._v2_1.setX((t-e.left)/e.width*2-1),this._v2_1.setY((e.bottom-i)/e.height*2-1),this._v2_1.clone()}getCursorPosition(t,i,s){return this._v2_1.copy(this.getCursorNDC(t,i,s)),this._v2_1.x*=(this.camera.right-this.camera.left)*.5,this._v2_1.y*=(this.camera.top-this.camera.bottom)*.5,this._v2_1.clone()}setCamera(t){t.lookAt(this.target),t.updateMatrix(),t.type=="PerspectiveCamera"&&(this._fov0=t.fov,this._fovState=t.fov),this._cameraMatrixState0.copy(t.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(t.projectionMatrix),this._zoom0=t.zoom,this._zoomState=this._zoom0,this._initialNear=t.near,this._nearPos0=t.position.distanceTo(this.target)-t.near,this._nearPos=this._initialNear,this._initialFar=t.far,this._farPos0=t.position.distanceTo(this.target)-t.far,this._farPos=this._initialFar,this._up0.copy(t.up),this._upState.copy(t.up),this.camera=t,this.camera.updateProjectionMatrix(),this._tbRadius=this.calculateTbRadius(t),this.makeGizmos(this.target,this._tbRadius)}setGizmosVisible(t){this._gizmos.visible=t,this.dispatchEvent(u)}setTbRadius(t){this.radiusFactor=t,this._tbRadius=this.calculateTbRadius(this.camera);const s=new C(0,0,this._tbRadius,this._tbRadius).getPoints(this._curvePts),e=new w().setFromPoints(s);for(const a in this._gizmos.children)this._gizmos.children[a].geometry=e;this.dispatchEvent(u)}makeGizmos(t,i){const e=new C(0,0,i,i).getPoints(this._curvePts),a=new w().setFromPoints(e),o=new A({color:16744576,fog:!1,transparent:!0,opacity:.6}),h=new A({color:8454016,fog:!1,transparent:!0,opacity:.6}),c=new A({color:8421631,fog:!1,transparent:!0,opacity:.6}),_=new R(a,o),p=new R(a,h),v=new R(a,c),g=Math.PI*.5;if(_.rotation.x=g,p.rotation.y=g,this._gizmoMatrixState0.identity().setPosition(t),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera.zoom!==1){const x=1/this.camera.zoom;this._scaleMatrix.makeScale(x,x,x),this._translationMatrix.makeTranslation(-t.x,-t.y,-t.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(t.x,t.y,t.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.traverse(function(x){x.isLine&&(x.geometry.dispose(),x.material.dispose())}),this._gizmos.clear(),this._gizmos.add(_),this._gizmos.add(p),this._gizmos.add(v)}onFocusAnim(t,i,s,e){if(this._timeStart==-1&&(this._timeStart=t),this._state==r.ANIMATION_FOCUS){const o=(t-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(e),o>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(i,this.scaleFactor),this._timeStart=-1,this.updateTbState(r.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(u);else{const h=this.easeOutCubic(o),c=1-h+this.scaleFactor*h;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(i,c,h),this.dispatchEvent(u);const _=this;this._animationId=window.requestAnimationFrame(function(p){_.onFocusAnim(p,i,s,e.clone())})}}else this._animationId=-1,this._timeStart=-1}onRotationAnim(t,i,s){if(this._timeStart==-1&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=t),this._state==r.ANIMATION_ROTATE){const e=(t-this._timeStart)/1e3;if(s+-this.dampingFactor*e>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(e,2)+s*e+0,this.applyTransformMatrix(this.rotate(i,this._angleCurrent)),this.dispatchEvent(u);const o=this;this._animationId=window.requestAnimationFrame(function(h){o.onRotationAnim(h,i,s)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(r.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(u)}else this._animationId=-1,this._timeStart=-1,this._state!=r.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(u))}pan(t,i,s=!1){const e=t.clone().sub(i);if(this.camera.isOrthographicCamera)e.multiplyScalar(1/this.camera.zoom);else if(this.camera.isPerspectiveCamera&&s){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const a=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);e.multiplyScalar(1/a)}return this._v3_1.set(e.x,e.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1),P}reset(){this.camera.zoom=this._zoom0,this.camera.isPerspectiveCamera&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix(),this._tbRadius=this.calculateTbRadius(this.camera),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(r.IDLE,!1),this.dispatchEvent(u)}rotate(t,i){const s=this._gizmos.position;return this._translationMatrix.makeTranslation(-s.x,-s.y,-s.z),this._rotationMatrix.makeRotationAxis(t,-i),this._m4_1.makeTranslation(s.x,s.y,s.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),P}copyState(){let t;this.camera.isOrthographicCamera?t=JSON.stringify({arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}):this.camera.isPerspectiveCamera&&(t=JSON.stringify({arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}})),navigator.clipboard.writeText(t)}pasteState(){const t=this;navigator.clipboard.readText().then(function(s){t.setStateFromJSON(s)})}saveState(){this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera.isPerspectiveCamera&&(this._fov0=this.camera.fov)}scale(t,i,s=!0){E.copy(i);let e=1/t;if(this.camera.isOrthographicCamera){this.camera.zoom=this._zoomState,this.camera.zoom*=t,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,e=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,e=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(e,e,e),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),E.sub(this._v3_1);const a=E.clone().multiplyScalar(e);return E.sub(a),this._m4_1.makeTranslation(E.x,E.y,E.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),P}else if(this.camera.isPerspectiveCamera){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let a=this._v3_1.distanceTo(E),o=a-a*e;const h=a-o;if(h<this.minDistance?(e=this.minDistance/a,o=a-a*e):h>this.maxDistance&&(e=this.maxDistance/a,o=a-a*e),f.copy(E).sub(this._v3_1).normalize().multiplyScalar(o),this._m4_1.makeTranslation(f.x,f.y,f.z),s){const c=this._v3_2;a=c.distanceTo(E),o=a-a*e,f.copy(E).sub(this._v3_2).normalize().multiplyScalar(o),this._translationMatrix.makeTranslation(c.x,c.y,c.z),this._scaleMatrix.makeScale(e,e,e),this._m4_2.makeTranslation(f.x,f.y,f.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-c.x,-c.y,-c.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return P}}setFov(t){this.camera.isPerspectiveCamera&&(this.camera.fov=d.clamp(t,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())}setTransformationMatrices(t=null,i=null){t!=null?P.camera!=null?P.camera.copy(t):P.camera=t.clone():P.camera=null,i!=null?P.gizmos!=null?P.gizmos.copy(i):P.gizmos=i.clone():P.gizmos=null}zRotate(t,i){return this._rotationMatrix.makeRotationAxis(this._rotationAxis,i),this._translationMatrix.makeTranslation(-t.x,-t.y,-t.z),this._m4_1.makeTranslation(t.x,t.y,t.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(t),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,i),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),P}getRaycaster(){return U}unprojectOnObj(t,i){const s=this.getRaycaster();s.near=i.near,s.far=i.far,s.setFromCamera(t,i);const e=s.intersectObjects(this.scene.children,!0);for(let a=0;a<e.length;a++)if(e[a].object.uuid!=this._gizmos.uuid&&e[a].face!=null)return e[a].point.clone();return null}unprojectOnTbSurface(t,i,s,e,a){if(t.type=="OrthographicCamera"){this._v2_1.copy(this.getCursorPosition(i,s,e)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const o=Math.pow(this._v2_1.x,2),h=Math.pow(this._v2_1.y,2),c=Math.pow(this._tbRadius,2);return o+h<=c*.5?this._v3_1.setZ(Math.sqrt(c-(o+h))):this._v3_1.setZ(c*.5/Math.sqrt(o+h)),this._v3_1}else if(t.type=="PerspectiveCamera"){this._v2_1.copy(this.getCursorNDC(i,s,e)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(t.projectionMatrixInverse);const o=this._v3_1.clone().normalize(),h=t.position.distanceTo(this._gizmos.position),c=Math.pow(a,2),_=this._v3_1.z,p=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(p==0)return o.set(this._v3_1.x,this._v3_1.y,a),o;const v=_/p,g=h;let x=Math.pow(v,2)+1,T=2*v*g,F=Math.pow(g,2)-c,b=Math.pow(T,2)-4*x*F;if(b>=0&&(this._v2_1.setX((-T-Math.sqrt(b))/(2*x)),this._v2_1.setY(v*this._v2_1.x+g),d.RAD2DEG*this._v2_1.angle()>=45)){const I=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(h-this._v2_1.y,2));return o.multiplyScalar(I),o.z+=h,o}x=v,T=g,F=-c*.5,b=Math.pow(T,2)-4*x*F,this._v2_1.setX((-T-Math.sqrt(b))/(2*x)),this._v2_1.setY(v*this._v2_1.x+g);const N=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(h-this._v2_1.y,2));return o.multiplyScalar(N),o.z+=h,o}}unprojectOnTbPlane(t,i,s,e,a=!1){if(t.type=="OrthographicCamera")return this._v2_1.copy(this.getCursorPosition(i,s,e)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(t.type=="PerspectiveCamera"){this._v2_1.copy(this.getCursorNDC(i,s,e)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(t.projectionMatrixInverse);const o=this._v3_1.clone().normalize(),h=this._v3_1.z,c=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let _;if(a?_=this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):_=t.position.distanceTo(this._gizmos.position),c==0)return o.set(0,0,0),o;const p=h/c,v=_,g=-v/p,x=Math.sqrt(Math.pow(v,2)+Math.pow(g,2));return o.multiplyScalar(x),o.z=0,o}}updateMatrixState(){this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera.isOrthographicCamera?(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom):this.camera.isPerspectiveCamera&&(this._fovState=this.camera.fov)}updateTbState(t,i){this._state=t,i&&this.updateMatrixState()}update(){if(this.target.equals(this._currentTarget)===!1&&(this._gizmos.position.copy(this.target),this._tbRadius=this.calculateTbRadius(this.camera),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)),this.camera.isOrthographicCamera){if(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom){const i=d.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.scale(i/this.camera.zoom,this._gizmos.position,!0))}}else if(this.camera.isPerspectiveCamera){const i=this.camera.position.distanceTo(this._gizmos.position);if(i>this.maxDistance+1e-6||i<this.minDistance-1e-6){const e=d.clamp(i,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.scale(e/i,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=d.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const s=this._tbRadius;if(this._tbRadius=this.calculateTbRadius(this.camera),s<this._tbRadius-1e-6||s>this._tbRadius+1e-6){const e=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,a=this._tbRadius/e,h=new C(0,0,a,a).getPoints(this._curvePts),c=new w().setFromPoints(h);for(const _ in this._gizmos.children)this._gizmos.children[_].geometry=c}}this.camera.lookAt(this._gizmos.position)}setStateFromJSON(t){const i=JSON.parse(t);if(i.arcballState!=null){this._cameraMatrixState.fromArray(i.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(i.arcballState.cameraUp),this.camera.near=i.arcballState.cameraNear,this.camera.far=i.arcballState.cameraFar,this.camera.zoom=i.arcballState.cameraZoom,this.camera.isPerspectiveCamera&&(this.camera.fov=i.arcballState.cameraFov),this._gizmoMatrixState.fromArray(i.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix(),this._tbRadius=this.calculateTbRadius(this.camera);const s=new y().copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(s),this.camera.lookAt(this._gizmos.position),this.updateTbState(r.IDLE,!1),this.dispatchEvent(u)}}}function X(){const n=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;this._tbRadius=this.calculateTbRadius(this.camera);const t=this._tbRadius/n,s=new C(0,0,t,t).getPoints(this._curvePts),e=new w().setFromPoints(s);for(const a in this._gizmos.children)this._gizmos.children[a].geometry=e;this.dispatchEvent(u)}function W(n){if(this.enabled){for(let t=0;t<this.mouseActions.length;t++)if(this.mouseActions[t].mouse==2){n.preventDefault();break}}}function H(){this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=l.NONE}function Q(n){if(n.button==0&&n.isPrimary?(this._downValid=!0,this._downEvents.push(n),this._downStart=performance.now()):this._downValid=!1,n.pointerType=="touch"&&this._input!=l.CURSOR)switch(this._touchStart.push(n),this._touchCurrent.push(n),this._input){case l.NONE:this._input=l.ONE_FINGER,this.onSinglePanStart(n,"ROTATE"),window.addEventListener("pointermove",this._onPointerMove),window.addEventListener("pointerup",this._onPointerUp);break;case l.ONE_FINGER:case l.ONE_FINGER_SWITCHED:this._input=l.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case l.TWO_FINGER:this._input=l.MULT_FINGER,this.onTriplePanStart(n);break}else if(n.pointerType!="touch"&&this._input==l.NONE){let t=null;n.ctrlKey||n.metaKey?t="CTRL":n.shiftKey&&(t="SHIFT"),this._mouseOp=this.getOpFromAction(n.button,t),this._mouseOp!=null&&(window.addEventListener("pointermove",this._onPointerMove),window.addEventListener("pointerup",this._onPointerUp),this._input=l.CURSOR,this._button=n.button,this.onSinglePanStart(n,this._mouseOp))}}function K(n){if(n.pointerType=="touch"&&this._input!=l.CURSOR)switch(this._input){case l.ONE_FINGER:this.updateTouchEvent(n),this.onSinglePanMove(n,r.ROTATE);break;case l.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],n)*this._devPxRatio>=this._switchSensibility){this._input=l.ONE_FINGER,this.updateTouchEvent(n),this.onSinglePanStart(n,"ROTATE");break}break;case l.TWO_FINGER:this.updateTouchEvent(n),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case l.MULT_FINGER:this.updateTouchEvent(n),this.onTriplePanMove(n);break}else if(n.pointerType!="touch"&&this._input==l.CURSOR){let t=null;n.ctrlKey||n.metaKey?t="CTRL":n.shiftKey&&(t="SHIFT");const i=this.getOpStateFromAction(this._button,t);i!=null&&this.onSinglePanMove(n,i)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],n)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}function B(n){if(n.pointerType=="touch"&&this._input!=l.CURSOR){const t=this._touchCurrent.length;for(let i=0;i<t;i++)if(this._touchCurrent[i].pointerId==n.pointerId){this._touchCurrent.splice(i,1),this._touchStart.splice(i,1);break}switch(this._input){case l.ONE_FINGER:case l.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),this._input=l.NONE,this.onSinglePanEnd();break;case l.TWO_FINGER:this.onDoublePanEnd(n),this.onPinchEnd(n),this.onRotateEnd(n),this._input=l.ONE_FINGER_SWITCHED;break;case l.MULT_FINGER:this._touchCurrent.length==0&&(window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),this._input=l.NONE,this.onTriplePanEnd());break}}else n.pointerType!="touch"&&this._input==l.CURSOR&&(window.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("pointerup",this._onPointerUp),this._input=l.NONE,this.onSinglePanEnd(),this._button=-1);if(n.isPrimary)if(this._downValid)if(n.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(this._nclicks==0)this._nclicks=1,this._clickStart=performance.now();else{const i=n.timeStamp-this._clickStart,s=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;i<=this._maxInterval&&s<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(n)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length);else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}function J(n){if(this.enabled&&this.enableZoom){let t=null;n.ctrlKey||n.metaKey?t="CTRL":n.shiftKey&&(t="SHIFT");const i=this.getOpFromAction("WHEEL",t);if(i!=null){n.preventDefault(),this.dispatchEvent(z);const s=125;let e=n.deltaY/s,a=1;switch(e>0?a=1/this.scaleFactor:e<0&&(a=this.scaleFactor),i){case"ZOOM":if(this.updateTbState(r.SCALE,!0),e>0?a=1/Math.pow(this.scaleFactor,e):e<0&&(a=Math.pow(this.scaleFactor,-e)),this.cursorZoom&&this.enablePan){let o;this.camera.isOrthographicCamera?o=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement).applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera.isPerspectiveCamera&&(o=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement).applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),this.applyTransformMatrix(this.scale(a,o))}else this.applyTransformMatrix(this.scale(a,this._gizmos.position));this._grid!=null&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(r.IDLE,!1),this.dispatchEvent(u),this.dispatchEvent(S);break;case"FOV":if(this.camera.isPerspectiveCamera){this.updateTbState(r.FOV,!0),n.deltaX!=0&&(e=n.deltaX/s,a=1,e>0?a=1/Math.pow(this.scaleFactor,e):e<0&&(a=Math.pow(this.scaleFactor,-e))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const o=this._v3_1.distanceTo(this._gizmos.position);let h=o/a;h=d.clamp(h,this.minDistance,this.maxDistance);const c=o*Math.tan(d.DEG2RAD*this.camera.fov*.5);let _=d.RAD2DEG*(Math.atan(c/h)*2);_>this.maxFov?_=this.maxFov:_<this.minFov&&(_=this.minFov);const p=c/Math.tan(d.DEG2RAD*(_/2));a=o/p,this.setFov(_),this.applyTransformMatrix(this.scale(a,this._gizmos.position,!1))}this._grid!=null&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(r.IDLE,!1),this.dispatchEvent(u),this.dispatchEvent(S);break}}}}export{it as A};
