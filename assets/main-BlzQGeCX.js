const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./EffectComposer-DiPw_UWQ.js","./three-D29c9MRG.js","./CopyShader-B0dke3by.js","./ShaderPass-B1yiaKM_.js","./Pass-DIKeR8G_.js","./RenderPass-izMPNzSc.js","./UnrealBloomPass-Bq7yDCkQ.js","./SSAOPass-D3mFbYdI.js","./FXAAShader-WBPB6ysx.js","./OutlinePass-BgQqcNOP.js"])))=>i.map(i=>d[i]);
import{V as k,e as Qe,g as ue,G as Fe,h as le,i as Gt,j as $t,k as Pe,D as Qt,C as Be,a as Vt,l as It,M as Ht,Q as Er,m as Ir,N as Sr,b as vn,n as Cr,P as Wt,I as Mr,o as Yt,p as ir,q as kr,r as Fr,s as Or,t as zr,u as Nr,v as Rr,w as Lr,x as Dr,y as Pr,z as Br,W as Ur,A as tn,L as Mn,F as kn,H as Gr,J as $r,K as Hr,O as jr,B as jt,R as Zr,T as Vr,U as Wr,X as Fn,Y as On,Z as Yr,_ as Kr}from"./three-D29c9MRG.js";import{A as Xr}from"./controls-CG9ErnIQ.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();function et(l){return l*Math.PI/180}function yt(l){return(l*180/Math.PI+360)%360}function en(l){const e=new Float32Array(l.length);let t=0;for(let n=0;n<l.length/9;n++){const r=new k().fromArray(l,n*9),i=new k().fromArray(l,n*9+3),s=new k().fromArray(l,n*9+6),a=new k().subVectors(r,i),c=new k().subVectors(r,s),u=new k().crossVectors(a,c);u.normalize();for(let d=0;d<3;d++)e[t++]=u.x,e[t++]=u.y,e[t++]=u.z}return e}function qr(l,e){const t=window.URL.createObjectURL(l),n=document.createElement("a");n.style.display="none",n.href=t,n.setAttribute("download",e),typeof n.download>"u"&&n.setAttribute("target","_blank"),document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>{window.URL.revokeObjectURL(t)},100)}function sr(l,e){const t=new Qe,n=[];for(const s of e)if(s.length===3)for(const a of s)n.push(l[a*3],l[a*3+1],l[a*3+2]);else if(s.length===4){const[a,c,u,d]=s;n.push(l[a*3],l[a*3+1],l[a*3+2],l[c*3],l[c*3+1],l[c*3+2],l[u*3],l[u*3+1],l[u*3+2]),n.push(l[u*3],l[u*3+1],l[u*3+2],l[d*3],l[d*3+1],l[d*3+2],l[a*3],l[a*3+1],l[a*3+2])}const r=new Float32Array(n);t.setAttribute("position",new ue(r,3));const i=en(r);return t.setAttribute("normal",new ue(i,3)),t}var Jr=Object.defineProperty,Qr=(l,e,t)=>e in l?Jr(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,q=(l,e,t)=>Qr(l,typeof e!="symbol"?e+"":e,t);const _n=class yn{constructor(e,t,n){q(this,"id"),q(this,"name"),q(this,"transform"),q(this,"visible"),q(this,"locked"),q(this,"parentId"),q(this,"userData"),q(this,"_threeObject"),q(this,"_isSelected",!1),q(this,"_selectionOutline"),this.id=e,this.name=t,this.transform=n||te.createDefaultTransform(),this.visible=!0,this.locked=!1}getThreeObject(){return this._threeObject}updateTransform(){this._threeObject&&(this._threeObject.position.copy(this.transform.position),this._threeObject.rotation.setFromVector3(this.transform.rotation),this._threeObject.scale.copy(this.transform.scale))}setVisible(e){this.visible=e,this._threeObject&&(this._threeObject.visible=e)}select(){this._isSelected||(this._isSelected=!0,this.createSelectionOutline(),yn.onSelectionChange?.(this))}deselect(){this._isSelected&&(this._isSelected=!1,this.removeSelectionOutline())}isSelected(){return this._isSelected}delete(){this.deselect(),this.dispose(),yn.onDelete?.(this)}createSelectionOutline(){if(!(!this._threeObject||this._selectionOutline)&&(this._selectionOutline=new Fe,this._threeObject instanceof le)){const e=new Gt({color:65280,side:$t,transparent:!0,opacity:.8}),t=new le(this._threeObject.geometry,e);t.renderOrder=-1,this._selectionOutline.add(t),this._selectionOutline.position.copy(this._threeObject.position),this._selectionOutline.rotation.copy(this._threeObject.rotation),this._selectionOutline.scale.copy(this._threeObject.scale),this._selectionOutline.scale.multiplyScalar(1.02),this._threeObject.parent?.add(this._selectionOutline)}}removeSelectionOutline(){this._selectionOutline&&(this._selectionOutline.parent?.remove(this._selectionOutline),this._selectionOutline.traverse(e=>{e instanceof le&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()))}),this._selectionOutline=void 0)}applyTransform(e){e.position.copy(this.transform.position),e.rotation.setFromVector3(this.transform.rotation),e.scale.copy(this.transform.scale)}createThreeMaterial(e){return new Pe({color:e.color,opacity:e.opacity,transparent:e.transparent||e.opacity<1,side:Qt,flatShading:!1,toneMapped:!0})}};q(_n,"onSelectionChange");q(_n,"onDelete");let Kt=_n;class ot extends Kt{constructor(e,t,n,r,i){super(e,t,i),q(this,"type"),q(this,"surfaceType"),q(this,"material"),this.type=n,this.surfaceType="structure",this.material=r}render(){if(!this._threeObject){const e=this.createGeometry(),t=this.createThreeMaterial(this.material);this._threeObject=new le(e,t),this._threeObject.name=this.name,this._threeObject.userData.cifObject=this,this._threeObject.userData.cifId=this.id,this._threeObject.userData.cifType=this.type,this._threeObject.userData.surfaceType=this.surfaceType,this._threeObject.visible=this.visible,this.applyTransform(this._threeObject)}return this._threeObject}dispose(){this.removeSelectionOutline(),this._threeObject instanceof le&&(this._threeObject.geometry&&this._threeObject.geometry.dispose(),this._threeObject.material&&(Array.isArray(this._threeObject.material)?this._threeObject.material.forEach(e=>e.dispose()):this._threeObject.material.dispose())),this._threeObject=void 0}}class Ft extends ot{constructor(e,t,n,r,i){super(e,t,"triangle",r,i),q(this,"vertices"),q(this,"normals"),q(this,"uvs"),this.vertices=n}createGeometry(){const e=new Qe,t=new Float32Array(9);for(let n=0;n<3;n++){const r=this.vertices[n];t[n*3]=r.x,t[n*3+1]=r.y,t[n*3+2]=r.z}if(e.setAttribute("position",new ue(t,3)),this.normals){const n=new Float32Array(9);for(let r=0;r<3;r++){const i=this.normals[r];n[r*3]=i.x,n[r*3+1]=i.y,n[r*3+2]=i.z}e.setAttribute("normal",new ue(n,3))}else{const n=en(t);e.setAttribute("normal",new ue(n,3))}if(this.uvs){const n=new Float32Array(6);for(let r=0;r<3;r++){const i=this.uvs[r];n[r*2]=i.x,n[r*2+1]=i.y}e.setAttribute("uv",new ue(n,2))}return e}clone(){return new Ft(te.generateId(),this.name+" (Copy)",[this.vertices[0].clone(),this.vertices[1].clone(),this.vertices[2].clone()],{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Ot extends ot{constructor(e,t,n,r,i){super(e,t,"quad",r,i),q(this,"vertices"),q(this,"normals"),q(this,"uvs"),this.vertices=n}createGeometry(){const e=new Qe,t=[0,1,2,2,3,0],n=new Float32Array(12);for(let i=0;i<4;i++){const s=this.vertices[i];n[i*3]=s.x,n[i*3+1]=s.y,n[i*3+2]=s.z}const r=new Float32Array(18);for(let i=0;i<6;i++){const s=t[i];r[i*3]=n[s*3],r[i*3+1]=n[s*3+1],r[i*3+2]=n[s*3+2]}if(e.setAttribute("position",new ue(r,3)),this.normals){const i=new Float32Array(18);for(let s=0;s<6;s++){const a=t[s],c=this.normals[a];i[s*3]=c.x,i[s*3+1]=c.y,i[s*3+2]=c.z}e.setAttribute("normal",new ue(i,3))}else{const i=en(r);e.setAttribute("normal",new ue(i,3))}if(this.uvs){const i=new Float32Array(12);for(let s=0;s<6;s++){const a=t[s],c=this.uvs[a];i[s*2]=c.x,i[s*2+1]=c.y}e.setAttribute("uv",new ue(i,2))}return e}clone(){return new Ot(te.generateId(),this.name+" (Copy)",[this.vertices[0].clone(),this.vertices[1].clone(),this.vertices[2].clone(),this.vertices[3].clone()],{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class wn extends ot{constructor(e,t,n,r,i){super(e,t,"cube",r,i),q(this,"vertices"),this.vertices=n}createGeometry(){const e=new Qe,t=[[0,1,2],[2,3,0],[4,7,6],[6,5,4],[0,4,5],[5,1,0],[2,6,7],[7,3,2],[0,3,7],[7,4,0],[1,5,6],[6,2,1]],n=[];for(const s of t)for(const a of s){const c=this.vertices[a];n.push(c.x,c.y,c.z)}const r=new Float32Array(n);e.setAttribute("position",new ue(r,3));const i=en(r);return e.setAttribute("normal",new ue(i,3)),e}clone(){return new wn(te.generateId(),this.name+" (Copy)",this.vertices.map(e=>e.clone()),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Tn extends ot{constructor(e,t,n,r,i){super(e,t,"revolution",r,i),q(this,"profile"),q(this,"axis"),q(this,"startAngle"),q(this,"endAngle"),q(this,"segments"),q(this,"closed"),this.profile=n,this.axis=new k(0,0,1),this.startAngle=0,this.endAngle=Math.PI*2,this.segments=32,this.closed=!0}createGeometry(){if(this.profile.length<2)return console.warn("Revolution profile must have at least 2 points"),new Qe;const e=this.endAngle-this.startAngle,t=[],n=[];for(let i=0;i<=this.segments;i++){const s=this.startAngle+e*i/this.segments,a=Math.cos(s),c=Math.sin(s);for(const u of this.profile){const d=u.x*a-u.y*c,p=u.x*c+u.y*a,g=u.z;t.push(d,p,g)}}const r=this.profile.length;for(let i=0;i<this.segments;i++)for(let s=0;s<r-1;s++){const a=i*r+s,c=i*r+s+1,u=(i+1)*r+s+1,d=(i+1)*r+s;n.push([a,c,u]),n.push([u,d,a])}return sr(t,n)}clone(){const e=new Tn(te.generateId(),this.name+" (Copy)",this.profile.map(t=>t.clone()),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()});return e.axis=this.axis.clone(),e.startAngle=this.startAngle,e.endAngle=this.endAngle,e.segments=this.segments,e.closed=this.closed,e}}class zt extends ot{constructor(e,t,n,r,i,s){super(e,t,"mesh",i,s),q(this,"vertices"),q(this,"faces"),q(this,"normals"),q(this,"uvs"),this.vertices=n,this.faces=r}createGeometry(){const e=[];for(const t of this.vertices)e.push(t.x,t.y,t.z);return sr(e,this.faces)}clone(){return new zt(te.generateId(),this.name+" (Copy)",this.vertices.map(e=>e.clone()),this.faces.map(e=>[...e]),{...this.material,color:this.material.color.clone()},{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()})}}class Me extends Kt{constructor(e,t,n){super(e,t,n),q(this,"children"),this.children=[]}addChild(e){if(e.parentId=this.id,this.children.push(e),this._threeObject&&this._threeObject instanceof Fe){const t=e.render();this._threeObject.add(t)}}removeChild(e){const t=this.children.indexOf(e);if(t!==-1&&(this.children.splice(t,1),e.parentId=void 0,this._threeObject)){const n=e.render();n&&this._threeObject.remove(n)}}render(){if(!this._threeObject){this._threeObject=new Fe,this._threeObject.name=this.name,this._threeObject.userData.cifObject=this,this._threeObject.userData.cifId=this.id,this._threeObject.userData.cifType="group",this._threeObject.visible=this.visible,this.applyTransform(this._threeObject);for(const e of this.children){const t=e.render();this._threeObject.add(t)}}return this._threeObject}clone(){const e=new Me(te.generateId(),this.name+" (Copy)",{position:this.transform.position.clone(),rotation:this.transform.rotation.clone(),scale:this.transform.scale.clone()});for(const t of this.children)e.addChild(t.clone());return e}dispose(){this.removeSelectionOutline();for(const e of this.children)e.dispose();this._threeObject=void 0}traverse(e){e(this);for(const t of this.children)t instanceof Me?t.traverse(e):e(t)}findById(e){if(this.id===e)return this;for(const t of this.children){if(t.id===e)return t;if(t instanceof Me){const n=t.findById(e);if(n)return n}}return null}}class ei{constructor(e){q(this,"metadata"),q(this,"root"),q(this,"materials"),q(this,"units"),q(this,"coordinateSystem"),q(this,"upAxis"),this.metadata={created:new Date,version:"2.0",...e},this.root=new Me(te.generateId(),"Root"),this.materials=new Map,this.units="meters",this.coordinateSystem="right-handed",this.upAxis="z"}render(){return this.root.render()}findById(e){return this.root.findById(e)}addToRoot(e){this.root.addChild(e)}dispose(){this.root.dispose(),this.materials.clear()}}class te{static createDefaultTransform(){return{position:new k(0,0,0),rotation:new k(0,0,0),scale:new k(1,1,1)}}static createDefaultMaterial(e="default",t=13421772){return{name:e,color:new Be(t),opacity:1,transparent:!1}}static generateId(){return"cif_"+Math.random().toString(36).substr(2,9)+"_"+Date.now().toString(36)}static createScene(e){return new ei(e)}static findObjectById(e,t){return e.findById(t)}static getAllOfType(e,t){const n=[];return e.traverse(r=>{r instanceof t&&n.push(r)}),n}static addToGroup(e,t){e.addChild(t)}static validateScene(e){const t=[];return e.root||t.push("Scene must have a root group"),e.materials.size===0&&console.warn("Scene has no materials defined"),e.root.traverse(n=>{n.id||t.push(`Object ${n.name||"unnamed"} has no ID`),n.name||t.push(`Object ${n.id} has no name`),n instanceof ot&&(n.material||t.push(`Primitive ${n.name} has no material`))}),{valid:t.length===0,errors:t}}}var ti=Object.defineProperty,ni=(l,e,t)=>e in l?ti(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,zn=(l,e,t)=>ni(l,typeof e!="symbol"?e+"":e,t);class St{constructor(e){zn(this,"scene"),zn(this,"currentGroup"),this.scene=te.createScene(e),this.currentGroup=this.scene.root}setUnits(e){return this.scene.units=e,this}setCoordinateSystem(e){return this.scene.coordinateSystem=e,this}setUpAxis(e){return this.scene.upAxis=e,this}addMaterial(e,t){const n={...te.createDefaultMaterial(),...t};return this.scene.materials.set(e,n),this}getMaterial(e){return this.scene.materials.get(e)}beginGroup(e){const t=new Me(te.generateId(),e,te.createDefaultTransform());return t.parentId=this.currentGroup.id,te.addToGroup(this.currentGroup,t),this.currentGroup=t,this}endGroup(){if(this.currentGroup.parentId){const e=te.findObjectById(this.scene.root,this.currentGroup.parentId);e&&"children"in e&&(this.currentGroup=e)}return this}setTransform(e){return Object.assign(this.currentGroup.transform,e),this}translate(e,t,n){return this.currentGroup.transform.position.set(e,t,n),this}rotate(e,t,n){return this.currentGroup.transform.rotation.set(e,t,n),this}scale(e,t,n){return this.currentGroup.transform.scale.set(e,t,n),this}addTriangle(e,t,n,r={}){[e,t,n].forEach((a,c)=>{if(!a||isNaN(a.x)||isNaN(a.y)||isNaN(a.z)||!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z))throw new Error(`Invalid vertex at index ${c}: ${a?`(${a.x}, ${a.y}, ${a.z})`:"null/undefined"}`)});const i=this.resolveMaterial(r.materialId,r.material),s=new Ft(te.generateId(),r.name||"Triangle",[e.clone(),t.clone(),n.clone()],i,{...te.createDefaultTransform(),...r.transform});return s.surfaceType=r.surfaceType||"structure",s.parentId=this.currentGroup.id,r.normals&&(s.normals=[r.normals[0].clone(),r.normals[1].clone(),r.normals[2].clone()]),r.uvs&&(s.uvs=[...r.uvs]),te.addToGroup(this.currentGroup,s),this}addQuad(e,t,n,r,i={}){[e,t,n,r].forEach((c,u)=>{if(!c||isNaN(c.x)||isNaN(c.y)||isNaN(c.z)||!isFinite(c.x)||!isFinite(c.y)||!isFinite(c.z))throw new Error(`Invalid vertex at index ${u}: ${c?`(${c.x}, ${c.y}, ${c.z})`:"null/undefined"}`)});const s=this.resolveMaterial(i.materialId,i.material),a=new Ot(te.generateId(),i.name||"Quad",[e.clone(),t.clone(),n.clone(),r.clone()],s,{...te.createDefaultTransform(),...i.transform});return a.surfaceType=i.surfaceType||"structure",a.parentId=this.currentGroup.id,i.normals&&(a.normals=[i.normals[0].clone(),i.normals[1].clone(),i.normals[2].clone(),i.normals[3].clone()]),i.uvs&&(a.uvs=[...i.uvs]),te.addToGroup(this.currentGroup,a),this}addCube(e,t={}){const n=this.resolveMaterial(t.materialId,t.material),r=new wn(te.generateId(),t.name||"Cube",e.map(i=>i.clone()),n,{...te.createDefaultTransform(),...t.transform});return r.surfaceType=t.surfaceType||"structure",r.parentId=this.currentGroup.id,te.addToGroup(this.currentGroup,r),this}addRevolution(e,t={}){const n=this.resolveMaterial(t.materialId,t.material),r=new Tn(te.generateId(),t.name||"Revolution",e.map(i=>i.clone()),n,{...te.createDefaultTransform(),...t.transform});return r.surfaceType=t.surfaceType||"structure",r.axis=t.axis?.clone()||new k(0,0,1),r.startAngle=t.startAngle||0,r.endAngle=t.endAngle||Math.PI*2,r.segments=t.segments||32,r.closed=t.closed!==!1,r.parentId=this.currentGroup.id,te.addToGroup(this.currentGroup,r),this}addMesh(e,t,n={}){const r=e.filter((a,c)=>{const u=!a||isNaN(a.x)||isNaN(a.y)||isNaN(a.z)||!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z);return u&&console.error(`Invalid vertex at index ${c}: ${a?`(${a.x}, ${a.y}, ${a.z})`:"null/undefined"}`),u});if(r.length>0&&r.length>0)throw new Error(`Found ${r.length} invalid vertices out of ${e.length}`);t.forEach((a,c)=>{a.forEach((u,d)=>{if(u<0||u>=e.length)throw new Error(`Invalid vertex index ${u} at position ${d} in face ${c}. Valid range is 0-${e.length-1}`)})});const i=this.resolveMaterial(n.materialId,n.material),s=new zt(te.generateId(),n.name||"Mesh",e.map(a=>a.clone()),t.map(a=>[...a]),i,{...te.createDefaultTransform(),...n.transform});return s.surfaceType=n.surfaceType||"structure",s.parentId=this.currentGroup.id,n.normals&&(s.normals=n.normals.map(a=>a.clone())),n.uvs&&(s.uvs=[...n.uvs]),te.addToGroup(this.currentGroup,s),this}addRectangle(e,t,n={}){const r=n.center||new k(0,0,0),i=e/2,s=t/2;return this.addQuad(new k(r.x-i,r.y-s,r.z),new k(r.x+i,r.y-s,r.z),new k(r.x+i,r.y+s,r.z),new k(r.x-i,r.y+s,r.z),{name:n.name||"Rectangle",materialId:n.materialId,material:n.material,transform:n.transform,surfaceType:n.surfaceType})}addCircle(e,t=32,n={}){const r=[new k(e,0,0),new k(0,0,0)];return this.addRevolution(r,{name:n.name||"Circle",materialId:n.materialId,material:n.material,transform:n.transform,segments:t,axis:new k(0,0,1),surfaceType:n.surfaceType})}addArc(e,t,n,r,i={}){const s=[new k(t,0,0),new k(e,0,0)];return this.addRevolution(s,{name:i.name||"Arc",materialId:i.materialId,material:i.material,transform:i.transform,startAngle:n,endAngle:r,segments:i.segments||32,closed:!1,axis:new k(0,0,1),surfaceType:i.surfaceType})}build(){this.currentGroup=this.scene.root;const e=te.validateScene(this.scene);return e.valid||console.warn("CIF Scene validation failed:",e.errors),this.scene}resolveMaterial(e,t){if(e&&this.scene.materials.has(e))return this.scene.materials.get(e);if(t){const r={...te.createDefaultMaterial(),...t},i=`material_${this.scene.materials.size}`;return this.scene.materials.set(i,r),r}const n="default";return this.scene.materials.has(n)||this.scene.materials.set(n,te.createDefaultMaterial()),this.scene.materials.get(n)}}var ri=Object.defineProperty,ii=(l,e,t)=>e in l?ri(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,si=(l,e,t)=>ii(l,e+"",t);const or=class Zt{static getMaterialByCategory(e){return Zt.MATERIALS.find(n=>n.category===e)||null}static getRandomMaterial(){const e=Math.floor(Math.random()*Zt.MATERIALS.length);return Zt.MATERIALS[e]}static createVariationOfMaterial(e,t=.1){const n=e.color.clone();return n.r=Math.max(0,Math.min(1,n.r+(Math.random()-.5)*t)),n.g=Math.max(0,Math.min(1,n.g+(Math.random()-.5)*t)),n.b=Math.max(0,Math.min(1,n.b+(Math.random()-.5)*t)),{...e,name:`${e.name} (Variant)`,color:n}}static getGradientMaterials(e,t,n){const r=[];for(let i=0;i<n;i++){const s=i/(n-1),a=new Be().lerpColors(e.color,t.color,s),c=e.opacity+(t.opacity-e.opacity)*s;r.push({name:`Gradient ${i+1}`,color:a,opacity:c,transparent:c<1,category:e.category})}return r}};si(or,"MATERIALS",[{name:"Audience Seating",color:new Be(14483456),opacity:1,transparent:!1,category:"audience"},{name:"Stage Platform",color:new Be(17152),opacity:1,transparent:!1,category:"stage"},{name:"Structural Wall",color:new Be(54016),opacity:1,transparent:!1,category:"structural"},{name:"imag Panel",color:new Be(4251856),opacity:.4,transparent:!0,category:"structural"}]);let it=or;function oi(l){const e=l.toLowerCase();return e.includes("audience")||e.includes("seating")||e.includes("seat")||e.includes("chair")?it.getMaterialByCategory("audience")||it.getRandomMaterial():e.includes("stage")&&(e.includes("platform")||e.includes("floor")||e.includes("deck"))||e.includes("platform")&&(e.includes("stage")||e.includes("performance"))||e.includes("performance area")?it.getMaterialByCategory("stage")||it.getRandomMaterial():(e.includes("wall")||e.includes("ceiling")||e.includes("floor")||e.includes("structure")||e.includes("beam")||e.includes("column"),it.getMaterialByCategory("structural")||it.getRandomMaterial())}var ai=Object.defineProperty,ci=(l,e,t)=>e in l?ai(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,nn=(l,e,t)=>ci(l,typeof e!="symbol"?e+"":e,t);class li{constructor(e={}){nn(this,"options"),nn(this,"groupColors",new Map),nn(this,"usedColors",new Set),this.options={preserveOriginalColors:e.preserveOriginalColors??!0,enableGroupColoring:e.enableGroupColoring??!0,variationAmount:e.variationAmount||.05}}getMaterialForObject(e,t,n,r){if(this.options.preserveOriginalColors&&t!==void 0){const i=this.normalizeColor(t);if(!this.isDefaultColor(i))return this.createMaterialFromColor(i,e)}return this.options.enableGroupColoring&&n?this.getMaterialForGroup(n,e,r):this.getContextBasedMaterial(e,r)}getMaterialForGroup(e,t,n){if(!this.groupColors.has(e)){const s=this.getContextBasedMaterial(e,n);this.groupColors.set(e,{baseColor:s.color.clone(),materialDef:s,memberCount:0,lastVariation:0})}const r=this.groupColors.get(e);r.memberCount++;const i=this.createGroupMemberVariation(r.materialDef,r.memberCount,t);return{name:i.name,color:i.color.clone(),opacity:i.opacity,transparent:i.transparent}}createGroupMemberVariation(e,t,n){const r=it.createVariationOfMaterial(e,this.options.variationAmount*.5),i=t*.03%.1,s=this.rgbToHsv(r.color);return s.h=(s.h+i)%1,r.color=this.hsvToRgb(s),r.name=`${e.name} (${n})`,r}getContextBasedMaterial(e,t){let n=oi(e);return t&&(n=this.adjustMaterialForSurfaceType(n,t)),n}adjustMaterialForSurfaceType(e,t){const n={...e};switch(t){case"listen":n.color=this.adjustColorTemperature(e.color,.1);break;case"obstacle":n.color=this.adjustColorTemperature(e.color,-.1);break}return n}createMaterialFromColor(e,t){return{name:`${t} Material`,color:e.clone(),opacity:1,transparent:!1}}normalizeColor(e){return typeof e=="number"?new Be(e):e.clone()}isDefaultColor(e){const t=[8947848,8421504,12632256,16777215,0],n=e.getHex();return t.includes(n)}adjustColorTemperature(e,t){const n=e.clone();return t>0?(n.r=Math.min(1,n.r+t),n.b=Math.max(0,n.b-t*.5)):(n.r=Math.max(0,n.r+t),n.b=Math.min(1,n.b-t*.5)),n}rgbToHsv(e){const t=e.r,n=e.g,r=e.b,i=Math.max(t,n,r),s=Math.min(t,n,r),a=i-s;let c=0;const u=i===0?0:a/i,d=i;return a!==0&&(i===t?c=(n-r)/a%6:i===n?c=(r-t)/a+2:c=(t-n)/a+4,c/=6,c<0&&(c+=1)),{h:c,s:u,v:d}}hsvToRgb({h:e,s:t,v:n}){const r=n*t,i=r*(1-Math.abs(e*6%2-1)),s=n-r;let a=0,c=0,u=0;return e>=0&&e<1/6?(a=r,c=i,u=0):e>=1/6&&e<2/6?(a=i,c=r,u=0):e>=2/6&&e<3/6?(a=0,c=r,u=i):e>=3/6&&e<4/6?(a=0,c=i,u=r):e>=4/6&&e<5/6?(a=i,c=0,u=r):(a=r,c=0,u=i),new Be(a+s,c+s,u+s)}reset(){this.groupColors.clear(),this.usedColors.clear()}getColorStats(){const e=Array.from(this.groupColors.values()).reduce((t,n)=>t+n.memberCount,0);return{totalGroups:this.groupColors.size,totalObjects:e}}}function Nt(l,e={}){const n={...{obj:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.2},dbacv:{preserveOriginalColors:!0,enableGroupColoring:!0,variationAmount:.1},fc3:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.15},cvf:{preserveOriginalColors:!1,enableGroupColoring:!0,variationAmount:.15},general:{preserveOriginalColors:!0,enableGroupColoring:!0,variationAmount:.15}}[l],...e};return new li(n)}class Y{static parseFloat(e,t,n=0){const r=e.getAttribute(t);if(!r)return n;const i=parseFloat(r);return isNaN(i)?n:i}static parseInt(e,t,n=0){const r=e.getAttribute(t);if(!r)return n;const i=parseInt(r,10);return isNaN(i)?n:i}static parseString(e,t,n=""){return e.getAttribute(t)||n}static parseBoolean(e,t,n=!1){const r=e.getAttribute(t);return r?r.toLowerCase()==="true"||r==="1":n}static parseVector3(e,t,n,r,i=new k(0,0,0)){const s=Y.parseFloat(e,t,i.x),a=Y.parseFloat(e,n,i.y),c=Y.parseFloat(e,r,i.z);return new k(s,a,c)}static parseVector3FromCSV(e,t,n=new k(0,0,0)){const r=e.getAttribute(t);if(!r)return n.clone();const i=r.split(",").map(s=>parseFloat(s.trim()));return i.length!==3||i.some(isNaN)?n.clone():new k(i[0],i[1],i[2])}static parseRotationDegToRad(e,t,n,r,i=new k(0,0,0)){const s=Y.parseFloat(e,t,i.x*180/Math.PI)*Math.PI/180,a=Y.parseFloat(e,n,i.y*180/Math.PI)*Math.PI/180,c=Y.parseFloat(e,r,i.z*180/Math.PI)*Math.PI/180;return new k(s,a,c)}static getChildrenByTagName(e,t){return Array.from(e.getElementsByTagName(t))}static getFirstChildByTagName(e,t){const n=e.getElementsByTagName(t);return n.length>0?n[0]:null}static getChildTextContent(e,t,n=""){return Y.getFirstChildByTagName(e,t)?.textContent||n}static hasAttribute(e,t){return e.hasAttribute(t)}static getAttributeCaseInsensitive(e,t,n=""){let r=e.getAttribute(t);return r!==null||(r=e.getAttribute(t.toLowerCase()),r!==null)||(r=e.getAttribute(t.toUpperCase()),r!==null)?r:n}static getElementsByTagNameCaseInsensitive(e,t){let n=Array.from(e.getElementsByTagName(t));return n.length>0||(n=Array.from(e.getElementsByTagName(t.toLowerCase()))),n}static getFirstChildByTagNameCaseInsensitive(e,t){const n=Y.getElementsByTagNameCaseInsensitive(e,t);return n.length>0?n[0]:null}static parseHexColor(e,t,n=16777215){const r=e.getAttribute(t);if(!r)return n;const i=r.replace(/^(#|0x)/,""),s=parseInt(i,16);return isNaN(s)?n:s}}class ui{convert(e,t){const n=new St({originalFormat:"dbacv",originalFileName:t,author:"D&B ArrayCalc",comments:"Converted from DBACV format"});n.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const r=Nt("dbacv"),i=new DOMParser().parseFromString(e,"application/xml"),s=Y.getElementsByTagNameCaseInsensitive(i,"RoomObject");for(let a=0;a<s.length;a++){const c=s[a];Y.getAttributeCaseInsensitive(c,"Shape")!=="5"&&this.processRoomObject(c,n,r)}return n.build()}processRoomObject(e,t,n){const r=Y.getAttributeCaseInsensitive(e,"Shape"),i=Y.getAttributeCaseInsensitive(e,"Name","Unnamed"),s=this.parseColor(Y.getAttributeCaseInsensitive(e,"Color")),a=s!==8947848?new Be(s):void 0,c=n.getMaterialForObject(i,a,"dbacv_objects",this.extractSurfaceType(e));Y.getAttributeCaseInsensitive(e,"Transparent")==="1"&&(c.opacity=.8,c.transparent=!0);const u=this.extractSurfaceType(e),d=this.extractOriginFromObjectAndGroup(e),p=this.extractZRotation(e);switch(r){case"1":this.createQuadPrimitive(e,t,i,c,d,p,u);break;case"2":this.createArcSegment(e,t,i,c,d,p,!1,u);break;case"3":this.createArcSegment(e,t,i,c,d,p,!0,u);break;case"4":this.createCube(e,t,i,c,d,p,u);break;case"6":this.createTrianglePrimitive(e,t,i,c,d,p,u);break}}createTrianglePrimitive(e,t,n,r,i,s,a){const c=this.extractVertices(e,3);c.length===3&&this.isValidGeometry(c)&&t.addTriangle(c[0],c[1],c[2],{name:n,material:r,surfaceType:a,transform:{position:i,rotation:new k(0,0,s)}})}createQuadPrimitive(e,t,n,r,i,s,a){const c=this.extractVertices(e,4);c.length===4&&this.isValidGeometry(c)&&t.addQuad(c[0],c[1],c[2],c[3],{name:n,material:r,surfaceType:a,transform:{position:i,rotation:new k(0,0,s)}})}createCube(e,t,n,r,i,s,a){const c=this.extractVertices(e,8);c.length===8&&this.isValidGeometry(c)&&t.addCube(c,{name:n,material:r,surfaceType:a,transform:{position:i,rotation:new k(0,0,s)}})}createArcSegment(e,t,n,r,i,s,a,c){let u,d,p,g;if(a){u=Y.parseFloat(e,"InnerA"),d=Y.parseFloat(e,"OuterA");const O=Y.parseFloat(e,"InnerB"),F=Y.parseFloat(e,"OuterB");p=isNaN(O)?u:O,g=isNaN(F)?d:F}else u=Y.parseFloat(e,"InnerRadiusA"),d=Y.parseFloat(e,"OuterRadiusA"),p=u,g=d;const v=et(Y.parseFloat(e,"StartAngle")),y=et(Y.parseFloat(e,"SpanAngle")),S=parseFloat(Y.getAttributeCaseInsensitive(e,"InnerZ","0")),_=parseFloat(Y.getAttributeCaseInsensitive(e,"OuterZ","0")),E=a?p:u,D=a?g:d,T=[new k(D,0,_),new k(E,0,S)],M=Math.max(8,Math.ceil(Math.abs(yt(y))/10)),R={name:n,material:r,surfaceType:c,startAngle:v,endAngle:v+y,segments:M};a&&(p!==u||g!==d)&&(R.ellipticalScaling={innerRadii:{major:u,minor:p},outerRadii:{major:d,minor:g}}),R.closed=Math.abs(y)>=2*Math.PI-.01,R.axis=new k(0,0,1),R.transform={position:i,rotation:new k(0,0,s)},t.addRevolution(T,R)}extractVertices(e,t){const n=[];for(let r=1;r<=t;r++){const i=Y.getFirstChildByTagNameCaseInsensitive(e,`P${r}`);if(i){const s=parseFloat(Y.getAttributeCaseInsensitive(i,"x","0")),a=parseFloat(Y.getAttributeCaseInsensitive(i,"y","0")),c=parseFloat(Y.getAttributeCaseInsensitive(i,"z","0"));n.push(new k(s,a,c))}}return n}parseColor(e){if(!e)return 8947848;const t=parseInt(e);return isNaN(t)?8947848:t&16777215}extractZRotation(e){const t=Y.getFirstChildByTagNameCaseInsensitive(e,"Rotation");if(t){const n=parseFloat(Y.getAttributeCaseInsensitive(t,"z","0"));return et(n)}return 0}extractOriginFromObjectAndGroup(e){const t=Y.getFirstChildByTagNameCaseInsensitive(e,"Origin"),n=new k(parseFloat(Y.getAttributeCaseInsensitive(t||e,"x","0")),parseFloat(Y.getAttributeCaseInsensitive(t||e,"y","0")),parseFloat(Y.getAttributeCaseInsensitive(t||e,"z","0"))),r=new k(0,0,0),i=e.parentNode,s=i?Y.getElementsByTagNameCaseInsensitive(i,"Origin"):[];for(let a=0;a<s.length;a++){const c=s[a].parentNode;c&&Y.getAttributeCaseInsensitive(c,"ObjectGroup")==="true"&&(r.x=parseFloat(Y.getAttributeCaseInsensitive(s[a],"x","0")),r.y=parseFloat(Y.getAttributeCaseInsensitive(s[a],"y","0")),r.z=parseFloat(Y.getAttributeCaseInsensitive(s[a],"z","0")))}return i&&Y.getAttributeCaseInsensitive(i,"ObjectGroup")==="true"&&(n.x+=r.x,n.y+=r.y,n.z+=r.z),n}isValidGeometry(e){if(e.length<2)return!1;const t=e[0],n=1e-6;for(let r=1;r<e.length;r++)if(t.distanceTo(e[r])>n)return!0;return!1}extractSurfaceType(e){const t=Y.getAttributeCaseInsensitive(e,"PlaneType"),n=parseFloat(Y.getAttributeCaseInsensitive(e,"ListenerHeight","0"));if(t==="1"&&n>1)return"listen";if(t==="4"||n<.1)return"structure";const r=Y.getAttributeCaseInsensitive(e,"Type");if(r){const s=r.toLowerCase();if(s==="listen")return"listen";if(s==="obstacle")return"obstacle";if(s==="structure")return"structure"}const i=Y.getAttributeCaseInsensitive(e,"SurfaceType");if(i){const s=i.toLowerCase();if(s==="listen")return"listen";if(s==="obstacle")return"obstacle";if(s==="structure")return"structure"}return"structure"}}var rn={},Nn;function ht(){return Nn||(Nn=1,(function(l){var e=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";function t(i,s){return Object.prototype.hasOwnProperty.call(i,s)}l.assign=function(i){for(var s=Array.prototype.slice.call(arguments,1);s.length;){var a=s.shift();if(a){if(typeof a!="object")throw new TypeError(a+"must be non-object");for(var c in a)t(a,c)&&(i[c]=a[c])}}return i},l.shrinkBuf=function(i,s){return i.length===s?i:i.subarray?i.subarray(0,s):(i.length=s,i)};var n={arraySet:function(i,s,a,c,u){if(s.subarray&&i.subarray){i.set(s.subarray(a,a+c),u);return}for(var d=0;d<c;d++)i[u+d]=s[a+d]},flattenChunks:function(i){var s,a,c,u,d,p;for(c=0,s=0,a=i.length;s<a;s++)c+=i[s].length;for(p=new Uint8Array(c),u=0,s=0,a=i.length;s<a;s++)d=i[s],p.set(d,u),u+=d.length;return p}},r={arraySet:function(i,s,a,c,u){for(var d=0;d<c;d++)i[u+d]=s[a+d]},flattenChunks:function(i){return[].concat.apply([],i)}};l.setTyped=function(i){i?(l.Buf8=Uint8Array,l.Buf16=Uint16Array,l.Buf32=Int32Array,l.assign(l,n)):(l.Buf8=Array,l.Buf16=Array,l.Buf32=Array,l.assign(l,r))},l.setTyped(e)})(rn)),rn}var At={},Xe={},mt={},Rn;function fi(){if(Rn)return mt;Rn=1;var l=ht(),e=4,t=0,n=1,r=2;function i(m){for(var z=m.length;--z>=0;)m[z]=0}var s=0,a=1,c=2,u=3,d=258,p=29,g=256,v=g+1+p,y=30,S=19,_=2*v+1,E=15,D=16,T=7,M=256,R=16,O=17,F=18,G=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Z=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],$=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],ie=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ne=512,j=new Array((v+2)*2);i(j);var K=new Array(y*2);i(K);var pe=new Array(ne);i(pe);var de=new Array(d-u+1);i(de);var W=new Array(p);i(W);var ye=new Array(y);i(ye);function fe(m,z,L,U,x){this.static_tree=m,this.extra_bits=z,this.extra_base=L,this.elems=U,this.max_length=x,this.has_stree=m&&m.length}var Ge,Re,Ae;function me(m,z){this.dyn_tree=m,this.max_code=0,this.stat_desc=z}function ke(m){return m<256?pe[m]:pe[256+(m>>>7)]}function Te(m,z){m.pending_buf[m.pending++]=z&255,m.pending_buf[m.pending++]=z>>>8&255}function ae(m,z,L){m.bi_valid>D-L?(m.bi_buf|=z<<m.bi_valid&65535,Te(m,m.bi_buf),m.bi_buf=z>>D-m.bi_valid,m.bi_valid+=L-D):(m.bi_buf|=z<<m.bi_valid&65535,m.bi_valid+=L)}function ge(m,z,L){ae(m,L[z*2],L[z*2+1])}function oe(m,z){var L=0;do L|=m&1,m>>>=1,L<<=1;while(--z>0);return L>>>1}function Ie(m){m.bi_valid===16?(Te(m,m.bi_buf),m.bi_buf=0,m.bi_valid=0):m.bi_valid>=8&&(m.pending_buf[m.pending++]=m.bi_buf&255,m.bi_buf>>=8,m.bi_valid-=8)}function $e(m,z){var L=z.dyn_tree,U=z.max_code,x=z.stat_desc.static_tree,C=z.stat_desc.has_stree,f=z.stat_desc.extra_bits,N=z.stat_desc.extra_base,V=z.stat_desc.max_length,o,A,I,h,b,w,H=0;for(h=0;h<=E;h++)m.bl_count[h]=0;for(L[m.heap[m.heap_max]*2+1]=0,o=m.heap_max+1;o<_;o++)A=m.heap[o],h=L[L[A*2+1]*2+1]+1,h>V&&(h=V,H++),L[A*2+1]=h,!(A>U)&&(m.bl_count[h]++,b=0,A>=N&&(b=f[A-N]),w=L[A*2],m.opt_len+=w*(h+b),C&&(m.static_len+=w*(x[A*2+1]+b)));if(H!==0){do{for(h=V-1;m.bl_count[h]===0;)h--;m.bl_count[h]--,m.bl_count[h+1]+=2,m.bl_count[V]--,H-=2}while(H>0);for(h=V;h!==0;h--)for(A=m.bl_count[h];A!==0;)I=m.heap[--o],!(I>U)&&(L[I*2+1]!==h&&(m.opt_len+=(h-L[I*2+1])*L[I*2],L[I*2+1]=h),A--)}}function He(m,z,L){var U=new Array(E+1),x=0,C,f;for(C=1;C<=E;C++)U[C]=x=x+L[C-1]<<1;for(f=0;f<=z;f++){var N=m[f*2+1];N!==0&&(m[f*2]=oe(U[N]++,N))}}function ce(){var m,z,L,U,x,C=new Array(E+1);for(L=0,U=0;U<p-1;U++)for(W[U]=L,m=0;m<1<<G[U];m++)de[L++]=U;for(de[L-1]=U,x=0,U=0;U<16;U++)for(ye[U]=x,m=0;m<1<<Z[U];m++)pe[x++]=U;for(x>>=7;U<y;U++)for(ye[U]=x<<7,m=0;m<1<<Z[U]-7;m++)pe[256+x++]=U;for(z=0;z<=E;z++)C[z]=0;for(m=0;m<=143;)j[m*2+1]=8,m++,C[8]++;for(;m<=255;)j[m*2+1]=9,m++,C[9]++;for(;m<=279;)j[m*2+1]=7,m++,C[7]++;for(;m<=287;)j[m*2+1]=8,m++,C[8]++;for(He(j,v+1,C),m=0;m<y;m++)K[m*2+1]=5,K[m*2]=oe(m,5);Ge=new fe(j,G,g+1,v,E),Re=new fe(K,Z,0,y,E),Ae=new fe(new Array(0),$,0,S,T)}function Oe(m){var z;for(z=0;z<v;z++)m.dyn_ltree[z*2]=0;for(z=0;z<y;z++)m.dyn_dtree[z*2]=0;for(z=0;z<S;z++)m.bl_tree[z*2]=0;m.dyn_ltree[M*2]=1,m.opt_len=m.static_len=0,m.last_lit=m.matches=0}function pt(m){m.bi_valid>8?Te(m,m.bi_buf):m.bi_valid>0&&(m.pending_buf[m.pending++]=m.bi_buf),m.bi_buf=0,m.bi_valid=0}function je(m,z,L,U){pt(m),Te(m,L),Te(m,~L),l.arraySet(m.pending_buf,m.window,z,L,m.pending),m.pending+=L}function Le(m,z,L,U){var x=z*2,C=L*2;return m[x]<m[C]||m[x]===m[C]&&U[z]<=U[L]}function he(m,z,L){for(var U=m.heap[L],x=L<<1;x<=m.heap_len&&(x<m.heap_len&&Le(z,m.heap[x+1],m.heap[x],m.depth)&&x++,!Le(z,U,m.heap[x],m.depth));)m.heap[L]=m.heap[x],L=x,x<<=1;m.heap[L]=U}function J(m,z,L){var U,x,C=0,f,N;if(m.last_lit!==0)do U=m.pending_buf[m.d_buf+C*2]<<8|m.pending_buf[m.d_buf+C*2+1],x=m.pending_buf[m.l_buf+C],C++,U===0?ge(m,x,z):(f=de[x],ge(m,f+g+1,z),N=G[f],N!==0&&(x-=W[f],ae(m,x,N)),U--,f=ke(U),ge(m,f,L),N=Z[f],N!==0&&(U-=ye[f],ae(m,U,N)));while(C<m.last_lit);ge(m,M,z)}function Ze(m,z){var L=z.dyn_tree,U=z.stat_desc.static_tree,x=z.stat_desc.has_stree,C=z.stat_desc.elems,f,N,V=-1,o;for(m.heap_len=0,m.heap_max=_,f=0;f<C;f++)L[f*2]!==0?(m.heap[++m.heap_len]=V=f,m.depth[f]=0):L[f*2+1]=0;for(;m.heap_len<2;)o=m.heap[++m.heap_len]=V<2?++V:0,L[o*2]=1,m.depth[o]=0,m.opt_len--,x&&(m.static_len-=U[o*2+1]);for(z.max_code=V,f=m.heap_len>>1;f>=1;f--)he(m,L,f);o=C;do f=m.heap[1],m.heap[1]=m.heap[m.heap_len--],he(m,L,1),N=m.heap[1],m.heap[--m.heap_max]=f,m.heap[--m.heap_max]=N,L[o*2]=L[f*2]+L[N*2],m.depth[o]=(m.depth[f]>=m.depth[N]?m.depth[f]:m.depth[N])+1,L[f*2+1]=L[N*2+1]=o,m.heap[1]=o++,he(m,L,1);while(m.heap_len>=2);m.heap[--m.heap_max]=m.heap[1],$e(m,z),He(L,V,m.bl_count)}function xt(m,z,L){var U,x=-1,C,f=z[1],N=0,V=7,o=4;for(f===0&&(V=138,o=3),z[(L+1)*2+1]=65535,U=0;U<=L;U++)C=f,f=z[(U+1)*2+1],!(++N<V&&C===f)&&(N<o?m.bl_tree[C*2]+=N:C!==0?(C!==x&&m.bl_tree[C*2]++,m.bl_tree[R*2]++):N<=10?m.bl_tree[O*2]++:m.bl_tree[F*2]++,N=0,x=C,f===0?(V=138,o=3):C===f?(V=6,o=3):(V=7,o=4))}function at(m,z,L){var U,x=-1,C,f=z[1],N=0,V=7,o=4;for(f===0&&(V=138,o=3),U=0;U<=L;U++)if(C=f,f=z[(U+1)*2+1],!(++N<V&&C===f)){if(N<o)do ge(m,C,m.bl_tree);while(--N!==0);else C!==0?(C!==x&&(ge(m,C,m.bl_tree),N--),ge(m,R,m.bl_tree),ae(m,N-3,2)):N<=10?(ge(m,O,m.bl_tree),ae(m,N-3,3)):(ge(m,F,m.bl_tree),ae(m,N-11,7));N=0,x=C,f===0?(V=138,o=3):C===f?(V=6,o=3):(V=7,o=4)}}function Ve(m){var z;for(xt(m,m.dyn_ltree,m.l_desc.max_code),xt(m,m.dyn_dtree,m.d_desc.max_code),Ze(m,m.bl_desc),z=S-1;z>=3&&m.bl_tree[ie[z]*2+1]===0;z--);return m.opt_len+=3*(z+1)+5+5+4,z}function _t(m,z,L,U){var x;for(ae(m,z-257,5),ae(m,L-1,5),ae(m,U-4,4),x=0;x<U;x++)ae(m,m.bl_tree[ie[x]*2+1],3);at(m,m.dyn_ltree,z-1),at(m,m.dyn_dtree,L-1)}function ct(m){var z=4093624447,L;for(L=0;L<=31;L++,z>>>=1)if(z&1&&m.dyn_ltree[L*2]!==0)return t;if(m.dyn_ltree[18]!==0||m.dyn_ltree[20]!==0||m.dyn_ltree[26]!==0)return n;for(L=32;L<g;L++)if(m.dyn_ltree[L*2]!==0)return n;return t}var Ke=!1;function wt(m){Ke||(ce(),Ke=!0),m.l_desc=new me(m.dyn_ltree,Ge),m.d_desc=new me(m.dyn_dtree,Re),m.bl_desc=new me(m.bl_tree,Ae),m.bi_buf=0,m.bi_valid=0,Oe(m)}function lt(m,z,L,U){ae(m,(s<<1)+(U?1:0),3),je(m,z,L)}function Se(m){ae(m,a<<1,3),ge(m,M,j),Ie(m)}function qe(m,z,L,U){var x,C,f=0;m.level>0?(m.strm.data_type===r&&(m.strm.data_type=ct(m)),Ze(m,m.l_desc),Ze(m,m.d_desc),f=Ve(m),x=m.opt_len+3+7>>>3,C=m.static_len+3+7>>>3,C<=x&&(x=C)):x=C=L+5,L+4<=x&&z!==-1?lt(m,z,L,U):m.strategy===e||C===x?(ae(m,(a<<1)+(U?1:0),3),J(m,j,K)):(ae(m,(c<<1)+(U?1:0),3),_t(m,m.l_desc.max_code+1,m.d_desc.max_code+1,f+1),J(m,m.dyn_ltree,m.dyn_dtree)),Oe(m),U&&pt(m)}function Tt(m,z,L){return m.pending_buf[m.d_buf+m.last_lit*2]=z>>>8&255,m.pending_buf[m.d_buf+m.last_lit*2+1]=z&255,m.pending_buf[m.l_buf+m.last_lit]=L&255,m.last_lit++,z===0?m.dyn_ltree[L*2]++:(m.matches++,z--,m.dyn_ltree[(de[L]+g+1)*2]++,m.dyn_dtree[ke(z)*2]++),m.last_lit===m.lit_bufsize-1}return mt._tr_init=wt,mt._tr_stored_block=lt,mt._tr_flush_block=qe,mt._tr_tally=Tt,mt._tr_align=Se,mt}var sn,Ln;function ar(){if(Ln)return sn;Ln=1;function l(e,t,n,r){for(var i=e&65535|0,s=e>>>16&65535|0,a=0;n!==0;){a=n>2e3?2e3:n,n-=a;do i=i+t[r++]|0,s=s+i|0;while(--a);i%=65521,s%=65521}return i|s<<16|0}return sn=l,sn}var on,Dn;function cr(){if(Dn)return on;Dn=1;function l(){for(var n,r=[],i=0;i<256;i++){n=i;for(var s=0;s<8;s++)n=n&1?3988292384^n>>>1:n>>>1;r[i]=n}return r}var e=l();function t(n,r,i,s){var a=e,c=s+i;n^=-1;for(var u=s;u<c;u++)n=n>>>8^a[(n^r[u])&255];return n^-1}return on=t,on}var an,Pn;function An(){return Pn||(Pn=1,an={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}),an}var Bn;function di(){if(Bn)return Xe;Bn=1;var l=ht(),e=fi(),t=ar(),n=cr(),r=An(),i=0,s=1,a=3,c=4,u=5,d=0,p=1,g=-2,v=-3,y=-5,S=-1,_=1,E=2,D=3,T=4,M=0,R=2,O=8,F=9,G=15,Z=8,$=29,ie=256,ne=ie+1+$,j=30,K=19,pe=2*ne+1,de=15,W=3,ye=258,fe=ye+W+1,Ge=32,Re=42,Ae=69,me=73,ke=91,Te=103,ae=113,ge=666,oe=1,Ie=2,$e=3,He=4,ce=3;function Oe(o,A){return o.msg=r[A],A}function pt(o){return(o<<1)-(o>4?9:0)}function je(o){for(var A=o.length;--A>=0;)o[A]=0}function Le(o){var A=o.state,I=A.pending;I>o.avail_out&&(I=o.avail_out),I!==0&&(l.arraySet(o.output,A.pending_buf,A.pending_out,I,o.next_out),o.next_out+=I,A.pending_out+=I,o.total_out+=I,o.avail_out-=I,A.pending-=I,A.pending===0&&(A.pending_out=0))}function he(o,A){e._tr_flush_block(o,o.block_start>=0?o.block_start:-1,o.strstart-o.block_start,A),o.block_start=o.strstart,Le(o.strm)}function J(o,A){o.pending_buf[o.pending++]=A}function Ze(o,A){o.pending_buf[o.pending++]=A>>>8&255,o.pending_buf[o.pending++]=A&255}function xt(o,A,I,h){var b=o.avail_in;return b>h&&(b=h),b===0?0:(o.avail_in-=b,l.arraySet(A,o.input,o.next_in,b,I),o.state.wrap===1?o.adler=t(o.adler,A,b,I):o.state.wrap===2&&(o.adler=n(o.adler,A,b,I)),o.next_in+=b,o.total_in+=b,b)}function at(o,A){var I=o.max_chain_length,h=o.strstart,b,w,H=o.prev_length,P=o.nice_match,B=o.strstart>o.w_size-fe?o.strstart-(o.w_size-fe):0,ee=o.window,nt=o.w_mask,ve=o.prev,re=o.strstart+ye,we=ee[h+H-1],Ce=ee[h+H];o.prev_length>=o.good_match&&(I>>=2),P>o.lookahead&&(P=o.lookahead);do if(b=A,!(ee[b+H]!==Ce||ee[b+H-1]!==we||ee[b]!==ee[h]||ee[++b]!==ee[h+1])){h+=2,b++;do;while(ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&ee[++h]===ee[++b]&&h<re);if(w=ye-(re-h),h=re-ye,w>H){if(o.match_start=A,H=w,w>=P)break;we=ee[h+H-1],Ce=ee[h+H]}}while((A=ve[A&nt])>B&&--I!==0);return H<=o.lookahead?H:o.lookahead}function Ve(o){var A=o.w_size,I,h,b,w,H;do{if(w=o.window_size-o.lookahead-o.strstart,o.strstart>=A+(A-fe)){l.arraySet(o.window,o.window,A,A,0),o.match_start-=A,o.strstart-=A,o.block_start-=A,h=o.hash_size,I=h;do b=o.head[--I],o.head[I]=b>=A?b-A:0;while(--h);h=A,I=h;do b=o.prev[--I],o.prev[I]=b>=A?b-A:0;while(--h);w+=A}if(o.strm.avail_in===0)break;if(h=xt(o.strm,o.window,o.strstart+o.lookahead,w),o.lookahead+=h,o.lookahead+o.insert>=W)for(H=o.strstart-o.insert,o.ins_h=o.window[H],o.ins_h=(o.ins_h<<o.hash_shift^o.window[H+1])&o.hash_mask;o.insert&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[H+W-1])&o.hash_mask,o.prev[H&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=H,H++,o.insert--,!(o.lookahead+o.insert<W)););}while(o.lookahead<fe&&o.strm.avail_in!==0)}function _t(o,A){var I=65535;for(I>o.pending_buf_size-5&&(I=o.pending_buf_size-5);;){if(o.lookahead<=1){if(Ve(o),o.lookahead===0&&A===i)return oe;if(o.lookahead===0)break}o.strstart+=o.lookahead,o.lookahead=0;var h=o.block_start+I;if((o.strstart===0||o.strstart>=h)&&(o.lookahead=o.strstart-h,o.strstart=h,he(o,!1),o.strm.avail_out===0)||o.strstart-o.block_start>=o.w_size-fe&&(he(o,!1),o.strm.avail_out===0))return oe}return o.insert=0,A===c?(he(o,!0),o.strm.avail_out===0?$e:He):(o.strstart>o.block_start&&(he(o,!1),o.strm.avail_out===0),oe)}function ct(o,A){for(var I,h;;){if(o.lookahead<fe){if(Ve(o),o.lookahead<fe&&A===i)return oe;if(o.lookahead===0)break}if(I=0,o.lookahead>=W&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+W-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),I!==0&&o.strstart-I<=o.w_size-fe&&(o.match_length=at(o,I)),o.match_length>=W)if(h=e._tr_tally(o,o.strstart-o.match_start,o.match_length-W),o.lookahead-=o.match_length,o.match_length<=o.max_lazy_match&&o.lookahead>=W){o.match_length--;do o.strstart++,o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+W-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart;while(--o.match_length!==0);o.strstart++}else o.strstart+=o.match_length,o.match_length=0,o.ins_h=o.window[o.strstart],o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+1])&o.hash_mask;else h=e._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++;if(h&&(he(o,!1),o.strm.avail_out===0))return oe}return o.insert=o.strstart<W-1?o.strstart:W-1,A===c?(he(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(he(o,!1),o.strm.avail_out===0)?oe:Ie}function Ke(o,A){for(var I,h,b;;){if(o.lookahead<fe){if(Ve(o),o.lookahead<fe&&A===i)return oe;if(o.lookahead===0)break}if(I=0,o.lookahead>=W&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+W-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart),o.prev_length=o.match_length,o.prev_match=o.match_start,o.match_length=W-1,I!==0&&o.prev_length<o.max_lazy_match&&o.strstart-I<=o.w_size-fe&&(o.match_length=at(o,I),o.match_length<=5&&(o.strategy===_||o.match_length===W&&o.strstart-o.match_start>4096)&&(o.match_length=W-1)),o.prev_length>=W&&o.match_length<=o.prev_length){b=o.strstart+o.lookahead-W,h=e._tr_tally(o,o.strstart-1-o.prev_match,o.prev_length-W),o.lookahead-=o.prev_length-1,o.prev_length-=2;do++o.strstart<=b&&(o.ins_h=(o.ins_h<<o.hash_shift^o.window[o.strstart+W-1])&o.hash_mask,I=o.prev[o.strstart&o.w_mask]=o.head[o.ins_h],o.head[o.ins_h]=o.strstart);while(--o.prev_length!==0);if(o.match_available=0,o.match_length=W-1,o.strstart++,h&&(he(o,!1),o.strm.avail_out===0))return oe}else if(o.match_available){if(h=e._tr_tally(o,0,o.window[o.strstart-1]),h&&he(o,!1),o.strstart++,o.lookahead--,o.strm.avail_out===0)return oe}else o.match_available=1,o.strstart++,o.lookahead--}return o.match_available&&(h=e._tr_tally(o,0,o.window[o.strstart-1]),o.match_available=0),o.insert=o.strstart<W-1?o.strstart:W-1,A===c?(he(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(he(o,!1),o.strm.avail_out===0)?oe:Ie}function wt(o,A){for(var I,h,b,w,H=o.window;;){if(o.lookahead<=ye){if(Ve(o),o.lookahead<=ye&&A===i)return oe;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=W&&o.strstart>0&&(b=o.strstart-1,h=H[b],h===H[++b]&&h===H[++b]&&h===H[++b])){w=o.strstart+ye;do;while(h===H[++b]&&h===H[++b]&&h===H[++b]&&h===H[++b]&&h===H[++b]&&h===H[++b]&&h===H[++b]&&h===H[++b]&&b<w);o.match_length=ye-(w-b),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=W?(I=e._tr_tally(o,1,o.match_length-W),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(I=e._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),I&&(he(o,!1),o.strm.avail_out===0))return oe}return o.insert=0,A===c?(he(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(he(o,!1),o.strm.avail_out===0)?oe:Ie}function lt(o,A){for(var I;;){if(o.lookahead===0&&(Ve(o),o.lookahead===0)){if(A===i)return oe;break}if(o.match_length=0,I=e._tr_tally(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,I&&(he(o,!1),o.strm.avail_out===0))return oe}return o.insert=0,A===c?(he(o,!0),o.strm.avail_out===0?$e:He):o.last_lit&&(he(o,!1),o.strm.avail_out===0)?oe:Ie}function Se(o,A,I,h,b){this.good_length=o,this.max_lazy=A,this.nice_length=I,this.max_chain=h,this.func=b}var qe;qe=[new Se(0,0,0,0,_t),new Se(4,4,8,4,ct),new Se(4,5,16,8,ct),new Se(4,6,32,32,ct),new Se(4,4,16,16,Ke),new Se(8,16,32,32,Ke),new Se(8,16,128,128,Ke),new Se(8,32,128,256,Ke),new Se(32,128,258,1024,Ke),new Se(32,258,258,4096,Ke)];function Tt(o){o.window_size=2*o.w_size,je(o.head),o.max_lazy_match=qe[o.level].max_lazy,o.good_match=qe[o.level].good_length,o.nice_match=qe[o.level].nice_length,o.max_chain_length=qe[o.level].max_chain,o.strstart=0,o.block_start=0,o.lookahead=0,o.insert=0,o.match_length=o.prev_length=W-1,o.match_available=0,o.ins_h=0}function m(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=O,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new l.Buf16(pe*2),this.dyn_dtree=new l.Buf16((2*j+1)*2),this.bl_tree=new l.Buf16((2*K+1)*2),je(this.dyn_ltree),je(this.dyn_dtree),je(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new l.Buf16(de+1),this.heap=new l.Buf16(2*ne+1),je(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new l.Buf16(2*ne+1),je(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function z(o){var A;return!o||!o.state?Oe(o,g):(o.total_in=o.total_out=0,o.data_type=R,A=o.state,A.pending=0,A.pending_out=0,A.wrap<0&&(A.wrap=-A.wrap),A.status=A.wrap?Re:ae,o.adler=A.wrap===2?0:1,A.last_flush=i,e._tr_init(A),d)}function L(o){var A=z(o);return A===d&&Tt(o.state),A}function U(o,A){return!o||!o.state||o.state.wrap!==2?g:(o.state.gzhead=A,d)}function x(o,A,I,h,b,w){if(!o)return g;var H=1;if(A===S&&(A=6),h<0?(H=0,h=-h):h>15&&(H=2,h-=16),b<1||b>F||I!==O||h<8||h>15||A<0||A>9||w<0||w>T)return Oe(o,g);h===8&&(h=9);var P=new m;return o.state=P,P.strm=o,P.wrap=H,P.gzhead=null,P.w_bits=h,P.w_size=1<<P.w_bits,P.w_mask=P.w_size-1,P.hash_bits=b+7,P.hash_size=1<<P.hash_bits,P.hash_mask=P.hash_size-1,P.hash_shift=~~((P.hash_bits+W-1)/W),P.window=new l.Buf8(P.w_size*2),P.head=new l.Buf16(P.hash_size),P.prev=new l.Buf16(P.w_size),P.lit_bufsize=1<<b+6,P.pending_buf_size=P.lit_bufsize*4,P.pending_buf=new l.Buf8(P.pending_buf_size),P.d_buf=1*P.lit_bufsize,P.l_buf=3*P.lit_bufsize,P.level=A,P.strategy=w,P.method=I,L(o)}function C(o,A){return x(o,A,O,G,Z,M)}function f(o,A){var I,h,b,w;if(!o||!o.state||A>u||A<0)return o?Oe(o,g):g;if(h=o.state,!o.output||!o.input&&o.avail_in!==0||h.status===ge&&A!==c)return Oe(o,o.avail_out===0?y:g);if(h.strm=o,I=h.last_flush,h.last_flush=A,h.status===Re)if(h.wrap===2)o.adler=0,J(h,31),J(h,139),J(h,8),h.gzhead?(J(h,(h.gzhead.text?1:0)+(h.gzhead.hcrc?2:0)+(h.gzhead.extra?4:0)+(h.gzhead.name?8:0)+(h.gzhead.comment?16:0)),J(h,h.gzhead.time&255),J(h,h.gzhead.time>>8&255),J(h,h.gzhead.time>>16&255),J(h,h.gzhead.time>>24&255),J(h,h.level===9?2:h.strategy>=E||h.level<2?4:0),J(h,h.gzhead.os&255),h.gzhead.extra&&h.gzhead.extra.length&&(J(h,h.gzhead.extra.length&255),J(h,h.gzhead.extra.length>>8&255)),h.gzhead.hcrc&&(o.adler=n(o.adler,h.pending_buf,h.pending,0)),h.gzindex=0,h.status=Ae):(J(h,0),J(h,0),J(h,0),J(h,0),J(h,0),J(h,h.level===9?2:h.strategy>=E||h.level<2?4:0),J(h,ce),h.status=ae);else{var H=O+(h.w_bits-8<<4)<<8,P=-1;h.strategy>=E||h.level<2?P=0:h.level<6?P=1:h.level===6?P=2:P=3,H|=P<<6,h.strstart!==0&&(H|=Ge),H+=31-H%31,h.status=ae,Ze(h,H),h.strstart!==0&&(Ze(h,o.adler>>>16),Ze(h,o.adler&65535)),o.adler=1}if(h.status===Ae)if(h.gzhead.extra){for(b=h.pending;h.gzindex<(h.gzhead.extra.length&65535)&&!(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>b&&(o.adler=n(o.adler,h.pending_buf,h.pending-b,b)),Le(o),b=h.pending,h.pending===h.pending_buf_size));)J(h,h.gzhead.extra[h.gzindex]&255),h.gzindex++;h.gzhead.hcrc&&h.pending>b&&(o.adler=n(o.adler,h.pending_buf,h.pending-b,b)),h.gzindex===h.gzhead.extra.length&&(h.gzindex=0,h.status=me)}else h.status=me;if(h.status===me)if(h.gzhead.name){b=h.pending;do{if(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>b&&(o.adler=n(o.adler,h.pending_buf,h.pending-b,b)),Le(o),b=h.pending,h.pending===h.pending_buf_size)){w=1;break}h.gzindex<h.gzhead.name.length?w=h.gzhead.name.charCodeAt(h.gzindex++)&255:w=0,J(h,w)}while(w!==0);h.gzhead.hcrc&&h.pending>b&&(o.adler=n(o.adler,h.pending_buf,h.pending-b,b)),w===0&&(h.gzindex=0,h.status=ke)}else h.status=ke;if(h.status===ke)if(h.gzhead.comment){b=h.pending;do{if(h.pending===h.pending_buf_size&&(h.gzhead.hcrc&&h.pending>b&&(o.adler=n(o.adler,h.pending_buf,h.pending-b,b)),Le(o),b=h.pending,h.pending===h.pending_buf_size)){w=1;break}h.gzindex<h.gzhead.comment.length?w=h.gzhead.comment.charCodeAt(h.gzindex++)&255:w=0,J(h,w)}while(w!==0);h.gzhead.hcrc&&h.pending>b&&(o.adler=n(o.adler,h.pending_buf,h.pending-b,b)),w===0&&(h.status=Te)}else h.status=Te;if(h.status===Te&&(h.gzhead.hcrc?(h.pending+2>h.pending_buf_size&&Le(o),h.pending+2<=h.pending_buf_size&&(J(h,o.adler&255),J(h,o.adler>>8&255),o.adler=0,h.status=ae)):h.status=ae),h.pending!==0){if(Le(o),o.avail_out===0)return h.last_flush=-1,d}else if(o.avail_in===0&&pt(A)<=pt(I)&&A!==c)return Oe(o,y);if(h.status===ge&&o.avail_in!==0)return Oe(o,y);if(o.avail_in!==0||h.lookahead!==0||A!==i&&h.status!==ge){var B=h.strategy===E?lt(h,A):h.strategy===D?wt(h,A):qe[h.level].func(h,A);if((B===$e||B===He)&&(h.status=ge),B===oe||B===$e)return o.avail_out===0&&(h.last_flush=-1),d;if(B===Ie&&(A===s?e._tr_align(h):A!==u&&(e._tr_stored_block(h,0,0,!1),A===a&&(je(h.head),h.lookahead===0&&(h.strstart=0,h.block_start=0,h.insert=0))),Le(o),o.avail_out===0))return h.last_flush=-1,d}return A!==c?d:h.wrap<=0?p:(h.wrap===2?(J(h,o.adler&255),J(h,o.adler>>8&255),J(h,o.adler>>16&255),J(h,o.adler>>24&255),J(h,o.total_in&255),J(h,o.total_in>>8&255),J(h,o.total_in>>16&255),J(h,o.total_in>>24&255)):(Ze(h,o.adler>>>16),Ze(h,o.adler&65535)),Le(o),h.wrap>0&&(h.wrap=-h.wrap),h.pending!==0?d:p)}function N(o){var A;return!o||!o.state?g:(A=o.state.status,A!==Re&&A!==Ae&&A!==me&&A!==ke&&A!==Te&&A!==ae&&A!==ge?Oe(o,g):(o.state=null,A===ae?Oe(o,v):d))}function V(o,A){var I=A.length,h,b,w,H,P,B,ee,nt;if(!o||!o.state||(h=o.state,H=h.wrap,H===2||H===1&&h.status!==Re||h.lookahead))return g;for(H===1&&(o.adler=t(o.adler,A,I,0)),h.wrap=0,I>=h.w_size&&(H===0&&(je(h.head),h.strstart=0,h.block_start=0,h.insert=0),nt=new l.Buf8(h.w_size),l.arraySet(nt,A,I-h.w_size,h.w_size,0),A=nt,I=h.w_size),P=o.avail_in,B=o.next_in,ee=o.input,o.avail_in=I,o.next_in=0,o.input=A,Ve(h);h.lookahead>=W;){b=h.strstart,w=h.lookahead-(W-1);do h.ins_h=(h.ins_h<<h.hash_shift^h.window[b+W-1])&h.hash_mask,h.prev[b&h.w_mask]=h.head[h.ins_h],h.head[h.ins_h]=b,b++;while(--w);h.strstart=b,h.lookahead=W-1,Ve(h)}return h.strstart+=h.lookahead,h.block_start=h.strstart,h.insert=h.lookahead,h.lookahead=0,h.match_length=h.prev_length=W-1,h.match_available=0,o.next_in=B,o.input=ee,o.avail_in=P,h.wrap=H,d}return Xe.deflateInit=C,Xe.deflateInit2=x,Xe.deflateReset=L,Xe.deflateResetKeep=z,Xe.deflateSetHeader=U,Xe.deflate=f,Xe.deflateEnd=N,Xe.deflateSetDictionary=V,Xe.deflateInfo="pako deflate (from Nodeca project)",Xe}var gt={},Un;function lr(){if(Un)return gt;Un=1;var l=ht(),e=!0,t=!0;try{String.fromCharCode.apply(null,[0])}catch{e=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{t=!1}for(var n=new l.Buf8(256),r=0;r<256;r++)n[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;n[254]=n[254]=1,gt.string2buf=function(s){var a,c,u,d,p,g=s.length,v=0;for(d=0;d<g;d++)c=s.charCodeAt(d),(c&64512)===55296&&d+1<g&&(u=s.charCodeAt(d+1),(u&64512)===56320&&(c=65536+(c-55296<<10)+(u-56320),d++)),v+=c<128?1:c<2048?2:c<65536?3:4;for(a=new l.Buf8(v),p=0,d=0;p<v;d++)c=s.charCodeAt(d),(c&64512)===55296&&d+1<g&&(u=s.charCodeAt(d+1),(u&64512)===56320&&(c=65536+(c-55296<<10)+(u-56320),d++)),c<128?a[p++]=c:c<2048?(a[p++]=192|c>>>6,a[p++]=128|c&63):c<65536?(a[p++]=224|c>>>12,a[p++]=128|c>>>6&63,a[p++]=128|c&63):(a[p++]=240|c>>>18,a[p++]=128|c>>>12&63,a[p++]=128|c>>>6&63,a[p++]=128|c&63);return a};function i(s,a){if(a<65534&&(s.subarray&&t||!s.subarray&&e))return String.fromCharCode.apply(null,l.shrinkBuf(s,a));for(var c="",u=0;u<a;u++)c+=String.fromCharCode(s[u]);return c}return gt.buf2binstring=function(s){return i(s,s.length)},gt.binstring2buf=function(s){for(var a=new l.Buf8(s.length),c=0,u=a.length;c<u;c++)a[c]=s.charCodeAt(c);return a},gt.buf2string=function(s,a){var c,u,d,p,g=a||s.length,v=new Array(g*2);for(u=0,c=0;c<g;){if(d=s[c++],d<128){v[u++]=d;continue}if(p=n[d],p>4){v[u++]=65533,c+=p-1;continue}for(d&=p===2?31:p===3?15:7;p>1&&c<g;)d=d<<6|s[c++]&63,p--;if(p>1){v[u++]=65533;continue}d<65536?v[u++]=d:(d-=65536,v[u++]=55296|d>>10&1023,v[u++]=56320|d&1023)}return i(v,u)},gt.utf8border=function(s,a){var c;for(a=a||s.length,a>s.length&&(a=s.length),c=a-1;c>=0&&(s[c]&192)===128;)c--;return c<0||c===0?a:c+n[s[c]]>a?c:a},gt}var cn,Gn;function ur(){if(Gn)return cn;Gn=1;function l(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}return cn=l,cn}var $n;function hi(){if($n)return At;$n=1;var l=di(),e=ht(),t=lr(),n=An(),r=ur(),i=Object.prototype.toString,s=0,a=4,c=0,u=1,d=2,p=-1,g=0,v=8;function y(D){if(!(this instanceof y))return new y(D);this.options=e.assign({level:p,method:v,chunkSize:16384,windowBits:15,memLevel:8,strategy:g,to:""},D||{});var T=this.options;T.raw&&T.windowBits>0?T.windowBits=-T.windowBits:T.gzip&&T.windowBits>0&&T.windowBits<16&&(T.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new r,this.strm.avail_out=0;var M=l.deflateInit2(this.strm,T.level,T.method,T.windowBits,T.memLevel,T.strategy);if(M!==c)throw new Error(n[M]);if(T.header&&l.deflateSetHeader(this.strm,T.header),T.dictionary){var R;if(typeof T.dictionary=="string"?R=t.string2buf(T.dictionary):i.call(T.dictionary)==="[object ArrayBuffer]"?R=new Uint8Array(T.dictionary):R=T.dictionary,M=l.deflateSetDictionary(this.strm,R),M!==c)throw new Error(n[M]);this._dict_set=!0}}y.prototype.push=function(D,T){var M=this.strm,R=this.options.chunkSize,O,F;if(this.ended)return!1;F=T===~~T?T:T===!0?a:s,typeof D=="string"?M.input=t.string2buf(D):i.call(D)==="[object ArrayBuffer]"?M.input=new Uint8Array(D):M.input=D,M.next_in=0,M.avail_in=M.input.length;do{if(M.avail_out===0&&(M.output=new e.Buf8(R),M.next_out=0,M.avail_out=R),O=l.deflate(M,F),O!==u&&O!==c)return this.onEnd(O),this.ended=!0,!1;(M.avail_out===0||M.avail_in===0&&(F===a||F===d))&&(this.options.to==="string"?this.onData(t.buf2binstring(e.shrinkBuf(M.output,M.next_out))):this.onData(e.shrinkBuf(M.output,M.next_out)))}while((M.avail_in>0||M.avail_out===0)&&O!==u);return F===a?(O=l.deflateEnd(this.strm),this.onEnd(O),this.ended=!0,O===c):(F===d&&(this.onEnd(c),M.avail_out=0),!0)},y.prototype.onData=function(D){this.chunks.push(D)},y.prototype.onEnd=function(D){D===c&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=e.flattenChunks(this.chunks)),this.chunks=[],this.err=D,this.msg=this.strm.msg};function S(D,T){var M=new y(T);if(M.push(D,!0),M.err)throw M.msg||n[M.err];return M.result}function _(D,T){return T=T||{},T.raw=!0,S(D,T)}function E(D,T){return T=T||{},T.gzip=!0,S(D,T)}return At.Deflate=y,At.deflate=S,At.deflateRaw=_,At.gzip=E,At}var Et={},Ye={},ln,Hn;function pi(){if(Hn)return ln;Hn=1;var l=30,e=12;return ln=function(n,r){var i,s,a,c,u,d,p,g,v,y,S,_,E,D,T,M,R,O,F,G,Z,$,ie,ne,j;i=n.state,s=n.next_in,ne=n.input,a=s+(n.avail_in-5),c=n.next_out,j=n.output,u=c-(r-n.avail_out),d=c+(n.avail_out-257),p=i.dmax,g=i.wsize,v=i.whave,y=i.wnext,S=i.window,_=i.hold,E=i.bits,D=i.lencode,T=i.distcode,M=(1<<i.lenbits)-1,R=(1<<i.distbits)-1;e:do{E<15&&(_+=ne[s++]<<E,E+=8,_+=ne[s++]<<E,E+=8),O=D[_&M];t:for(;;){if(F=O>>>24,_>>>=F,E-=F,F=O>>>16&255,F===0)j[c++]=O&65535;else if(F&16){G=O&65535,F&=15,F&&(E<F&&(_+=ne[s++]<<E,E+=8),G+=_&(1<<F)-1,_>>>=F,E-=F),E<15&&(_+=ne[s++]<<E,E+=8,_+=ne[s++]<<E,E+=8),O=T[_&R];n:for(;;){if(F=O>>>24,_>>>=F,E-=F,F=O>>>16&255,F&16){if(Z=O&65535,F&=15,E<F&&(_+=ne[s++]<<E,E+=8,E<F&&(_+=ne[s++]<<E,E+=8)),Z+=_&(1<<F)-1,Z>p){n.msg="invalid distance too far back",i.mode=l;break e}if(_>>>=F,E-=F,F=c-u,Z>F){if(F=Z-F,F>v&&i.sane){n.msg="invalid distance too far back",i.mode=l;break e}if($=0,ie=S,y===0){if($+=g-F,F<G){G-=F;do j[c++]=S[$++];while(--F);$=c-Z,ie=j}}else if(y<F){if($+=g+y-F,F-=y,F<G){G-=F;do j[c++]=S[$++];while(--F);if($=0,y<G){F=y,G-=F;do j[c++]=S[$++];while(--F);$=c-Z,ie=j}}}else if($+=y-F,F<G){G-=F;do j[c++]=S[$++];while(--F);$=c-Z,ie=j}for(;G>2;)j[c++]=ie[$++],j[c++]=ie[$++],j[c++]=ie[$++],G-=3;G&&(j[c++]=ie[$++],G>1&&(j[c++]=ie[$++]))}else{$=c-Z;do j[c++]=j[$++],j[c++]=j[$++],j[c++]=j[$++],G-=3;while(G>2);G&&(j[c++]=j[$++],G>1&&(j[c++]=j[$++]))}}else if((F&64)===0){O=T[(O&65535)+(_&(1<<F)-1)];continue n}else{n.msg="invalid distance code",i.mode=l;break e}break}}else if((F&64)===0){O=D[(O&65535)+(_&(1<<F)-1)];continue t}else if(F&32){i.mode=e;break e}else{n.msg="invalid literal/length code",i.mode=l;break e}break}}while(s<a&&c<d);G=E>>3,s-=G,E-=G<<3,_&=(1<<E)-1,n.next_in=s,n.next_out=c,n.avail_in=s<a?5+(a-s):5-(s-a),n.avail_out=c<d?257+(d-c):257-(c-d),i.hold=_,i.bits=E},ln}var un,jn;function mi(){if(jn)return un;jn=1;var l=ht(),e=15,t=852,n=592,r=0,i=1,s=2,a=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],c=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],u=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],d=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];return un=function(g,v,y,S,_,E,D,T){var M=T.bits,R=0,O=0,F=0,G=0,Z=0,$=0,ie=0,ne=0,j=0,K=0,pe,de,W,ye,fe,Ge=null,Re=0,Ae,me=new l.Buf16(e+1),ke=new l.Buf16(e+1),Te=null,ae=0,ge,oe,Ie;for(R=0;R<=e;R++)me[R]=0;for(O=0;O<S;O++)me[v[y+O]]++;for(Z=M,G=e;G>=1&&me[G]===0;G--);if(Z>G&&(Z=G),G===0)return _[E++]=1<<24|64<<16|0,_[E++]=1<<24|64<<16|0,T.bits=1,0;for(F=1;F<G&&me[F]===0;F++);for(Z<F&&(Z=F),ne=1,R=1;R<=e;R++)if(ne<<=1,ne-=me[R],ne<0)return-1;if(ne>0&&(g===r||G!==1))return-1;for(ke[1]=0,R=1;R<e;R++)ke[R+1]=ke[R]+me[R];for(O=0;O<S;O++)v[y+O]!==0&&(D[ke[v[y+O]]++]=O);if(g===r?(Ge=Te=D,Ae=19):g===i?(Ge=a,Re-=257,Te=c,ae-=257,Ae=256):(Ge=u,Te=d,Ae=-1),K=0,O=0,R=F,fe=E,$=Z,ie=0,W=-1,j=1<<Z,ye=j-1,g===i&&j>t||g===s&&j>n)return 1;for(;;){ge=R-ie,D[O]<Ae?(oe=0,Ie=D[O]):D[O]>Ae?(oe=Te[ae+D[O]],Ie=Ge[Re+D[O]]):(oe=96,Ie=0),pe=1<<R-ie,de=1<<$,F=de;do de-=pe,_[fe+(K>>ie)+de]=ge<<24|oe<<16|Ie|0;while(de!==0);for(pe=1<<R-1;K&pe;)pe>>=1;if(pe!==0?(K&=pe-1,K+=pe):K=0,O++,--me[R]===0){if(R===G)break;R=v[y+D[O]]}if(R>Z&&(K&ye)!==W){for(ie===0&&(ie=Z),fe+=F,$=R-ie,ne=1<<$;$+ie<G&&(ne-=me[$+ie],!(ne<=0));)$++,ne<<=1;if(j+=1<<$,g===i&&j>t||g===s&&j>n)return 1;W=K&ye,_[W]=Z<<24|$<<16|fe-E|0}}return K!==0&&(_[fe+K]=R-ie<<24|64<<16|0),T.bits=Z,0},un}var Zn;function gi(){if(Zn)return Ye;Zn=1;var l=ht(),e=ar(),t=cr(),n=pi(),r=mi(),i=0,s=1,a=2,c=4,u=5,d=6,p=0,g=1,v=2,y=-2,S=-3,_=-4,E=-5,D=8,T=1,M=2,R=3,O=4,F=5,G=6,Z=7,$=8,ie=9,ne=10,j=11,K=12,pe=13,de=14,W=15,ye=16,fe=17,Ge=18,Re=19,Ae=20,me=21,ke=22,Te=23,ae=24,ge=25,oe=26,Ie=27,$e=28,He=29,ce=30,Oe=31,pt=32,je=852,Le=592,he=15,J=he;function Ze(x){return(x>>>24&255)+(x>>>8&65280)+((x&65280)<<8)+((x&255)<<24)}function xt(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new l.Buf16(320),this.work=new l.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function at(x){var C;return!x||!x.state?y:(C=x.state,x.total_in=x.total_out=C.total=0,x.msg="",C.wrap&&(x.adler=C.wrap&1),C.mode=T,C.last=0,C.havedict=0,C.dmax=32768,C.head=null,C.hold=0,C.bits=0,C.lencode=C.lendyn=new l.Buf32(je),C.distcode=C.distdyn=new l.Buf32(Le),C.sane=1,C.back=-1,p)}function Ve(x){var C;return!x||!x.state?y:(C=x.state,C.wsize=0,C.whave=0,C.wnext=0,at(x))}function _t(x,C){var f,N;return!x||!x.state||(N=x.state,C<0?(f=0,C=-C):(f=(C>>4)+1,C<48&&(C&=15)),C&&(C<8||C>15))?y:(N.window!==null&&N.wbits!==C&&(N.window=null),N.wrap=f,N.wbits=C,Ve(x))}function ct(x,C){var f,N;return x?(N=new xt,x.state=N,N.window=null,f=_t(x,C),f!==p&&(x.state=null),f):y}function Ke(x){return ct(x,J)}var wt=!0,lt,Se;function qe(x){if(wt){var C;for(lt=new l.Buf32(512),Se=new l.Buf32(32),C=0;C<144;)x.lens[C++]=8;for(;C<256;)x.lens[C++]=9;for(;C<280;)x.lens[C++]=7;for(;C<288;)x.lens[C++]=8;for(r(s,x.lens,0,288,lt,0,x.work,{bits:9}),C=0;C<32;)x.lens[C++]=5;r(a,x.lens,0,32,Se,0,x.work,{bits:5}),wt=!1}x.lencode=lt,x.lenbits=9,x.distcode=Se,x.distbits=5}function Tt(x,C,f,N){var V,o=x.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new l.Buf8(o.wsize)),N>=o.wsize?(l.arraySet(o.window,C,f-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):(V=o.wsize-o.wnext,V>N&&(V=N),l.arraySet(o.window,C,f-N,V,o.wnext),N-=V,N?(l.arraySet(o.window,C,f-N,N,0),o.wnext=N,o.whave=o.wsize):(o.wnext+=V,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=V))),0}function m(x,C){var f,N,V,o,A,I,h,b,w,H,P,B,ee,nt,ve=0,re,we,Ce,ze,Pt,Bt,be,We,Ee=new l.Buf8(4),rt,Je,Cn=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!x||!x.state||!x.output||!x.input&&x.avail_in!==0)return y;f=x.state,f.mode===K&&(f.mode=pe),A=x.next_out,V=x.output,h=x.avail_out,o=x.next_in,N=x.input,I=x.avail_in,b=f.hold,w=f.bits,H=I,P=h,We=p;e:for(;;)switch(f.mode){case T:if(f.wrap===0){f.mode=pe;break}for(;w<16;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(f.wrap&2&&b===35615){f.check=0,Ee[0]=b&255,Ee[1]=b>>>8&255,f.check=t(f.check,Ee,2,0),b=0,w=0,f.mode=M;break}if(f.flags=0,f.head&&(f.head.done=!1),!(f.wrap&1)||(((b&255)<<8)+(b>>8))%31){x.msg="incorrect header check",f.mode=ce;break}if((b&15)!==D){x.msg="unknown compression method",f.mode=ce;break}if(b>>>=4,w-=4,be=(b&15)+8,f.wbits===0)f.wbits=be;else if(be>f.wbits){x.msg="invalid window size",f.mode=ce;break}f.dmax=1<<be,x.adler=f.check=1,f.mode=b&512?ne:K,b=0,w=0;break;case M:for(;w<16;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(f.flags=b,(f.flags&255)!==D){x.msg="unknown compression method",f.mode=ce;break}if(f.flags&57344){x.msg="unknown header flags set",f.mode=ce;break}f.head&&(f.head.text=b>>8&1),f.flags&512&&(Ee[0]=b&255,Ee[1]=b>>>8&255,f.check=t(f.check,Ee,2,0)),b=0,w=0,f.mode=R;case R:for(;w<32;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}f.head&&(f.head.time=b),f.flags&512&&(Ee[0]=b&255,Ee[1]=b>>>8&255,Ee[2]=b>>>16&255,Ee[3]=b>>>24&255,f.check=t(f.check,Ee,4,0)),b=0,w=0,f.mode=O;case O:for(;w<16;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}f.head&&(f.head.xflags=b&255,f.head.os=b>>8),f.flags&512&&(Ee[0]=b&255,Ee[1]=b>>>8&255,f.check=t(f.check,Ee,2,0)),b=0,w=0,f.mode=F;case F:if(f.flags&1024){for(;w<16;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}f.length=b,f.head&&(f.head.extra_len=b),f.flags&512&&(Ee[0]=b&255,Ee[1]=b>>>8&255,f.check=t(f.check,Ee,2,0)),b=0,w=0}else f.head&&(f.head.extra=null);f.mode=G;case G:if(f.flags&1024&&(B=f.length,B>I&&(B=I),B&&(f.head&&(be=f.head.extra_len-f.length,f.head.extra||(f.head.extra=new Array(f.head.extra_len)),l.arraySet(f.head.extra,N,o,B,be)),f.flags&512&&(f.check=t(f.check,N,B,o)),I-=B,o+=B,f.length-=B),f.length))break e;f.length=0,f.mode=Z;case Z:if(f.flags&2048){if(I===0)break e;B=0;do be=N[o+B++],f.head&&be&&f.length<65536&&(f.head.name+=String.fromCharCode(be));while(be&&B<I);if(f.flags&512&&(f.check=t(f.check,N,B,o)),I-=B,o+=B,be)break e}else f.head&&(f.head.name=null);f.length=0,f.mode=$;case $:if(f.flags&4096){if(I===0)break e;B=0;do be=N[o+B++],f.head&&be&&f.length<65536&&(f.head.comment+=String.fromCharCode(be));while(be&&B<I);if(f.flags&512&&(f.check=t(f.check,N,B,o)),I-=B,o+=B,be)break e}else f.head&&(f.head.comment=null);f.mode=ie;case ie:if(f.flags&512){for(;w<16;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(b!==(f.check&65535)){x.msg="header crc mismatch",f.mode=ce;break}b=0,w=0}f.head&&(f.head.hcrc=f.flags>>9&1,f.head.done=!0),x.adler=f.check=0,f.mode=K;break;case ne:for(;w<32;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}x.adler=f.check=Ze(b),b=0,w=0,f.mode=j;case j:if(f.havedict===0)return x.next_out=A,x.avail_out=h,x.next_in=o,x.avail_in=I,f.hold=b,f.bits=w,v;x.adler=f.check=1,f.mode=K;case K:if(C===u||C===d)break e;case pe:if(f.last){b>>>=w&7,w-=w&7,f.mode=Ie;break}for(;w<3;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}switch(f.last=b&1,b>>>=1,w-=1,b&3){case 0:f.mode=de;break;case 1:if(qe(f),f.mode=Ae,C===d){b>>>=2,w-=2;break e}break;case 2:f.mode=fe;break;case 3:x.msg="invalid block type",f.mode=ce}b>>>=2,w-=2;break;case de:for(b>>>=w&7,w-=w&7;w<32;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if((b&65535)!==(b>>>16^65535)){x.msg="invalid stored block lengths",f.mode=ce;break}if(f.length=b&65535,b=0,w=0,f.mode=W,C===d)break e;case W:f.mode=ye;case ye:if(B=f.length,B){if(B>I&&(B=I),B>h&&(B=h),B===0)break e;l.arraySet(V,N,o,B,A),I-=B,o+=B,h-=B,A+=B,f.length-=B;break}f.mode=K;break;case fe:for(;w<14;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(f.nlen=(b&31)+257,b>>>=5,w-=5,f.ndist=(b&31)+1,b>>>=5,w-=5,f.ncode=(b&15)+4,b>>>=4,w-=4,f.nlen>286||f.ndist>30){x.msg="too many length or distance symbols",f.mode=ce;break}f.have=0,f.mode=Ge;case Ge:for(;f.have<f.ncode;){for(;w<3;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}f.lens[Cn[f.have++]]=b&7,b>>>=3,w-=3}for(;f.have<19;)f.lens[Cn[f.have++]]=0;if(f.lencode=f.lendyn,f.lenbits=7,rt={bits:f.lenbits},We=r(i,f.lens,0,19,f.lencode,0,f.work,rt),f.lenbits=rt.bits,We){x.msg="invalid code lengths set",f.mode=ce;break}f.have=0,f.mode=Re;case Re:for(;f.have<f.nlen+f.ndist;){for(;ve=f.lencode[b&(1<<f.lenbits)-1],re=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(re<=w);){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(Ce<16)b>>>=re,w-=re,f.lens[f.have++]=Ce;else{if(Ce===16){for(Je=re+2;w<Je;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(b>>>=re,w-=re,f.have===0){x.msg="invalid bit length repeat",f.mode=ce;break}be=f.lens[f.have-1],B=3+(b&3),b>>>=2,w-=2}else if(Ce===17){for(Je=re+3;w<Je;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}b>>>=re,w-=re,be=0,B=3+(b&7),b>>>=3,w-=3}else{for(Je=re+7;w<Je;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}b>>>=re,w-=re,be=0,B=11+(b&127),b>>>=7,w-=7}if(f.have+B>f.nlen+f.ndist){x.msg="invalid bit length repeat",f.mode=ce;break}for(;B--;)f.lens[f.have++]=be}}if(f.mode===ce)break;if(f.lens[256]===0){x.msg="invalid code -- missing end-of-block",f.mode=ce;break}if(f.lenbits=9,rt={bits:f.lenbits},We=r(s,f.lens,0,f.nlen,f.lencode,0,f.work,rt),f.lenbits=rt.bits,We){x.msg="invalid literal/lengths set",f.mode=ce;break}if(f.distbits=6,f.distcode=f.distdyn,rt={bits:f.distbits},We=r(a,f.lens,f.nlen,f.ndist,f.distcode,0,f.work,rt),f.distbits=rt.bits,We){x.msg="invalid distances set",f.mode=ce;break}if(f.mode=Ae,C===d)break e;case Ae:f.mode=me;case me:if(I>=6&&h>=258){x.next_out=A,x.avail_out=h,x.next_in=o,x.avail_in=I,f.hold=b,f.bits=w,n(x,P),A=x.next_out,V=x.output,h=x.avail_out,o=x.next_in,N=x.input,I=x.avail_in,b=f.hold,w=f.bits,f.mode===K&&(f.back=-1);break}for(f.back=0;ve=f.lencode[b&(1<<f.lenbits)-1],re=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(re<=w);){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(we&&(we&240)===0){for(ze=re,Pt=we,Bt=Ce;ve=f.lencode[Bt+((b&(1<<ze+Pt)-1)>>ze)],re=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(ze+re<=w);){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}b>>>=ze,w-=ze,f.back+=ze}if(b>>>=re,w-=re,f.back+=re,f.length=Ce,we===0){f.mode=oe;break}if(we&32){f.back=-1,f.mode=K;break}if(we&64){x.msg="invalid literal/length code",f.mode=ce;break}f.extra=we&15,f.mode=ke;case ke:if(f.extra){for(Je=f.extra;w<Je;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}f.length+=b&(1<<f.extra)-1,b>>>=f.extra,w-=f.extra,f.back+=f.extra}f.was=f.length,f.mode=Te;case Te:for(;ve=f.distcode[b&(1<<f.distbits)-1],re=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(re<=w);){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if((we&240)===0){for(ze=re,Pt=we,Bt=Ce;ve=f.distcode[Bt+((b&(1<<ze+Pt)-1)>>ze)],re=ve>>>24,we=ve>>>16&255,Ce=ve&65535,!(ze+re<=w);){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}b>>>=ze,w-=ze,f.back+=ze}if(b>>>=re,w-=re,f.back+=re,we&64){x.msg="invalid distance code",f.mode=ce;break}f.offset=Ce,f.extra=we&15,f.mode=ae;case ae:if(f.extra){for(Je=f.extra;w<Je;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}f.offset+=b&(1<<f.extra)-1,b>>>=f.extra,w-=f.extra,f.back+=f.extra}if(f.offset>f.dmax){x.msg="invalid distance too far back",f.mode=ce;break}f.mode=ge;case ge:if(h===0)break e;if(B=P-h,f.offset>B){if(B=f.offset-B,B>f.whave&&f.sane){x.msg="invalid distance too far back",f.mode=ce;break}B>f.wnext?(B-=f.wnext,ee=f.wsize-B):ee=f.wnext-B,B>f.length&&(B=f.length),nt=f.window}else nt=V,ee=A-f.offset,B=f.length;B>h&&(B=h),h-=B,f.length-=B;do V[A++]=nt[ee++];while(--B);f.length===0&&(f.mode=me);break;case oe:if(h===0)break e;V[A++]=f.length,h--,f.mode=me;break;case Ie:if(f.wrap){for(;w<32;){if(I===0)break e;I--,b|=N[o++]<<w,w+=8}if(P-=h,x.total_out+=P,f.total+=P,P&&(x.adler=f.check=f.flags?t(f.check,V,P,A-P):e(f.check,V,P,A-P)),P=h,(f.flags?b:Ze(b))!==f.check){x.msg="incorrect data check",f.mode=ce;break}b=0,w=0}f.mode=$e;case $e:if(f.wrap&&f.flags){for(;w<32;){if(I===0)break e;I--,b+=N[o++]<<w,w+=8}if(b!==(f.total&4294967295)){x.msg="incorrect length check",f.mode=ce;break}b=0,w=0}f.mode=He;case He:We=g;break e;case ce:We=S;break e;case Oe:return _;case pt:default:return y}return x.next_out=A,x.avail_out=h,x.next_in=o,x.avail_in=I,f.hold=b,f.bits=w,(f.wsize||P!==x.avail_out&&f.mode<ce&&(f.mode<Ie||C!==c))&&Tt(x,x.output,x.next_out,P-x.avail_out),H-=x.avail_in,P-=x.avail_out,x.total_in+=H,x.total_out+=P,f.total+=P,f.wrap&&P&&(x.adler=f.check=f.flags?t(f.check,V,P,x.next_out-P):e(f.check,V,P,x.next_out-P)),x.data_type=f.bits+(f.last?64:0)+(f.mode===K?128:0)+(f.mode===Ae||f.mode===W?256:0),(H===0&&P===0||C===c)&&We===p&&(We=E),We}function z(x){if(!x||!x.state)return y;var C=x.state;return C.window&&(C.window=null),x.state=null,p}function L(x,C){var f;return!x||!x.state||(f=x.state,(f.wrap&2)===0)?y:(f.head=C,C.done=!1,p)}function U(x,C){var f=C.length,N,V,o;return!x||!x.state||(N=x.state,N.wrap!==0&&N.mode!==j)?y:N.mode===j&&(V=1,V=e(V,C,f,0),V!==N.check)?S:(o=Tt(x,C,f,f),o?(N.mode=Oe,_):(N.havedict=1,p))}return Ye.inflateReset=Ve,Ye.inflateReset2=_t,Ye.inflateResetKeep=at,Ye.inflateInit=Ke,Ye.inflateInit2=ct,Ye.inflate=m,Ye.inflateEnd=z,Ye.inflateGetHeader=L,Ye.inflateSetDictionary=U,Ye.inflateInfo="pako inflate (from Nodeca project)",Ye}var fn,Vn;function fr(){return Vn||(Vn=1,fn={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}),fn}var dn,Wn;function vi(){if(Wn)return dn;Wn=1;function l(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}return dn=l,dn}var Yn;function yi(){if(Yn)return Et;Yn=1;var l=gi(),e=ht(),t=lr(),n=fr(),r=An(),i=ur(),s=vi(),a=Object.prototype.toString;function c(p){if(!(this instanceof c))return new c(p);this.options=e.assign({chunkSize:16384,windowBits:0,to:""},p||{});var g=this.options;g.raw&&g.windowBits>=0&&g.windowBits<16&&(g.windowBits=-g.windowBits,g.windowBits===0&&(g.windowBits=-15)),g.windowBits>=0&&g.windowBits<16&&!(p&&p.windowBits)&&(g.windowBits+=32),g.windowBits>15&&g.windowBits<48&&(g.windowBits&15)===0&&(g.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new i,this.strm.avail_out=0;var v=l.inflateInit2(this.strm,g.windowBits);if(v!==n.Z_OK)throw new Error(r[v]);if(this.header=new s,l.inflateGetHeader(this.strm,this.header),g.dictionary&&(typeof g.dictionary=="string"?g.dictionary=t.string2buf(g.dictionary):a.call(g.dictionary)==="[object ArrayBuffer]"&&(g.dictionary=new Uint8Array(g.dictionary)),g.raw&&(v=l.inflateSetDictionary(this.strm,g.dictionary),v!==n.Z_OK)))throw new Error(r[v])}c.prototype.push=function(p,g){var v=this.strm,y=this.options.chunkSize,S=this.options.dictionary,_,E,D,T,M,R=!1;if(this.ended)return!1;E=g===~~g?g:g===!0?n.Z_FINISH:n.Z_NO_FLUSH,typeof p=="string"?v.input=t.binstring2buf(p):a.call(p)==="[object ArrayBuffer]"?v.input=new Uint8Array(p):v.input=p,v.next_in=0,v.avail_in=v.input.length;do{if(v.avail_out===0&&(v.output=new e.Buf8(y),v.next_out=0,v.avail_out=y),_=l.inflate(v,n.Z_NO_FLUSH),_===n.Z_NEED_DICT&&S&&(_=l.inflateSetDictionary(this.strm,S)),_===n.Z_BUF_ERROR&&R===!0&&(_=n.Z_OK,R=!1),_!==n.Z_STREAM_END&&_!==n.Z_OK)return this.onEnd(_),this.ended=!0,!1;v.next_out&&(v.avail_out===0||_===n.Z_STREAM_END||v.avail_in===0&&(E===n.Z_FINISH||E===n.Z_SYNC_FLUSH))&&(this.options.to==="string"?(D=t.utf8border(v.output,v.next_out),T=v.next_out-D,M=t.buf2string(v.output,D),v.next_out=T,v.avail_out=y-T,T&&e.arraySet(v.output,v.output,D,T,0),this.onData(M)):this.onData(e.shrinkBuf(v.output,v.next_out))),v.avail_in===0&&v.avail_out===0&&(R=!0)}while((v.avail_in>0||v.avail_out===0)&&_!==n.Z_STREAM_END);return _===n.Z_STREAM_END&&(E=n.Z_FINISH),E===n.Z_FINISH?(_=l.inflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===n.Z_OK):(E===n.Z_SYNC_FLUSH&&(this.onEnd(n.Z_OK),v.avail_out=0),!0)},c.prototype.onData=function(p){this.chunks.push(p)},c.prototype.onEnd=function(p){p===n.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=e.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg};function u(p,g){var v=new c(g);if(v.push(p,!0),v.err)throw v.msg||r[v.err];return v.result}function d(p,g){return g=g||{},g.raw=!0,u(p,g)}return Et.Inflate=c,Et.inflate=u,Et.inflateRaw=d,Et.ungzip=u,Et}var hn,Kn;function bi(){if(Kn)return hn;Kn=1;var l=ht().assign,e=hi(),t=yi(),n=fr(),r={};return l(r,e,t,n),hn=r,hn}var xi=bi();class _i{convert(e,t){const n=new St({originalFormat:"fc3",originalFileName:t,author:"AFMG EASE",comments:"Converted from EASE Focus format"});n.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const r=Nt("fc3"),i=this.extractEaseData(e);if(!i)throw new Error("Failed to extract EASE data from FC3 file");const s={x:parseFloat(i.Project?.Origin?.X||"0"),y:parseFloat(i.Project?.Origin?.Y||"0")},a=i.Project?.AudienceZoneManager;if(!a)throw new Error("No audience zone manager found in FC3 file");for(const[c,u]of Object.entries(a))if(c.slice(0,5)==="Zone["){const d=u,p=d.Label||c;n.beginGroup(p);const g=new k(parseFloat(d.X)-s.x,parseFloat(d.Y)-s.y,0);n.translate(g.x,g.y,g.z),d.Orientation&&n.rotate(0,0,et(parseFloat(d.Orientation)));for(const[v,y]of Object.entries(d))if(v.slice(0,5)==="Area["){const S=y;this.processZoneArea(d,S,n,r,p)}n.endGroup()}return n.build()}extractEaseData(e){try{const t=new Uint8Array(e),n=[31,139],r=this.findOffset(t,n);if(r===-1)throw new Error("GZIP signature not found in FC3 file");const i=xi.ungzip(t.slice(r),{to:"string"}),s=new DOMParser().parseFromString(i,"application/xml"),a=s.getElementsByTagName("Keys")[0],c=s.getElementsByTagName("Values")[0];if(!a||!c)throw new Error("Invalid FC3 file structure");const u=a.getAttribute("href")?.slice(1),d=c.getAttribute("href")?.slice(1);if(!u||!d)throw new Error("Missing keys or values reference in FC3 file");const p=[],g=s.getElementById(u);if(g)for(const _ of g.children)p.push(_.innerHTML);const v=[],y=s.getElementById(d);if(y)for(const _ of y.children)v.push(_.innerHTML);const S={};for(let _=0;_<p.length;_++)this.createObjects(S,p[_].split("."),v[_]);return S}catch(t){return console.error("Error extracting EASE data:",t),null}}createObjects(e,t,n){return t.length===1?(e[t[0]]=n,e):(e[t[0]]=e[t[0]]||{},this.createObjects(e[t[0]],t.slice(1),n))}processZoneArea(e,t,n,r,i){(!e.Type||e.Type==="")&&(e.Width!==void 0&&(e.Type="Rectangle"),e.Radius!==void 0&&(e.Type="Arc"),e.FrontEdge!==void 0&&(e.Type="Trapezoid"),e.RightAngleLeft!==void 0&&(e.Type="Right Trapezoid"));const s=t.Label||"Area",a=r.getMaterialForObject(`${e.Type} ${s}`,void 0,i,"listen");switch(e.Type){case"Annulus":case"Arc":this.createArcGeometry(e,t,n,s,a);break;case"Right Trapezoid":this.createRightTrapezoid(e,t,n,s,a);break;case"Trapezoid":this.createTrapezoid(e,t,n,s,a);break;case"Rectangle":this.createRectangle(e,t,n,s,a);break;default:console.warn(`Unknown EASE zone type: ${e.Type}`)}}createArcGeometry(e,t,n,r,i){const s=(parseFloat(e.InnerRadius||"0")||0)+parseFloat(t.D1),a=(parseFloat(e.InnerRadius||"0")||0)+parseFloat(t.D2),c=parseFloat(e.SweepAngle||"360"),u=360-c/2,d=u+c,p=[new k(a,0,parseFloat(t.Z2)),new k(s,0,parseFloat(t.Z1))];n.addRevolution(p,{name:r,material:i,startAngle:et(u),endAngle:et(d),segments:Math.max(8,Math.ceil(c/10)),closed:c>=360,axis:new k(0,0,1),surfaceType:"listen"})}createRightTrapezoid(e,t,n,r,i){const s=e.RightAngleLeft||0,a=parseFloat(t.D1),c=parseFloat(t.D2),u=parseFloat(e.FrontEdge?.toString()||"0"),d=parseFloat(e.BackEdge?.toString()||"0"),p=e.Depth||0,g=(d-u)/p,v=new k(-p/2+a,u+a*g,parseFloat(t.Z1)),y=new k(-p/2+c,u+c*g,parseFloat(t.Z2)),S=new k(-p/2+c,0,parseFloat(t.Z2)),_=new k(-p/2+a,0,parseFloat(t.Z1));s==0?(v.y=-v.y,y.y=-y.y,n.addQuad(_,S,y,v,{name:r,material:i,surfaceType:"listen"})):n.addQuad(v,y,S,_,{name:r,material:i,surfaceType:"listen"})}createTrapezoid(e,t,n,r,i){const s=e.Depth||0,a=parseFloat(e.FrontEdge?.toString()||"0"),u=(parseFloat(e.BackEdge?.toString()||"0")-a)/s,d=parseFloat(t.D1),p=parseFloat(t.D2),g=new k(-(s/2)+d,-d*u/2-a/2,parseFloat(t.Z1)),v=new k(-(s/2)+p,-p*u/2-a/2,parseFloat(t.Z2)),y=new k(-(s/2)+p,p*u/2+a/2,parseFloat(t.Z2)),S=new k(-(s/2)+d,d*u/2+a/2,parseFloat(t.Z1));n.addQuad(S,g,v,y,{name:r,material:i,surfaceType:"listen"})}createRectangle(e,t,n,r,i){const s=e.Depth||0,a=e.Width||0,c=parseFloat(t.D1),u=parseFloat(t.D2),d=new k(-(s/2)+c,-a/2,parseFloat(t.Z1)),p=new k(-(s/2)+u,-a/2,parseFloat(t.Z2)),g=new k(-(s/2)+u,a/2,parseFloat(t.Z2)),v=new k(-(s/2)+c,a/2,parseFloat(t.Z1));n.addQuad(d,p,g,v,{name:r,material:i,surfaceType:"listen"})}findOffset(e,t){return e.findIndex((n,r,i)=>{if(r+t.length>i.length)return!1;const s=i.slice(r,r+t.length);return t.every((a,c)=>s[c]===a)})}}class wi{convert(e,t){const n=new St({originalFormat:"obj",originalFileName:t,author:"Wavefront OBJ",comments:"Converted from OBJ format"});n.setCoordinateSystem("right-handed").setUpAxis("y").setUnits("meters");const r=Nt("obj"),i=this.parseObjData(e);for(const s of i.objects)if(s.faces.length>0){const a=r.getMaterialForObject(s.name||"OBJ Mesh",void 0,"obj_objects","structure");n.addMesh(i.vertices,s.faces,{name:s.name||"OBJ Mesh",material:a,normals:i.normals.length>0?i.normals:void 0,uvs:i.uvs.length>0?i.uvs:void 0})}return n.build()}parseObjData(e){const t=[],n=[],r=[],i=[];let s={name:"default",faces:[]};i.push(s);const a=e.split(`
`);for(const u of a){const d=u.trim();if(!d||d.startsWith("#"))continue;const p=d.split(/\s+/);switch(p[0]){case"v":if(p.length>=4){const v=parseFloat(p[1]),y=parseFloat(p[2]),S=parseFloat(p[3]);t.push(new k(v,y,S))}break;case"vn":if(p.length>=4){const v=parseFloat(p[1]),y=parseFloat(p[2]),S=parseFloat(p[3]);n.push(new k(v,y,S))}break;case"vt":if(p.length>=3){const v=parseFloat(p[1]),y=parseFloat(p[2]);r.push(new Vt(v,y))}break;case"f":if(p.length>=4){const v=this.parseFace(p.slice(1));v.length>=3&&s.faces.push(v)}break;case"o":case"g":p.length>=2&&(s={name:p.slice(1).join(" "),faces:[]},i.push(s));break}}const c=i.filter(u=>u.faces.length>0);return{vertices:t,normals:n,uvs:r,objects:c.length>0?c:[s]}}parseFace(e){const t=[];for(const n of e){const r=n.split("/"),i=parseInt(r[0]);isNaN(i)||t.push(i-1)}if(t.length>4){const n=[];for(let r=1;r<t.length-1;r++)n.push(t[0],t[r],t[r+1]);return n}return t}static fromThreeObject(e,t){const n=new St({originalFormat:"threejs",originalFileName:t,author:"Three.js Object",comments:"Converted from Three.js Object3D"});n.setCoordinateSystem("right-handed").setUpAxis("y").setUnits("meters");const r=Nt("general");function i(s,a,c=0){if(s.isMesh&&s.geometry){const u=s.geometry,d=u.getAttribute("position");if(d){const p=[],g=[];for(let _=0;_<d.count;_++){const E=d.getX(_),D=d.getY(_),T=d.getZ(_);p.push(new k(E,D,T))}const v=u.index;if(v)for(let _=0;_<v.count;_+=3){const E=v.getX(_),D=v.getX(_+1),T=v.getX(_+2);g.push([E,D,T])}else for(let _=0;_<d.count;_+=3)g.push([_,_+1,_+2]);const y=s.matrixWorld;p.forEach(_=>{_.applyMatrix4(y)});const S=r.getMaterialForObject(s.name||"Three.js Mesh",void 0,"threejs_objects","structure");a.addMesh(p,g,{name:s.name||"Three.js Mesh",material:S})}}if(s.children)for(const u of s.children)u.children&&u.children.length>0?(a.beginGroup(u.name||"Group"),i(u,a,c+1),a.endGroup()):i(u,a,c+1)}return i(e,n),n.build()}}let Ti=class{convert(e,t){const n=JSON.parse(e),r=new St({originalFormat:n.metadata.originalFormat||"cif",originalFileName:t||n.metadata.originalFileName,author:n.metadata.author,comments:n.metadata.comments,version:n.metadata.version,created:n.metadata.created?new Date(n.metadata.created):new Date,formatSpecific:n.metadata.formatSpecific});if(r.setUnits(n.units||"meters").setCoordinateSystem(n.coordinateSystem||"right-handed").setUpAxis(n.upAxis||"z"),n.materials)for(const[i,s]of Object.entries(n.materials)){const a=s;r.addMaterial(i,{name:a.name,color:new Be(a.color.r,a.color.g,a.color.b),opacity:a.opacity,transparent:a.transparent,properties:a.properties})}if(n.root&&n.root.children)for(const i of n.root.children)this.processObject(i,r);return r.build()}processObject(e,t){if(e.type==="group"){if(t.beginGroup(e.name),this.setObjectProperties(e,t),e.children)for(const n of e.children)this.processObject(n,t);t.endGroup()}else{const n=this.parseTransform(e.transform),r=this.parseMaterial(e.material);switch(e.type){case"triangle":const i=this.parseVertices(e.vertices,3);t.addTriangle(i[0],i[1],i[2],{name:e.name,material:r,transform:n});break;case"quad":const s=this.parseVertices(e.vertices,4);t.addQuad(s[0],s[1],s[2],s[3],{name:e.name,material:r,transform:n});break;case"cube":t.addCube(this.parseVertices(e.vertices,8),{name:e.name,material:r,transform:n});break;case"revolution":t.addRevolution(this.parseVertices(e.profile),{name:e.name,material:r,transform:n,axis:this.parseVector3(e.axis),startAngle:e.startAngle,endAngle:e.endAngle,segments:e.segments});break;case"mesh":t.addMesh(this.parseVertices(e.vertices),e.faces,{name:e.name,material:r,transform:n});break}}}setObjectProperties(e,t){if(e.transform){const n=this.parseTransform(e.transform);t.setTransform(n)}}parseTransform(e){return{position:this.parseVector3(e.position),rotation:this.parseVector3(e.rotation),scale:this.parseVector3(e.scale)}}parseVector3(e){return new k(e.x,e.y,e.z)}parseVertices(e,t){const n=e.map(r=>this.parseVector3(r));if(t&&n.length!==t)throw new Error(`Expected ${t} vertices, got ${n.length}`);return n}parseMaterial(e){return{name:e.name,color:new Be(e.color.r,e.color.g,e.color.b),opacity:e.opacity,transparent:e.transparent,properties:e.properties}}};class Ai{convert(e,t){const n=JSON.parse(e),r=new St({originalFormat:"cvf",originalFileName:t,author:n.title||"Clair Venue Exchange",comments:n.notes||"Converted from CVF format"});r.setCoordinateSystem("right-handed").setUpAxis("z").setUnits("meters");const i=Nt("cvf");r.beginGroup("CVF_Import"),r.rotate(0,0,et(90));for(const s of n.zones)this.processZone(s,n.projectOrigin,r,i);return r.endGroup(),r.build()}processZone(e,t,n,r){n.beginGroup(e.name);const i=new k(e.position.x-t.x,e.position.y-t.y,0);n.translate(i.x,i.y,i.z),n.rotate(0,0,et(e.rotation));for(const s of e.sections)this.processSection(e,s,n,r);n.endGroup()}processSection(e,t,n,r){if(t.points.length<3){console.warn(`Section ${t.name} has fewer than 3 points, skipping`);return}const s=r.getMaterialForObject(`${e.params.type} ${t.name}`,void 0,e.name,"listen");switch(e.params.type){case"SymmetricPolygon":this.createSymmetricPolygonSection(e,t,n,s);break;case"AsymmetricPolygon":this.createAsymmetricPolygonSection(e,t,n,s);break;case"Circular":this.createCircularSection(e,t,n,s);break;default:console.warn(`Unknown CVF zone type: ${e.params.type}`)}}createSymmetricPolygonSection(e,t,n,r){const i=e.params,s=i.frontWidth||0,a=i.rearWidth||0,c=e.depth;for(let u=0;u<t.points.length-1;u++){const d=t.points[u],p=t.points[u+1],g=this.interpolateWidth(d.x,c,s,a),v=this.interpolateWidth(p.x,c,s,a),y=new k(d.x-c/2,-g/2,d.z),S=new k(p.x-c/2,-v/2,p.z),_=new k(d.x-c/2,g/2,d.z),E=new k(p.x-c/2,v/2,p.z);n.addQuad(y,S,E,_,{name:`${t.name}_segment_${u}`,material:r,surfaceType:"listen"})}}createAsymmetricPolygonSection(e,t,n,r){const i=e.params,s=i.frontRightWidth||0,a=i.frontLeftWidth||0,c=i.rearRightWidth||0,u=i.rearLeftWidth||0,d=e.depth;for(let p=0;p<t.points.length-1;p++){const g=t.points[p],v=t.points[p+1],y=this.interpolateWidth(g.x,d,s,c),S=this.interpolateWidth(g.x,d,a,u),_=this.interpolateWidth(v.x,d,s,c),E=this.interpolateWidth(v.x,d,a,u),D=new k(g.x-d/2,y,g.z),T=new k(v.x-d/2,_,v.z),M=new k(g.x-d/2,-S,g.z),R=new k(v.x-d/2,-E,v.z);n.addQuad(M,R,T,D,{name:`${t.name}_segment_${p}`,material:r,surfaceType:"listen"})}}createCircularSection(e,t,n,r){const i=e.params,s=i.frontRadius||0,a=i.angle||360,c=[];for(const p of t.points){const g=s+p.x;c.push(new k(g,0,p.z))}const u=360-a/2,d=u+a;n.addRevolution(c,{name:t.name,material:r,startAngle:et(u),endAngle:et(d),segments:Math.max(8,Math.ceil(a/10)),closed:a>=360,axis:new k(0,0,1),surfaceType:"listen"})}interpolateWidth(e,t,n,r){const i=(e+t/2)/t;return n+(r-n)*i}}var Ei=Object.defineProperty,Ii=(l,e,t)=>e in l?Ei(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Si=(l,e,t)=>Ii(l,e+"",t);const dr=class hr{static getSupportedExtensions(){return this.SUPPORTED_EXTENSIONS}static isSupported(e){return this.SUPPORTED_EXTENSIONS.includes(e.toLowerCase())}async processFile(e,t){const n=performance.now(),r=this.getFileExtension(t);if(!hr.isSupported(r))throw new Error(`Unsupported file format: ${r}`);try{let i,s;switch(r){case"dbacv":i=await this.processDbacv(e,t);break;case"fc3":case"fc2":i=await this.processFc3(e,t);break;case"obj":i=await this.processObj(e,t);break;case"cvf":i=await this.processCvf(e,t);break;case"cif":case"json":i=await this.processCIF(e,t);break;default:throw new Error(`Unsupported format: ${r}`)}const a=performance.now()-n;return{cifScene:i,threeObject:s,metadata:{format:r.toUpperCase(),fileName:t,processingTime:a,objectCount:i?.root?.children?.length||0}}}catch(i){throw console.error(`Error processing ${r} file:`,i),new Error(`Failed to process ${r} file: ${i instanceof Error?i.message:"Unknown error"}`)}}async processDbacv(e,t){try{let n;if(e.startsWith("data:")){const i=e.split(",")[1];n=atob(i)}else n=e;return new ui().convert(n,t)}catch(n){throw new Error(`DBACV processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processFc3(e,t){try{return new _i().convert(e,t)}catch(n){throw new Error(`FC3 processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processObj(e,t){try{let n;if(e.startsWith("data:")){const i=e.split(",")[1];n=atob(i)}else n=e;return new wi().convert(n,t)}catch(n){throw new Error(`OBJ processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processCvf(e,t){try{let n;if(e.startsWith("data:")){const i=e.split(",")[1];n=atob(i)}else n=e;return new Ai().convert(n,t)}catch(n){throw new Error(`CVF processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async processCIF(e,t){try{let n;if(e.startsWith("data:")){const i=e.split(",")[1];n=atob(i)}else n=e;return new Ti().convert(n,t)}catch(n){throw new Error(`CIF processing failed: ${n instanceof Error?n.message:"Unknown error"}`)}}getFileExtension(e){return e.split(".").pop()?.toLowerCase()||""}static validateFile(e){if(e.size>52428800)return{valid:!1,error:"File too large. Maximum size is 50MB."};const n=e.name.split(".").pop()?.toLowerCase()||"";return this.isSupported(n)?{valid:!0}:{valid:!1,error:`Unsupported file type: ${n}. Supported types: ${this.SUPPORTED_EXTENSIONS.join(", ")}`}}static async readFile(e){return new Promise((t,n)=>{const r=new FileReader,i=e.name.split(".").pop()?.toLowerCase()||"";r.onload=s=>{s.target?.result?t(s.target.result):n(new Error("Failed to read file"))},r.onerror=()=>n(new Error("Error reading file")),i==="fc3"||i==="fc2"?r.readAsArrayBuffer(e):r.readAsDataURL(e)})}};Si(dr,"SUPPORTED_EXTENSIONS",["dbacv","fc3","fc2","obj","cif","json","cvf"]);let bn=dr;class st{static applyTransform(e,t){return e.map(n=>{const r=n.clone();r.multiply(t.scale);const i=new It(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return r.applyEuler(i),r.add(t.position),r})}static applyTransformToVertex(e,t){const n=e.clone();n.multiply(t.scale);const r=new It(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return n.applyEuler(r),n.add(t.position),n}static applyTransformToNormals(e,t){return e.map(n=>{const r=n.clone();r.divide(t.scale);const i=new It(t.rotation.x,t.rotation.y,t.rotation.z,"XYZ");return r.applyEuler(i),r.normalize(),r})}static combineTransforms(e,t){const n=t.position.clone();n.multiply(e.scale);const r=new It(e.rotation.x,e.rotation.y,e.rotation.z,"XYZ");n.applyEuler(r),n.add(e.position);const i=new k(e.rotation.x+t.rotation.x,e.rotation.y+t.rotation.y,e.rotation.z+t.rotation.z),s=new k().copy(e.scale).multiply(t.scale);return{position:n,rotation:i,scale:s}}static createIdentityTransform(){return{position:new k(0,0,0),rotation:new k(0,0,0),scale:new k(1,1,1)}}}class Ci{export(e){let t=this.generateHeader();return this.processGroup(e.root,st.createIdentityTransform(),(n,r)=>{for(const i of n)t+=this.writeTriangle(i,r)}),t}processGroup(e,t,n){const r=st.combineTransforms(t,e.transform);for(const i of e.children)if(i instanceof Me)this.processGroup(i,r,n);else if(i instanceof ot){const s=this.primitiveToTriangles(i,r);n(s,i.name)}}generateHeader(){return`"; Exported by CIF to SoundVision Exporter"
"; "
";   using Outside is front (white)"
";   using Name By Layer"
";   using Visible Entities"
";"
";"
";"
"; LengthUnit", "m"
";"
`}primitiveToTriangles(e,t){const n=[];switch(e.type){case"triangle":n.push(...this.triangleToTriangles(e));break;case"quad":n.push(...this.quadToTriangles(e));break;case"revolution":n.push(...this.revolutionToTriangles(e));break;case"mesh":n.push(...this.meshToTriangles(e));break}const r=st.combineTransforms(t,e.transform);return n.map(i=>st.applyTransform(i,r))}triangleToTriangles(e){return[e.vertices.map(t=>t.clone())]}quadToTriangles(e){const[t,n,r,i]=e.vertices;return[[t.clone(),n.clone(),r.clone()],[r.clone(),i.clone(),t.clone()]]}revolutionToTriangles(e){const t=[],{profile:n,segments:r,startAngle:i,endAngle:s}=e;if(n.length<2)return t;const a=s-i,c=[];for(let d=0;d<=r;d++){const p=i+a*d/r,g=Math.cos(p),v=Math.sin(p);for(const y of n){const S=y.x*g-y.y*v,_=y.x*v+y.y*g,E=y.z;c.push(new k(S,_,E))}}const u=n.length;for(let d=0;d<r;d++)for(let p=0;p<u-1;p++){const g=d*u+p,v=d*u+p+1,y=(d+1)*u+p+1,S=(d+1)*u+p;t.push([c[g].clone(),c[v].clone(),c[y].clone()]),t.push([c[y].clone(),c[S].clone(),c[g].clone()])}return t}meshToTriangles(e){const t=[];for(const n of e.faces)if(n.length===3)t.push([e.vertices[n[0]].clone(),e.vertices[n[1]].clone(),e.vertices[n[2]].clone()]);else if(n.length===4){const[r,i,s,a]=n;t.push([e.vertices[r].clone(),e.vertices[i].clone(),e.vertices[s].clone()]),t.push([e.vertices[s].clone(),e.vertices[a].clone(),e.vertices[r].clone()])}else for(let r=1;r<n.length-1;r++)t.push([e.vertices[n[0]].clone(),e.vertices[n[r]].clone(),e.vertices[n[r+1]].clone()]);return t}writeTriangle(e,t){const n=e.map(c=>new k(-c.y,c.x,c.z)),r=n[1].clone().sub(n[0]),i=n[2].clone().sub(n[0]);r.cross(i).z<0&&n.reverse();let a=`"Label","${t}"
`;for(const c of n)a+=`${c.x},${c.y},${c.z}
`;return a+=`";"
`,a}}class Mi{export(e){const t=this.extractVertexData(e);return this.generateOBJ(t,e)}extractVertexData(e){const t=[],n=[],r=[],i=[],s=new Map,a=new Map,c=new Map;let u=0,d=0,p=0;const g=_=>{const E=`${_.x.toFixed(6)},${_.y.toFixed(6)},${_.z.toFixed(6)}`;return s.has(E)?s.get(E):(t.push(_.clone()),s.set(E,u),u++)},v=_=>{const E=`${_.x.toFixed(6)},${_.y.toFixed(6)},${_.z.toFixed(6)}`;return a.has(E)?a.get(E):(n.push(_.clone().normalize()),a.set(E,d),d++)},y=_=>{const E=`${_.x.toFixed(6)},${_.y.toFixed(6)}`;return c.has(E)?c.get(E):(r.push({x:_.x,y:_.y}),c.set(E,p),p++)},S=(_,E)=>{const D=st.combineTransforms(E,_.transform);for(const T of _.children)if(T instanceof ot){const M=st.combineTransforms(D,T.transform),R=this.primitiveToVertexData(T,M);for(const O of R.faces){const F=[],G=[],Z=[];for(let $=0;$<O.vertices.length;$++)F.push(g(O.vertices[$])),O.normals&&O.normals[$]&&G.push(v(O.normals[$])),O.uvs&&O.uvs[$]&&Z.push(y(O.uvs[$]));i.push({vertices:F,normals:G.length>0?G:void 0,uvs:Z.length>0?Z:void 0,objectName:T.name})}}else T instanceof Me&&S(T,D)};return S(e.root,st.createIdentityTransform()),{vertices:t,normals:n,uvs:r,faces:i}}primitiveToVertexData(e,t){const n=[];switch(e.type){case"triangle":n.push(...this.triangleToFaces(e));break;case"quad":n.push(...this.quadToFaces(e));break;case"revolution":n.push(...this.revolutionToFaces(e));break;case"mesh":n.push(...this.meshToFaces(e));break}return{faces:n.map(r=>({vertices:st.applyTransform(r.vertices,t),normals:r.normals?st.applyTransformToNormals(r.normals,t):void 0,uvs:r.uvs}))}}triangleToFaces(e){return[{vertices:e.vertices.map(t=>t.clone()),normals:e.normals?.map(t=>t.clone()),uvs:e.uvs}]}quadToFaces(e){const[t,n,r,i]=e.vertices,s=e.normals,a=e.uvs;return[{vertices:[t.clone(),n.clone(),r.clone()],normals:s?[s[0].clone(),s[1].clone(),s[2].clone()]:void 0,uvs:a?[a[0],a[1],a[2]]:void 0},{vertices:[r.clone(),i.clone(),t.clone()],normals:s?[s[2].clone(),s[3].clone(),s[0].clone()]:void 0,uvs:a?[a[2],a[3],a[0]]:void 0}]}revolutionToFaces(e){const t=[],{profile:n,segments:r,startAngle:i,endAngle:s}=e;if(n.length<2)return t;const a=s-i,c=[];for(let d=0;d<=r;d++){const p=i+a*d/r,g=Math.cos(p),v=Math.sin(p);for(const y of n){const S=y.x*g-y.y*v,_=y.x*v+y.y*g,E=y.z;c.push(new k(S,_,E))}}const u=n.length;for(let d=0;d<r;d++)for(let p=0;p<u-1;p++){const g=d*u+p,v=d*u+p+1,y=(d+1)*u+p+1,S=(d+1)*u+p;t.push({vertices:[c[g].clone(),c[v].clone(),c[y].clone()]}),t.push({vertices:[c[y].clone(),c[S].clone(),c[g].clone()]})}return t}meshToFaces(e){const t=[];for(const n of e.faces)if(n.length===3)t.push({vertices:[e.vertices[n[0]].clone(),e.vertices[n[1]].clone(),e.vertices[n[2]].clone()],normals:e.normals?[e.normals[n[0]].clone(),e.normals[n[1]].clone(),e.normals[n[2]].clone()]:void 0,uvs:e.uvs?[e.uvs[n[0]],e.uvs[n[1]],e.uvs[n[2]]]:void 0});else if(n.length===4){const[r,i,s,a]=n;t.push({vertices:[e.vertices[r].clone(),e.vertices[i].clone(),e.vertices[s].clone()],normals:e.normals?[e.normals[r].clone(),e.normals[i].clone(),e.normals[s].clone()]:void 0,uvs:e.uvs?[e.uvs[r],e.uvs[i],e.uvs[s]]:void 0}),t.push({vertices:[e.vertices[s].clone(),e.vertices[a].clone(),e.vertices[r].clone()],normals:e.normals?[e.normals[s].clone(),e.normals[a].clone(),e.normals[r].clone()]:void 0,uvs:e.uvs?[e.uvs[s],e.uvs[a],e.uvs[r]]:void 0})}return t}generateOBJ(e,t){let n="";n+=`# Exported by CIF to OBJ Exporter
`,n+=`# Source: ${t.metadata.originalFileName||"Unknown"}
`,n+=`# Created: ${new Date().toISOString()}
`,n+=`# Vertices: ${e.vertices.length}
`,n+=`# Faces: ${e.faces.length}

`;for(const i of e.vertices)n+=`v ${i.x.toFixed(6)} ${i.y.toFixed(6)} ${i.z.toFixed(6)}
`;if(e.uvs.length>0){n+=`
`;for(const i of e.uvs)n+=`vt ${i.x.toFixed(6)} ${i.y.toFixed(6)}
`}if(e.normals.length>0){n+=`
`;for(const i of e.normals)n+=`vn ${i.x.toFixed(6)} ${i.y.toFixed(6)} ${i.z.toFixed(6)}
`}const r=new Map;for(const i of e.faces)r.has(i.objectName)||r.set(i.objectName,[]),r.get(i.objectName).push(i);for(const[i,s]of r){n+=`
# Object: ${i}
`,n+=`o ${i.replace(/\s+/g,"_")}
`;for(const a of s){n+="f ";for(let c=0;c<a.vertices.length;c++){let d=`${a.vertices[c]+1}`;a.uvs&&a.uvs[c]!==void 0?d+=`/${a.uvs[c]+1}`:a.normals&&a.normals[c]!==void 0&&(d+="/"),a.normals&&a.normals[c]!==void 0&&(d+=`/${a.normals[c]+1}`),n+=d,c<a.vertices.length-1&&(n+=" ")}n+=`
`}}return n}}var ki=Object.defineProperty,Fi=(l,e,t)=>e in l?ki(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Ut=(l,e,t)=>Fi(l,typeof e!="symbol"?e+"":e,t);class Oi{constructor(){Ut(this,"outputDoc"),Ut(this,"nameList",[]),Ut(this,"objectIdCounter",1),Ut(this,"parentChildMap",new Map),this.outputDoc=document.implementation.createDocument("","",null)}export(e){this.nameList=[],this.objectIdCounter=1,this.parentChildMap.clear();const t=this.outputDoc.createElement("ArrayCalc");t.setAttribute("Version","11.1.1");const n=this.outputDoc.createElement("Project");n.setAttribute("Name",e.metadata.originalFileName||"Convertifer3D");let r=this.outputDoc.createElement("Date");r.textContent=new Date().toLocaleDateString(),n.appendChild(r),r=this.outputDoc.createElement("Author"),r.textContent=e.metadata.author||"Convertifer 3D",n.appendChild(r),r=this.outputDoc.createElement("Comments"),r.textContent=e.metadata.comments||"Converted from CIF format",n.appendChild(r),t.appendChild(n);const i=this.outputDoc.createElement("Venue");i.setAttribute("Version","9"),t.appendChild(i);const s=this.createWrapperGroup();i.appendChild(s),this.convertGroup(e.root,s);let a=new XMLSerializer().serializeToString(t);return a=`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ArrayCalc>`+a,a}convertGroup(e,t){const n=e.name!=="Root"&&this.hasNonIdentityTransform(e.transform);let r=t;n&&(r=this.createGroupElement(e),t.appendChild(r));for(const i of e.children)if("type"in i){const s=i;!n&&e.name!=="Root"&&(s.transform=this.combineTransforms(e.transform,s.transform));const a=this.convertPrimitive(s);for(const c of a)r.appendChild(c)}else{const s=i;!n&&e.name!=="Root"&&(s.transform=this.combineTransforms(e.transform,s.transform)),this.convertGroup(s,r)}}createWrapperGroup(){const e=this.outputDoc.createElement("RoomObject"),t=this.objectIdCounter++;return e.setAttribute("Id",t.toString()),e.setAttribute("ObjectGroup","true"),e.setAttribute("Shape","5"),e.setAttribute("PlaneType","1"),e.setAttribute("Name",this.getUniqueName("Scene")),e.setAttribute("Enabled","1"),e.setAttribute("Transparent","1"),e.setAttribute("Locked","0"),e.setAttribute("ListenerHeight","1.7"),e.setAttribute("Color",this.colorToDbacv(8947848)),e.setAttribute("PrintColor","4294945280"),e.setAttribute("ParentVenueObjectId","0"),e.setAttribute("OrderIndex","4"),this.addWrapperTransform(e),e}createGroupElement(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;return t.setAttribute("Id",n.toString()),t.setAttribute("ObjectGroup","true"),t.setAttribute("Shape","5"),t.setAttribute("PlaneType","1"),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent","1"),t.setAttribute("Locked",e.locked?"1":"0"),t.setAttribute("ListenerHeight","1.7"),t.setAttribute("Color",this.colorToDbacv(8947848)),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),this.addTransformElements(t,e.transform),t}convertPrimitive(e){const t=[];switch(e.type){case"triangle":t.push(this.convertTriangle(e));break;case"quad":t.push(this.convertQuad(e));break;case"cube":t.push(this.convertCube(e));break;case"revolution":t.push(...this.convertRevolution(e));break;case"mesh":t.push(...this.convertMesh(e));break}return t}convertTriangle(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;t.setAttribute("Id",n.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","6"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const r=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",r.listenerHeight),t.setAttribute("PlaneType",r.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);for(let i=0;i<3;i++)this.addVertex(t,e.vertices[i],i+1);return this.addTransformElements(t,e.transform),t}convertQuad(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;t.setAttribute("Id",n.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","1"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const r=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",r.listenerHeight),t.setAttribute("PlaneType",r.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);const i=this.ensureQuadAntiClockwise(e.vertices);for(let s=0;s<4;s++)this.addVertex(t,i[s],s+1);return this.addTransformElements(t,e.transform),t}ensureQuadAntiClockwise(e){if(e.length!==4)return e;let t=0;for(let n=0;n<4;n++){const r=e[n],i=e[(n+1)%4];t+=(i.x-r.x)*(i.y+r.y)}return t<0?[e[0],e[3],e[2],e[1]]:e}convertCube(e){const t=this.outputDoc.createElement("RoomObject"),n=this.objectIdCounter++;t.setAttribute("Id",n.toString()),t.setAttribute("Name",this.getUniqueName(e.name)),t.setAttribute("Shape","4"),t.setAttribute("Enabled",e.visible?"1":"0"),t.setAttribute("Transparent",e.material.transparent?"1":"0"),t.setAttribute("Locked",e.locked?"1":"0");const r=this.getPlaneTypeAndHeight(e.surfaceType);t.setAttribute("ListenerHeight",r.listenerHeight),t.setAttribute("PlaneType",r.planeType),t.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),t.setAttribute("PrintColor","4294945280"),t.setAttribute("ParentVenueObjectId","0"),t.setAttribute("OrderIndex","4"),t.setAttribute("Type",e.surfaceType);for(let i=0;i<8;i++)this.addVertex(t,e.vertices[i],i+1);return this.addTransformElements(t,e.transform),t}convertRevolution(e){if(this.canConvertToArcSegment(e))return this.convertRevolutionToArcSegments(e);const t=this.revolutionToMesh(e);return this.convertMeshElements(t,`${e.name}_revolution`,e.material,e.transform,e.visible,e.locked,e.surfaceType)}convertMesh(e){return this.convertMeshElements({vertices:e.vertices,faces:e.faces},e.name,e.material,e.transform,e.visible,e.locked,e.surfaceType)}convertMeshElements(e,t,n,r,i,s,a){const c=[];for(let u=0;u<e.faces.length;u++){const d=e.faces[u],p=this.createFaceRoomObject(d,e.vertices,e.faces.length===1?t:`${t}_face_${u}`,n,r,i,s,a);p&&c.push(p)}return c}createFaceRoomObject(e,t,n,r,i,s,a,c){if(e.length===3){const u=this.outputDoc.createElement("RoomObject"),d=this.objectIdCounter++;if(u.setAttribute("Id",d.toString()),u.setAttribute("Name",this.getUniqueName(n)),u.setAttribute("Shape","6"),u.setAttribute("Enabled",s?"1":"0"),u.setAttribute("Transparent",r.transparent?"1":"0"),u.setAttribute("Locked",a?"1":"0"),c){const p=this.getPlaneTypeAndHeight(c);u.setAttribute("ListenerHeight",p.listenerHeight),u.setAttribute("PlaneType",p.planeType),u.setAttribute("Type",c)}else u.setAttribute("ListenerHeight","1.2"),u.setAttribute("PlaneType","1");u.setAttribute("Color",this.colorToDbacv(r.color.getHex())),u.setAttribute("PrintColor","4294945280"),u.setAttribute("ParentVenueObjectId","0"),u.setAttribute("OrderIndex","4");for(let p=0;p<3;p++)this.addVertex(u,t[e[p]],p+1);return this.addTransformElementsWithRotation(u,i),u}else if(e.length===4){const u=this.outputDoc.createElement("RoomObject"),d=this.objectIdCounter++;if(u.setAttribute("Id",d.toString()),u.setAttribute("Name",this.getUniqueName(n)),u.setAttribute("Shape","1"),u.setAttribute("Enabled",s?"1":"0"),u.setAttribute("Transparent",r.transparent?"1":"0"),u.setAttribute("Locked",a?"1":"0"),c){const p=this.getPlaneTypeAndHeight(c);u.setAttribute("ListenerHeight",p.listenerHeight),u.setAttribute("PlaneType",p.planeType),u.setAttribute("Type",c)}else u.setAttribute("ListenerHeight","1.2"),u.setAttribute("PlaneType","1");u.setAttribute("Color",this.colorToDbacv(r.color.getHex())),u.setAttribute("PrintColor","4294945280"),u.setAttribute("ParentVenueObjectId","0"),u.setAttribute("OrderIndex","4");for(let p=0;p<4;p++)this.addVertex(u,t[e[p]],p+1);return this.addTransformElementsWithRotation(u,i),u}return null}revolutionToMesh(e){const{profile:t,segments:n,startAngle:r,endAngle:i}=e,s=[],a=[];if(t.length<2)return{vertices:s,faces:a};const c=i-r;for(let d=0;d<=n;d++){const p=r+c*d/n,g=Math.cos(p),v=Math.sin(p);for(const y of t){const S=y.x*g-y.y*v,_=y.x*v+y.y*g,E=y.z;s.push(new k(S,_,E))}}const u=t.length;for(let d=0;d<n;d++)for(let p=0;p<u-1;p++){const g=d*u+p,v=d*u+p+1,y=(d+1)*u+p+1,S=(d+1)*u+p;a.push([g,v,y]),a.push([y,S,g])}return{vertices:s,faces:a}}addVertex(e,t,n){const r=this.outputDoc.createElement(`P${n}`);r.setAttribute("x",t.x.toString()),r.setAttribute("y",t.y.toString()),r.setAttribute("z",t.z.toString()),e.appendChild(r)}addTransformElements(e,t){this.addTransformElementsWithRotation(e,t)}addWrapperTransform(e){let t=this.outputDoc.createElement("Origin");t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("z","0"),e.appendChild(t),t=this.outputDoc.createElement("Rotation"),t.setAttribute("x","0"),t.setAttribute("y","0"),t.setAttribute("z","0"),e.appendChild(t),t=this.outputDoc.createElement("Scaling"),t.setAttribute("x","1"),t.setAttribute("y","1"),t.setAttribute("z","1"),e.appendChild(t)}addTransformElementsWithRotation(e,t){const n=t.position.x,r=t.position.y,i=t.position.z;let s=this.outputDoc.createElement("Origin");s.setAttribute("x",n.toString()),s.setAttribute("y",r.toString()),s.setAttribute("z",i.toString()),e.appendChild(s),s=this.outputDoc.createElement("Rotation"),s.setAttribute("x",yt(t.rotation.x).toString()),s.setAttribute("y",yt(t.rotation.y).toString()),s.setAttribute("z",yt(t.rotation.z).toString()),e.appendChild(s),s=this.outputDoc.createElement("Scaling"),s.setAttribute("x",t.scale.x.toString()),s.setAttribute("y",t.scale.y.toString()),s.setAttribute("z",t.scale.z.toString()),e.appendChild(s)}colorToDbacv(e){return((4278190080|e)>>>0).toString()}getPlaneTypeAndHeight(e){switch(e){case"listen":return{planeType:"1",listenerHeight:"1.7"};case"obstacle":return{planeType:"1",listenerHeight:"1.2"};case"structure":return{planeType:"4",listenerHeight:"0.01"};default:return{planeType:"1",listenerHeight:"1.2"}}}getUniqueName(e){(!e||e==="")&&(e="element");const t=this.nameList.filter(n=>n.includes(e));return this.nameList.push(e),t.length===0?e:`${e}#${t.length}`}canConvertToArcSegment(e){if(e.profile.length<2)return!1;const t=e.axis.normalize(),n=new k(0,0,1);return!(t.distanceTo(n)>.01)}convertRevolutionToArcSegments(e){const t=[],n=e.profile;for(let r=0;r<n.length-1;r++){const i=n[r],s=n[r+1],a=this.createSingleArcSegment(e,i,s,`${e.name}_arc_${r}`);t.push(a)}return t}createSingleArcSegment(e,t,n,r){const i=this.outputDoc.createElement("RoomObject"),s=this.objectIdCounter++;i.setAttribute("Id",s.toString()),i.setAttribute("Name",this.getUniqueName(r)),i.setAttribute("Shape","2"),i.setAttribute("Enabled",e.visible?"1":"0"),i.setAttribute("Transparent",e.material.transparent?"1":"0"),i.setAttribute("Locked",e.locked?"1":"0");const a=this.getPlaneTypeAndHeight(e.surfaceType);i.setAttribute("ListenerHeight",a.listenerHeight),i.setAttribute("PlaneType",a.planeType),i.setAttribute("Color",this.colorToDbacv(e.material.color.getHex())),i.setAttribute("PrintColor","4294945280"),i.setAttribute("ParentVenueObjectId","0"),i.setAttribute("OrderIndex","4"),i.setAttribute("Type",e.surfaceType);const c=Math.abs(t.x),u=Math.abs(n.x),d=t.z,p=n.z,g=yt(e.startAngle),v=e.endAngle-e.startAngle;let y=v*180/Math.PI;return(Math.abs(v-2*Math.PI)<.001||Math.abs(y)<.001)&&(y=360),i.setAttribute("OuterRadiusA",c.toString()),i.setAttribute("OuterRadiusB",c.toString()),i.setAttribute("InnerRadiusA",u.toString()),i.setAttribute("InnerRadiusB",u.toString()),i.setAttribute("StartAngle",g.toString()),i.setAttribute("SpanAngle",y.toString()),i.setAttribute("OuterZ",d.toString()),i.setAttribute("InnerZ",p.toString()),this.addTransformElements(i,e.transform),i}hasNonIdentityTransform(e){const t=e.position,n=e.rotation,r=e.scale;return Math.abs(t.x)>1e-6||Math.abs(t.y)>1e-6||Math.abs(t.z)>1e-6||Math.abs(n.x)>1e-6||Math.abs(n.y)>1e-6||Math.abs(n.z)>1e-6||Math.abs(r.x-1)>1e-6||Math.abs(r.y-1)>1e-6||Math.abs(r.z-1)>1e-6}combineTransforms(e,t){return{position:new k(e.position.x+t.position.x,e.position.y+t.position.y,e.position.z+t.position.z),rotation:new k(e.rotation.x+t.rotation.x,e.rotation.y+t.rotation.y,e.rotation.z+t.rotation.z),scale:new k(e.scale.x*t.scale.x,e.scale.y*t.scale.y,e.scale.z*t.scale.z)}}}class zi{export(e){const t=this.sceneToSerializable(e);return JSON.stringify(t,null,2)}sceneToSerializable(e){return{metadata:{...e.metadata,created:e.metadata.created.toISOString()},root:this.objectToSerializable(e.root),materials:this.materialsToSerializable(e.materials),units:e.units,coordinateSystem:e.coordinateSystem,upAxis:e.upAxis}}objectToSerializable(e){const t={id:e.id,name:e.name,transform:{position:{x:e.transform.position.x,y:e.transform.position.y,z:e.transform.position.z},rotation:{x:e.transform.rotation.x,y:e.transform.rotation.y,z:e.transform.rotation.z},scale:{x:e.transform.scale.x,y:e.transform.scale.y,z:e.transform.scale.z}},visible:e.visible,locked:e.locked,parentId:e.parentId,userData:e.userData};if("children"in e)return{...t,type:"group",children:e.children.map(r=>this.objectToSerializable(r))};{const n=e,r={...t,type:n.type,material:this.materialToSerializable(n.material)};switch(n.type){case"triangle":const i=n;r.vertices=i.vertices.map(d=>({x:d.x,y:d.y,z:d.z})),i.normals&&(r.normals=i.normals.map(d=>({x:d.x,y:d.y,z:d.z}))),i.uvs&&(r.uvs=i.uvs.map(d=>({x:d.x,y:d.y})));break;case"quad":const s=n;r.vertices=s.vertices.map(d=>({x:d.x,y:d.y,z:d.z})),s.normals&&(r.normals=s.normals.map(d=>({x:d.x,y:d.y,z:d.z}))),s.uvs&&(r.uvs=s.uvs.map(d=>({x:d.x,y:d.y})));break;case"cube":const a=n;r.vertices=a.vertices.map(d=>({x:d.x,y:d.y,z:d.z}));break;case"revolution":const c=n;r.profile=c.profile.map(d=>({x:d.x,y:d.y,z:d.z})),r.axis={x:c.axis.x,y:c.axis.y,z:c.axis.z},r.startAngle=c.startAngle,r.endAngle=c.endAngle,r.segments=c.segments,r.closed=c.closed;break;case"mesh":const u=n;r.vertices=u.vertices.map(d=>({x:d.x,y:d.y,z:d.z})),r.faces=u.faces,u.normals&&(r.normals=u.normals.map(d=>({x:d.x,y:d.y,z:d.z}))),u.uvs&&(r.uvs=u.uvs.map(d=>({x:d.x,y:d.y})));break}return r}}materialToSerializable(e){return{name:e.name,color:{r:e.color.r,g:e.color.g,b:e.color.b},opacity:e.opacity,transparent:e.transparent,properties:e.properties}}materialsToSerializable(e){const t={};return e.forEach((n,r)=>{t[r]=this.materialToSerializable(n)}),t}}class Ni{export(e){const t={version:"1.0",projectOrigin:{x:0,y:0},zones:[],title:e.metadata.originalFileName||"Converted Venue",notes:e.metadata.comments||"Converted from CIF format"};return this.processGroup(e.root,t,new Ht),JSON.stringify(t,null,2)}processGroup(e,t,n){const r=new Ht;if(e.transform.position&&r.makeTranslation(e.transform.position.x,e.transform.position.y,e.transform.position.z),e.transform.rotation){const g=new Ht;g.makeRotationFromEuler(new It(e.transform.rotation.x,e.transform.rotation.y,e.transform.rotation.z,"XYZ")),r.multiply(g)}const i=n.clone().multiply(r);if(e.name==="CVF_Import"||e.name==="FC3_Import"||e.name==="Root"){for(const g of e.children)if("children"in g)this.processGroup(g,t,i);else if("type"in g){const v=new Me(g.id+"_temp",g.name||"Geometry");v.children.push(g);const y=this.reconstructZone(v,new k,0);y&&t.zones.push(y)}return}const s=new k,a=new Er,c=new k;i.decompose(s,a,c);const u=new It().setFromRotationMatrix(i),d=yt(u.z)-90,p=this.reconstructZone(e,s,d);p&&t.zones.push(p);for(const g of e.children)"children"in g&&this.processGroup(g,t,i)}reconstructZone(e,t,n){const r=[];for(const p of e.children)"type"in p&&r.push(p);if(r.length===0)return null;const i=r.some(p=>p.type==="revolution"),s=r.some(p=>p.type==="quad"),a=r.some(p=>p.type==="triangle");let c,u,d=10;if(i){const p=r.find(g=>g.type==="revolution");if(p)c={type:"Circular",frontRadius:0,angle:yt(p.endAngle-p.startAngle)},u=this.extractSectionsFromRevolution(p);else return null}else if(s||a)c={type:"SymmetricPolygon",frontWidth:10,rearWidth:10},u=this.extractSectionsFromQuads(r),d=this.estimateDepthFromQuads(r);else return null;return{name:e.name||"Zone",position:{x:t.x,y:t.y},rotation:n,sections:u,depth:d,params:c}}extractSectionsFromRevolution(e){const t={name:e.name||"Section",audienceHeight:0,points:[]};for(const n of e.profile)t.points.push({x:n.x,z:n.z});return t.points.length>0&&(t.audienceHeight=t.points.reduce((n,r)=>n+r.z,0)/t.points.length),[t]}extractSectionsFromQuads(e){const t={name:"Section",audienceHeight:0,points:[]},n=new Map;for(const r of e)if(r.type==="quad"||r.type==="triangle"){const i=(r.type==="quad",r.vertices);for(const s of i){const a=`${s.x.toFixed(3)},${s.z.toFixed(3)}`;n.has(a)||n.set(a,{x:s.x,z:s.z})}}return t.points=Array.from(n.values()).sort((r,i)=>r.x-i.x),t.points.length<3&&(t.points=[{x:0,z:0},{x:5,z:0},{x:10,z:0}]),t.points.length>0&&(t.audienceHeight=t.points.reduce((r,i)=>r+i.z,0)/t.points.length),[t]}estimateDepthFromQuads(e){let t=1/0,n=-1/0;for(const i of e)if(i.type==="quad"||i.type==="triangle"){const s=(i.type==="quad",i.vertices);for(const a of s)t=Math.min(t,a.x),n=Math.max(n,a.x)}const r=n-t;return r>0?r:10}}const Xn={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class En{constructor(){this.pluginCallbacks=[],this.register(function(e){return new ji(e)}),this.register(function(e){return new Zi(e)}),this.register(function(e){return new Yi(e)}),this.register(function(e){return new Ki(e)}),this.register(function(e){return new Xi(e)}),this.register(function(e){return new qi(e)}),this.register(function(e){return new Vi(e)}),this.register(function(e){return new Wi(e)}),this.register(function(e){return new Ji(e)}),this.register(function(e){return new Qi(e)})}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){const i=new Hi,s=[];for(let a=0,c=this.pluginCallbacks.length;a<c;a++)s.push(this.pluginCallbacks[a](i));i.setPlugins(s),i.write(e,t,r).catch(n)}parseAsync(e,t){const n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}const Q={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},pn="KHR_mesh_quantization",Ue={};Ue[kr]=Q.NEAREST;Ue[Fr]=Q.NEAREST_MIPMAP_NEAREST;Ue[Or]=Q.NEAREST_MIPMAP_LINEAR;Ue[zr]=Q.LINEAR;Ue[Nr]=Q.LINEAR_MIPMAP_NEAREST;Ue[Rr]=Q.LINEAR_MIPMAP_LINEAR;Ue[Lr]=Q.CLAMP_TO_EDGE;Ue[Dr]=Q.REPEAT;Ue[Pr]=Q.MIRRORED_REPEAT;const qn={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Ri=new Be,Jn=12,Li=1179937895,Di=2,Qn=8,Pi=1313821514,Bi=5130562;function Mt(l,e){return l.length===e.length&&l.every(function(t,n){return t===e[n]})}function Ui(l){return new TextEncoder().encode(l).buffer}function Gi(l){return Mt(l.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function $i(l,e,t){const n={min:new Array(l.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(l.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let r=e;r<e+t;r++)for(let i=0;i<l.itemSize;i++){let s;l.itemSize>4?s=l.array[r*l.itemSize+i]:(i===0?s=l.getX(r):i===1?s=l.getY(r):i===2?s=l.getZ(r):i===3&&(s=l.getW(r)),l.normalized===!0&&(s=vn.normalize(s,l.array))),n.min[i]=Math.min(n.min[i],s),n.max[i]=Math.max(n.max[i],s)}return n}function pr(l){return Math.ceil(l/4)*4}function mn(l,e=0){const t=pr(l.byteLength);if(t!==l.byteLength){const n=new Uint8Array(t);if(n.set(new Uint8Array(l)),e!==0)for(let r=l.byteLength;r<t;r++)n[r]=e;return n.buffer}return l}function er(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function tr(l,e){if(l.toBlob!==void 0)return new Promise(n=>l.toBlob(n,e));let t;return e==="image/jpeg"?t=.92:e==="image/webp"&&(t=.8),l.convertToBlob({type:e,quality:t})}class Hi{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const r=this,i=r.buffers,s=r.json;n=r.options;const a=r.extensionsUsed,c=r.extensionsRequired,u=new Blob(i,{type:"application/octet-stream"}),d=Object.keys(a),p=Object.keys(c);if(d.length>0&&(s.extensionsUsed=d),p.length>0&&(s.extensionsRequired=p),s.buffers&&s.buffers.length>0&&(s.buffers[0].byteLength=u.size),n.binary===!0){const g=new FileReader;g.readAsArrayBuffer(u),g.onloadend=function(){const v=mn(g.result),y=new DataView(new ArrayBuffer(Qn));y.setUint32(0,v.byteLength,!0),y.setUint32(4,Bi,!0);const S=mn(Ui(JSON.stringify(s)),32),_=new DataView(new ArrayBuffer(Qn));_.setUint32(0,S.byteLength,!0),_.setUint32(4,Pi,!0);const E=new ArrayBuffer(Jn),D=new DataView(E);D.setUint32(0,Li,!0),D.setUint32(4,Di,!0);const T=Jn+_.byteLength+S.byteLength+y.byteLength+v.byteLength;D.setUint32(8,T,!0);const M=new Blob([E,_,S,y,v],{type:"application/octet-stream"}),R=new FileReader;R.readAsArrayBuffer(M),R.onloadend=function(){t(R.result)}}}else if(s.buffers&&s.buffers.length>0){const g=new FileReader;g.readAsDataURL(u),g.onloadend=function(){const v=g.result;s.buffers[0].uri=v,t(s)}}else t(s)}serializeUserData(e,t){if(Object.keys(e.userData).length===0)return;const n=this.options,r=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){t.extensions===void 0&&(t.extensions={});for(const s in i.gltfExtensions)t.extensions[s]=i.gltfExtensions[s],r[s]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(i){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+i.message)}}getUID(e,t=!1){if(this.uids.has(e)===!1){const r=new Map;r.set(!0,this.uid++),r.set(!1,this.uid++),this.uids.set(e,r)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const n=new k;for(let r=0,i=e.count;r<i;r++)if(Math.abs(n.fromBufferAttribute(e,r).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const n=e.clone(),r=new k;for(let i=0,s=n.count;i<s;i++)r.fromBufferAttribute(n,i),r.x===0&&r.y===0&&r.z===0?r.setX(1):r.normalize(),n.setXYZ(i,r.x,r.y,r.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1;const r={};(t.offset.x!==0||t.offset.y!==0)&&(r.offset=t.offset.toArray(),n=!0),t.rotation!==0&&(r.rotation=t.rotation,n=!0),(t.repeat.x!==1||t.repeat.y!==1)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function n(v){return v.colorSpace===ir?function(S){return S<.04045?S*.0773993808:Math.pow(S*.9478672986+.0521327014,2.4)}:function(S){return S}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures.");const r=e?e.image:null,i=t?t.image:null,s=Math.max(r?r.width:0,i?i.width:0),a=Math.max(r?r.height:0,i?i.height:0),c=er();c.width=s,c.height=a;const u=c.getContext("2d");u.fillStyle="#00ffff",u.fillRect(0,0,s,a);const d=u.getImageData(0,0,s,a);if(r){u.drawImage(r,0,0,s,a);const v=n(e),y=u.getImageData(0,0,s,a).data;for(let S=2;S<y.length;S+=4)d.data[S]=v(y[S]/256)*256}if(i){u.drawImage(i,0,0,s,a);const v=n(t),y=u.getImageData(0,0,s,a).data;for(let S=1;S<y.length;S+=4)d.data[S]=v(y[S]/256)*256}u.putImageData(d,0,0);const g=(e||t).clone();return g.source=new Ir(c),g.colorSpace=Sr,g.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),g}processBuffer(e){const t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,r,i){const s=this.json;s.bufferViews||(s.bufferViews=[]);let a;switch(t){case Q.BYTE:case Q.UNSIGNED_BYTE:a=1;break;case Q.SHORT:case Q.UNSIGNED_SHORT:a=2;break;default:a=4}const c=pr(r*e.itemSize*a),u=new DataView(new ArrayBuffer(c));let d=0;for(let v=n;v<n+r;v++)for(let y=0;y<e.itemSize;y++){let S;e.itemSize>4?S=e.array[v*e.itemSize+y]:(y===0?S=e.getX(v):y===1?S=e.getY(v):y===2?S=e.getZ(v):y===3&&(S=e.getW(v)),e.normalized===!0&&(S=vn.normalize(S,e.array))),t===Q.FLOAT?u.setFloat32(d,S,!0):t===Q.INT?u.setInt32(d,S,!0):t===Q.UNSIGNED_INT?u.setUint32(d,S,!0):t===Q.SHORT?u.setInt16(d,S,!0):t===Q.UNSIGNED_SHORT?u.setUint16(d,S,!0):t===Q.BYTE?u.setInt8(d,S):t===Q.UNSIGNED_BYTE&&u.setUint8(d,S),d+=a}const p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return i!==void 0&&(p.target=i),i===Q.ARRAY_BUFFER&&(p.byteStride=e.itemSize*a),this.byteOffset+=c,s.bufferViews.push(p),{id:s.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){const i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const s=mn(i.result),a={buffer:t.processBuffer(s),byteOffset:t.byteOffset,byteLength:s.byteLength};t.byteOffset+=s.byteLength,r(n.bufferViews.push(a)-1)}})}processAccessor(e,t,n,r){const i=this.json,s={1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"};let a;if(e.array.constructor===Float32Array)a=Q.FLOAT;else if(e.array.constructor===Int32Array)a=Q.INT;else if(e.array.constructor===Uint32Array)a=Q.UNSIGNED_INT;else if(e.array.constructor===Int16Array)a=Q.SHORT;else if(e.array.constructor===Uint16Array)a=Q.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)a=Q.BYTE;else if(e.array.constructor===Uint8Array)a=Q.UNSIGNED_BYTE;else throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");if(n===void 0&&(n=0),r===void 0&&(r=e.count),r===0)return null;const c=$i(e,n,r);let u;t!==void 0&&(u=e===t.index?Q.ELEMENT_ARRAY_BUFFER:Q.ARRAY_BUFFER);const d=this.processBufferView(e,a,n,r,u),p={bufferView:d.id,byteOffset:d.byteOffset,componentType:a,count:r,max:c.max,min:c.min,type:s[e.itemSize]};return e.normalized===!0&&(p.normalized=!0),i.accessors||(i.accessors=[]),i.accessors.push(p)-1}processImage(e,t,n,r="image/png"){if(e!==null){const i=this,s=i.cache,a=i.json,c=i.options,u=i.pending;s.images.has(e)||s.images.set(e,{});const d=s.images.get(e),p=r+":flipY/"+n.toString();if(d[p]!==void 0)return d[p];a.images||(a.images=[]);const g={mimeType:r},v=er();v.width=Math.min(e.width,c.maxTextureSize),v.height=Math.min(e.height,c.maxTextureSize);const y=v.getContext("2d");if(n===!0&&(y.translate(0,v.height),y.scale(1,-1)),e.data!==void 0){t!==Cr&&console.error("GLTFExporter: Only RGBAFormat is supported."),(e.width>c.maxTextureSize||e.height>c.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const _=new Uint8ClampedArray(e.height*e.width*4);for(let E=0;E<_.length;E+=4)_[E+0]=e.data[E+0],_[E+1]=e.data[E+1],_[E+2]=e.data[E+2],_[E+3]=e.data[E+3];y.putImageData(new ImageData(_,e.width,e.height),0,0)}else y.drawImage(e,0,0,v.width,v.height);c.binary===!0?u.push(tr(v,r).then(_=>i.processBufferViewImage(_)).then(_=>{g.bufferView=_})):v.toDataURL!==void 0?g.uri=v.toDataURL(r):u.push(tr(v,r).then(_=>new FileReader().readAsDataURL(_)).then(_=>{g.uri=_}));const S=a.images.push(g)-1;return d[p]=S,S}else throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const n={magFilter:Ue[e.magFilter],minFilter:Ue[e.minFilter],wrapS:Ue[e.wrapS],wrapT:Ue[e.wrapT]};return t.samplers.push(n)-1}processTexture(e){const t=this.cache,n=this.json;if(t.textures.has(e))return t.textures.get(e);n.textures||(n.textures=[]);let r=e.userData.mimeType;r==="image/webp"&&(r="image/png");const i={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,r)};e.name&&(i.name=e.name),this._invokeAll(function(a){a.writeTexture&&a.writeTexture(e,i)});const s=n.textures.push(i)-1;return t.textures.set(e,s),s}processMaterial(e){const t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);const r={pbrMetallicRoughness:{}};e.isMeshStandardMaterial!==!0&&e.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const i=e.color.toArray().concat([e.opacity]);if(Mt(i,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=.5,r.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const a=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),c={index:this.processTexture(a),channel:a.channel};this.applyTextureTransform(c,a),r.pbrMetallicRoughness.metallicRoughnessTexture=c}if(e.map){const a={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(a,e.map),r.pbrMetallicRoughness.baseColorTexture=a}if(e.emissive){const a=e.emissive;if(Math.max(a.r,a.g,a.b)>0&&(r.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const u={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(u,e.emissiveMap),r.emissiveTexture=u}}if(e.normalMap){const a={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&e.normalScale.x!==1&&(a.scale=e.normalScale.x),this.applyTextureTransform(a,e.normalMap),r.normalTexture=a}if(e.aoMap){const a={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};e.aoMapIntensity!==1&&(a.strength=e.aoMapIntensity),this.applyTextureTransform(a,e.aoMap),r.occlusionTexture=a}e.transparent?r.alphaMode="BLEND":e.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=e.alphaTest),e.side===Qt&&(r.doubleSided=!0),e.name!==""&&(r.name=e.name),this.serializeUserData(e,r),this._invokeAll(function(a){a.writeMaterial&&a.writeMaterial(e,r)});const s=n.materials.push(r)-1;return t.materials.set(e,s),s}processMesh(e){const t=this.cache,n=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let T=0,M=e.material.length;T<M;T++)r.push(e.material[T].uuid);else r.push(e.material.uuid);const i=r.join(":");if(t.meshes.has(i))return t.meshes.get(i);const s=e.geometry;let a;e.isLineSegments?a=Q.LINES:e.isLineLoop?a=Q.LINE_LOOP:e.isLine?a=Q.LINE_STRIP:e.isPoints?a=Q.POINTS:a=e.material.wireframe?Q.LINES:Q.TRIANGLES;const c={},u={},d=[],p=[],g={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},v=s.getAttribute("normal");v!==void 0&&!this.isNormalizedNormalAttribute(v)&&(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),s.setAttribute("normal",this.createNormalizedNormalAttribute(v)));let y=null;for(let T in s.attributes){if(T.slice(0,5)==="morph")continue;const M=s.attributes[T];if(T=g[T]||T.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(T)||(T="_"+T),t.attributes.has(this.getUID(M))){u[T]=t.attributes.get(this.getUID(M));continue}y=null;const O=M.array;T==="JOINTS_0"&&!(O instanceof Uint16Array)&&!(O instanceof Uint8Array)&&(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),y=new ue(new Uint16Array(O),M.itemSize,M.normalized));const F=this.processAccessor(y||M,s);F!==null&&(T.startsWith("_")||this.detectMeshQuantization(T,M),u[T]=F,t.attributes.set(this.getUID(M),F))}if(v!==void 0&&s.setAttribute("normal",v),Object.keys(u).length===0)return null;if(e.morphTargetInfluences!==void 0&&e.morphTargetInfluences.length>0){const T=[],M=[],R={};if(e.morphTargetDictionary!==void 0)for(const O in e.morphTargetDictionary)R[e.morphTargetDictionary[O]]=O;for(let O=0;O<e.morphTargetInfluences.length;++O){const F={};let G=!1;for(const Z in s.morphAttributes){if(Z!=="position"&&Z!=="normal"){G||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),G=!0);continue}const $=s.morphAttributes[Z][O],ie=Z.toUpperCase(),ne=s.attributes[Z];if(t.attributes.has(this.getUID($,!0))){F[ie]=t.attributes.get(this.getUID($,!0));continue}const j=$.clone();if(!s.morphTargetsRelative)for(let K=0,pe=$.count;K<pe;K++)for(let de=0;de<$.itemSize;de++)de===0&&j.setX(K,$.getX(K)-ne.getX(K)),de===1&&j.setY(K,$.getY(K)-ne.getY(K)),de===2&&j.setZ(K,$.getZ(K)-ne.getZ(K)),de===3&&j.setW(K,$.getW(K)-ne.getW(K));F[ie]=this.processAccessor(j,s),t.attributes.set(this.getUID(ne,!0),F[ie])}p.push(F),T.push(e.morphTargetInfluences[O]),e.morphTargetDictionary!==void 0&&M.push(R[O])}c.weights=T,M.length>0&&(c.extras={},c.extras.targetNames=M)}const S=Array.isArray(e.material);if(S&&s.groups.length===0)return null;const _=S?e.material:[e.material],E=S?s.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let T=0,M=E.length;T<M;T++){const R={mode:a,attributes:u};if(this.serializeUserData(s,R),p.length>0&&(R.targets=p),s.index!==null){let F=this.getUID(s.index);(E[T].start!==void 0||E[T].count!==void 0)&&(F+=":"+E[T].start+":"+E[T].count),t.attributes.has(F)?R.indices=t.attributes.get(F):(R.indices=this.processAccessor(s.index,s,E[T].start,E[T].count),t.attributes.set(F,R.indices)),R.indices===null&&delete R.indices}const O=this.processMaterial(_[E[T].materialIndex]);O!==null&&(R.material=O),d.push(R)}c.primitives=d,n.meshes||(n.meshes=[]),this._invokeAll(function(T){T.writeMesh&&T.writeMesh(e,c)});const D=n.meshes.push(c)-1;return t.meshes.set(i,D),D}detectMeshQuantization(e,t){if(this.extensionsUsed[pn])return;let n;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");const r=e.split("_",1)[0];Xn[r]&&Xn[r].includes(n)&&(this.extensionsUsed[pn]=!0,this.extensionsRequired[pn]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const n=e.isOrthographicCamera,r={type:n?"orthographic":"perspective"};return n?r.orthographic={xmag:e.right*2,ymag:e.top*2,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:vn.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},e.name!==""&&(r.name=e.type),t.cameras.push(r)-1}processAnimation(e,t){const n=this.json,r=this.nodeMap;n.animations||(n.animations=[]),e=En.Utils.mergeMorphTargetTracks(e.clone(),t);const i=e.tracks,s=[],a=[];for(let c=0;c<i.length;++c){const u=i[c],d=Wt.parseTrackName(u.name);let p=Wt.findNode(t,d.nodeName);const g=qn[d.propertyName];if(d.objectName==="bones"&&(p.isSkinnedMesh===!0?p=p.skeleton.getBoneByName(d.objectIndex):p=void 0),!p||!g)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',u.name),null;const v=1;let y=u.values.length/u.times.length;g===qn.morphTargetInfluences&&(y/=p.morphTargetInfluences.length);let S;u.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(S="CUBICSPLINE",y/=3):u.getInterpolation()===Mr?S="STEP":S="LINEAR",a.push({input:this.processAccessor(new ue(u.times,v)),output:this.processAccessor(new ue(u.values,y)),interpolation:S}),s.push({sampler:a.length-1,target:{node:r.get(p),path:g}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:a,channels:s}),n.animations.length-1}processSkin(e){const t=this.json,n=this.nodeMap,r=t.nodes[n.get(e)],i=e.skeleton;if(i===void 0)return null;const s=e.skeleton.bones[0];if(s===void 0)return null;const a=[],c=new Float32Array(i.bones.length*16),u=new Ht;for(let p=0;p<i.bones.length;++p)a.push(n.get(i.bones[p])),u.copy(i.boneInverses[p]),u.multiply(e.bindMatrix).toArray(c,p*16);return t.skins===void 0&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new ue(c,16)),joints:a,skeleton:n.get(s)}),r.skin=t.skins.length-1}processNode(e){const t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(n.trs){const a=e.quaternion.toArray(),c=e.position.toArray(),u=e.scale.toArray();Mt(a,[0,0,0,1])||(i.rotation=a),Mt(c,[0,0,0])||(i.translation=c),Mt(u,[1,1,1])||(i.scale=u)}else e.matrixAutoUpdate&&e.updateMatrix(),Gi(e.matrix)===!1&&(i.matrix=e.matrix.elements);if(e.name!==""&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const a=this.processMesh(e);a!==null&&(i.mesh=a)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const a=[];for(let c=0,u=e.children.length;c<u;c++){const d=e.children[c];if(d.visible||n.onlyVisible===!1){const p=this.processNode(d);p!==null&&a.push(p)}}a.length>0&&(i.children=a)}this._invokeAll(function(a){a.writeNode&&a.writeNode(e,i)});const s=t.nodes.push(i)-1;return r.set(e,s),s}processScene(e){const t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);const r={};e.name!==""&&(r.name=e.name),t.scenes.push(r);const i=[];for(let s=0,a=e.children.length;s<a;s++){const c=e.children[s];if(c.visible||n.onlyVisible===!1){const u=this.processNode(c);u!==null&&i.push(u)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}processObjects(e){const t=new Yt;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(r){r.beforeParse&&r.beforeParse(e)});const n=[];for(let r=0;r<e.length;r++)e[r]instanceof Yt?this.processScene(e[r]):n.push(e[r]);n.length>0&&this.processObjects(n);for(let r=0;r<this.skins.length;++r)this.processSkin(this.skins[r]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);this._invokeAll(function(r){r.afterParse&&r.afterParse(e)})}_invokeAll(e){for(let t=0,n=this.plugins.length;t<n;t++)e(this.plugins[t])}}class ji{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}const n=this.writer,r=n.json,i=n.extensionsUsed,s={};e.name&&(s.name=e.name),s.color=e.color.toArray(),s.intensity=e.intensity,e.isDirectionalLight?s.type="directional":e.isPointLight?(s.type="point",e.distance>0&&(s.range=e.distance)):e.isSpotLight&&(s.type="spot",e.distance>0&&(s.range=e.distance),s.spot={},s.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,s.spot.outerConeAngle=e.angle),e.decay!==void 0&&e.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||e.target.position.x!==0||e.target.position.y!==0||e.target.position.z!==-1)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);const a=r.extensions[this.name].lights;a.push(s),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class Zi{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class Vi{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.clearcoat===0)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){const s={index:n.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(s,e.clearcoatMap),i.clearcoatTexture=s}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const s={index:n.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(s,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=s}if(e.clearcoatNormalMap){const s={index:n.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};n.applyTextureTransform(s,e.clearcoatNormalMap),i.clearcoatNormalTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class Wi{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.iridescence===0)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){const s={index:n.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(s,e.iridescenceMap),i.iridescenceTexture=s}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const s={index:n.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(s,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class Yi{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){const s={index:n.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(s,e.transmissionMap),i.transmissionTexture=s}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class Ki{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.transmission===0)return;const n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){const s={index:n.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(s,e.thicknessMap),i.thicknessTexture=s}i.attenuationDistance=e.attenuationDistance,i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class Xi{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.ior===1.5)return;const r=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class qi{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.specularIntensity===1&&e.specularColor.equals(Ri)&&!e.specularIntensityMap&&!e.specularColorTexture)return;const n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){const s={index:n.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(s,e.specularIntensityMap),i.specularTexture=s}if(e.specularColorMap){const s={index:n.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(s,e.specularColorMap),i.specularColorTexture=s}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class Ji{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||e.sheen==0)return;const n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){const s={index:n.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(s,e.sheenRoughnessMap),i.sheenRoughnessTexture=s}if(e.sheenColorMap){const s={index:n.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(s,e.sheenColorMap),i.sheenColorTexture=s}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class Qi{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||e.emissiveIntensity===1)return;const r=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}En.Utils={insertKeyframe:function(l,e){const n=l.getValueSize(),r=new l.TimeBufferType(l.times.length+1),i=new l.ValueBufferType(l.values.length+n),s=l.createInterpolant(new l.ValueBufferType(n));let a;if(l.times.length===0){r[0]=e;for(let c=0;c<n;c++)i[c]=0;a=0}else if(e<l.times[0]){if(Math.abs(l.times[0]-e)<.001)return 0;r[0]=e,r.set(l.times,1),i.set(s.evaluate(e),0),i.set(l.values,n),a=0}else if(e>l.times[l.times.length-1]){if(Math.abs(l.times[l.times.length-1]-e)<.001)return l.times.length-1;r[r.length-1]=e,r.set(l.times,0),i.set(l.values,0),i.set(s.evaluate(e),l.values.length),a=r.length-1}else for(let c=0;c<l.times.length;c++){if(Math.abs(l.times[c]-e)<.001)return c;if(l.times[c]<e&&l.times[c+1]>e){r.set(l.times.slice(0,c+1),0),r[c+1]=e,r.set(l.times.slice(c+1),c+2),i.set(l.values.slice(0,(c+1)*n),0),i.set(s.evaluate(e),(c+1)*n),i.set(l.values.slice((c+1)*n),(c+2)*n),a=c+1;break}}return l.times=r,l.values=i,a},mergeMorphTargetTracks:function(l,e){const t=[],n={},r=l.tracks;for(let i=0;i<r.length;++i){let s=r[i];const a=Wt.parseTrackName(s.name),c=Wt.findNode(e,a.nodeName);if(a.propertyName!=="morphTargetInfluences"||a.propertyIndex===void 0){t.push(s);continue}if(s.createInterpolant!==s.InterpolantFactoryMethodDiscrete&&s.createInterpolant!==s.InterpolantFactoryMethodLinear){if(s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),s=s.clone(),s.setInterpolation(Br)}const u=c.morphTargetInfluences.length,d=c.morphTargetDictionary[a.propertyIndex];if(d===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let p;if(n[c.uuid]===void 0){p=s.clone();const v=new p.ValueBufferType(u*p.times.length);for(let y=0;y<p.times.length;y++)v[y*u+d]=p.values[y];p.name=(a.nodeName||"")+".morphTargetInfluences",p.values=v,n[c.uuid]=p,t.push(p);continue}const g=s.createInterpolant(new s.ValueBufferType(1));p=n[c.uuid];for(let v=0;v<p.times.length;v++)p.values[v*u+d]=g.evaluate(p.times[v]);for(let v=0;v<s.times.length;v++){const y=this.insertKeyframe(p,s.times[v]);p.values[y*u+d]=s.values[v]}}return l.tracks=t,l}};class es{async export(e){const t=new Yt,n=new Fe;n.name=e.root.name||"Root",n.rotation.x=-Math.PI/2,t.add(n),this.processGroup(e.root,n);const r=new En;return new Promise((i,s)=>{r.parse(t,a=>{a instanceof ArrayBuffer?i(a):s(new Error("Expected ArrayBuffer from GLTFExporter but got JSON"))},a=>{s(a)},{binary:!0,onlyVisible:!1,truncateDrawRange:!0,embedImages:!0,maxTextureSize:4096})})}processGroup(e,t){for(const n of e.children)if(n instanceof ot){const r=this.createMeshFromPrimitive(n);r&&t.add(r)}else if(n instanceof Me){const r=new Fe;r.name=n.name,this.applyTransform(r,n.transform),t.add(r),this.processGroup(n,r)}}createMeshFromPrimitive(e){let t=null;switch(e.type){case"triangle":t=this.triangleToGeometry(e);break;case"quad":t=this.quadToGeometry(e);break;case"cube":t=this.cubeToGeometry(e);break;case"revolution":t=this.revolutionToGeometry(e);break;case"mesh":t=this.meshToGeometry(e);break}if(!t)return null;const n=this.createMaterial(e.material),r=new le(t,n);return r.name=e.name,this.applyTransform(r,e.transform),r.userData={...e.userData,cifId:e.id,cifType:e.type,surfaceType:e.surfaceType},r}shouldFlipWinding(e,t,n){const r=new k().subVectors(t,e),i=new k().subVectors(n,e);return new k().crossVectors(r,i).z<0}triangleToGeometry(e){const t=new Qe,n=new k(e.vertices[0].x,e.vertices[0].y,e.vertices[0].z),r=new k(e.vertices[1].x,e.vertices[1].y,e.vertices[1].z),i=new k(e.vertices[2].x,e.vertices[2].y,e.vertices[2].z),s=this.shouldFlipWinding(n,r,i),a=s?[n,i,r]:[n,r,i],c=new Float32Array(9);for(let u=0;u<3;u++)c[u*3]=a[u].x,c[u*3+1]=a[u].y,c[u*3+2]=a[u].z;if(t.setAttribute("position",new ue(c,3)),e.normals&&e.normals.length===3){const u=s?[0,2,1]:[0,1,2],d=new Float32Array(9);for(let p=0;p<3;p++)d[p*3]=e.normals[u[p]].x,d[p*3+1]=e.normals[u[p]].y,d[p*3+2]=e.normals[u[p]].z;t.setAttribute("normal",new ue(d,3))}else t.computeVertexNormals();if(e.uvs&&e.uvs.length===3){const u=s?[0,2,1]:[0,1,2],d=new Float32Array(6);for(let p=0;p<3;p++)d[p*2]=e.uvs[u[p]].x,d[p*2+1]=e.uvs[u[p]].y;t.setAttribute("uv",new ue(d,2))}return t}quadToGeometry(e){const t=new Qe,n=new k(e.vertices[0].x,e.vertices[0].y,e.vertices[0].z),r=new k(e.vertices[1].x,e.vertices[1].y,e.vertices[1].z),i=new k(e.vertices[2].x,e.vertices[2].y,e.vertices[2].z),s=new k(e.vertices[3].x,e.vertices[3].y,e.vertices[3].z),a=this.shouldFlipWinding(n,r,i),c=a?[n,i,r]:[n,r,i],u=a?[n,s,i]:[n,i,s],d=a?[0,2,1]:[0,1,2],p=a?[0,3,2]:[0,2,3],g=new Float32Array(18);if(g[0]=c[0].x,g[1]=c[0].y,g[2]=c[0].z,g[3]=c[1].x,g[4]=c[1].y,g[5]=c[1].z,g[6]=c[2].x,g[7]=c[2].y,g[8]=c[2].z,g[9]=u[0].x,g[10]=u[0].y,g[11]=u[0].z,g[12]=u[1].x,g[13]=u[1].y,g[14]=u[1].z,g[15]=u[2].x,g[16]=u[2].y,g[17]=u[2].z,t.setAttribute("position",new ue(g,3)),e.normals&&e.normals.length===4){const v=new Float32Array(18);for(let y=0;y<3;y++)v[y*3]=e.normals[d[y]].x,v[y*3+1]=e.normals[d[y]].y,v[y*3+2]=e.normals[d[y]].z;for(let y=0;y<3;y++)v[9+y*3]=e.normals[p[y]].x,v[9+y*3+1]=e.normals[p[y]].y,v[9+y*3+2]=e.normals[p[y]].z;t.setAttribute("normal",new ue(v,3))}else t.computeVertexNormals();if(e.uvs&&e.uvs.length===4){const v=new Float32Array(12);for(let y=0;y<3;y++)v[y*2]=e.uvs[d[y]].x,v[y*2+1]=e.uvs[d[y]].y;for(let y=0;y<3;y++)v[6+y*2]=e.uvs[p[y]].x,v[6+y*2+1]=e.uvs[p[y]].y;t.setAttribute("uv",new ue(v,2))}return t}cubeToGeometry(e){const t=new Qe,n=e.vertices,r=[];return r.push(n[0].x,n[0].y,n[0].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[7].x,n[7].y,n[7].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[7].x,n[7].y,n[7].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[7].x,n[7].y,n[7].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[5].x,n[5].y,n[5].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[1].x,n[1].y,n[1].z),r.push(n[6].x,n[6].y,n[6].z),r.push(n[2].x,n[2].y,n[2].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[0].x,n[0].y,n[0].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[4].x,n[4].y,n[4].z),r.push(n[3].x,n[3].y,n[3].z),r.push(n[7].x,n[7].y,n[7].z),t.setAttribute("position",new ue(new Float32Array(r),3)),t.computeVertexNormals(),t}revolutionToGeometry(e){const t=new Qe,{profile:n,segments:r,startAngle:i,endAngle:s}=e;if(n.length<2)return t;const a=s-i,c=[];for(let u=0;u<r;u++)for(let d=0;d<n.length-1;d++){const p=i+a*u/r,g=i+a*(u+1)/r,v=Math.cos(p),y=Math.sin(p),S=Math.cos(g),_=Math.sin(g),E=n[d],D=n[d+1],T=new k(E.x*v-E.y*y,E.x*y+E.y*v,E.z),M=new k(D.x*v-D.y*y,D.x*y+D.y*v,D.z),R=new k(D.x*S-D.y*_,D.x*_+D.y*S,D.z),O=new k(E.x*S-E.y*_,E.x*_+E.y*S,E.z),F=1e-6;Math.abs(D.x)<F&&Math.abs(D.y)<F?this.shouldFlipWinding(T,M,O)?c.push(T.x,T.y,T.z,O.x,O.y,O.z,M.x,M.y,M.z):c.push(T.x,T.y,T.z,M.x,M.y,M.z,O.x,O.y,O.z):this.shouldFlipWinding(T,M,R)?(c.push(T.x,T.y,T.z,R.x,R.y,R.z,M.x,M.y,M.z),c.push(T.x,T.y,T.z,O.x,O.y,O.z,R.x,R.y,R.z)):(c.push(T.x,T.y,T.z,M.x,M.y,M.z,R.x,R.y,R.z),c.push(T.x,T.y,T.z,R.x,R.y,R.z,O.x,O.y,O.z))}return t.setAttribute("position",new ue(new Float32Array(c),3)),t.computeVertexNormals(),t}meshToGeometry(e){const t=new Qe,n=[],r=[],i=[];for(const s of e.faces)if(s.length===3){const a=new k(e.vertices[s[0]].x,e.vertices[s[0]].y,e.vertices[s[0]].z),c=new k(e.vertices[s[1]].x,e.vertices[s[1]].y,e.vertices[s[1]].z),u=new k(e.vertices[s[2]].x,e.vertices[s[2]].y,e.vertices[s[2]].z),p=this.shouldFlipWinding(a,c,u)?[s[0],s[2],s[1]]:s;for(const g of p){const v=e.vertices[g];if(n.push(v.x,v.y,v.z),e.normals&&e.normals[g]){const y=e.normals[g];r.push(y.x,y.y,y.z)}if(e.uvs&&e.uvs[g]){const y=e.uvs[g];i.push(y.x,y.y)}}}else if(s.length===4){const[a,c,u,d]=s,p=new k(e.vertices[a].x,e.vertices[a].y,e.vertices[a].z),g=new k(e.vertices[c].x,e.vertices[c].y,e.vertices[c].z),v=new k(e.vertices[u].x,e.vertices[u].y,e.vertices[u].z),y=this.shouldFlipWinding(p,g,v),S=y?[a,u,c]:[a,c,u],_=y?[a,d,u]:[a,u,d];for(const E of S){const D=e.vertices[E];if(n.push(D.x,D.y,D.z),e.normals&&e.normals[E]){const T=e.normals[E];r.push(T.x,T.y,T.z)}if(e.uvs&&e.uvs[E]){const T=e.uvs[E];i.push(T.x,T.y)}}for(const E of _){const D=e.vertices[E];if(n.push(D.x,D.y,D.z),e.normals&&e.normals[E]){const T=e.normals[E];r.push(T.x,T.y,T.z)}if(e.uvs&&e.uvs[E]){const T=e.uvs[E];i.push(T.x,T.y)}}}return t.setAttribute("position",new ue(new Float32Array(n),3)),r.length>0?t.setAttribute("normal",new ue(new Float32Array(r),3)):t.computeVertexNormals(),i.length>0&&t.setAttribute("uv",new ue(new Float32Array(i),2)),t}createMaterial(e){return new Pe({color:e.color,opacity:e.opacity,transparent:e.transparent,side:Qt,metalness:.1,roughness:.8})}applyTransform(e,t){e.position.copy(t.position),e.rotation.setFromVector3(t.rotation),e.scale.copy(t.scale)}}var ts=Object.defineProperty,ns=(l,e,t)=>e in l?ts(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,rs=(l,e,t)=>ns(l,e+"",t);const mr=class gr{static getSupportedExportFormats(){return this.EXPORT_FORMATS}static isFormatSupported(e){return this.EXPORT_FORMATS.includes(e)}async exportScene(e,t){if(!gr.isFormatSupported(t.format))throw new Error(`Unsupported export format: ${t.format}`);let n,r=t.fileName||"exported";r=r.replace(/\.[^/.]+$/,"");try{switch(t.format){case"sv":n=this.exportSV(e),r+=".txt";break;case"obj":n=this.exportOBJ(e),r+=".obj";break;case"dbacv":n=this.exportDbacv(e),r+=".dbacv";break;case"cif":n=this.exportCIF(e),r+=".cif.json";break;case"cvf":n=this.exportCVF(e),r+=".cvf";break;case"glb":n=await this.exportGLB(e),r+=".glb";break;default:throw new Error(`Unsupported format: ${t.format}`)}return{data:n,fileName:r,format:t.format,mimeType:this.getMimeType(t.format),size:n instanceof ArrayBuffer?n.byteLength:new Blob([n]).size}}catch(i){throw new Error(`Export failed: ${i instanceof Error?i.message:"Unknown error"}`)}}exportSV(e){return new Ci().export(e)}exportOBJ(e){return new Mi().export(e)}exportDbacv(e){return new Oi().export(e)}exportCIF(e){return new zi().export(e)}exportCVF(e){return new Ni().export(e)}async exportGLB(e){return new es().export(e)}getMimeType(e){switch(e){case"sv":return"text/plain";case"obj":return"text/plain";case"dbacv":return"application/xml";case"cif":return"application/json";case"cvf":return"application/json";case"glb":return"model/gltf-binary";default:return"text/plain"}}static createDownloadBlob(e){return e.data instanceof ArrayBuffer?new Blob([e.data],{type:e.mimeType}):new Blob([e.data],{type:e.mimeType})}static downloadResult(e){const t=this.createDownloadBlob(e),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download=e.fileName,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}static getFileExtension(e){switch(e){case"sv":return".txt";case"obj":return".obj";case"dbacv":return".dbacv";case"cif":return".cif.json";case"cvf":return".cvf";case"glb":return".glb";default:return".txt"}}};rs(mr,"EXPORT_FORMATS",["sv","obj","dbacv","cif","cvf","glb"]);let is=mr;const ss="modulepreload",os=function(l,e){return new URL(l,e).href},nr={},vt=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){let s=function(d){return Promise.all(d.map(p=>Promise.resolve(p).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};const a=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),u=c?.nonce||c?.getAttribute("nonce");r=s(t.map(d=>{if(d=os(d,n),d in nr)return;nr[d]=!0;const p=d.endsWith(".css"),g=p?'[rel="stylesheet"]':"";if(!!n)for(let S=a.length-1;S>=0;S--){const _=a[S];if(_.href===d&&(!p||_.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${g}`))return;const y=document.createElement("link");if(y.rel=p?"stylesheet":ss,p||(y.as="script"),y.crossOrigin="",y.href=d,u&&y.setAttribute("nonce",u),document.head.appendChild(y),p)return new Promise((S,_)=>{y.addEventListener("load",S),y.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(s){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s}return r.then(s=>{for(const a of s||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})};var as=Object.defineProperty,cs=(l,e,t)=>e in l?as(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Ct=(l,e,t)=>cs(l,typeof e!="symbol"?e+"":e,t);class ls{constructor(e,t,n,r={}){Ct(this,"renderer"),Ct(this,"scene"),Ct(this,"camera"),Ct(this,"composer"),Ct(this,"options"),this.renderer=e,this.scene=t,this.camera=n,this.options={enableSSAO:!0,enableBloom:!0,enableFXAA:!0,enableOutlines:!1,bloomThreshold:.8,bloomStrength:.5,bloomRadius:.4,ssaoRadius:.3,ssaoMinDistance:.005,ssaoMaxDistance:.1,outlineThickness:.003,outlineColor:0,...r},this.setupPostProcessing()}async setupPostProcessing(){try{const{EffectComposer:e}=await vt(async()=>{const{EffectComposer:u}=await import("./EffectComposer-DiPw_UWQ.js");return{EffectComposer:u}},__vite__mapDeps([0,1,2,3,4]),import.meta.url),{RenderPass:t}=await vt(async()=>{const{RenderPass:u}=await import("./RenderPass-izMPNzSc.js");return{RenderPass:u}},__vite__mapDeps([5,1,4]),import.meta.url),{ShaderPass:n}=await vt(async()=>{const{ShaderPass:u}=await import("./ShaderPass-B1yiaKM_.js");return{ShaderPass:u}},__vite__mapDeps([3,1,4]),import.meta.url),{UnrealBloomPass:r}=await vt(async()=>{const{UnrealBloomPass:u}=await import("./UnrealBloomPass-Bq7yDCkQ.js");return{UnrealBloomPass:u}},__vite__mapDeps([6,1,4,2]),import.meta.url),{SSAOPass:i}=await vt(async()=>{const{SSAOPass:u}=await import("./SSAOPass-D3mFbYdI.js");return{SSAOPass:u}},__vite__mapDeps([7,1,4,2]),import.meta.url),{FXAAShader:s}=await vt(async()=>{const{FXAAShader:u}=await import("./FXAAShader-WBPB6ysx.js");return{FXAAShader:u}},__vite__mapDeps([8,1]),import.meta.url),{OutlinePass:a}=await vt(async()=>{const{OutlinePass:u}=await import("./OutlinePass-BgQqcNOP.js");return{OutlinePass:u}},__vite__mapDeps([9,1,4,2]),import.meta.url);this.composer=new e(this.renderer);const c=new t(this.scene,this.camera);if(this.composer.addPass(c),this.options.enableSSAO){const u=new i(this.scene,this.camera,window.innerWidth,window.innerHeight);u.kernelRadius=this.options.ssaoRadius,u.minDistance=this.options.ssaoMinDistance,u.maxDistance=this.options.ssaoMaxDistance,this.composer.addPass(u)}if(this.options.enableBloom){const u=new r(new Vt(window.innerWidth,window.innerHeight),this.options.bloomStrength,this.options.bloomRadius,this.options.bloomThreshold);this.composer.addPass(u)}if(this.options.enableOutlines){const u=new a(new Vt(window.innerWidth,window.innerHeight),this.scene,this.camera);u.edgeStrength=3,u.edgeGlow=.5,u.edgeThickness=this.options.outlineThickness,u.pulsePeriod=2,u.visibleEdgeColor.setHex(this.options.outlineColor),u.hiddenEdgeColor.setHex(1640965),this.composer.addPass(u)}if(this.options.enableFXAA){const u=new n(s);u.material.uniforms.resolution.value.x=1/window.innerWidth,u.material.uniforms.resolution.value.y=1/window.innerHeight,this.composer.addPass(u)}}catch(e){console.warn("Post-processing effects not available:",e),this.composer=null}}render(){this.composer?this.composer.render():this.renderer.render(this.scene,this.camera)}resize(e,t){this.composer&&(this.composer.setSize(e,t),this.composer.passes.forEach(n=>{n.material&&n.material.uniforms&&n.material.uniforms.resolution&&(n.material.uniforms.resolution.value.x=1/e,n.material.uniforms.resolution.value.y=1/t)}))}setOutlineObjects(e){if(this.composer&&this.options.enableOutlines){const t=this.composer.passes.find(n=>n.constructor.name==="OutlinePass");t&&(t.selectedObjects=e)}}updateOptions(e){if(this.options={...this.options,...e},this.composer){const t=this.composer.passes.find(i=>i.constructor.name==="UnrealBloomPass");t&&(t.threshold=this.options.bloomThreshold,t.strength=this.options.bloomStrength,t.radius=this.options.bloomRadius);const n=this.composer.passes.find(i=>i.constructor.name==="SSAOPass");n&&(n.kernelRadius=this.options.ssaoRadius,n.minDistance=this.options.ssaoMinDistance,n.maxDistance=this.options.ssaoMaxDistance);const r=this.composer.passes.find(i=>i.constructor.name==="OutlinePass");r&&(r.edgeThickness=this.options.outlineThickness,r.visibleEdgeColor.setHex(this.options.outlineColor))}}dispose(){this.composer&&this.composer.dispose()}}var us=Object.defineProperty,fs=(l,e,t)=>e in l?us(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,Xt=(l,e,t)=>fs(l,typeof e!="symbol"?e+"":e,t);class qt{static createWireframe(e,t={}){const n={...this.DEFAULT_WIREFRAME_OPTIONS,...t};let r;switch(n.mode){case"edges":r=new tn(e,15);break;case"silhouette":r=this.createSilhouetteGeometry(e);break;case"basic":default:r=new Ur(e);break}const i=new Mn({color:n.color,opacity:n.opacity,transparent:n.opacity<1,linewidth:n.lineWidth,depthTest:n.depthTest}),s=new kn(r,i);return s.renderOrder=n.renderOrder,s}static createSelectionOutline(e,t={}){const n={...this.DEFAULT_OUTLINE_OPTIONS,...t},r=new Fe,i=new le(e.geometry,e.material);i.position.copy(e.position),i.rotation.copy(e.rotation),i.scale.copy(e.scale),i.userData={...e.userData};const s=new Gt({color:n.color,side:$t,transparent:!0,opacity:.8}),a=new le(e.geometry,s);if(a.position.copy(e.position),a.rotation.copy(e.rotation),a.scale.copy(e.scale).multiplyScalar(1+n.thickness),a.renderOrder=-1,r.add(a),r.add(i),n.glow){const c=new Gt({color:n.color,transparent:!0,opacity:.3,side:$t}),u=new le(e.geometry,c);u.position.copy(e.position),u.rotation.copy(e.rotation),u.scale.copy(e.scale).multiplyScalar(1+n.thickness*2),u.renderOrder=-2,r.add(u)}return n.pulse&&(r.pulseOptions=n,r.startTime=Date.now()),r.__isOutlineGroup=!0,r}static updatePulsingOutlines(e){const t=Date.now();e.forEach(n=>{const r=n.pulseOptions,i=n.startTime;if(r&&i){const s=(t-i)/1e3,a=(Math.sin(s*Math.PI*2/r.pulsePeriod)+1)/2;n.children.forEach(c=>{if(c instanceof le&&c.material instanceof Gt){const u=c.material;u.side===$t&&(u.opacity=.5+a*.3)}})}})}static createSilhouetteGeometry(e){return new tn(e,30)}static createEnhancedMaterial(e,t={}){const n=new Pe({color:e,side:Qt});return t.wireframeOverlay&&(n.wireframeOverlay=!0),n}static toggleWireframeMode(e,t){e.traverse(n=>{n instanceof le&&(t?Array.isArray(n.material)?n.material.forEach(r=>{r instanceof Pe&&(r.wireframe=!0)}):n.material instanceof Pe&&(n.material.wireframe=!0):Array.isArray(n.material)?n.material.forEach(r=>{r instanceof Pe&&(r.wireframe=!1)}):n.material instanceof Pe&&(n.material.wireframe=!1))})}static createEdgeHighlight(e,t=16777215,n=2){const r=new tn(e,10),i=new Mn({color:t,linewidth:n,transparent:!0,opacity:.9,depthTest:!1}),s=new kn(r,i);return s.renderOrder=999,s}}Xt(qt,"DEFAULT_WIREFRAME_OPTIONS",{enabled:!0,color:4210752,opacity:.8,lineWidth:1,mode:"edges",depthTest:!0,renderOrder:1});Xt(qt,"DEFAULT_OUTLINE_OPTIONS",{color:65280,thickness:.005,glow:!0,animated:!1,pulse:!0,pulsePeriod:2});class ds{constructor(){Xt(this,"selectedObjects",new Set),Xt(this,"outlineGroups",new Map)}isOutlineGroup(e){return e.__isOutlineGroup===!0}isChildOfOutlineGroup(e){let t=e.parent;for(;t;){if(t.__isOutlineGroup===!0)return!0;t=t.parent}return!1}selectObject(e,t){if(!this.selectedObjects.has(e)&&!(this.isOutlineGroup(e)||this.isChildOfOutlineGroup(e))&&(this.selectedObjects.add(e),e instanceof le)){const n=qt.createSelectionOutline(e,t);n.__isOutlineGroup=!0,this.outlineGroups.set(e,n);const r=e.parent;r&&(r.remove(e),r.add(n))}}deselectObject(e){if(!this.selectedObjects.has(e))return;this.selectedObjects.delete(e);const t=this.outlineGroups.get(e);if(t&&e instanceof le){const n=t.parent;n&&(n.remove(t),n.add(e)),this.outlineGroups.delete(e)}}clearSelection(){Array.from(this.selectedObjects).forEach(t=>this.deselectObject(t))}updateAnimations(){const e=Array.from(this.outlineGroups.values());qt.updatePulsingOutlines(e)}getSelectedObjects(){return Array.from(this.selectedObjects)}deleteObject(e){if(!this.selectedObjects.has(e))return!1;const t=this.outlineGroups.get(e);if(t&&e instanceof le){const n=t.parent;n&&(n.remove(t),t.traverse(r=>{r instanceof le&&(r.geometry&&r.geometry.dispose(),r.material&&(Array.isArray(r.material)?r.material.forEach(i=>i.dispose()):r.material.dispose()))})),this.outlineGroups.delete(e)}else{const n=e.parent;n&&n.remove(e)}return e.traverse(n=>{n instanceof le&&(n.geometry&&n.geometry.dispose(),n.material&&(Array.isArray(n.material)?n.material.forEach(r=>r.dispose()):n.material.dispose()))}),this.selectedObjects.delete(e),!0}}var hs=Object.defineProperty,ps=(l,e,t)=>e in l?hs(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t,ut=(l,e,t)=>ps(l,typeof e!="symbol"?e+"":e,t);class ms{constructor(){ut(this,"treePanel",null),ut(this,"treeContent",null),ut(this,"currentScene",null),ut(this,"threeScene",null),ut(this,"selectedNodeId",null),ut(this,"onNodeSelect"),ut(this,"collapsedNodes",new Set),ut(this,"isInitialLoad",!0),this.initializeUI()}initializeUI(){if(this.treePanel=document.getElementById("sceneTreePanel"),this.treeContent=document.getElementById("sceneTreeRoot"),!this.treePanel||!this.treeContent){console.error("Scene tree UI elements not found");return}this.setupEventListeners()}setupEventListeners(){document.getElementById("showSceneTree")?.addEventListener("click",()=>{this.togglePanel()}),document.getElementById("closeTreePanel")?.addEventListener("click",()=>{this.hidePanel()}),document.getElementById("toggleTreePanel")?.addEventListener("click",()=>{this.toggleCollapse()}),document.getElementById("refreshSceneTree")?.addEventListener("click",()=>{this.refresh()})}setScene(e,t){this.currentScene=e,this.threeScene=t,this.buildTree()}setNodeSelectCallback(e){this.onNodeSelect=e}showPanel(){this.treePanel&&(this.treePanel.style.display="block",this.refresh())}hidePanel(){this.treePanel&&(this.treePanel.style.display="none")}togglePanel(){this.treePanel&&(this.treePanel.style.display==="none"||!this.treePanel.style.display?this.showPanel():this.hidePanel())}toggleCollapse(){this.treePanel&&this.treePanel.classList.toggle("collapsed")}refresh(){if(this.currentScene&&this.threeScene){const e=this.selectedNodeId;this.saveCollapseState(),this.isInitialLoad=!1,this.buildTree(),this.restoreCollapseState(),e&&this.restoreSelection(e)}}restoreSelection(e){const t=this.treeContent?.querySelector(`[data-node-id="${e}"]`);t?(this.selectedNodeId=e,t.classList.add("selected")):this.selectedNodeId=null}saveCollapseState(){if(this.collapsedNodes.clear(),!this.treeContent)return;this.treeContent.querySelectorAll(".tree-children.collapsed").forEach(t=>{const n=t.closest(".tree-node");if(n){const r=n.querySelector(".tree-item");if(r){const i=r.getAttribute("data-node-id");i&&this.collapsedNodes.add(i)}}})}restoreCollapseState(){this.treeContent&&this.collapsedNodes.forEach(e=>{const t=this.treeContent.querySelector(`[data-node-id="${e}"]`);if(t){const n=t.closest(".tree-node");if(n){const r=n.querySelector(".tree-children"),i=n.querySelector(".tree-toggle");r&&i&&(r.classList.add("collapsed"),i.textContent="")}}})}buildTree(){if(!this.currentScene||!this.treeContent)return;this.treeContent.innerHTML="";const e=this.createTreeNodeFromCIF(this.currentScene.root);if(e){const t=this.createTreeElement(e,!0);this.treeContent.appendChild(t)}this.isInitialLoad&&(this.isInitialLoad=!1)}createTreeNodeFromCIF(e){const t={id:e.id,name:e.name||"Unnamed",type:"children"in e?"group":"primitive",visible:e.visible,locked:e.locked,cifObject:e,children:[]};if("type"in e&&(t.primitiveType=e.type),this.threeScene&&(t.object=this.findThreeObjectByCifId(this.threeScene,e.id)),"children"in e)for(const n of e.children){const r=this.createTreeNodeFromCIF(n);t.children.push(r)}return t}findThreeObjectByCifId(e,t){if(e.userData.cifId===t)return e;for(const n of e.children){const r=this.findThreeObjectByCifId(n,t);if(r)return r}}createTreeElement(e,t=!1){const n=document.createElement("div");n.className="tree-node";const r=document.createElement("div");r.className=`tree-item ${e.type}`,r.dataset.nodeId=e.id;const i=document.createElement("div");if(i.className="tree-toggle",e.type==="group"&&e.children.length>0){const c=this.isInitialLoad&&!t&&!this.collapsedNodes.has(e.id),u=this.collapsedNodes.has(e.id);i.textContent=c||u?"":"",i.addEventListener("click",d=>{d.stopPropagation(),this.toggleNode(n)})}else i.textContent="";r.appendChild(i);const s=document.createElement("div");s.className="tree-icon",s.textContent=this.getNodeIcon(e),r.appendChild(s);const a=document.createElement("div");if(a.className="tree-label",a.textContent=e.name,r.appendChild(a),e.type==="group"&&e.children.length>0){const c=document.createElement("div");c.className="tree-stats",c.textContent=`(${e.children.length})`,r.appendChild(c)}if(r.addEventListener("click",c=>{c.stopPropagation(),this.selectNode(e)}),n.appendChild(r),e.children.length>0){const c=document.createElement("div");c.className="tree-children";const u=this.isInitialLoad&&!t&&!this.collapsedNodes.has(e.id),d=this.collapsedNodes.has(e.id);(u||d)&&(c.classList.add("collapsed"),u&&this.collapsedNodes.add(e.id));for(const p of e.children){const g=this.createTreeElement(p,!1);c.appendChild(g)}n.appendChild(c)}return n}getNodeIcon(e){if(e.type==="group")return"";switch(e.primitiveType){case"triangle":return"";case"quad":return"";case"cube":return"";case"revolution":return"";case"mesh":return"";default:return""}}toggleNode(e){const t=e.querySelector(".tree-children"),n=e.querySelector(".tree-toggle"),r=e.querySelector(".tree-item");if(t&&n&&r){const i=r.getAttribute("data-node-id"),s=t.classList.contains("collapsed");t.classList.toggle("collapsed"),n.textContent=t.classList.contains("collapsed")?"":"",i&&(s?this.collapsedNodes.delete(i):this.collapsedNodes.add(i))}}selectNode(e){this.selectedNodeId&&this.treeContent?.querySelector(`[data-node-id="${this.selectedNodeId}"]`)?.classList.remove("selected"),this.selectedNodeId=e.id,this.treeContent?.querySelector(`[data-node-id="${e.id}"]`)?.classList.add("selected"),this.onNodeSelect&&this.onNodeSelect(e)}selectNodeById(e){if(this.selectedNodeId===e)return;const t=n=>{if(n.id===e)return n;for(const r of n.children){const i=t(r);if(i)return i}return null};if(this.currentScene){const n=this.createTreeNodeFromCIF(this.currentScene.root),r=t(n);r&&this.selectNode(r)}}expandToNode(e){const t=this.findPathToNode(e);for(const n of t){const r=this.treeContent?.querySelector(`[data-node-id="${n}"]`)?.closest(".tree-node");if(r){const i=r.querySelector(".tree-children"),s=r.querySelector(".tree-toggle");i&&s&&(i.classList.remove("collapsed"),s.textContent="")}}}findPathToNode(e){const t=(n,r)=>{const i=[...r,n.id];if(n.id===e)return i;for(const s of n.children){const a=t(s,i);if(a)return a}return null};if(this.currentScene){const n=this.createTreeNodeFromCIF(this.currentScene.root);return t(n,[])||[]}return[]}}const ft=new ms,gs=new bn,vs=new is,tt=document.getElementById("drop"),X=new Yt;let _e=null,De=null,Rt=null,Lt=null,gn=null,se=null;const Ne=new Set;let bt=!1;const dt=[],ys=10;document.body.addEventListener("dragover",l=>{l.stopPropagation(),l.preventDefault(),l.dataTransfer.dropEffect="copy",tt&&(tt.style.backgroundColor="#e8f5e8",tt.style.borderColor="#4CAF50")});document.body.addEventListener("dragleave",l=>{tt&&!tt.contains(l.relatedTarget)&&(tt.style.backgroundColor="",tt.style.borderColor="")});async function Dt(l){try{if(!_e){xe("No scene loaded to export","error");return}const e=bs()||"Convertifer3d",t=await vs.exportScene(_e,{format:l,fileName:e}),n=t.data instanceof ArrayBuffer?new Blob([t.data],{type:t.mimeType}):new Blob([t.data],{type:t.mimeType});qr(n,t.fileName),xe(`${l.toUpperCase()} file exported successfully!`,"success")}catch(e){console.error("Export error:",e),xe(`Error exporting ${l.toUpperCase()} file`,"error")}}document.getElementById("exportSV")?.addEventListener("click",()=>Dt("sv"));document.getElementById("exportOBJ")?.addEventListener("click",()=>Dt("obj"));document.getElementById("exportDBACV")?.addEventListener("click",()=>Dt("dbacv"));document.getElementById("exportCIF")?.addEventListener("click",()=>Dt("cif"));document.getElementById("exportGLB")?.addEventListener("click",()=>Dt("glb"));document.getElementById("file_upload")?.addEventListener("change",l=>{const e=l;e.target.files&&vr(l,e.target.files)});document.body.addEventListener("drop",l=>{l.stopPropagation(),l.preventDefault(),tt&&(tt.style.backgroundColor="",tt.style.borderColor=""),l.dataTransfer?.files&&vr(l,l.dataTransfer.files)});function bs(){if(_e?.metadata.originalFileName)return _e.metadata.originalFileName.replace(/\.[^/.]+$/,"");let l="Convertifer3d";return X.traverse(e=>{if(e.userData.originalFileName){l=e.userData.originalFileName.replace(/\.[^/.]+$/,"");return}}),l}async function vr(l,e){if(l.stopPropagation(),l.preventDefault(),e.length===0){xe("No file selected","error");return}const t=e[0],n=bn.validateFile(t);if(!n.valid){xe(n.error,"error");return}const r=xs(t.name);xe(`Loading ${r.toUpperCase()} file...`,"info");try{const i=await bn.readFile(t),s=await gs.processFile(i,t.name);if(s.cifScene)_e=s.cifScene,_s(s.cifScene),xe(`File loaded successfully! Objects: ${s.metadata.objectCount} (${s.metadata.processingTime.toFixed(1)}ms)`,"success");else throw new Error("No scene data generated from file")}catch(i){console.error("File processing error:",i),xe(i instanceof Error?i.message:"Error loading file. Please check the file format.","error")}}function xs(l){return l.split(".").pop()?.toLowerCase()||""}function _s(l){br(X),X.clear(),Ne.clear(),bt=!1,_e=l,Kt.onSelectionChange=t=>{In(t)},Kt.onDelete=t=>{"removeNode"in ft&&ft.removeNode(t.id)};const e=l.root.render();X.add(e),yr(),ft.setScene(l,X),ft.setNodeSelectCallback(t=>{t.cifObject&&xr(t.cifObject)})}function yr(){const l=new Gr(75,window.innerWidth/window.innerHeight,.1,1e3),e=new $r({antialias:!0,alpha:!0,powerPreference:"high-performance"});Rt=e,Lt=l,e.shadowMap.enabled=!0,e.shadowMap.type=Hr,e.toneMapping=jr,e.toneMappingExposure=1.5,e.outputColorSpace=ir,e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(Math.min(window.devicePixelRatio,2));const t=document.getElementById("drop");t&&(t.style.display="none"),X.background=new Be(15790320);const n=document.querySelector("canvas");n&&n.remove(),document.body.appendChild(e.domElement);const r=new Xr(l,e.domElement,X);De=new ls(e,X,l,{enableSSAO:!1,enableBloom:!1,enableFXAA:!0,enableOutlines:!1,bloomThreshold:.8,bloomStrength:.3,bloomRadius:.4}),r.addEventListener("change",()=>{l.up=new k(0,0,1),De?De.render():e.render(X,l)});const i=new jt().setFromObject(X);if(i.isEmpty())l.position.set(-30,-30,30),l.lookAt(0,0,0);else{const M=i.getCenter(new k),R=i.getSize(new k),O=Math.max(R.x,R.y,R.z),F=l.fov*(Math.PI/180);let G=Math.abs(O/2/Math.tan(F/2));G*=2,l.position.set(M.x-G,M.y-G,M.z+G),l.lookAt(M)}l.up=new k(0,0,1),r.update();const s=new Zr,a=new Vt;let c=null;if(!X.getObjectByName("axes")){const M=new Vr(5);M.name="axes",X.add(M)}function d(M){a.x=M.clientX/window.innerWidth*2-1,a.y=-(M.clientY/window.innerHeight)*2+1,s.setFromCamera(a,l);const R=s.intersectObjects(X.children,!0);if(c&&c instanceof le){const O=c.userData.originalMaterial;O&&(c.material=O,delete c.userData.originalMaterial),c=null}if(R.length>0){const G=R[0].object.userData.cifObject?.getThreeObject();if(G instanceof le&&G!==c){c=G;const Z=c;Z.userData.originalMaterial=Z.material,Z.material=Z.material.clone(),Z.material instanceof Pe&&Z.material.emissive.setHex(4473924)}}document.body.style.cursor=c?"pointer":"default"}if(gn=new ds,!X.getObjectByName("ambientLight")){const M=new Wr(8421504,.8);M.name="ambientLight",X.add(M)}if(!X.getObjectByName("directionalLight")){const M=new Fn(16777215,1.2);M.position.set(10,10,5),M.name="directionalLight",X.add(M)}if(!X.getObjectByName("fillLight")){const M=new Fn(16777215,.7);M.position.set(-10,5,-5),M.name="fillLight",X.add(M)}function y(M){a.x=M.clientX/window.innerWidth*2-1,a.y=-(M.clientY/window.innerHeight)*2+1,s.setFromCamera(a,l);const R=s.intersectObjects(X.children,!0);if(R.length>0){const O=R[0].object,F=ws(O,M);F?se===F?kt():xr(F):kt()}else kt()}const S=window.onPointerMoveHandler;S&&window.removeEventListener("pointermove",S);const _=window.onPointerClickHandler;_&&window.removeEventListener("click",_),window.onPointerMoveHandler=d,window.onPointerClickHandler=y,window.addEventListener("pointermove",d),window.addEventListener("click",y);function E(){l.aspect=window.innerWidth/window.innerHeight,l.updateProjectionMatrix(),e.setSize(window.innerWidth,window.innerHeight),De&&De.resize(window.innerWidth,window.innerHeight)}const D=window.onWindowResizeHandler;D&&window.removeEventListener("resize",D),window.onWindowResizeHandler=E,window.addEventListener("resize",E);function T(){requestAnimationFrame(T),r.update(),gn&&gn?.updateAnimations(),De?De.render():e.render(X,l)}De?De.render():e.render(X,l),T()}function xe(l,e="info"){let t=document.getElementById("notification");t||(t=document.createElement("div"),t.id="notification",t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            word-wrap: break-word;
            transition: opacity 0.3s ease;
        `,document.body.appendChild(t));const n={success:"#4CAF50",error:"#f44336",info:"#2196F3"};t.style.backgroundColor=n[e],t.textContent=l,t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},5e3)}function br(l){l.traverse(e=>{if(e instanceof le){const t=e;t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(n=>n.dispose()):t.material.dispose())}})}function ws(l,e){if(l.userData.cifObject){let n=l.userData.cifObject;if(e.shiftKey&&n.parentId){let r=_e?.findById(n.parentId);for(;r&&r.parentId;){const i=_e?.findById(r.parentId);if(i)r=i;else break}r instanceof Me&&(n=r)}else if(e.ctrlKey&&n.parentId){const r=_e?.findById(n.parentId);r instanceof Me&&(n=r)}return n}let t=l.parent;for(;t&&t!==X;){if(t.userData.cifObject)return t.userData.cifObject;t=t.parent}return null}function xr(l){kt(),se=l,l.select(),ft.selectNodeById(l.id),ft.expandToNode(l.id)}function kt(){se&&(se.deselect(),se=null,_r())}function In(l){const e=Ss(l);Cs(e)}function xn(){kt()}function Ts(){if(dt.length===0){xe("Nothing to undo","info");return}if(!_e){xe("No scene available for undo","error");return}const l=dt.pop(),{cifObject:e,parentId:t,childIndex:n,objectName:r,objectType:i}=l;try{let s;if(t){const p=_e.findById(t);if(!p||!("children"in p))throw new Error(`Parent object with ID ${t} not found or is not a group`);s=p}else s=_e.root;const a=e.name,c=e.clone();c.name=a,c.parentId=t||void 0,n>=0&&n<=s.children.length?s.children.splice(n,0,c):s.children.push(c);const u=c.render();let d;if(t){const g=_e.findById(t)?.getThreeObject();g instanceof Fe?d=g:d=X.children[0]}else d=X.children[0];d?d.add(u):X.add(u),De?De.render():Rt&&Lt&&Rt.render(X,Lt),Jt(),ft.refresh(),xe(`${i} "${r}" restored successfully`,"success")}catch(s){console.error("Error during undo operation:",s),xe(`Failed to restore ${i} "${r}": ${s}`,"error"),dt.push(l),Jt()}}function Jt(){const l=document.getElementById("undoDelete");l&&(dt.length>0?(l.removeAttribute("disabled"),l.textContent=`Undo Delete (${dt.length})`):(l.setAttribute("disabled","true"),l.textContent="Undo Delete"))}function As(l){const e=document.getElementById("objectInfoPanel"),t=document.getElementById("objectInfoDetails");if(!e||!t)return;const n=Ms(l),r=l instanceof Fe;t.innerHTML=`
        <div><strong>Name:</strong> ${n.name}</div>
        <div><strong>Type:</strong> ${n.type}</div>
        ${r?`<div><strong>Children:</strong> ${n.children} meshes</div>`:""}
        <div><strong>Position:</strong> ${n.position}</div>
        <div><strong>Rotation:</strong> ${n.rotation}</div>
        <div><strong>Scale:</strong> ${n.scale}</div>
        <div><strong>Vertices:</strong> ${n.vertices}</div>
        <div><strong>Faces:</strong> ${n.faces}</div>
        ${n.material?`<div><strong>Material${r?"s":""}:</strong> ${n.material}</div>`:""}
        ${n.cifType?`<div><strong>CIF Type:</strong> ${n.cifType}</div>`:""}
        ${n.surfaceType?`
            <div>
                <strong>Surface Type:</strong>
                <select id="surfaceTypeSelector">
                    <option value="listen" ${n.surfaceType==="listen"?"selected":""}>Listen</option>
                    <option value="obstacle" ${n.surfaceType==="obstacle"?"selected":""}>Obstacle</option>
                    <option value="structure" ${n.surfaceType==="structure"?"selected":""}>Structure</option>
                </select>
            </div>
        `:""}
        <div class="solo-controls">
            <button id="soloButton" class="solo-btn ${Ne.has(l)?"active":""}">${Ne.has(l)?"Un-Solo":"Solo"}</button>
            ${bt?'<button id="clearSoloButton" class="clear-solo-btn">Clear All Solo</button>':""}
        </div>
    `;const i=e._clickHandler;i&&e.removeEventListener("click",i);const s=document.getElementById("surfaceTypeSelector");s&&s.addEventListener("change",d=>{const p=d.target.value;Es(l,p)});const a=document.getElementById("soloButton");a&&a.addEventListener("click",d=>{d.stopPropagation(),wr(l)});const c=document.getElementById("clearSoloButton");c&&c.addEventListener("click",d=>{d.stopPropagation(),Tr()});const u=d=>{d.stopPropagation()};e.addEventListener("click",u),e._clickHandler=u,e.style.display="block"}function Es(l,e){if(l.userData.surfaceType=e,_e&&l.userData.cifId){const t=te.findObjectById(_e.root,l.userData.cifId);t&&"surfaceType"in t&&(t.surfaceType=e)}l instanceof Fe&&l.traverse(t=>{if(t!==l&&t.userData.cifId&&(t.userData.surfaceType=e,_e)){const n=te.findObjectById(_e.root,t.userData.cifId);n&&"surfaceType"in n&&(n.surfaceType=e)}}),xe(`Surface type updated to "${e}"`,"success")}function Is(l,e){"surfaceType"in l&&(l.surfaceType=e);const t=l.getThreeObject();t&&(t.userData.surfaceType=e),l instanceof Me&&l.traverse(n=>{if(n!==l&&"surfaceType"in n){n.surfaceType=e;const r=n.getThreeObject();r&&(r.userData.surfaceType=e)}}),xe(`Surface type updated to "${e}"`,"success")}function _r(){const l=document.getElementById("objectInfoPanel");if(l){const e=l._clickHandler;e&&(l.removeEventListener("click",e),delete l._clickHandler),l.style.display="none"}}function Ss(l){const e={name:l.name||`${l.constructor.name} (${l.id})`,type:l instanceof Me?"CIF Group":`CIF ${l.type}`,position:`${l.transform.position.x.toFixed(2)}, ${l.transform.position.y.toFixed(2)}, ${l.transform.position.z.toFixed(2)}`,rotation:`${(l.transform.rotation.x*180/Math.PI).toFixed(1)}, ${(l.transform.rotation.y*180/Math.PI).toFixed(1)}, ${(l.transform.rotation.z*180/Math.PI).toFixed(1)}`,scale:`${l.transform.scale.x.toFixed(2)}, ${l.transform.scale.y.toFixed(2)}, ${l.transform.scale.z.toFixed(2)}`,cifId:l.id,visible:l.visible,locked:l.locked};if(l instanceof Me){e.childCount=l.children.length;let t=0,n=0;l.traverse(r=>{r instanceof Ft?(t+=3,n+=1):r instanceof Ot?(t+=4,n+=2):r instanceof zt&&(t+=r.vertices.length,n+=r.faces.length)}),e.vertices=t.toString(),e.faces=n.toString()}else{const t=l;"surfaceType"in t&&(e.surfaceType=t.surfaceType,e.materialColor=`#${t.material.color.getHexString()}`),l instanceof Ft?(e.vertices="3",e.faces="1"):l instanceof Ot?(e.vertices="4",e.faces="2"):l instanceof zt&&(e.vertices=l.vertices.length.toString(),e.faces=l.faces.length.toString())}return e}function Cs(l){const e=document.getElementById("objectInfoPanel"),t=document.getElementById("objectInfoDetails");if(!e||!t)return;let n="";for(const[u,d]of Object.entries(l)){if(u==="cifId")continue;const p=u.charAt(0).toUpperCase()+u.slice(1).replace(/([A-Z])/g," $1");u==="surfaceType"?n+=`
                <div>
                    <strong>Surface Type:</strong>
                    <select id="surfaceTypeSelector">
                        <option value="listen" ${d==="listen"?"selected":""}>Listen</option>
                        <option value="obstacle" ${d==="obstacle"?"selected":""}>Obstacle</option>
                        <option value="structure" ${d==="structure"?"selected":""}>Structure</option>
                    </select>
                </div>
            `:n+=`<div><strong>${p}:</strong> ${d}</div>`}if(se&&se.getThreeObject()){const u=se.getThreeObject();n+=`
            <div class="solo-controls">
                <button id="soloButton" class="solo-btn ${Ne.has(u)?"active":""}">${Ne.has(u)?"Un-Solo":"Solo"}</button>
                ${bt?'<button id="clearSoloButton" class="clear-solo-btn">Clear All Solo</button>':""}
            </div>
        `}t.innerHTML=n;const r=document.getElementById("surfaceTypeSelector");r&&se&&r.addEventListener("change",u=>{const d=u.target.value;Is(se,d)});const i=document.getElementById("soloButton");if(i&&se&&se.getThreeObject()){const u=se.getThreeObject();i.addEventListener("click",d=>{d.stopPropagation(),wr(u)})}const s=document.getElementById("clearSoloButton");s&&s.addEventListener("click",u=>{u.stopPropagation(),Tr()});const a=e._clickHandler;a&&e.removeEventListener("click",a);const c=u=>{u.stopPropagation()};e.addEventListener("click",c),e._clickHandler=c,e.style.display="block"}function Ms(l){let e=l.name;(!e||e.trim()==="")&&(l.userData.cifType?(e=`${l.userData.cifType.charAt(0).toUpperCase()+l.userData.cifType.slice(1)}`,l.userData.cifId&&(e+=` (${l.userData.cifId})`)):(e=`${l.type}`,l.userData.cifId&&(e+=` (${l.userData.cifId})`)));const t={name:e,type:l.type,position:`${l.position.x.toFixed(2)}, ${l.position.y.toFixed(2)}, ${l.position.z.toFixed(2)}`,rotation:`${(l.rotation.x*180/Math.PI).toFixed(1)}, ${(l.rotation.y*180/Math.PI).toFixed(1)}, ${(l.rotation.z*180/Math.PI).toFixed(1)}`,scale:`${l.scale.x.toFixed(2)}, ${l.scale.y.toFixed(2)}, ${l.scale.z.toFixed(2)}`,vertices:"N/A",faces:"N/A"};if(l instanceof Fe){let n=0,r=0,i=0;const s=new Set;l.traverse(a=>{a instanceof le&&a.geometry&&(i++,a.geometry.attributes.position&&(n+=a.geometry.attributes.position.count||0),a.geometry.index&&(r+=Math.floor(a.geometry.index.count/3)),a.material&&(Array.isArray(a.material)?a.material.forEach(c=>s.add(c.type)):s.add(a.material.type)))}),t.children=i.toString(),t.vertices=n>0?n.toString():"N/A",t.faces=r>0?r.toString():"N/A",t.material=s.size>0?Array.from(s).join(", "):"N/A"}else if(l instanceof le&&l.geometry){const n=l.geometry;if(n.attributes.position&&(t.vertices=(n.attributes.position.count||0).toString()),n.index&&(t.faces=Math.floor(n.index.count/3).toString()),l.material)if(Array.isArray(l.material))t.material=`Multiple (${l.material.length})`;else if(l.material instanceof Pe){const r=l.material.color;t.material=`Standard (#${r.getHexString()})`}else t.material=l.material.type}return l.userData.cifType&&(t.cifType=l.userData.cifType),l.userData.surfaceType&&(t.surfaceType=l.userData.surfaceType),t}function ks(){const l=document.getElementById("objectInfoPanel");l&&l.classList.toggle("collapsed")}document.addEventListener("keydown",l=>{if(l.ctrlKey||l.metaKey)switch(l.key.toLowerCase()){case"o":l.preventDefault(),document.getElementById("file_upload")?.click();break;case"s":l.preventDefault(),document.getElementById("exportOBJ")?.click();break;case"t":l.preventDefault(),Fs();break}else switch(l.key){case"Delete":case"Backspace":l.preventDefault(),se&&Ar();break;case"Escape":l.preventDefault(),xn();break}});function Fs(){br(X),X.clear();const l=new On(2,2,2),e=new Pe({color:16007990}),t=new le(l,e);t.name="Red Cube",t.position.set(-3,0,0),t.userData.cifId="test-cube-1",t.userData.cifType="cube",X.add(t);const n=new Yr(1.5,32,32),r=new Pe({color:5025616}),i=new le(n,r);i.name="Green Sphere",i.position.set(3,0,0),i.userData.cifId="test-sphere-1",i.userData.cifType="sphere",X.add(i);const s=new Fe;s.name="Test Group",s.userData.cifId="test-group-1",s.userData.cifType="group",s.position.set(0,0,3);const a=new Kr(1,1,3,16),c=new Pe({color:2201331}),u=new le(a,c);u.name="",u.userData.cifId="test-cylinder-1",u.userData.cifType="cylinder";const d=new le(new On(.5,.5,.5),new Pe({color:16771899}));d.name="Small Yellow Cube",d.position.set(1,2,0),d.userData.cifId="test-small-cube-1",d.userData.cifType="cube",s.add(u),s.add(d),X.add(s),yr(),xe("Test scene loaded: Click objects to select meshes. Ctrl+Click for groups. Shift+Click for root groups.","info")}function wr(l){Ne.has(l)?(Ne.delete(l),Ne.size===0?(bt=!1,Sn()):rr()):(Ne.add(l),bt=!0,rr()),se&&se.getThreeObject()===l?In(se):As(l),xe(Ne.has(l)?`"${l.name}" soloed`:`"${l.name}" un-soloed`,"info")}function Tr(){Ne.clear(),bt=!1,Sn(),se&&In(se),xe("All solo cleared","info")}function rr(){if(!bt||Ne.size===0){Sn();return}const l=new Set;Ne.forEach(t=>{t.traverse(r=>{l.add(r)});let n=t.parent;for(;n&&n!==X;)l.add(n),n=n.parent;if(t.userData.cifId){const r=t.name?.split("_")[0]||"";X.traverse(i=>{if(i instanceof Fe&&i.userData.cifId&&!l.has(i)){const s=i.name||"",a=s.split("_")[0]||s;let c=!1;r&&a&&(r.toLowerCase().includes(a.toLowerCase())||a.toLowerCase().includes(r.toLowerCase()))&&(c=!0),(s.toLowerCase().includes("root")||s.toLowerCase().includes("group")||s.toLowerCase().includes("container")||s.toLowerCase()==="scene")&&(c=!0),c&&l.add(i)}})}}),X.traverse(t=>{t instanceof Fe&&(!t.name||t.name==="")&&!l.has(t)&&t.parent&&l.has(t.parent)&&l.add(t)});const e=new jt;Ne.forEach(t=>{const n=new jt().setFromObject(t);e.union(n)}),X.traverse(t=>{if(t instanceof le&&(!t.name||t.name==="")&&!l.has(t)&&!t.userData.cifId){const n=new jt().setFromObject(t),r=n.getCenter(new k);(e.intersectsBox(n)||e.distanceToPoint(r)<5)&&l.add(t)}}),X.traverse(t=>{t===X||t.name==="axes"||t.type.includes("Light")||(t instanceof le||t instanceof Fe)&&(t.visible=l.has(t))})}function Sn(){X.traverse(l=>{l!==X&&(l instanceof le||l instanceof Fe)&&(l.visible=!0)})}function Ar(){if(!se||!_e)return;const l=se instanceof Me?"group":"object",e=se.name||"unnamed "+l,t=se.parentId;let n=null,r=-1;if(t?(n=_e.findById(t),n&&"children"in n&&(r=n.children.findIndex(i=>i.id===se.id))):(n=_e.root,r=n.children.findIndex(i=>i.id===se.id)),!n||r===-1){xe(`Failed to locate ${l} "${e}" in scene hierarchy`,"error");return}try{const i=se.clone();i.name=se.name;const s={cifObject:i,parentId:t??null,childIndex:r,objectName:e,objectType:l},a=se.getThreeObject();n.children.splice(r,1),a&&a.parent&&(a.parent.remove(a),se.dispose()),se.deselect(),se=null,De?De.render():Rt&&Lt&&Rt.render(X,Lt),dt.push(s),dt.length>ys&&dt.shift().cifObject.dispose(),Jt(),ft.refresh(),_r(),xe(`${l} "${e}" deleted successfully`,"success")}catch(i){console.error("Error during deletion:",i),xe(`Failed to delete ${l} "${e}": ${i}`,"error")}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("toggleInfoPanel")?.addEventListener("click",()=>{ks()}),document.getElementById("closeInfoPanel")?.addEventListener("click",()=>{xn()}),document.getElementById("deleteObject")?.addEventListener("click",()=>{se&&confirm("Are you sure you want to delete this object?")&&Ar()}),document.getElementById("undoDelete")?.addEventListener("click",()=>{Ts()}),document.getElementById("deselectObject")?.addEventListener("click",()=>{xn()}),Jt()});
